<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.1</storyId>
    <title>Expand Message Library to 365 Messages</title>
    <status>drafted</status>
    <generatedAt>2025-11-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-1-expand-message-library-to-365-messages.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>the app creator</asA>
    <iWant>to expand the message library from 100 to 365 unique messages</iWant>
    <soThat>my girlfriend receives a different message every day for a full year</soThat>
    <tasks>
      <task id="1">Generate 265 additional messages using AI-assisted generation with clear prompts for tone, category, and quality specifications</task>
      <task id="2">Manually curate and review all generated messages for quality, authenticity, variety, removing generic/clichéd content</task>
      <task id="3">Categorize messages appropriately across 5 categories (reasons: 73, memories: 73, affirmations: 73, future-plans: 73, custom: 73)</task>
      <task id="4">Update src/data/defaultMessages.ts with all 365 messages following Message interface structure</task>
      <task id="5">Run validation scripts: duplicate detection, category distribution, bundle size check (≤50KB gzipped)</task>
      <task id="6">Test rotation algorithm with expanded library - verify deterministic selection and performance (O(1) time)</task>
      <task id="7">Execute manual quality review of random 30-message sample (10% sampling) for final approval</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.1.1" priority="must">
      <title>Generate 265 Additional Messages Across 5 Categories</title>
      <description>Total library contains 365 messages distributed across 5 categories: Reasons (73), Memories (73), Affirmations (73), Future Plans (73), Custom (73)</description>
      <verification>Script counts messages by category, verifies totals match distribution targets</verification>
    </criterion>
    <criterion id="AC-3.1.2" priority="must">
      <title>Messages Are High-Quality, Heartfelt, and Varied</title>
      <description>Messages meet quality standards: tone variety (romantic/playful/heartfelt/reflective), length balance (80% short, 15% medium, 5% long), authentic and emotionally resonant, no generic clichés</description>
      <verification>Manual review of random 30-message sample (10% sampling) validates quality standards</verification>
    </criterion>
    <criterion id="AC-3.1.3" priority="must">
      <title>Update defaultMessages.ts with All 365 Messages</title>
      <description>src/data/defaultMessages.ts exports const array with 365 Message objects, following interface structure, sequential IDs 1-365, compiles without errors, bundle size increase ≤50KB gzipped</description>
      <verification>TypeScript compilation succeeds, bundle analyzer confirms size impact ≤50KB</verification>
    </criterion>
    <criterion id="AC-3.1.4" priority="must">
      <title>Each Message Tagged with Appropriate Category</title>
      <description>Every message has valid category field from MessageCategory type, semantically correct assignments, no undefined/null/invalid values</description>
      <verification>Script validates all messages have valid categories, spot-check 20 messages for semantic correctness</verification>
    </criterion>
    <criterion id="AC-3.1.5" priority="must">
      <title>No Duplicate Messages in Library</title>
      <description>No identical text content (case-insensitive), no near-duplicates (>90% similarity), unique message IDs (1-365, no gaps)</description>
      <verification>Script generates hash of all message texts, detects collisions, fuzzy match check for near-duplicates</verification>
    </criterion>
    <criterion id="AC-3.1.6" priority="must">
      <title>Message Rotation Algorithm Handles 365-Message Library Correctly</title>
      <description>Algorithm deterministically selects one message per day based on date seed, same message all day, rotates over 365-day cycle, O(1) performance, existing tests pass</description>
      <verification>Unit tests validate rotation logic, E2E test confirms same message shown across multiple app loads same day</verification>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD.md" section="Functional Requirements">
        <title>Message Library & Navigation Requirements</title>
        <relevance>Defines FR006-FR011 functional requirements for 365-message library, daily rotation, and message features</relevance>
        <excerpt>FR006: System SHALL maintain library of 365 unique love messages across 5 categories (reasons, memories, affirmations, future plans, custom). FR007: System SHALL display one message per day based on date-based rotation algorithm. FR010: System SHALL allow users to favorite messages with visual indication.</excerpt>
      </doc>
      <doc path="docs/tech-spec-epic-3.md" section="Story 3.1 Specification">
        <title>Technical Design for Message Expansion</title>
        <relevance>Provides complete technical specifications for expanding message library from 100 to 365 messages</relevance>
        <excerpt>Epic 3 transforms the daily message experience from a static 100-message rotation into a rich, year-long emotional journey with 365 unique messages. Story 3.1 deliverable: Update defaultMessages.ts with 265 additional messages across 5 categories with balanced 73-per-category distribution. Bundle size impact: +50KB gzipped maximum.</excerpt>
      </doc>
      <doc path="docs/data-models.md" section="Message Interface">
        <title>Message Data Structure Definition</title>
        <relevance>Defines the Message interface structure and MessageCategory type used throughout the application</relevance>
        <excerpt>Message interface: id (number, auto-increment), text (string, content), category (MessageCategory: 'reason'|'memory'|'affirmation'|'future'|'custom'), isCustom (boolean), createdAt (Date), isFavorite (boolean, optional). MessageCategory distribution (100 messages): 30 reason, 25 memory, 25 affirmation, 20 future.</excerpt>
      </doc>
      <doc path="docs/architecture.md" section="Data Architecture">
        <title>IndexedDB Schema and Data Flow</title>
        <relevance>Describes IndexedDB messages store structure and data persistence patterns</relevance>
        <excerpt>IndexedDB schema - messages store: keyPath 'id' (auto-increment), indexes: 'by-category' (category field), 'by-date' (createdAt field). Message rotation: Daily message computed from messages pool, stored in messageHistory.lastMessageId. Data flow: User Action → Component → Zustand Store → Service Layer → IndexedDB.</excerpt>
      </doc>
      <doc path="docs/epics.md" section="Epic 3 - Enhanced Message Experience">
        <title>Epic Context and Story Relationships</title>
        <relevance>Provides context for how Story 3.1 fits within Epic 3's broader message enhancement goals</relevance>
        <excerpt>Epic 3 objectives: Expand to 365 messages (Story 3.1), implement swipe navigation (Story 3.2-3.3), enable custom message management (Story 3.4-3.5). Story 3.1 is foundation for subsequent stories - swipe navigation will browse this library, custom messages will integrate with this default set.</excerpt>
      </doc>
    </docs>
    <code>
      <artifact path="src/data/defaultMessages.ts" kind="data" lines="1-50">
        <symbol>defaultMessages</symbol>
        <reason>The primary file to update - currently contains 100 messages, needs expansion to 365 messages. Defines messages in category arrays (reasons, memories, affirmations, futures, customs) then exports combined const array.</reason>
      </artifact>
      <artifact path="src/utils/messageRotation.ts" kind="utility" lines="7-16">
        <symbol>getDailyMessageId</symbol>
        <reason>Core rotation algorithm - already compatible with variable message pool sizes. Uses modulo operation (daysSinceStart % totalMessages) for deterministic daily selection. No changes required for 365-message library.</reason>
      </artifact>
      <artifact path="src/utils/messageRotation.ts" kind="utility" lines="21-47">
        <symbol>getTodayMessage</symbol>
        <reason>Daily message selection function with favorite prioritization. Accepts messages array of any size, separates favorites, rotates through pool. Will work seamlessly with 365-message expansion.</reason>
      </artifact>
      <artifact path="src/types/index.ts" kind="types" lines="5-16">
        <symbol>MessageCategory</symbol>
        <reason>Defines MessageCategory type ('reason'|'memory'|'affirmation'|'future'|'custom') and Message interface structure. All 265 new messages must follow this schema with valid category assignments.</reason>
      </artifact>
      <artifact path="tests/e2e/message-display.spec.ts" kind="test">
        <symbol>message display tests</symbol>
        <reason>Existing E2E tests for message display and rotation. Must continue to pass with 365-message library. Tests verify deterministic selection, same message shown all day, no errors on load.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="typescript" version="~5.9.3" purpose="Type safety and strict mode validation for Message interface"/>
        <package name="vite" version="^7.1.7" purpose="Build tool - bundle 365 messages at compile time, verify bundle size impact ≤50KB gzipped"/>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="bundle-size">Bundle size increase from 265 additional messages must be ≤50KB gzipped. Measured via `npm run build` and bundle analyzer.</constraint>
    <constraint type="data-structure">All 365 messages must follow Message interface: id (sequential 1-365), text (string), category (valid MessageCategory), isCustom (false for defaults), createdAt (Date), isFavorite (false default).</constraint>
    <constraint type="category-distribution">Balanced distribution: 73 messages per category (reasons: 73, memories: 73, affirmations: 73, future: 73, custom: 73) for 20% each.</constraint>
    <constraint type="quality">Messages must be high-quality, heartfelt, varied in tone (romantic/playful/heartfelt/reflective) and length (80% short, 15% medium, 5% long). No generic clichés like "You complete me".</constraint>
    <constraint type="algorithm-compatibility">Existing messageRotation.ts algorithm must work with 365 messages without code changes. getDailyMessageId() uses modulo operation - inherently compatible with any pool size.</constraint>
    <constraint type="typescript">Strict mode compliance required. All messages must compile without TypeScript errors. Use MessageCategory type for category field.</constraint>
    <constraint type="uniqueness">No duplicate message text (case-insensitive comparison). No near-duplicates (>90% similarity). Unique IDs 1-365 with no gaps.</constraint>
    <constraint type="testing">All existing unit and E2E tests for message rotation and display must continue to pass with expanded library. No test regressions allowed.</constraint>
  </constraints>
  <interfaces>
    <interface name="Message" path="src/types/index.ts" lines="9-16">
      <signature>interface Message { id: number; text: string; category: MessageCategory; isCustom: boolean; createdAt: Date; isFavorite?: boolean; }</signature>
      <usage>Every message in defaultMessages.ts must conform to this interface structure. Use for type checking and validation.</usage>
    </interface>
    <interface name="MessageCategory" path="src/types/index.ts" lines="5">
      <signature>type MessageCategory = 'reason' | 'memory' | 'affirmation' | 'future' | 'custom';</signature>
      <usage>Valid category values for Message.category field. Assign semantically correct categories based on message content.</usage>
    </interface>
    <interface name="getDailyMessageId" path="src/utils/messageRotation.ts" lines="7-16">
      <signature>function getDailyMessageId(startDate: Date, today: Date, totalMessages: number): number</signature>
      <usage>Core rotation algorithm. Calculates deterministic message index using (daysSinceStart % totalMessages). Already compatible with 365-message pool.</usage>
    </interface>
    <interface name="getTodayMessage" path="src/utils/messageRotation.ts" lines="21-47">
      <signature>function getTodayMessage(messages: Message[], startDate: Date, favoriteIds: number[]): Message | null</signature>
      <usage>Daily message selector with favorite prioritization. Accepts expanded 365-message array without code changes. Shows favorites every 3rd day.</usage>
    </interface>
  </interfaces>
  <tests>
    <standards>Playwright E2E testing framework (Epic 2 infrastructure). Tests use baseFixture with cleanApp for test isolation. Multi-browser validation (Chromium, Firefox, WebKit) with 2 retries in CI. Tests verify via data-testid attributes (message-card, message-text, message-category-badge). Pattern: Arrange → Act → Assert. TypeScript strict mode for test code. CI integration via GitHub Actions (.github/workflows/playwright.yml).</standards>
    <locations>
      <location>tests/e2e/message-display.spec.ts - Existing E2E tests for message rotation and display (must pass with 365 messages)</location>
      <location>tests/e2e/favorites.spec.ts - Tests for favorite functionality (should work with expanded library)</location>
      <location>scripts/check-duplicates.js - Validation script to detect duplicate message text (to be created)</location>
      <location>scripts/validate-categories.js - Validation script to verify category distribution (to be created)</location>
    </locations>
    <ideas>
      <idea ac="AC-3.1.1">
        <test>Create validation script (scripts/validate-categories.js) to count messages by category</test>
        <approach>Parse defaultMessages.ts, count by category, verify each has 73 messages (±5 tolerance), total equals 365</approach>
      </idea>
      <idea ac="AC-3.1.2">
        <test>Manual quality review process with random sampling</test>
        <approach>Generate random 30-message sample (10%), review for: tone variety, length distribution, authenticity, no clichés. Document review checklist in story Implementation Log.</approach>
      </idea>
      <idea ac="AC-3.1.3">
        <test>TypeScript compilation validation and bundle size check</test>
        <approach>Run `npm run build`, verify no TypeScript errors. Use bundle analyzer or `du -h dist/assets/*.js` to confirm gzipped size increase ≤50KB from baseline.</approach>
      </idea>
      <idea ac="AC-3.1.4">
        <test>Extend validation script to check category semantic correctness</test>
        <approach>Spot-check 20 random messages: verify category matches content (e.g., "I love..." → reason, "Remember when..." → memory). Manual review with categorization rules.</approach>
      </idea>
      <idea ac="AC-3.1.5">
        <test>Create duplicate detection script (scripts/check-duplicates.js)</test>
        <approach>Generate hash of all message texts (case-insensitive), detect collisions. Optional: fuzzy matching with string similarity (e.g., Levenshtein distance) for near-duplicates >90% similarity.</approach>
      </idea>
      <idea ac="AC-3.1.6">
        <test>Run existing message-display.spec.ts test suite</test>
        <approach>Execute `npx playwright test message-display.spec.ts` with 365-message library. Verify all tests pass: deterministic rotation, same message shown all day, no performance degradation (O(1) selection time).</approach>
      </idea>
    </ideas>
  </tests>
</story-context>

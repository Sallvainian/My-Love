<story-context id="6-1-supabase-backend-setup-api-integration" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>Supabase Backend Setup &amp; API Integration</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-1-supabase-backend-setup-api-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to set up Supabase backend and create API integration layer</iWant>
    <soThat>I can sync mood and interaction data between devices</soThat>
    <tasks>
      - Task 1: Supabase Project Initialization (AC: #1)
      - Task 2: Database Schema Creation (AC: #2)
      - Task 3: Row Level Security Setup (AC: #3)
      - Task 4: Realtime Configuration (AC: #4)
      - Task 5: Install and Configure Supabase SDK (AC: #5)
      - Task 6: Create API Service Stubs (AC: #6)
      - Task 7: Environment Variable Setup (AC: #1, #7)
      - Task 8: Error Handling Implementation (AC: #8)
      - Task 9: Documentation (AC: #9)
      - Task 10: Integration Testing (AC: #10)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Supabase Project Setup
      - Create Supabase project on https://supabase.com (free tier)
      - Configure environment variables: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY
      - Document Supabase project URL and anon key in .env.example
      - Verify connection from client app

    AC-2: Database Schema Creation
      - Create moods table with Row Level Security (RLS)
        * Columns: id (UUID), user_id (UUID FK), mood_type (TEXT CHECK), note (TEXT), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)
        * Index: idx_moods_user_created on (user_id, created_at)
      - Create interactions table with RLS
        * Columns: id (UUID), type (TEXT CHECK), from_user_id (UUID FK), to_user_id (UUID FK), viewed (BOOLEAN), created_at (TIMESTAMPTZ)
        * Index: idx_interactions_to_user_viewed on (to_user_id, viewed)
      - Create users table (minimal schema)
        * Columns: id (UUID PK), partner_name (TEXT), device_id (UUID)
      - Apply SQL migrations via Supabase Dashboard SQL Editor

    AC-3: Row Level Security Policies
      - Enable RLS on all tables (ALTER TABLE table ENABLE ROW LEVEL SECURITY)
      - moods table policies:
        * "Users can insert own moods": FOR INSERT WITH CHECK (auth.uid() = user_id)
        * "Users can view own and partner moods": FOR SELECT USING (true) -- simplified for 2-user MVP
      - interactions table policies:
        * "Users can insert interactions": FOR INSERT WITH CHECK (auth.uid() = from_user_id)
        * "Users can view interactions to/from them": FOR SELECT USING (auth.uid() IN (from_user_id, to_user_id))
      - Verify policies work via Supabase Dashboard SQL Editor test queries

    AC-4: Realtime Configuration
      - Enable Realtime for moods table via Supabase Dashboard (Database → Replication)
      - Enable Realtime for interactions table
      - Verify Realtime publications created (supabase_realtime publication includes both tables)

    AC-5: Supabase Client SDK Integration
      - Install @supabase/supabase-js dependency: npm install @supabase/supabase-js
      - Create src/api/supabaseClient.ts singleton instance
      - Initialize SupabaseClient with URL and anon key from environment variables
      - Configure JWT authentication (Supabase SDK handles automatically)
      - Export typed client instance for use across services

    AC-6: API Service Layer Structure
      - Create src/api/ directory for all Supabase-related services
      - Create src/api/supabaseClient.ts - Singleton client instance
      - Create src/api/moodSyncService.ts - Mood sync operations (stub implementation)
      - Create src/api/interactionService.ts - Interaction operations (stub implementation)
      - Each service imports supabaseClient and exposes typed methods

    AC-7: Authentication Configuration
      - Configure Supabase JWT authentication using anon key
      - Set up environment variables: VITE_USER_ID, VITE_PARTNER_ID (hardcoded UUIDs)
      - Document partner UUID setup in README with step-by-step instructions
      - No email/password authentication (hardcoded user pairing for MVP)

    AC-8: Error Handling Infrastructure
      - Implement network error detection (check navigator.onLine)
      - Create graceful degradation pattern for offline mode
      - Add error logging for Supabase API failures (console.error)
      - Return clear error messages for 4xx/5xx responses
      - Handle PostgrestError types from Supabase SDK

    AC-9: Documentation
      - Update README.md with Supabase setup instructions
      - Document environment variable configuration (.env.example)
      - Add SQL migration scripts to docs/migrations/ directory
      - Document Row Level Security policy rationale
      - Include troubleshooting guide for common Supabase errors

    AC-10: Verification Testing
      - Test Supabase connection via simple query (e.g., SELECT from moods)
      - Verify RLS policies block unauthorized access (test with different user_id)
      - Verify environment variables load correctly in dev and build
      - Test error handling for missing API keys (should fail gracefully)
      - Confirm all tables visible in Supabase Dashboard
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Supabase Architecture</section>
        <snippet>Epic implements real-time emotional connection features with Supabase (managed PostgreSQL with Realtime) as backend service for syncing mood data and interactions. Core features: mood logging, Supabase integration with Row Level Security, interactive poke/kiss actions, anniversary countdowns, and calendar-based mood history.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Data Models and Contracts</section>
        <snippet>MoodEntry interface: id (number/UUID), userId (string), moodType (enum), note (string, max 500), timestamp (Date), synced (boolean), supabaseId (string). SupabaseMoodRecord: id (UUID), user_id, mood_type (TEXT CHECK), note, created_at, updated_at. PostgreSQL tables with Row Level Security policies for access control.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>APIs and Interfaces - Supabase PostgREST Endpoints</section>
        <snippet>POST /rest/v1/moods (create mood), GET /rest/v1/moods?select=*&amp;user_id=eq.id (fetch moods), POST /rest/v1/interactions (send poke/kiss), GET /rest/v1/interactions?to_user_id=eq.id&amp;viewed=eq.false (get unviewed). Realtime channels via WebSocket for live updates on moods and interactions tables.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Service Layer - BaseIndexedDBService</section>
        <snippet>Generic base class for IndexedDB CRUD operations. Type constraint: T extends { id?: number }. Abstract methods: getStoreName(), _doInit(). Shared methods: init(), add(), get(), getAll(), update(), delete(), clear(), getPage(). Services extend this pattern for consistency.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Offline-First Architecture</section>
        <snippet>Service Worker pre-caches assets (JS, CSS, HTML, images). IndexedDB stores photos and messages locally. LocalStorage persists settings and small state. PWA Manifest enables installation and standalone mode. All features work without network connectivity.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 6: Interactive Connection Features</section>
        <snippet>FR016-FR025 coverage. Mood tracking (FR019-FR022), poke/kiss interactions (FR023-FR025), anniversary countdowns (FR016-FR018). Supabase backend for partner visibility and real-time sync. 6 stories total including backend setup, mood UI, calendar view, sync, interactions, and countdowns.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/BaseIndexedDBService.ts</path>
        <kind>service</kind>
        <symbol>BaseIndexedDBService&lt;T&gt;</symbol>
        <lines>1-292</lines>
        <reason>Generic base class pattern to follow for new MoodService. Provides CRUD operations, initialization guard, error handling, and pagination. All new services should extend this class.</reason>
      </artifact>
      <artifact>
        <path>src/services/customMessageService.ts</path>
        <kind>service</kind>
        <symbol>CustomMessageService extends BaseIndexedDBService&lt;Message&gt;</symbol>
        <lines>full</lines>
        <reason>Reference implementation showing how to extend BaseIndexedDBService. Implements getStoreName(), _doInit() with schema creation, and service-specific methods (create, getActiveCustomMessages, export/import).</reason>
      </artifact>
      <artifact>
        <path>src/services/photoStorageService.ts</path>
        <kind>service</kind>
        <symbol>PhotoStorageService extends BaseIndexedDBService&lt;Photo&gt;</symbol>
        <lines>full</lines>
        <reason>Reference implementation for service extending base class. Shows custom pagination with index, quota tracking (estimateQuotaRemaining), and schema migration patterns (v1→v2).</reason>
      </artifact>
      <artifact>
        <path>src/validation/schemas.ts</path>
        <kind>validation</kind>
        <symbol>MoodEntrySchema</symbol>
        <lines>130-164</lines>
        <reason>Existing Zod schema for MoodEntry validation. Use this pattern for Supabase API request/response validation. Shows IsoDateStringSchema for date format, enum validation for MoodType, and note max length constraint.</reason>
      </artifact>
      <artifact>
        <path>src/validation/errorMessages.ts</path>
        <kind>validation</kind>
        <symbol>formatZodError, createValidationError, ValidationError</symbol>
        <lines>1-198</lines>
        <reason>Error transformation utilities for user-friendly error messages. Use formatZodError() when validating Supabase API responses, createValidationError() for service-layer error handling. Includes type guards for ZodError and ValidationError.</reason>
      </artifact>
      <artifact>
        <path>.env.example</path>
        <kind>config</kind>
        <symbol>VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY, VITE_USER_ID, VITE_PARTNER_ID</symbol>
        <lines>full</lines>
        <reason>Template for environment variables. This story must update this file with Supabase credentials and document how to obtain values from Supabase Dashboard.</reason>
      </artifact>
      <artifact>
        <path>package.json</path>
        <kind>dependency-manifest</kind>
        <symbol>dependencies</symbol>
        <lines>28-39</lines>
        <reason>Current dependency list. This story adds @supabase/supabase-js and removes pocketbase. Existing: react 19.1.1, zustand 5.0.8, idb 8.0.3, zod 3.25.76 (for validation), framer-motion 12.23.24 (animations).</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <dependency name="react" version="^19.1.1" purpose="UI framework for components" />
        <dependency name="zustand" version="^5.0.8" purpose="State management for moods/interactions" />
        <dependency name="idb" version="^8.0.3" purpose="IndexedDB wrapper (local-first storage)" />
        <dependency name="zod" version="^3.25.76" purpose="Runtime validation for API requests/responses" />
        <dependency name="framer-motion" version="^12.23.24" purpose="Animations for UI feedback" />
        <dependency name="lucide-react" version="^0.548.0" purpose="Icons for mood types and interactions" />
        <dependency name="@supabase/supabase-js" version="^2.38.0" purpose="Supabase client SDK (TO BE ADDED)" status="to-add" />
        <dependency name="pocketbase" version="^0.26.3" purpose="Old backend (TO BE REMOVED)" status="to-remove" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    Architecture Constraints:
      - MUST extend BaseIndexedDBService for any new IndexedDB services (established pattern from Story 5.3)
      - MUST use Zod validation at service boundaries before IndexedDB/Supabase writes (established pattern from Story 5.5)
      - MUST follow offline-first architecture: all features work locally, Supabase sync is enhancement when online
      - MUST maintain single Zustand store pattern (no store splitting)
      - MUST use service worker for asset caching (existing PWA setup)
      - MUST support mobile viewports 320px-428px (NFR004)

    Database Constraints:
      - MUST use PostgreSQL CHECK constraints for data integrity (mood_type enum, note max length)
      - MUST enable Row Level Security on ALL tables before deployment (security requirement)
      - MUST use UUID primary keys for Supabase tables (auto-generated via gen_random_uuid())
      - MUST create indexes for query performance (moods: by-date, interactions: by-user-viewed)
      - MUST follow Supabase naming conventions: snake_case for columns, lowercase for tables

    Error Handling Constraints:
      - MUST check navigator.onLine before Supabase API calls (graceful degradation)
      - MUST handle PostgrestError from Supabase SDK with user-friendly messages
      - MUST queue failed syncs for retry (max 3 attempts with exponential backoff)
      - MUST log all API errors to console.error for debugging
      - MUST NOT crash app on network failures (ErrorBoundary in place from Story 1.5)

    Performance Constraints:
      - MUST maintain &lt;2s load time on 3G connection (NFR001)
      - MUST batch mood syncs (max 50 per batch) to reduce API calls
      - MUST use Supabase query filters server-side to reduce payload size
      - MUST maintain single persistent Realtime channel for all subscriptions
      - MUST use exponential backoff for Realtime reconnection (1s, 2s, 4s, max 30s)

    Security Constraints:
      - MUST NOT commit .env with real credentials to version control
      - MUST document that VITE_SUPABASE_ANON_KEY is safe for client-side use
      - MUST rely on Row Level Security for access control (not application-level checks)
      - MUST validate all user inputs with Zod schemas before API calls
      - MUST use parameterized queries (PostgREST handles automatically)

    Testing Constraints:
      - MUST write integration tests for Supabase connection and RLS policies
      - MUST test offline behavior (network disconnection scenarios)
      - MUST verify environment variables load correctly in dev and build
      - MUST test error handling for missing API keys
      - MUST verify all tables visible in Supabase Dashboard

    Documentation Constraints:
      - MUST update README.md with Supabase setup instructions
      - MUST document .env.example with comments explaining each variable
      - MUST save SQL migration scripts to docs/migrations/
      - MUST document Row Level Security policy rationale
      - MUST include troubleshooting guide for common errors
  </constraints>

  <interfaces>
    Supabase REST API (PostgREST):
      <interface>
        <name>POST /rest/v1/moods</name>
        <kind>REST endpoint</kind>
        <signature>POST https://PROJECT_URL.supabase.co/rest/v1/moods
          Headers: apikey: ANON_KEY, Authorization: Bearer JWT
          Body: { user_id: UUID, mood_type: string, note?: string }
          Response: SupabaseMoodRecord { id: UUID, user_id, mood_type, note, created_at, updated_at }</signature>
        <path>Supabase managed endpoint (auto-generated from schema)</path>
      </interface>
      <interface>
        <name>GET /rest/v1/moods</name>
        <kind>REST endpoint</kind>
        <signature>GET https://PROJECT_URL.supabase.co/rest/v1/moods?select=*&amp;user_id=eq.{id}
          Headers: apikey: ANON_KEY, Authorization: Bearer JWT
          Response: SupabaseMoodRecord[]</signature>
        <path>Supabase managed endpoint (auto-generated from schema)</path>
      </interface>
      <interface>
        <name>POST /rest/v1/interactions</name>
        <kind>REST endpoint</kind>
        <signature>POST https://PROJECT_URL.supabase.co/rest/v1/interactions
          Headers: apikey: ANON_KEY, Authorization: Bearer JWT
          Body: { type: 'poke' | 'kiss', from_user_id: UUID, to_user_id: UUID }
          Response: SupabaseInteractionRecord { id: UUID, type, from_user_id, to_user_id, viewed, created_at }</signature>
        <path>Supabase managed endpoint (auto-generated from schema)</path>
      </interface>

    Supabase Realtime API (WebSocket):
      <interface>
        <name>Realtime Mood Updates Channel</name>
        <kind>WebSocket subscription</kind>
        <signature>supabase.channel('moods')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'moods', filter: 'user_id=eq.{partnerId}' }, callback)
          .subscribe()
          Returns: RealtimeChannel with unsubscribe method</signature>
        <path>src/api/moodSyncService.ts (to be created)</path>
      </interface>
      <interface>
        <name>Realtime Interaction Updates Channel</name>
        <kind>WebSocket subscription</kind>
        <signature>supabase.channel('interactions')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'interactions', filter: 'to_user_id=eq.{currentUserId}' }, callback)
          .subscribe()
          Returns: RealtimeChannel with unsubscribe method</signature>
        <path>src/api/interactionService.ts (to be created)</path>
      </interface>

    Local Service Interfaces (To Be Created):
      <interface>
        <name>SupabaseClient</name>
        <kind>Singleton service</kind>
        <signature>export const supabase = createClient(VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
          Type: SupabaseClient&lt;Database&gt;
          Methods: from(table), channel(name), auth, storage</signature>
        <path>src/api/supabaseClient.ts (to be created)</path>
      </interface>
      <interface>
        <name>MoodSyncService</name>
        <kind>Service class</kind>
        <signature>interface IMoodSyncService {
          syncMood(mood: MoodEntry): Promise&lt;SupabaseMoodRecord&gt;;
          syncPendingMoods(): Promise&lt;{ synced: number; failed: number }&gt;;
          subscribeMoodUpdates(callback: (mood: SupabaseMoodRecord) =&gt; void): () =&gt; void;
        }</signature>
        <path>src/api/moodSyncService.ts (to be created)</path>
      </interface>
      <interface>
        <name>InteractionService</name>
        <kind>Service class</kind>
        <signature>interface IInteractionService {
          sendPoke(partnerId: string): Promise&lt;InteractionRecord&gt;;
          sendKiss(partnerId: string): Promise&lt;InteractionRecord&gt;;
          subscribeInteractions(callback: (interaction: SupabaseInteractionRecord) =&gt; void): () =&gt; void;
          getInteractionHistory(limit: number, offset: number): Promise&lt;Interaction[]&gt;;
        }</signature>
        <path>src/api/interactionService.ts (to be created)</path>
      </interface>
  </interfaces>

  <tests>
    <standards>
      Testing frameworks: Vitest 4.0.9 (unit/integration), Playwright 1.56.1 (E2E), fake-indexeddb 6.2.5 (mocking).
      Coverage target: 80% for services and utilities.
      Test patterns: Mock Supabase SDK responses, mock Realtime channel events, test offline behavior with network throttling.
      Service tests follow BaseIndexedDBService pattern: test init(), CRUD operations, error handling, quota limits.
      Validation tests use Zod schema fixtures, test formatZodError() transformations, verify user-friendly messages.
    </standards>
    <locations>
      Unit tests: tests/unit/api/ (errorHandlers.test.ts, supabaseClient.test.ts)
      Integration tests: tests/integration/supabase.test.ts (connection, RLS policies, Realtime)
      E2E tests: tests/e2e/ (smoke tests for Supabase connection, error recovery)
    </locations>
    <ideas>
      <idea ac="AC-1">
        Test: Supabase client initialization with environment variables
        Given: VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY set in .env
        When: App initializes
        Then: supabaseClient instance created successfully, connection verified via simple query
      </idea>
      <idea ac="AC-2,AC-3">
        Test: Database schema and Row Level Security policies
        Given: SQL migrations executed in Supabase Dashboard
        When: Query tables via Supabase client
        Then: All tables exist with correct schema, RLS policies block unauthorized access
      </idea>
      <idea ac="AC-4">
        Test: Realtime channel subscription
        Given: Realtime enabled for moods and interactions tables
        When: Subscribe to postgres_changes events
        Then: Channel connects, receives INSERT events when partner logs mood
      </idea>
      <idea ac="AC-5,AC-6">
        Test: Service layer stub methods
        Given: supabaseClient, moodSyncService, interactionService created
        When: Call syncMood(), sendPoke() stub methods
        Then: Methods exist, return expected types, import supabaseClient correctly
      </idea>
      <idea ac="AC-7">
        Test: Environment variable loading
        Given: .env.example documented, .env with real UUIDs
        When: Access import.meta.env.VITE_SUPABASE_URL
        Then: Values load correctly in dev and build, missing keys logged gracefully
      </idea>
      <idea ac="AC-8">
        Test: Error handling for network failures
        Given: Mock navigator.onLine = false
        When: Attempt Supabase API call
        Then: Graceful error message displayed, operation queued for retry
      </idea>
      <idea ac="AC-9">
        Test: Documentation completeness
        Given: README.md, .env.example, docs/migrations/ files created
        When: Review documentation
        Then: All setup steps documented, SQL scripts saved, troubleshooting guide included
      </idea>
      <idea ac="AC-10">
        Test: Integration verification
        Given: Supabase project set up, SDK configured
        When: Run integration tests (connection, RLS, env vars, error handling)
        Then: All tests pass, tables visible in Supabase Dashboard
      </idea>
    </ideas>
  </tests>
</story-context>

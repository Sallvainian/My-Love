<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5</storyId>
    <title>Centralize Input Validation Layer</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-5-centralize-input-validation-layer.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a centralized validation layer for user inputs</iWant>
    <soThat>corrupted or invalid data can't enter the system</soThat>
    <tasks>
      - Task 1: Setup Validation Infrastructure (AC: #1)
      - Task 2: Define Message Validation Schema (AC: #2)
      - Task 3: Define Photo Validation Schema (AC: #3)
      - Task 4: Define Mood and Settings Schemas (AC: #4, #5)
      - Task 5: Integrate Validation into customMessageService (AC: #6, #7)
      - Task 6: Integrate Validation into photoStorageService (AC: #6, #7)
      - Task 7: Integrate Validation into migrationService and Store (AC: #6, #7)
      - Task 8: Create Error Transformation Utilities (AC: #7)
      - Task 9: Update Form Components for Error Display (AC: #7)
      - Task 10: Add Unit Tests for Validation Schemas (AC: #9)
      - Task 11: Documentation and Cleanup (AC: #10)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Validation Infrastructure Created
    - Create src/validation/ directory with validation schemas
    - Install Zod library (zod@^3.23.0)
    - Define validation rules for all data models: messages, photos, moods, settings

    AC-2: Message Validation
    - Validate message content (min: 1 char, max: 1000 chars)
    - Validate category (enum: 'reason', 'memory', 'affirmation', 'future', 'custom')
    - Validate optional fields: tags (array of strings), active (boolean)
    - Prevent empty strings, null values, excessively long inputs

    AC-3: Photo Validation
    - Validate caption (max: 500 chars, optional)
    - Validate tags (array of strings, optional)
    - Validate image blob (Blob instance check)
    - Validate metadata: width, height, mimeType, sizes (positive numbers)

    AC-4: Mood Validation
    - Validate date format (ISO date string: YYYY-MM-DD)
    - Validate mood type (enum: 'loved', 'happy', 'content', 'thoughtful', 'grateful')
    - Validate optional note (max: 200 chars)

    AC-5: Settings Validation
    - Validate partner name (min: 1 char)
    - Validate relationship start date (ISO date string)
    - Validate theme (enum: 'sunset', 'ocean', 'lavender', 'rose')
    - Validate nested structures (relationship, customization, notifications)

    AC-6: Service Layer Integration
    - Apply validation at service boundary (before IndexedDB write)
    - Validation occurs in customMessageService.ts, photoStorageService.ts, migrationService.ts
    - Return clear, user-friendly error messages on validation failure
    - Use Zod's .parse() for strict validation, .safeParse() for graceful handling

    AC-7: Error Handling
    - Catch ZodError exceptions in service methods
    - Transform Zod errors into user-friendly messages
    - Display field-specific errors in UI forms
    - Log validation errors for debugging (without exposing to user)

    AC-8: Type Safety
    - Generate TypeScript types from Zod schemas using z.infer&lt;&gt;
    - Replace manual type definitions with schema-derived types where applicable
    - Ensure schema and types stay in sync (single source of truth)

    AC-9: Unit Test Coverage
    - Add validation tests to Story 5.4's unit test suite
    - Test edge cases: empty strings, null values, max lengths, invalid enums
    - Test boundary conditions: min/max lengths, date formats
    - Achieve 100% coverage of validation schemas

    AC-10: Documentation
    - Document validation strategy in technical-decisions.md
    - Add inline comments to schemas explaining validation rules
    - Document error message format and handling patterns
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification: Code Quality &amp; Performance</title>
        <section>Story 5.5: Centralize Input Validation Layer</section>
        <snippet>Centralize validation logic using Zod schemas to prevent invalid data from entering the system at service boundaries. This prevents the data corruption edge cases discovered during Epic 4 photo upload testing. Validation enforces type safety at runtime, complementing TypeScript's compile-time checking.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Data Architecture - IndexedDB Schema</section>
        <snippet>Database: my-love-db (version 2). Object stores: photos (key: id, indexes: by-date), messages (key: id, indexes: by-category, by-date). All data persisted client-side via IndexedDB with LocalStorage for settings state.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Security Considerations</section>
        <snippet>TypeScript provides type safety to prevent runtime errors. Input sanitization needed for custom messages. React escapes content by default (XSS protection). Client-side only app (no backend, no authentication).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>My-Love Epic Breakdown</title>
        <section>Epic 5: Code Quality &amp; Performance Improvements</section>
        <snippet>Epic 5 addresses technical debt and optimizes performance: store refactoring, photo pagination, service base class extraction, unit test coverage, and centralized input validation to prevent data corruption.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/services/customMessageService.ts</path>
        <kind>service</kind>
        <symbol>CustomMessageService</symbol>
        <lines>1-299</lines>
        <reason>Message service requiring validation integration. Methods: create(), update() need MessageSchema validation. Current implementation has no validation - accepts any input.</reason>
      </artifact>
      <artifact>
        <path>src/services/photoStorageService.ts</path>
        <kind>service</kind>
        <symbol>PhotoStorageService</symbol>
        <lines>1-322</lines>
        <reason>Photo service requiring validation integration. Methods: create(), update() need PhotoSchema validation. Current implementation validates structure but not content constraints.</reason>
      </artifact>
      <artifact>
        <path>src/services/migrationService.ts</path>
        <kind>service</kind>
        <symbol>migrateCustomMessagesFromLocalStorage</symbol>
        <lines>1-131</lines>
        <reason>Migration service needs validation for backward compatibility. Should use safeParse() to handle legacy data gracefully without blocking app initialization.</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>useAppStore</symbol>
        <lines>1-200</lines>
        <reason>Zustand store manages moods and settings state. Store actions addMoodEntry() and updateSettings() need validation integration for mood entries and settings updates.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>Message, Photo, MoodEntry, Settings</symbol>
        <lines>1-181</lines>
        <reason>Existing TypeScript type definitions. Zod schemas will mirror these types. Can optionally derive types from schemas using z.infer&lt;&gt; for single source of truth.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package>zod</package>
        <version>^3.23.0</version>
        <purpose>Runtime validation library with TypeScript integration. Provides schema-based validation, type inference, and detailed error messages.</purpose>
      </node>
      <node>
        <package>idb</package>
        <version>^8.0.3</version>
        <purpose>Already installed. IndexedDB wrapper used by all services. Validation happens before idb operations.</purpose>
      </node>
      <node>
        <package>vitest</package>
        <version>TBD from Story 5.4</version>
        <purpose>Unit testing framework. Story 5.4 installs Vitest - Story 5.5 adds validation schema tests to existing test suite.</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Architecture</type>
      <description>Service Boundary Pattern: Validation must occur at service layer boundary (before IndexedDB writes), not in UI or store. Services validate input → store IndexedDB → update state.</description>
    </constraint>
    <constraint>
      <type>Backward Compatibility</type>
      <description>Existing data may not pass new validation rules. Use .safeParse() in migration service to handle legacy data. Log validation failures but don't block app initialization.</description>
    </constraint>
    <constraint>
      <type>Performance</type>
      <description>Zod validation adds &lt;10ms per operation (acceptable). Pre-compile schemas at module load. Only validate at service boundary (not in UI or store to avoid redundant validation).</description>
    </constraint>
    <constraint>
      <type>Error Handling</type>
      <description>Catch ZodError exceptions in services. Transform to user-friendly messages using formatZodError() utility. Display field-specific errors in UI forms with red text styling.</description>
    </constraint>
    <constraint>
      <type>Type Safety</type>
      <description>Option 1: Keep existing types/index.ts definitions, mirror in Zod schemas. Option 2: Use z.infer&lt;&gt; to derive types from schemas (single source of truth). Start with Option 1 for gradual migration.</description>
    </constraint>
    <constraint>
      <type>Testing</type>
      <description>Add validation tests to Story 5.4's Vitest suite. Test edge cases (empty strings, max lengths, invalid enums), boundary conditions (min/max, date formats), and error message formatting. Achieve 100% schema coverage.</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Zod Schema API</name>
      <kind>Validation Schema</kind>
      <signature>
        // Message validation
        const MessageSchema = z.object({
          id: z.number().optional(),
          text: z.string().min(1).max(1000),
          category: z.enum(['reason', 'memory', 'affirmation', 'future', 'custom']),
          isCustom: z.boolean(),
          active: z.boolean().default(true),
          createdAt: z.date(),
          isFavorite: z.boolean().optional(),
          updatedAt: z.date().optional(),
          tags: z.array(z.string()).optional(),
        });

        // Photo validation
        const PhotoSchema = z.object({
          id: z.number().optional(),
          imageBlob: z.instanceof(Blob),
          caption: z.string().max(500).optional(),
          tags: z.array(z.string()).default([]),
          uploadDate: z.date(),
          originalSize: z.number().positive(),
          compressedSize: z.number().positive(),
          width: z.number().int().positive(),
          height: z.number().int().positive(),
          mimeType: z.enum(['image/jpeg', 'image/png', 'image/webp']),
        });

        // Usage in services
        const validated = MessageSchema.parse(input); // Throws on error
        const result = MessageSchema.safeParse(input); // Returns {success, data, error}
      </signature>
      <path>src/validation/schemas.ts</path>
    </interface>

    <interface>
      <name>Service Validation Pattern</name>
      <kind>Service Method</kind>
      <signature>
        class CustomMessageService {
          async create(input: CreateMessageInput): Promise&lt;Message&gt; {
            // Validate input at service boundary
            const validated = CreateMessageInputSchema.parse(input);

            // Proceed with IndexedDB write using validated data
            const id = await this.db!.add('messages', validated);
            return { ...validated, id } as Message;
          }
        }
      </signature>
      <path>src/services/customMessageService.ts</path>
    </interface>

    <interface>
      <name>Error Transformation Utility</name>
      <kind>Utility Function</kind>
      <signature>
        function formatZodError(error: ZodError): string {
          const fieldErrors = error.errors.map((err) => {
            const field = err.path.join('.');
            const message = err.message;
            return `${field}: ${message}`;
          });
          return fieldErrors.join(', ');
        }

        // Usage example
        try {
          const validated = MessageSchema.parse(input);
        } catch (error) {
          if (error instanceof z.ZodError) {
            const message = formatZodError(error);
            throw new ValidationError(message);
          }
          throw error;
        }
      </signature>
      <path>src/validation/errorMessages.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest framework (installed in Story 5.4). Test files located in tests/unit/validation/. Use fake-indexeddb for service integration tests. Validation tests focus on edge cases and boundary conditions. Follow AAA pattern (Arrange-Act-Assert). Target 100% coverage of validation schemas.
    </standards>

    <locations>
      tests/unit/validation/schemas.test.ts - Validation schema unit tests
      tests/unit/validation/errorMessages.test.ts - Error transformation tests
      tests/unit/services/ - Service integration tests with validation
    </locations>

    <ideas>
      AC-2: Message Validation Tests
      - Test empty string rejected (min: 1)
      - Test 1001 char string rejected (max: 1000)
      - Test invalid category enum ('invalid') rejected
      - Test valid message with all fields accepted
      - Test optional fields (tags, active, isFavorite) work correctly

      AC-3: Photo Validation Tests
      - Test caption &gt; 500 chars rejected
      - Test non-Blob imageBlob rejected
      - Test negative width/height rejected
      - Test invalid mimeType enum rejected
      - Test valid photo with all metadata accepted

      AC-4: Mood Validation Tests
      - Test invalid date format ('2024-13-45') rejected
      - Test valid ISO date format ('2024-11-14') accepted
      - Test invalid mood type ('hppy' typo) rejected
      - Test note &gt; 200 chars rejected

      AC-5: Settings Validation Tests
      - Test empty partner name rejected
      - Test invalid theme enum rejected
      - Test nested structure validation (relationship object)
      - Test valid settings with all fields accepted

      AC-7: Error Message Formatting Tests
      - Test ZodError transforms to user-friendly message
      - Test field paths formatted correctly ('relationship.partnerName')
      - Test multiple errors concatenated properly

      AC-9: Edge Case Coverage
      - Test whitespace-only strings
      - Test null vs undefined handling
      - Test boundary values (exactly min/max length)
      - Test array validation (empty arrays, invalid items)
    </ideas>
  </tests>
</story-context>

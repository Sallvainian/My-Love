<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>3</storyId>
    <title>Mood History Calendar View</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-3-mood-history-calendar-view.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>to see my mood history in a calendar</iWant>
    <soThat>I can reflect on patterns over time</soThat>
    <tasks>
- [ ] **Task 1: Create Calendar Grid Component** (AC: #1, #2, #5)
- [ ] **Task 2: Integrate MoodService.getMoodsInRange()** (AC: #5)
- [ ] **Task 3: Render Mood Indicators on Days** (AC: #2)
- [ ] **Task 4: Implement Month Navigation** (AC: #3)
- [ ] **Task 5: Create Mood Detail Modal** (AC: #4)
- [ ] **Task 6: Wire Day Tap to Open Modal** (AC: #4)
- [ ] **Task 7: Add to Navigation & Integrate with MoodTracker** (AC: #1)
- [ ] **Task 8: E2E Testing** (AC: All)
- [ ] **Task 9: Performance Optimization** (AC: #6)
- [ ] **Task 10: Accessibility & UX Polish** (AC: #4, #6)
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Calendar Month View Rendering**: Calendar displays current month with 30-31 day grid, days with moods show color-coded indicators, current date highlighted, responsive layout (mobile <640px, desktop optimized)

2. **Mood Indicator Display**: Each mood type has distinct color/icon (loved: pink heart, happy: yellow smile, content: blue meh, thoughtful: purple thought, grateful: green sparkles), positioned on day cell, visual hierarchy maintained

3. **Month Navigation**: Previous/next month buttons, display month + year, updates grid with new month's moods, smooth Framer Motion transitions (300ms), keyboard navigation support

4. **Mood Detail Modal**: Tap day with mood opens modal showing mood type (icon+color), formatted date/timestamp, note text if present, close button and Esc key handler, Framer Motion animations, accessible focus trap

5. **Data Loading via getMoodsInRange()**: Loads moods only for visible month using MoodService.getMoodsInRange(startOfMonth, endOfMonth), <100ms query via by-date index, loading state displayed

6. **Performance & UX**: Calendar grid renders <200ms for 30-day month, month navigation feels instant (<100ms perceived), lazy load moods, cache current month, no memory leaks on unmount
  </acceptanceCriteria>

  <artifacts>
    <docs>
<!-- Epic 6 Tech Spec -->
<doc>
  <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
  <title>Epic Technical Specification: Interactive Connection Features</title>
  <section>Story 6.3: Mood History Calendar View</section>
  <snippet>AC3 addresses this story: Calendar view displays current month with mood icons, tapping a date shows mood details (mood type, note, date), navigate between months, responsive layout. MoodHistoryCalendar component renders 30-31 day grid using getMoodsInRange() for efficient queries via by-date index.</snippet>
</doc>

<!-- Architecture Patterns -->
<doc>
  <path>docs/architecture.md</path>
  <title>Architecture Documentation</title>
  <section>Component-Based Architecture & Service Layer</section>
  <snippet>Follow existing component patterns: separate calendar grid and modal into reusable components, use TypeScript interfaces, clean composition. BaseIndexedDBService<T> pattern provides CRUD operations with pagination support via getPage() method.</snippet>
</doc>

<!-- Epics Breakdown -->
<doc>
  <path>docs/epics.md</path>
  <title>My-Love - Epic Breakdown</title>
  <section>Epic 6: Interactive Connection Features > Story 6.3</section>
  <snippet>Calendar view displays current month with mood icons on logged dates. Tapping a date shows mood details (mood type, note, date). Navigate between months (prev/next buttons). Empty dates show no mood indicator. Current date highlighted. Responsive layout (mobile and desktop).</snippet>
</doc>

<!-- Story File with Dev Notes -->
<doc>
  <path>docs/sprint-artifacts/6-3-mood-history-calendar-view.md</path>
  <title>Story 6.3: Mood History Calendar View</title>
  <section>Dev Notes - Architecture Alignment & Learnings from Story 6.2</section>
  <snippet>MoodService available with getMoodsInRange() returning Promise<MoodEntry[]>. Mood type icons: loved=Heart, happy=Smile, content=Meh, thoughtful=MessageCircle, grateful=Sparkles. Color palette: loved=pink-500, happy=yellow-500, content=blue-500, thoughtful=purple-500, grateful=green-500. Calendar render <200ms, IndexedDB query <100ms. Review findings: tests need different dates for moods (not all "today"), maxLength on textarea for defense-in-depth.</snippet>
</doc>
    </docs>

    <code>
<!-- MoodService - Data Layer -->
<artifact>
  <path>src/services/moodService.ts</path>
  <kind>service</kind>
  <symbol>MoodService</symbol>
  <lines>1-303</lines>
  <reason>Core service for mood CRUD operations. Extends BaseIndexedDBService<MoodEntry>. Implements getMoodsInRange(start, end) for calendar queries using by-date index. Critical for Story 6.3 data loading.</reason>
</artifact>

<!-- MoodSlice - State Management -->
<artifact>
  <path>src/stores/slices/moodSlice.ts</path>
  <kind>slice</kind>
  <symbol>MoodSlice</symbol>
  <lines>1-152</lines>
  <reason>Zustand state slice managing moods array and sync status. Provides actions: addMoodEntry(), getMoodForDate(), loadMoods(). Calendar component will consume moods state and actions.</reason>
</artifact>

<!-- MoodTracker Component - Integration Reference -->
<artifact>
  <path>src/components/MoodTracker/MoodTracker.tsx</path>
  <kind>component</kind>
  <symbol>MoodTracker</symbol>
  <lines>1-220</lines>
  <reason>Existing mood tracking UI from Story 6.2. Reference for mood icons, colors, error handling patterns. Calendar will integrate as sub-tab or button in this component.</reason>
</artifact>

<!-- MoodEntry Type Definition -->
<artifact>
  <path>src/types/index.ts</path>
  <kind>type</kind>
  <symbol>MoodEntry</symbol>
  <lines>62-71</lines>
  <reason>MoodEntry interface defines schema: id, userId, mood (MoodType), note (optional), date (ISO string YYYY-MM-DD), timestamp (Date), synced (boolean), supabaseId (optional). Calendar displays and filters by date field.</reason>
</artifact>

<!-- BaseIndexedDBService - Service Pattern -->
<artifact>
  <path>src/services/BaseIndexedDBService.ts</path>
  <kind>service</kind>
  <symbol>BaseIndexedDBService</symbol>
  <lines>1-239</lines>
  <reason>Generic base class providing CRUD operations and error handling. MoodService extends this pattern. Reference for understanding service layer architecture and pagination methods like getPage().</reason>
</artifact>

<!-- MoodButton - Reusable Component -->
<artifact>
  <path>src/components/MoodTracker/MoodButton.tsx</path>
  <kind>component</kind>
  <symbol>MoodButton</symbol>
  <lines>1-80</lines>
  <reason>Reusable mood button component from Story 6.2. May be repurposed or referenced for calendar day cell interactions and mood icon display patterns.</reason>
</artifact>
    </code>

    <dependencies>
<ecosystem name="node">
  <package name="react" version="19.1.1">Core UI framework for component rendering</package>
  <package name="framer-motion" version="12.23.24">Declarative animations for modal entrance/exit and month transitions</package>
  <package name="lucide-react" version="0.548.0">Icon library for mood type icons (Heart, Smile, Meh, MessageCircle, Sparkles)</package>
  <package name="zustand" version="5.0.8">State management for moods array and sync status</package>
  <package name="idb" version="8.0.3">IndexedDB wrapper used by MoodService for efficient queries</package>
  <package name="date-fns" version="4.1.0">Date manipulation and formatting for calendar calculations and display</package>
  <package name="zod" version="3.25.76">Runtime validation (already used by MoodService for MoodEntrySchema)</package>
  <package name="typescript" version="5.9.3">Type-safe development</package>
  <package name="tailwind-css" version="3.4.18">Utility-first styling for responsive calendar grid</package>
</ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
**Performance Constraints (NFR001):**
- Calendar grid render time: <200ms for 30-day month (measured with performance.now())
- IndexedDB query time: <100ms for getMoodsInRange() via by-date index (validated in Story 6.2)
- Month navigation perceived delay: <100ms (use debouncing to prevent rapid clicks)
- Memory management: No leaks on unmount (cleanup event listeners, subscriptions)

**Offline-First Requirement (NFR002):**
- Calendar must work fully offline (moods loaded from local IndexedDB)
- No network calls required for calendar view functionality
- Graceful degradation if sync features unavailable

**Responsive Design (NFR004):**
- Mobile viewports: 320px-428px (single column calendar, touch-optimized)
- Desktop: Optimized grid layout with larger day cells
- Tailwind responsive classes: sm:, md:, lg: breakpoints

**Architecture Alignment:**
- **Service Layer**: Use MoodService.getMoodsInRange(start, end) for data queries (already exists from Story 6.2)
- **Component Structure**: Follow PhotoGallery and MoodTracker patterns (separate grid and modal components, TypeScript interfaces, clean composition)
- **State Management**: Follow Zustand patterns from moodSlice (Option 1: add calendar state to moodSlice, Option 2: keep local useState if isolated)
- **Animations**: Framer Motion for modal (slideUp entrance with backdrop fade, same as PhotoCarousel) and month transitions (fade or slide, 300ms duration)
- **Icons**: lucide-react for mood type icons (Heart, Smile, Meh, MessageCircle, Sparkles)
- **Styling**: Tailwind responsive classes for mobile-first design

**Learnings from Story 6.2 (Review Status):**
- Tests need different dates for multiple moods (not all "today") due to by-date unique constraint
- maxLength attribute needed on textarea for defense-in-depth validation
- MoodEntrySchema from validation layer ensures data integrity
- by-date index enables <100ms query performance (validated in tests)

**Code Quality Standards:**
- React.memo for day cells to prevent unnecessary re-renders
- useCallback for event handlers to avoid function recreation
- Clean up subscriptions and intervals on component unmount
- Add data-testid attributes for E2E testing (data-testid="calendar-day-{date}")
- ARIA labels for accessibility (screen readers, keyboard navigation)
  </constraints>

  <interfaces>
<!-- MoodService API -->
<interface>
  <name>MoodService.getMoodsInRange()</name>
  <kind>service method</kind>
  <signature>getMoodsInRange(startDate: Date, endDate: Date): Promise<MoodEntry[]></signature>
  <path>src/services/moodService.ts</path>
  <usage>Load moods for visible calendar month. Calculate startOfMonth and endOfMonth, pass to method. Returns moods sorted chronologically. Query time <100ms via by-date index.</usage>
</interface>

<!-- MoodSlice State Interface -->
<interface>
  <name>MoodSlice</name>
  <kind>zustand slice</kind>
  <signature>moods: MoodEntry[], getMoodForDate: (date: string) => MoodEntry | undefined, loadMoods: () => Promise<void></signature>
  <path>src/stores/slices/moodSlice.ts</path>
  <usage>Access moods array from Zustand store via useAppStore((state) => state.moods). Use getMoodForDate(dateString) to check if mood exists for specific date. loadMoods() refreshes moods from IndexedDB if needed.</usage>
</interface>

<!-- MoodEntry Type -->
<interface>
  <name>MoodEntry</name>
  <kind>typescript interface</kind>
  <signature>{ id?: number; userId: string; mood: MoodType; note?: string; date: string; timestamp: Date; synced: boolean; supabaseId?: string }</signature>
  <path>src/types/index.ts:62-71</path>
  <usage>Type definition for mood entries. Calendar filters by date field (ISO string YYYY-MM-DD), displays mood type with icon/color, shows note in modal.</usage>
</interface>

<!-- Calendar Helpers Interface (to be created) -->
<interface>
  <name>Calendar Utility Functions</name>
  <kind>utility functions</kind>
  <signature>getDaysInMonth(year, month): number, getFirstDayOfMonth(year, month): number, generateCalendarDays(year, month): CalendarDay[]</signature>
  <path>src/utils/calendarHelpers.ts (new file)</path>
  <usage>Utility functions for calendar grid calculations. getDaysInMonth returns 28-31, getFirstDayOfMonth returns 0-6 (Sunday-Saturday), generateCalendarDays creates array of CalendarDay objects with date and mood placeholders.</usage>
</interface>

<!-- Framer Motion Modal Pattern -->
<interface>
  <name>Modal Animation Variants</name>
  <kind>animation pattern</kind>
  <signature>Framer Motion AnimatePresence with slideUp entrance and backdrop fade</signature>
  <path>Reference: src/components/PhotoGallery/* (existing pattern)</path>
  <usage>Use Framer Motion <AnimatePresence> to conditionally render modal. Variants: initial={{ y: '100%', opacity: 0 }}, animate={{ y: 0, opacity: 1 }}, exit={{ y: '100%', opacity: 0 }}, transition={{ duration: 0.3 }}. Backdrop with opacity 0 â†’ 0.5 fade.</usage>
</interface>
  </interfaces>

  <tests>
    <standards>
**Testing Frameworks:**
- E2E: Playwright 1.56.1 (comprehensive user journey testing)
- Unit: Vitest 4.0.9 (component logic and utility functions)
- Coverage: @vitest/coverage-v8 (ensure 70%+ coverage)

**Testing Patterns from Previous Stories:**
- data-testid attributes for reliable element selection (e.g., data-testid="calendar-day-2025-11-15")
- Playwright auto-start preview server (configured in playwright.config.ts)
- IndexedDB mocking with fake-indexeddb for unit tests
- Date mocking to ensure consistent test results

**Story 6.2 Learnings:**
- Use explicit date strings in test data ('2025-11-14', '2025-11-15', etc.) to avoid by-date unique constraint violations
- Don't use "today" for multiple test moods; vary dates to test calendar rendering across different days

**Performance Testing:**
- Measure calendar render time with performance.now() (target: <200ms for 30-day month)
- Verify IndexedDB getMoodsInRange() query time <100ms (by-date index)
- Test month navigation responsiveness (<100ms perceived delay)
    </standards>

    <locations>
- tests/e2e/ - End-to-end Playwright tests
- tests/unit/ - Unit tests for utility functions and component logic
- tests/integration/ - Integration tests for service layer
- src/components/**/*.test.tsx - Component unit tests (if using Vitest)
    </locations>

    <ideas>
**E2E Test: Navigate to Mood History and Verify Calendar Renders (AC #1, #2)**
- Navigate to Mood History tab/button from MoodTracker view
- Assert calendar grid displays for current month
- Assert correct number of day cells (28-31 based on month)
- Assert current date is highlighted with distinct visual style
- Verify empty days show neutral background
- Verify responsive layout on mobile viewport (320px-640px)

**E2E Test: Log Mood and Verify Indicator Appears in Calendar (AC #2)**
- Log mood in MoodTracker (e.g., "Loved" with note)
- Navigate to Mood History
- Assert calendar shows pink heart indicator on today's date
- Repeat for all 5 mood types, verify distinct colors/icons

**E2E Test: Navigate Previous/Next Month (AC #3)**
- Open calendar to current month
- Click "Previous Month" button
- Assert calendar updates to previous month (verify month/year label)
- Assert moods for new month load correctly
- Click "Next Month" twice to return to current month
- Assert smooth Framer Motion transition animation
- Test keyboard navigation: arrow keys trigger month change

**E2E Test: Tap Day with Mood to Open Modal (AC #4)**
- Log mood with note "Feeling amazing today!"
- Navigate to calendar, tap today's date
- Assert modal opens with mood type (icon + color)
- Assert date formatted correctly ("Monday, Nov 15, 2025")
- Assert timestamp formatted ("3:42 PM")
- Assert note text displayed
- Close modal via close button (X icon)
- Reopen modal, close via ESC key
- Verify modal closes and focus returns to calendar

**E2E Test: Efficient Data Loading via getMoodsInRange() (AC #5)**
- Mock IndexedDB with 100 moods spanning 3 months
- Open calendar to current month
- Assert only moods for current month loaded (verify via network tab or IndexedDB inspection)
- Navigate to previous month
- Assert only moods for previous month loaded (not all 100 moods)
- Verify loading state displayed during mood fetch (skeleton or spinner)

**E2E Test: Performance - Calendar Renders <200ms (AC #6)**
- Instrument calendar component with performance.now() before/after render
- Load calendar with 30-day month (all days with moods)
- Assert render time <200ms
- Navigate to next month, assert <100ms perceived delay
- Verify no memory leaks: unmount component, check heap size

**Unit Test: Calendar Grid Calculation Helpers**
- Test getDaysInMonth(2025, 0) returns 31 (January)
- Test getDaysInMonth(2024, 1) returns 29 (February leap year)
- Test getFirstDayOfMonth(2025, 10) returns correct day of week (0-6)
- Test generateCalendarDays() produces correct number of cells (empty cells + month days)

**Unit Test: Mood Lookup Optimization**
- Test Map-based mood lookup by date (O(1) complexity)
- Mock moods array with 30 entries
- Assert getMoodForDate('2025-11-15') returns correct MoodEntry
- Assert getMoodForDate('2025-11-16') returns undefined if no mood logged

**Accessibility Test: Keyboard Navigation and Screen Readers (AC #4)**
- Test tab navigation through calendar day cells
- Test Enter/Space key opens modal on focused day with mood
- Test arrow keys navigate previous/next month
- Test ESC key closes modal
- Verify ARIA labels announced correctly by screen reader
- Verify focus trap within modal (tab cycles within modal)
- Verify focus returns to trigger element on modal close
    </ideas>
  </tests>
</story-context>

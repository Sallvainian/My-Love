<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.4</storyId>
    <title>Photo Edit & Delete Functionality</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-4-photo-edit-delete-functionality.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>to edit captions/tags or delete photos</iWant>
    <soThat>I can manage my photo collection</soThat>
    <tasks>
      <task id="1" label="Create PhotoEditModal Component">
        <subtask id="1.1">Create component file src/components/PhotoEditModal/PhotoEditModal.tsx</subtask>
        <subtask id="1.2">Implement modal overlay layout (fixed position, z-index: 60, backdrop)</subtask>
        <subtask id="1.3">Display photo thumbnail preview (max 200px height)</subtask>
        <subtask id="1.4">Implement caption textarea with character counter (max 500 chars)</subtask>
        <subtask id="1.5">Implement tags input field with validation (max 10 tags, comma-separated)</subtask>
        <subtask id="1.6">Add Save button with form validation (disable if invalid)</subtask>
        <subtask id="1.7">Add Cancel button to close modal without saving</subtask>
        <subtask id="1.8">Add data-testid attributes for E2E testing</subtask>
        <acceptanceCriteria>AC-4.4.1, AC-4.4.2, AC-4.4.3</acceptanceCriteria>
      </task>
      <task id="2" label="Implement Photo Update Logic in Zustand">
        <subtask id="2.1">Add updatePhoto(photoId, updates) action to useAppStore</subtask>
        <subtask id="2.2">Call photoStorageService.update(photoId, updates) in action</subtask>
        <subtask id="2.3">Update photos array in state (find by ID, replace with updated photo)</subtask>
        <subtask id="2.4">Handle update errors gracefully (show error toast, keep modal open)</subtask>
        <subtask id="2.5">Trigger PhotoCarousel and PhotoGallery re-renders after update</subtask>
        <acceptanceCriteria>AC-4.4.3</acceptanceCriteria>
      </task>
      <task id="3" label="Create PhotoDeleteConfirmation Component">
        <subtask id="3.1">Create component file src/components/PhotoDeleteConfirmation/PhotoDeleteConfirmation.tsx</subtask>
        <subtask id="3.2">Implement dialog overlay layout (z-index: 70, above edit modal)</subtask>
        <subtask id="3.3">Display confirmation message: "Delete this photo? This action cannot be undone."</subtask>
        <subtask id="3.4">Add Cancel button (closes dialog)</subtask>
        <subtask id="3.5">Add Delete button (red/destructive styling, confirms deletion)</subtask>
        <subtask id="3.6">Add data-testid attributes for E2E testing</subtask>
        <acceptanceCriteria>AC-4.4.4</acceptanceCriteria>
      </task>
      <task id="4" label="Implement Photo Delete Logic in Zustand">
        <subtask id="4.1">Add deletePhoto(photoId) action to useAppStore</subtask>
        <subtask id="4.2">Call photoStorageService.delete(photoId) in action</subtask>
        <subtask id="4.3">Update photos array (filter out deleted photo by ID)</subtask>
        <subtask id="4.4">Implement carousel navigation logic after delete (next/prev/close)</subtask>
        <subtask id="4.5">Handle delete errors gracefully (show error, keep dialog open)</subtask>
        <subtask id="4.6">Trigger PhotoGallery grid refresh after delete</subtask>
        <acceptanceCriteria>AC-4.4.5, AC-4.4.7</acceptanceCriteria>
      </task>
      <task id="5" label="Enable Edit and Delete Buttons in PhotoCarouselControls">
        <subtask id="5.1">Remove disabled state from Edit button</subtask>
        <subtask id="5.2">Remove disabled state from Delete button</subtask>
        <subtask id="5.3">Add onClick handler for Edit: opens PhotoEditModal with currentPhoto</subtask>
        <subtask id="5.4">Add onClick handler for Delete: opens PhotoDeleteConfirmation with currentPhoto</subtask>
        <subtask id="5.5">Remove "Coming in Story 4.4" tooltips</subtask>
        <subtask id="5.6">Update button styling (remove opacity-50, cursor-not-allowed)</subtask>
        <acceptanceCriteria>AC-4.4.1, AC-4.4.4</acceptanceCriteria>
      </task>
      <task id="6" label="Integrate PhotoEditModal into PhotoCarousel">
        <subtask id="6.1">Add isEditModalOpen state to PhotoCarousel component</subtask>
        <subtask id="6.2">Conditionally render PhotoEditModal when isEditModalOpen is true</subtask>
        <subtask id="6.3">Pass currentPhoto data to PhotoEditModal as props</subtask>
        <subtask id="6.4">Implement closeEditModal handler (sets isEditModalOpen to false)</subtask>
        <subtask id="6.5">Pass updatePhoto action to PhotoEditModal</subtask>
        <subtask id="6.6">Test modal open/close flow</subtask>
        <acceptanceCriteria>AC-4.4.1, AC-4.4.2, AC-4.4.3</acceptanceCriteria>
      </task>
      <task id="7" label="Integrate PhotoDeleteConfirmation into PhotoCarousel">
        <subtask id="7.1">Add isDeleteConfirmOpen state to PhotoCarousel component</subtask>
        <subtask id="7.2">Conditionally render PhotoDeleteConfirmation when isDeleteConfirmOpen is true</subtask>
        <subtask id="7.3">Pass currentPhoto data to PhotoDeleteConfirmation as props</subtask>
        <subtask id="7.4">Implement closeDeleteConfirm handler (sets isDeleteConfirmOpen to false)</subtask>
        <subtask id="7.5">Pass deletePhoto action to PhotoDeleteConfirmation</subtask>
        <subtask id="7.6">Test delete flow with navigation after delete</subtask>
        <acceptanceCriteria>AC-4.4.4, AC-4.4.5, AC-4.4.7</acceptanceCriteria>
      </task>
      <task id="8" label="Create E2E Test Suite for Edit &amp; Delete">
        <subtask id="8.1">Create tests/e2e/photo-edit-delete.spec.ts</subtask>
        <subtask id="8.2">Test: Edit button opens modal with current photo data</subtask>
        <subtask id="8.3">Test: Edit caption and tags, save updates IndexedDB</subtask>
        <subtask id="8.4">Test: Cancel button closes modal without saving</subtask>
        <subtask id="8.5">Test: Delete button shows confirmation dialog</subtask>
        <subtask id="8.6">Test: Cancel delete closes dialog without action</subtask>
        <subtask id="8.7">Test: Confirm delete removes photo from IndexedDB and grid</subtask>
        <subtask id="8.8">Test: Carousel navigates to next photo after delete</subtask>
        <subtask id="8.9">Test: Carousel closes when last photo is deleted</subtask>
        <subtask id="8.10">Test: Form validation (caption length, tag limits)</subtask>
        <acceptanceCriteria>All</acceptanceCriteria>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.4.1" label="Edit Button Opens Edit Modal">
      <given>PhotoCarousel is open with a photo displayed</given>
      <when>user clicks Edit button (pencil icon) in top bar</when>
      <then>PhotoEditModal SHALL open with current photo context</then>
      <requirements>
        - PhotoCarouselControls Edit button becomes functional (remove disabled state)
        - onClick handler calls openEditModal(currentPhoto)
        - PhotoEditModal renders as modal overlay (z-index: 60, above carousel)
        - Semi-transparent backdrop prevents interaction with carousel
        - Current photo displayed as preview in modal
        - Close button (X) or backdrop click closes modal without saving
      </requirements>
    </criterion>
    <criterion id="AC-4.4.2" label="Edit Modal Shows Photo and Form Fields">
      <given>PhotoEditModal is open</given>
      <when>modal renders</when>
      <then>modal SHALL display photo preview, caption field, tags field, and save/cancel buttons</then>
      <requirements>
        - Photo preview: thumbnail or small preview (max 200px height)
        - Caption field: textarea, pre-populated with current caption (or empty)
        - Caption placeholder: "Add a caption..."
        - Caption character count: "X / 500 characters" below field
        - Tags field: text input, pre-populated with comma-separated tags (or empty)
        - Tags placeholder: "beach, sunset, memories"
        - Tags helper text: "Separate tags with commas (max 10 tags)"
        - Save button: primary action, enabled when validation passes
        - Cancel button: secondary action, discards changes
      </requirements>
    </criterion>
    <criterion id="AC-4.4.3" label="Save Updates IndexedDB and Refreshes Carousel">
      <given>PhotoEditModal is open with edited caption/tags</given>
      <when>user clicks Save button</when>
      <then>photo SHALL be updated in IndexedDB and carousel SHALL refresh</then>
      <requirements>
        - updatePhoto(photoId, { caption, tags }) action called
        - photoStorageService.update(photoId, updates) persists to IndexedDB
        - Zustand photos array updated (find photo by ID, replace with updated)
        - PhotoCarousel re-renders with new caption/tags
        - PhotoGallery grid updated (caption overlay shows new text)
        - Success toast: "Photo updated!" (optional)
        - Modal closes after successful save
      </requirements>
    </criterion>
    <criterion id="AC-4.4.4" label="Delete Button Shows Confirmation Dialog">
      <given>PhotoCarousel is open with a photo displayed</given>
      <when>user clicks Delete button (trash icon) in top bar</when>
      <then>PhotoDeleteConfirmation dialog SHALL open with warning message</then>
      <requirements>
        - PhotoCarouselControls Delete button becomes functional (remove disabled state)
        - onClick handler calls openDeleteConfirmation(currentPhoto)
        - PhotoDeleteConfirmation renders as dialog overlay (z-index: 70, above modal)
        - Dialog title: "Delete this photo?"
        - Dialog message: "This action cannot be undone."
        - Cancel button: secondary action, closes dialog without deleting
        - Delete button: destructive action (red color), confirms deletion
      </requirements>
    </criterion>
    <criterion id="AC-4.4.5" label="Confirmed Delete Removes Photo from IndexedDB">
      <given>PhotoDeleteConfirmation dialog is open</given>
      <when>user clicks Delete button (red)</when>
      <then>photo SHALL be removed from IndexedDB and Zustand state</then>
      <requirements>
        - deletePhoto(photoId) action called
        - photoStorageService.delete(photoId) removes from IndexedDB
        - Photo blob deleted (storage reclaimed)
        - Zustand photos array updated (filter out deleted photo by ID)
        - PhotoGallery grid re-renders (deleted photo removed from grid)
        - Success toast: "Photo deleted" (optional)
        - Confirmation dialog closes after successful delete
      </requirements>
    </criterion>
    <criterion id="AC-4.4.6" label="Deleted Photos No Longer Appear in Grid or Carousel">
      <given>photo has been deleted via confirmation dialog</given>
      <when>user views PhotoGallery or navigates carousel</when>
      <then>deleted photo SHALL NOT be visible anywhere</then>
      <requirements>
        - Deleted photo filtered out of photos array in Zustand
        - PhotoGallery grid does not render deleted photo
        - Carousel cannot navigate to deleted photo (ID no longer exists)
        - Photo count decreases by 1 (if count badge present)
        - No broken image placeholders or errors
      </requirements>
    </criterion>
    <criterion id="AC-4.4.7" label="Carousel Navigates After Delete">
      <given>photo deleted from carousel</given>
      <when>delete operation completes</when>
      <then>carousel SHALL navigate to next photo OR close if last photo</then>
      <requirements>
        - If not last photo: navigateToNext() called → carousel shows next photo
        - If last photo and not first: navigateToPrev() called → carousel shows previous photo
        - If only one photo (first and last): clearPhotoSelection() called → carousel closes, grid shown
        - Navigation animation: smooth transition (300ms spring, same as swipe)
        - Deleted photo never briefly visible during transition
      </requirements>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Story 4.4: Photo Edit &amp; Delete Functionality</section>
        <snippet>Edit button in carousel opens edit modal with current photo preview, editable caption/tags, save/cancel. Delete button shows confirmation dialog. Carousel navigates to next photo after delete or closes if last photo.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Data Models and Contracts - Photo Interface</section>
        <snippet>Photo interface with id, imageBlob, caption (optional, max 500 chars), tags array, uploadDate, originalSize, compressedSize, width, height, mimeType.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Services and Modules - Photo Storage Service</section>
        <snippet>photoStorageService provides IndexedDB CRUD for photos object store. Update and delete operations return Promises. Handles transaction rollback on failure.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>State Management - Zustand</section>
        <snippet>Centralized state management using Zustand with persistence middleware. Actions are async functions that update state and call service methods.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>IndexedDB Schema</section>
        <snippet>photos object store with auto-increment primary key, indexed by uploadDate. Stores Photo objects with blob data.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics Documentation</title>
        <section>Epic 4 - Photo Gallery &amp; Memories</section>
        <snippet>Photo gallery system with upload, storage, carousel viewing, and management. Offline-first, privacy-focused architecture.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/components/PhotoCarousel/PhotoCarouselControls.tsx</path>
        <kind>component</kind>
        <symbol>PhotoCarouselControls</symbol>
        <lines>38-60</lines>
        <reason>Edit and Delete buttons currently disabled (lines 39-60), need to be enabled and wired to onClick handlers for PhotoEditModal and PhotoDeleteConfirmation</reason>
      </artifact>
      <artifact>
        <path>src/components/PhotoCarousel/PhotoCarousel.tsx</path>
        <kind>component</kind>
        <symbol>PhotoCarousel</symbol>
        <lines>1-200</lines>
        <reason>Main carousel component where PhotoEditModal and PhotoDeleteConfirmation will be integrated with state management</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>photos state slice</symbol>
        <lines>47-50</lines>
        <reason>Photos state management (photos: Photo[], isLoadingPhotos, photoError, storageWarning). Need to add updatePhoto() and deletePhoto() actions</reason>
      </artifact>
      <artifact>
        <path>src/services/photoStorageService.ts</path>
        <kind>service</kind>
        <symbol>update, delete</symbol>
        <lines>213-240</lines>
        <reason>Existing update(photoId, updates) and delete(photoId) methods ready for use. Update method accepts Partial&lt;Photo&gt; for caption/tags updates</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>type</kind>
        <symbol>Photo</symbol>
        <lines>21-32</lines>
        <reason>Photo interface definition with caption (optional, max 500 chars) and tags (string array) fields that will be edited</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <react version="^19.1.1">UI framework for components</react>
        <react-dom version="^19.1.1">React rendering</react-dom>
        <zustand version="^5.0.8">State management for photos state and actions</zustand>
        <idb version="^8.0.3">IndexedDB wrapper for photo persistence</idb>
        <framer-motion version="^12.23.24">Animations for modal transitions</framer-motion>
        <lucide-react version="^0.548.0">Icons (Edit, Trash2, X)</lucide-react>
        <typescript version="~5.9.3">Type safety</typescript>
      </node>
      <dev>
        <playwright version="^1.56.1">E2E testing for edit/delete flows</playwright>
        <tailwindcss version="^3.4.18">Styling for modal overlays</tailwindcss>
        <vite version="^7.1.7">Build tool</vite>
      </dev>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="component-pattern">
      - Modal components must follow z-index hierarchy: carousel (50) &lt; edit modal (60) &lt; delete confirmation (70)
      - All modals require backdrop (bg-black/80) to prevent interaction with lower layers
      - Modal close behavior: backdrop click or X button closes modal
      - Use data-testid attributes for all interactive elements
    </constraint>
    <constraint type="state-management">
      - All photo operations must update Zustand photos state
      - Actions must be async functions with try/catch error handling
      - State updates must trigger re-renders in PhotoCarousel and PhotoGallery
      - Follow existing action pattern: uploadPhoto() from Story 4.1
    </constraint>
    <constraint type="form-validation">
      - Caption: optional, max 500 characters
      - Tags: optional, max 10 tags, max 50 chars per tag
      - Tags input: comma-separated string, parsed to string array
      - Real-time validation feedback (character count, tag limit warnings)
      - Save button disabled until validation passes
    </constraint>
    <constraint type="navigation-after-delete">
      - If not last photo: navigate to next photo (same index after filter)
      - If last photo and not first: navigate to previous photo
      - If only one photo: close carousel, return to grid
      - Navigation animation: smooth transition (300ms spring)
      - No flash of deleted photo during transition
    </constraint>
    <constraint type="accessibility">
      - Modal dialogs: role="dialog", aria-modal="true", aria-labelledby
      - Form labels: aria-label for caption textarea, tags input
      - Delete button: aria-label="Delete this photo permanently"
      - Cancel buttons: aria-label="Cancel without saving"
      - Keyboard: Escape closes modals, Tab cycles through form fields
    </constraint>
    <constraint type="offline-first">
      - All operations must work offline (IndexedDB only, no backend)
      - Error handling for IndexedDB transaction failures
      - No network dependency for edit/delete operations
    </constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>photoStorageService.update</name>
      <kind>service method</kind>
      <signature>async update(photoId: number, updates: Partial&lt;Photo&gt;): Promise&lt;void&gt;</signature>
      <path>src/services/photoStorageService.ts</path>
      <description>Updates photo in IndexedDB with partial updates (caption, tags). Throws error if photo not found.</description>
    </interface>
    <interface>
      <name>photoStorageService.delete</name>
      <kind>service method</kind>
      <signature>async delete(photoId: number): Promise&lt;void&gt;</signature>
      <path>src/services/photoStorageService.ts</path>
      <description>Deletes photo from IndexedDB by ID. Blob cleanup handled automatically. Throws error if photo not found.</description>
    </interface>
    <interface>
      <name>Photo</name>
      <kind>type interface</kind>
      <signature>interface Photo { id: number; imageBlob: Blob; caption?: string; tags: string[]; uploadDate: Date; originalSize: number; compressedSize: number; width: number; height: number; mimeType: string; }</signature>
      <path>src/types/index.ts</path>
      <description>Photo data model. Caption is optional (max 500 chars). Tags is array of strings (max 10 tags).</description>
    </interface>
    <interface>
      <name>useAppStore.photos</name>
      <kind>zustand state</kind>
      <signature>photos: Photo[]</signature>
      <path>src/stores/useAppStore.ts</path>
      <description>Array of all photos loaded from IndexedDB. Updated by uploadPhoto(), updatePhoto(), deletePhoto() actions.</description>
    </interface>
    <interface>
      <name>useAppStore.selectPhoto</name>
      <kind>zustand action</kind>
      <signature>selectPhoto: (id: number) =&gt; void</signature>
      <path>src/stores/useAppStore.ts</path>
      <description>Selects a photo for carousel view. Sets selectedPhotoId state.</description>
    </interface>
    <interface>
      <name>useAppStore.clearPhotoSelection</name>
      <kind>zustand action</kind>
      <signature>clearPhotoSelection: () =&gt; void</signature>
      <path>src/stores/useAppStore.ts</path>
      <description>Closes carousel by clearing selectedPhotoId. Returns to grid view.</description>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Epic 4 follows established Playwright E2E testing patterns from Epic 2. Tests validate full user journeys with real IndexedDB and blob storage (not mocked). Focus on critical paths: edit modal flow, delete confirmation flow, navigation after delete. All tests use data-testid attributes for element selection. Test execution: parallel with 4 workers, target &lt;10 minutes for full suite.
    </standards>
    <locations>
      - tests/e2e/ - E2E test suites
      - tests/e2e/photo-edit-delete.spec.ts - New test suite for Story 4.4
      - tests/fixtures/photos.ts - Test photo fixtures
      - tests/support/helpers/photoHelpers.ts - Test helper functions
    </locations>
    <ideas>
      <idea criterion="AC-4.4.1">
        Test: Click Edit button in carousel → verify PhotoEditModal opens with current photo preview and data-testid="photo-edit-modal"
      </idea>
      <idea criterion="AC-4.4.2">
        Test: Edit modal displays photo thumbnail, caption field pre-populated, tags field pre-populated, character counter, save/cancel buttons
      </idea>
      <idea criterion="AC-4.4.3">
        Test: Edit caption "Sunset" → "Beach Sunset", save → verify IndexedDB updated, carousel refreshes with new caption, modal closes
      </idea>
      <idea criterion="AC-4.4.3">
        Test: Add tags "beach, sunset" → "beach, sunset, memories", save → verify tags array updated in IndexedDB
      </idea>
      <idea criterion="AC-4.4.3">
        Test: Caption validation - enter 501 characters → save button disabled, show error message
      </idea>
      <idea criterion="AC-4.4.3">
        Test: Tags validation - enter 11 tags → save button disabled, show "Max 10 tags" error
      </idea>
      <idea criterion="AC-4.4.4">
        Test: Click Delete button in carousel → verify PhotoDeleteConfirmation dialog opens with data-testid="photo-delete-confirmation"
      </idea>
      <idea criterion="AC-4.4.5">
        Test: Confirmation dialog shows "Delete this photo? This action cannot be undone." → click Cancel → dialog closes, no deletion
      </idea>
      <idea criterion="AC-4.4.5">
        Test: Click Delete (red button) in confirmation → verify photo removed from IndexedDB, dialog closes
      </idea>
      <idea criterion="AC-4.4.6">
        Test: Delete photo ID 5 → verify PhotoGallery grid no longer shows photo, count decreases by 1
      </idea>
      <idea criterion="AC-4.4.7">
        Test: Delete middle photo (index 5 of 10) → verify carousel navigates to next photo (new index 5)
      </idea>
      <idea criterion="AC-4.4.7">
        Test: Delete last photo (index 9 of 10) → verify carousel navigates to previous photo (index 8)
      </idea>
      <idea criterion="AC-4.4.7">
        Test: Delete only photo → verify carousel closes, grid shows empty state or no photos message
      </idea>
    </ideas>
  </tests>
</story-context>

<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>1</storyId>
    <title>Split useAppStore into Feature Slices</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-1-split-useappstore-into-feature-slices.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to split the monolithic useAppStore.ts (1,267 lines) into feature-specific slices</iWant>
    <soThat>the state management is more maintainable and easier to reason about</soThat>
    <tasks>
      - Task 1: Analyze Current Store Structure (AC: 1)
        - Subtask 1.1: Review useAppStore.ts and identify state/actions by feature domain
        - Subtask 1.2: Document current state structure and dependencies between features
        - Subtask 1.3: Identify shared state that should remain in core (theme, initialization flags)
        - Subtask 1.4: Map persistence requirements for each slice (LocalStorage partializer)
        - Subtask 1.5: Identify cross-slice dependencies (e.g., messages depends on settings for rotation)

      - Task 2: Create Slice Files (AC: 1, 2)
        - Subtask 2.1: Create src/stores/slices/messagesSlice.ts with messages state and actions
        - Subtask 2.2: Create src/stores/slices/photosSlice.ts with photos state and actions
        - Subtask 2.3: Create src/stores/slices/settingsSlice.ts with settings state and actions
        - Subtask 2.4: Create src/stores/slices/navigationSlice.ts with navigation state and actions
        - Subtask 2.5: Create src/stores/slices/moodSlice.ts with mood state and actions
        - Subtask 2.6: Ensure each slice exports StateCreator type for composition

      - Task 3-7: Extract individual slices (Messages, Photos, Settings, Navigation, Mood)
      - Task 8: Update Main Store with Slice Composition (AC: 3)
      - Task 9: Update Component Imports (AC: 4)
      - Task 10: Update Persist Configuration (AC: 3, 5)
      - Task 11: Run E2E Test Suite (AC: 5)
      - Task 12: Document Slice Architecture (AC: 6)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. 5 slice files created: useMessagesStore.ts, usePhotosStore.ts, useSettingsStore.ts, useNavigationStore.ts, useMoodStore.ts
    2. Clear boundaries: Each slice has clear feature boundaries (messages, photos, settings, navigation, mood)
    3. Main store composition: Main store composes slices using spread operator
    4. Zero breaking changes: Component imports updated, existing API compatibility maintained
    5. All E2E tests pass: All existing Epic 2 E2E tests pass without modification
    6. Documentation updated: Slice architecture documented in technical-decisions.md
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>State Management - Zustand Store Architecture</section>
        <snippet>Single Store pattern with useAppStore (no store splitting). Persistence via LocalStorage with partialize middleware. Critical state persisted: settings, isOnboarded, messageHistory, moods. Non-persisted: messages, photos, currentMessage (derived/loaded from IndexedDB).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Data Architecture - LocalStorage Schema</section>
        <snippet>Storage Key: my-love-storage. Persisted State: settings, isOnboarded, messageHistory, moods. Partialize strategy ensures only necessary state is persisted. State validation via validateHydratedState() helper.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 5: Code Quality & Performance Improvements</title>
        <section>Story 5.1: Split useAppStore into Feature Slices</section>
        <snippet>Split monolithic 1,268-line store into feature slices. Use Zustand's slice pattern or composition. Maintain API compatibility. Each slice independently testable. Prerequisites: Epic 1 and Epic 2 complete (stable foundation with tests).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-1-split-useappstore-into-feature-slices.md</path>
        <title>Story 5.1 Details</title>
        <section>Slice Composition Pattern</section>
        <snippet>Zustand supports manual composition with spread operator. Pattern: create(persist((set, get) => ({ ...messagesSlice(set, get), ...photosSlice(set, get), ... }), persistConfig)). Each slice exports StateCreator type. Slices access full AppState via get() for cross-slice dependencies.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-1-split-useappstore-into-feature-slices.md</path>
        <title>Story 5.1 Details</title>
        <section>Store Refactoring Strategy</section>
        <snippet>Current Structure (1,267 lines): Messages (~400 lines), Photos (~350 lines), Settings (~200 lines), Navigation (~50 lines), Mood (~50 lines), Shared/Core (~200 lines). Each slice self-contained with service imports. No circular dependencies.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-1-split-useappstore-into-feature-slices.md</path>
        <title>Story 5.1 Details</title>
        <section>Cross-Slice Dependencies</section>
        <snippet>Messages depends on Settings (rotation uses settings.relationship.startDate). Photos depends on Settings (theme, storage preferences). All slices depend on Initialization (initializeApp coordinates). Slices access other state via get() pattern.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-1-split-useappstore-into-feature-slices.md</path>
        <title>Story 5.1 Details</title>
        <section>Persistence Strategy per Slice</section>
        <snippet>Persisted: Settings (settings, isOnboarded), Messages (messageHistory, customMessages), Mood (moods). Not Persisted: Messages (messages, currentMessage - derived), Photos (all photo state - loaded from IndexedDB), Navigation (currentView - restored from URL).</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>AppState</symbol>
        <lines>1-1267</lines>
        <reason>Monolithic store to be split. Contains all state/actions for messages, photos, settings, navigation, mood. Current size: 1,267 lines requiring refactoring into feature slices.</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>useAppStore</symbol>
        <lines>166-1267</lines>
        <reason>Main Zustand store with persist middleware. Contains composition pattern to replicate: create(persist((set, get) => ({ ...state, ...actions }), { partialize, onRehydrateStorage })).</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>validation</kind>
        <symbol>validateHydratedState</symbol>
        <lines>130-164</lines>
        <reason>State validation helper for persist hydration. Must remain in main store to validate composed slice state. Critical for Map deserialization (messageHistory.shownMessages).</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>guards</kind>
        <symbol>isInitializing, isInitialized, isHydrated</symbol>
        <lines>124-127</lines>
        <reason>Initialization guards preventing concurrent/duplicate initialization. Must remain global in main store for StrictMode protection across all slices.</reason>
      </artifact>
      <artifact>
        <path>src/services/storage.ts</path>
        <kind>service</kind>
        <symbol>StorageService</symbol>
        <lines>1-50</lines>
        <reason>IndexedDB service for messages. Will be imported by messagesSlice for loadMessages, addMessage, toggleFavorite operations.</reason>
      </artifact>
      <artifact>
        <path>src/services/customMessageService.ts</path>
        <kind>service</kind>
        <symbol>CustomMessageService</symbol>
        <lines>1-50</lines>
        <reason>Custom message CRUD service. Will be imported by messagesSlice for custom message management (create, update, delete, import/export).</reason>
      </artifact>
      <artifact>
        <path>src/services/photoStorageService.ts</path>
        <kind>service</kind>
        <symbol>PhotoStorageService</symbol>
        <lines>1-50</lines>
        <reason>IndexedDB service for photos. Will be imported by photosSlice for loadPhotos, uploadPhoto, updatePhoto, deletePhoto operations.</reason>
      </artifact>
      <artifact>
        <path>src/services/imageCompressionService.ts</path>
        <kind>service</kind>
        <symbol>ImageCompressionService</symbol>
        <lines>1-50</lines>
        <reason>Photo compression service. Will be imported by photosSlice for uploadPhoto compression workflow.</reason>
      </artifact>
      <artifact>
        <path>src/utils/messageRotation.ts</path>
        <kind>utility</kind>
        <symbol>getDailyMessage, formatDate, getAvailableHistoryDays</symbol>
        <lines>N/A</lines>
        <reason>Message rotation algorithm utilities. Will be imported by messagesSlice for date-based message selection and navigation.</reason>
      </artifact>
      <artifact>
        <path>src/config/constants.ts</path>
        <kind>config</kind>
        <symbol>APP_CONFIG</symbol>
        <lines>N/A</lines>
        <reason>Pre-configuration constants. Will be imported by settingsSlice for default settings initialization.</reason>
      </artifact>
      <artifact>
        <path>src/data/defaultMessages.ts</path>
        <kind>data</kind>
        <symbol>defaultMessages</symbol>
        <lines>N/A</lines>
        <reason>Default message collection. Will be imported by messagesSlice for initial message population.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <runtime>
          <package>zustand</package>
          <version>^5.0.8</version>
          <purpose>State management with persist middleware and StateCreator type for slice composition</purpose>
        </runtime>
        <runtime>
          <package>idb</package>
          <version>^8.0.3</version>
          <purpose>IndexedDB wrapper used by storage services</purpose>
        </runtime>
        <runtime>
          <package>react</package>
          <version>^19.1.1</version>
          <purpose>React hooks and component integration with Zustand store</purpose>
        </runtime>
        <devDependencies>
          <package>typescript</package>
          <version>~5.9.3</version>
          <purpose>Type safety for StateCreator generics and AppState interface</purpose>
        </devDependencies>
        <devDependencies>
          <package>@playwright/test</package>
          <version>^1.56.1</version>
          <purpose>E2E testing to validate no breaking changes after refactoring</purpose>
        </devDependencies>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Maintain exact same export structure from useAppStore - components should not need to change imports</constraint>
    <constraint>Zero breaking changes to component API - selectors remain unchanged: useAppStore(state => state.messages)</constraint>
    <constraint>Preserve initialization guards (isInitializing, isInitialized, isHydrated) for StrictMode compatibility</constraint>
    <constraint>Keep validateHydratedState helper in main store to validate composed slice state</constraint>
    <constraint>Persist middleware configuration must handle all slice state correctly via partialize</constraint>
    <constraint>Map deserialization for messageHistory.shownMessages must work after composition</constraint>
    <constraint>Each slice must be self-contained with its own service/utility imports - no circular dependencies</constraint>
    <constraint>Cross-slice dependencies accessed via get() pattern only - slices don't import other slices</constraint>
    <constraint>Zustand StateCreator pattern: StateCreator&lt;AppState, [], [], SliceType&gt;</constraint>
    <constraint>Main store remains single store - no store splitting, just internal composition</constraint>
    <constraint>All Epic 1-4 E2E tests must pass without modification after refactoring</constraint>
    <constraint>Component re-render optimization via selectors should be maintained or improved</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>StateCreator (Zustand)</name>
      <kind>TypeScript Generic Type</kind>
      <signature>type StateCreator&lt;State, Mutators, Middlewares, SliceState&gt; = (set: SetState&lt;State&gt;, get: GetState&lt;State&gt;, api: StoreApi&lt;State&gt;) => SliceState</signature>
      <path>node_modules/zustand/vanilla.d.ts</path>
      <usage>Each slice exports a StateCreator factory function for composition in main store</usage>
    </interface>
    <interface>
      <name>AppState</name>
      <kind>TypeScript Interface</kind>
      <signature>interface AppState { settings, messages, photos, navigation, mood state + actions }</signature>
      <path>src/stores/useAppStore.ts</path>
      <usage>Full app state type - each slice contributes partial implementation via StateCreator&lt;AppState, [], [], SliceType&gt;</usage>
    </interface>
    <interface>
      <name>MessagesSlice</name>
      <kind>TypeScript Interface (to be created)</kind>
      <signature>interface MessagesSlice { messages, messageHistory, currentMessage, customMessages state + message actions }</signature>
      <path>src/stores/slices/messagesSlice.ts</path>
      <usage>Defines state and actions for messages feature - subset of AppState</usage>
    </interface>
    <interface>
      <name>PhotosSlice</name>
      <kind>TypeScript Interface (to be created)</kind>
      <signature>interface PhotosSlice { photos, isLoadingPhotos, photoError, storageWarning, selectedPhotoId state + photo actions }</signature>
      <path>src/stores/slices/photosSlice.ts</path>
      <usage>Defines state and actions for photos feature - subset of AppState</usage>
    </interface>
    <interface>
      <name>SettingsSlice</name>
      <kind>TypeScript Interface (to be created)</kind>
      <signature>interface SettingsSlice { settings, isOnboarded state + settings actions }</signature>
      <path>src/stores/slices/settingsSlice.ts</path>
      <usage>Defines state and actions for settings feature - subset of AppState</usage>
    </interface>
    <interface>
      <name>NavigationSlice</name>
      <kind>TypeScript Interface (to be created)</kind>
      <signature>interface NavigationSlice { currentView state + navigation actions }</signature>
      <path>src/stores/slices/navigationSlice.ts</path>
      <usage>Defines state and actions for view navigation - subset of AppState</usage>
    </interface>
    <interface>
      <name>MoodSlice</name>
      <kind>TypeScript Interface (to be created)</kind>
      <signature>interface MoodSlice { moods state + mood actions }</signature>
      <path>src/stores/slices/moodSlice.ts</path>
      <usage>Defines state and actions for mood tracking - subset of AppState</usage>
    </interface>
    <interface>
      <name>persist middleware</name>
      <kind>Zustand Middleware</kind>
      <signature>persist(stateCreator, { name, storage, partialize, onRehydrateStorage })</signature>
      <path>node_modules/zustand/middleware.d.ts</path>
      <usage>Wraps composed store to persist selected state to LocalStorage with validation on hydration</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      E2E Testing with Playwright: All existing Epic 1-4 E2E tests must pass without modification. Tests validate: message display, favorites, settings persistence, message navigation, custom messages, photo upload/edit/delete, photo gallery/carousel, view navigation. Test framework: @playwright/test v1.56.1. Test location: tests/e2e/. No unit tests currently exist - Story 5.4 will add Vitest for unit testing utilities and slices.
    </standards>

    <locations>
      - tests/e2e/message-display.spec.ts - Epic 2 message rendering
      - tests/e2e/favorites.spec.ts - Epic 2 favorite toggling
      - tests/e2e/persistence.spec.ts - Epic 2 LocalStorage persistence
      - tests/e2e/settings.spec.ts - Epic 1 settings management
      - tests/e2e/message-history.spec.ts - Epic 3 message history
      - tests/e2e/swipe-navigation.spec.ts - Epic 3 message navigation
      - tests/e2e/admin-panel.spec.ts - Epic 3 custom messages
      - tests/e2e/custom-message-persistence.spec.ts - Epic 3 custom message CRUD
      - tests/e2e/photo-upload.spec.ts - Epic 4 photo upload
      - tests/e2e/photo-edit-delete.spec.ts - Epic 4 photo editing
      - tests/e2e/photo-gallery.spec.ts - Epic 4 gallery view
      - tests/e2e/photo-carousel.spec.ts - Epic 4 carousel navigation
      - tests/e2e/navigation.spec.ts - Epic 4 view navigation
    </locations>

    <ideas>
      - AC-1: Test that all 5 slice files exist and export StateCreator functions (messagesSlice, photosSlice, settingsSlice, navigationSlice, moodSlice)
      - AC-2: Test that each slice has clear feature boundaries by inspecting exported state/action names (no cross-contamination)
      - AC-3: Test that main store composition works by verifying useAppStore exports all expected state/actions after slice composition
      - AC-4: Test zero breaking changes by running ALL existing E2E tests without modification - all should pass
      - AC-5: Specifically run Epic 2, 3, 4 E2E suites (npm run test:e2e) and verify 100% pass rate
      - AC-6: Test that technical-decisions.md contains new section on slice architecture with composition pattern documented
      - Cross-slice dependency test: Verify message rotation still works (depends on settings.relationship.startDate)
      - Persist hydration test: Verify state reloads correctly after browser refresh (Map deserialization for messageHistory)
      - Performance test: Use React DevTools Profiler to verify component re-renders reduced by 30% (better selector optimization)
      - Memory leak test: Verify no Zustand store memory leaks with Zustand DevTools after refactoring
    </ideas>
  </tests>
</story-context>

<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>7</storyId>
    <title>User Authentication &amp; Login Screen</title>
    <status>drafted</status>
    <generatedAt>2025-11-15T00:00:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-7-user-authentication-login.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to log in with my credentials</iWant>
    <soThat>my mood logs and interactions are secure and synced to my account</soThat>
    <tasks>
      <task id="1" ac="#1, #2">
        <label>Create LoginScreen component</label>
        <subtasks>
          <subtask>Email input field with validation (email format)</subtask>
          <subtask>Password input field with show/hide toggle</subtask>
          <subtask>Sign In button with loading state</subtask>
          <subtask>Error message display area</subtask>
          <subtask>Form submission handler</subtask>
        </subtasks>
      </task>
      <task id="2" ac="#3, #4, #5">
        <label>Implement Supabase Auth integration</label>
        <subtasks>
          <subtask>Create authService.ts with signIn, signOut, getSession methods</subtask>
          <subtask>Integrate Supabase Auth client from supabaseClient.ts</subtask>
          <subtask>Handle successful login flow (store session, redirect to home)</subtask>
          <subtask>Handle failed login errors (invalid credentials, network failures)</subtask>
          <subtask>Add error messaging for common auth errors</subtask>
        </subtasks>
      </task>
      <task id="3" ac="#6">
        <label>Implement auth session persistence</label>
        <subtasks>
          <subtask>Configure Supabase Auth to persist session in localStorage</subtask>
          <subtask>Check for existing session on app initialization</subtask>
          <subtask>Restore user state from session on page reload</subtask>
          <subtask>Handle session expiration gracefully</subtask>
        </subtasks>
      </task>
      <task id="4" ac="#7">
        <label>Add logout functionality</label>
        <subtasks>
          <subtask>Add "Sign Out" button in Settings component</subtask>
          <subtask>Implement signOut handler that clears session</subtask>
          <subtask>Redirect to login screen after logout</subtask>
          <subtask>Clear user state from app store</subtask>
        </subtasks>
      </task>
      <task id="5" ac="#8, #9, #10">
        <label>Update authentication flow</label>
        <subtasks>
          <subtask>Replace hardcoded VITE_USER_ID with session.user.id</subtask>
          <subtask>Update all API calls to use authenticated user ID</subtask>
          <subtask>Verify RLS policies enforce user-specific data access</subtask>
          <subtask>Test with test user accounts (testuser1@example.com, testuser2@example.com)</subtask>
        </subtasks>
      </task>
      <task id="6" ac="#1">
        <label>Add authentication guards</label>
        <subtasks>
          <subtask>Create ProtectedRoute wrapper component</subtask>
          <subtask>Check auth state on app initialization</subtask>
          <subtask>Show LoginScreen if not authenticated</subtask>
          <subtask>Show main app if authenticated</subtask>
        </subtasks>
      </task>
      <task id="7" ac="#8">
        <label>E2E testing integration</label>
        <subtasks>
          <subtask>Update E2E test setup to authenticate test users</subtask>
          <subtask>Add login helper function in test utilities</subtask>
          <subtask>Ensure tests start with authenticated session</subtask>
          <subtask>Verify logout functionality in tests</subtask>
        </subtasks>
      </task>
      <task id="8">
        <label>Update documentation</label>
        <subtasks>
          <subtask>Document authentication flow in technical-decisions.md</subtask>
          <subtask>Update .env.example with auth configuration</subtask>
          <subtask>Add authentication setup instructions to README.md</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">Login screen displays on app load if user is not authenticated</criterion>
    <criterion id="AC-2">Login form includes email and password fields with validation</criterion>
    <criterion id="AC-3">"Sign In" button authenticates user via Supabase Auth</criterion>
    <criterion id="AC-4">Successful login stores auth session and navigates to home screen</criterion>
    <criterion id="AC-5">Failed login shows error message (invalid credentials, network error)</criterion>
    <criterion id="AC-6">Auth session persists across page reloads (localStorage/session storage)</criterion>
    <criterion id="AC-7">Logout functionality available in Settings tab</criterion>
    <criterion id="AC-8">Test user accounts work with E2E tests (testuser1@example.com, testuser2@example.com)</criterion>
    <criterion id="AC-9">Row Level Security policies enforce user can only access their own data</criterion>
    <criterion id="AC-10">Replace hardcoded VITE_USER_ID with authenticated user ID from Supabase session</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>User Journeys - Daily Message Experience</section>
        <snippet>Opens My Love PWA from home screen, App loads instantly with cached offline support (NFR002). All features work except mood sync and poke/kiss features when offline.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>PWA Architecture - Service Worker Strategy</section>
        <snippet>PWA with offline-first capabilities through IndexedDB and service workers. Authentication via JWT with Row Level Security. HTTPS required for PWA features.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 6: Interactive Connection Features - Story 6.7</section>
        <snippet>User authentication and login screen to secure mood logs and interactions. Replaces hardcoded VITE_USER_ID with Supabase Auth session. RLS policies enforce user-specific access.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Data Models and Contracts - Supabase Authentication</section>
        <snippet>JWT-based authentication with Row Level Security policies. Tables: users, moods, interactions with RLS enforcement at database level. Supabase Auth SDK handles JWT token storage in localStorage.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Security - Authentication &amp; Authorization</section>
        <snippet>Supabase authentication: JWT-based with Row Level Security policies. VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY for client-side. RLS enforced by PostgreSQL policies. Token storage automatic via Supabase SDK in LocalStorage.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Open Questions - Q1: Supabase Auth Integration</section>
        <snippet>Decision: Keep hardcoded UUIDs for MVP simplicity initially. Story 6.7 implements proper Supabase Auth with email/password login for test users testuser1@example.com and testuser2@example.com (password: TestPassword123!).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/api/supabaseClient.ts</path>
        <kind>service</kind>
        <symbol>supabase (client singleton), initializeAuth, getCurrentUserId, getPartnerId</symbol>
        <lines>1-230</lines>
        <reason>Existing Supabase client setup with anonymous auth. Story 6.7 extends this to use email/password authentication via Supabase Auth SDK.</reason>
      </artifact>
      <artifact>
        <path>src/api/supabaseClient.ts</path>
        <kind>service</kind>
        <symbol>getCurrentUserId, getPartnerId</symbol>
        <lines>195-220</lines>
        <reason>Functions to retrieve authenticated user ID from Supabase session. Story 6.7 replaces VITE_USER_ID hardcoded values with these session-based IDs.</reason>
      </artifact>
      <artifact>
        <path>src/api/moodSyncService.ts</path>
        <kind>service</kind>
        <symbol>MoodSyncService</symbol>
        <lines>1-300</lines>
        <reason>Uses getCurrentUserId() for RLS-compliant mood sync. Must be updated to use auth session user ID instead of VITE_USER_ID.</reason>
      </artifact>
      <artifact>
        <path>src/api/interactionService.ts</path>
        <kind>service</kind>
        <symbol>InteractionService</symbol>
        <lines>1-200</lines>
        <reason>Sends poke/kiss interactions using user IDs. Must update to use authenticated session IDs for RLS policy enforcement.</reason>
      </artifact>
      <artifact>
        <path>src/components/Settings/AnniversarySettings.tsx</path>
        <kind>component</kind>
        <symbol>AnniversarySettings</symbol>
        <lines>1-488</lines>
        <reason>Existing Settings component structure. Story 6.7 adds "Sign Out" button here for logout functionality (AC-7).</reason>
      </artifact>
      <artifact>
        <path>src/App.tsx</path>
        <kind>component</kind>
        <symbol>App</symbol>
        <lines>1-100</lines>
        <reason>Main app component. Story 6.7 adds auth guard logic here to conditionally render LoginScreen vs main app based on auth state.</reason>
      </artifact>
      <artifact>
        <path>tests/e2e/mood-tracker.spec.ts</path>
        <kind>test</kind>
        <symbol>Mood Tracker test suite</symbol>
        <lines>1-50</lines>
        <reason>Existing E2E test pattern using data-testid selectors. Story 6.7 E2E tests follow this pattern for login/logout flows.</reason>
      </artifact>
    </code>
    <dependencies>
      <package ecosystem="npm">
        <name>@supabase/supabase-js</name>
        <version>^2.81.1</version>
        <purpose>Supabase JavaScript Client SDK for authentication, database operations, and Realtime</purpose>
      </package>
      <package ecosystem="npm">
        <name>react</name>
        <version>^19.1.1</version>
        <purpose>UI framework for LoginScreen component and authentication guards</purpose>
      </package>
      <package ecosystem="npm">
        <name>zustand</name>
        <version>^5.0.8</version>
        <purpose>State management for auth session state (user, isAuthenticated)</purpose>
      </package>
      <package ecosystem="npm">
        <name>zod</name>
        <version>^3.25.76</version>
        <purpose>Schema validation for login form (email format, password requirements)</purpose>
      </package>
      <package ecosystem="npm">
        <name>lucide-react</name>
        <version>^0.548.0</version>
        <purpose>Icons for login form (Eye/EyeOff for password toggle, LogOut for sign out button)</purpose>
      </package>
      <package ecosystem="npm">
        <name>framer-motion</name>
        <version>^12.23.24</version>
        <purpose>Animations for LoginScreen transitions and error message feedback</purpose>
      </package>
      <package ecosystem="npm">
        <name>@playwright/test</name>
        <version>^1.56.1</version>
        <purpose>E2E testing framework for authentication flow testing (login, logout, session persistence)</purpose>
      </package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Component-based React architecture with TypeScript strict mode</constraint>
    <constraint type="pattern">Zustand for state management with persist middleware for auth session</constraint>
    <constraint type="pattern">Supabase Auth SDK for authentication (email/password) with JWT tokens</constraint>
    <constraint type="pattern">Row Level Security (RLS) policies enforce database-level access control</constraint>
    <constraint type="security">Auth session persists in localStorage via Supabase SDK (automatic)</constraint>
    <constraint type="security">HTTPS required for Supabase Auth (enforced by GitHub Pages deployment)</constraint>
    <constraint type="testing">E2E tests must authenticate test users (testuser1@example.com, testuser2@example.com)</constraint>
    <constraint type="testing">All tests use data-testid selectors following existing pattern</constraint>
    <constraint type="implementation">Replace hardcoded VITE_USER_ID with session.user.id throughout codebase</constraint>
    <constraint type="implementation">Graceful error handling for network failures, invalid credentials, session expiration</constraint>
    <constraint type="implementation">Mobile-first responsive design for LoginScreen (320px-428px viewports)</constraint>
    <constraint type="implementation">Offline-first: Show helpful error if attempting login while offline</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Supabase Auth API - signInWithPassword</name>
      <kind>REST</kind>
      <signature>supabase.auth.signInWithPassword({ email: string, password: string }): Promise&lt;AuthResponse&gt;</signature>
      <path>@supabase/supabase-js SDK method</path>
      <description>Authenticates user with email and password. Returns auth session with JWT token and user object.</description>
    </interface>
    <interface>
      <name>Supabase Auth API - signOut</name>
      <kind>REST</kind>
      <signature>supabase.auth.signOut(): Promise&lt;{ error: AuthError | null }&gt;</signature>
      <path>@supabase/supabase-js SDK method</path>
      <description>Logs out user and clears session from localStorage. RLS policies automatically deny access after signOut.</description>
    </interface>
    <interface>
      <name>Supabase Auth API - getSession</name>
      <kind>REST</kind>
      <signature>supabase.auth.getSession(): Promise&lt;{ data: { session: Session | null }, error: AuthError | null }&gt;</signature>
      <path>@supabase/supabase-js SDK method</path>
      <description>Retrieves current auth session from localStorage. Used on app init to check if user is authenticated.</description>
    </interface>
    <interface>
      <name>Supabase Auth API - onAuthStateChange</name>
      <kind>Event Listener</kind>
      <signature>supabase.auth.onAuthStateChange((event: AuthChangeEvent, session: Session | null) =&gt; void): { data: { subscription: Subscription } }</signature>
      <path>@supabase/supabase-js SDK method</path>
      <description>Listens for auth state changes (SIGNED_IN, SIGNED_OUT, TOKEN_REFRESHED). Used to update app state when auth status changes.</description>
    </interface>
    <interface>
      <name>getCurrentUserId</name>
      <kind>Function</kind>
      <signature>getCurrentUserId(): Promise&lt;string&gt;</signature>
      <path>src/api/supabaseClient.ts:195-208</path>
      <description>Returns authenticated user ID from Supabase Auth session. Replaces VITE_USER_ID hardcoded value.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <paragraph>
        Testing framework: Playwright for E2E tests (v1.56.1), Vitest for unit/integration tests (v4.0.9).
        Pattern: All interactive elements use data-testid attributes following convention: [component]-[element]-[action] (e.g., "login-email-input", "login-submit-button").
        Auth testing: E2E tests authenticate with test users (testuser1@example.com / testuser2@example.com, password: TestPassword123!).
        Session testing: Verify auth session persists across page reloads by checking localStorage and re-authenticating.
        RLS testing: Verify users can only access their own data by attempting cross-user queries (should fail with RLS policy error).
        Error scenarios: Test invalid credentials, network failures, session expiration, offline login attempts.
        Coverage: 80% target for auth services, 70% for LoginScreen component, 100% E2E coverage of critical auth flows.
      </paragraph>
    </standards>
    <locations>
      <location>tests/e2e/</location>
      <location>tests/integration/</location>
      <location>tests/unit/components/</location>
      <location>tests/unit/api/</location>
    </locations>
    <ideas>
      <idea ac="AC-1, AC-2, AC-3, AC-4">
        E2E test: Login flow - Navigate to login screen, enter valid credentials, submit form, verify redirect to home screen and auth session stored.
      </idea>
      <idea ac="AC-5">
        E2E test: Invalid credentials - Enter incorrect email/password, submit, verify error message displays ("Invalid credentials").
      </idea>
      <idea ac="AC-6">
        E2E test: Session persistence - Login, reload page, verify user remains authenticated without login screen.
      </idea>
      <idea ac="AC-7">
        E2E test: Logout flow - Login, navigate to Settings, click "Sign Out", verify redirect to login screen and session cleared.
      </idea>
      <idea ac="AC-8">
        E2E test: Test user accounts - Login with testuser1@example.com and testuser2@example.com, verify both authenticate successfully.
      </idea>
      <idea ac="AC-9">
        Integration test: RLS policies - Authenticate as testuser1, attempt to query testuser2's moods, verify RLS denies access.
      </idea>
      <idea ac="AC-10">
        Unit test: authService - Mock Supabase signInWithPassword, verify getCurrentUserId returns session.user.id (not VITE_USER_ID).
      </idea>
      <idea ac="AC-5">
        E2E test: Network error - Disconnect network, attempt login, verify error message "Network error. Check your connection."
      </idea>
      <idea ac="AC-6">
        Unit test: Session expiration - Mock expired session, verify app redirects to login screen and shows "Session expired" message.
      </idea>
      <idea ac="AC-2">
        Unit test: Login form validation - Test email format validation (invalid emails rejected), password required validation.
      </idea>
    </ideas>
  </tests>
</story-context>

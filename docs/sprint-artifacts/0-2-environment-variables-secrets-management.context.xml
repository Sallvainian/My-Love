<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>2</storyId>
    <title>Environment Variables & Secrets Management</title>
    <status>drafted</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-2-environment-variables-secrets-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to properly configure environment variables and GitHub secrets</iWant>
    <soThat>production build has correct Supabase connection details without exposing secrets</soThat>
    <tasks>
      <task id="1">Create .env.example file with documented env vars</task>
      <task id="2">Update .gitignore to exclude .env files</task>
      <task id="3">Configure GitHub Secrets (VITE_SUPABASE_URL, VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY)</task>
      <task id="4">Create/update src/lib/supabase.ts with validateEnv() function</task>
      <task id="5">Update .github/workflows/deploy.yml to inject secrets during build</task>
      <task id="6">Add environment variable types to vite-env.d.ts</task>
      <task id="7">Update README.md with environment setup instructions</task>
      <task id="8">Write unit tests for environment validation</task>
      <task id="9">Write integration tests for config files</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-0.2.1">
      <title>.env.example Documentation</title>
      <description>File exists at project root and documents all required VITE_ environment variables (VITE_SUPABASE_URL, VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY) with descriptions and example values</description>
      <validation>cat .env.example | grep -E "VITE_SUPABASE_URL|VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY"</validation>
    </criterion>
    <criterion id="AC-0.2.2">
      <title>Git Ignore Configuration</title>
      <description>.env and .env.local entries exist in .gitignore; attempting to commit .env file results in git ignoring it</description>
      <validation>grep -E "^\.env$|^\.env\.local$" .gitignore</validation>
    </criterion>
    <criterion id="AC-0.2.3">
      <title>GitHub Secrets Configuration</title>
      <description>Repository secrets contain VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY; secrets are accessible to GitHub Actions workflows and masked in logs</description>
      <validation>Manual: Navigate to Settings → Secrets and variables → Actions in GitHub repository</validation>
    </criterion>
    <criterion id="AC-0.2.4">
      <title>Build-Time Environment Validation</title>
      <description>Build fails immediately with clear error message when required environment variables are missing; error message specifies which variables are missing</description>
      <validation>unset VITE_SUPABASE_URL; npm run build 2>&1 | grep -q "Missing required env vars"</validation>
    </criterion>
    <criterion id="AC-0.2.5">
      <title>Runtime Environment Validation</title>
      <description>Application validates required VITE_ environment variables are present at startup; missing variables trigger clear error message; application does not proceed to render UI if validation fails</description>
      <validation>console.log(import.meta.env.VITE_SUPABASE_URL); // Should log URL, not undefined</validation>
    </criterion>
    <criterion id="AC-0.2.6">
      <title>Secrets Not Exposed in Client Bundle</title>
      <description>Secrets are injected at build time only; no plaintext secrets or environment variable references (import.meta.env) visible in bundled files; actual URLs present in bundle</description>
      <validation>npm run build; grep -r "VITE_SUPABASE" dist/ # Should NOT find variable names</validation>
    </criterion>
    <criterion id="AC-0.2.7">
      <title>Environment Separation</title>
      <description>Local development uses .env/.env.local file; production uses GitHub Secrets injected during CI/CD build; clear separation and documentation for both contexts</description>
      <validation>grep -A 2 "env:" .github/workflows/deploy.yml | grep VITE_SUPABASE</validation>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Environment Variables Schema</section>
        <snippet>Defines EnvironmentConfig interface with VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY as required string fields with runtime validation</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Supabase Client Configuration</section>
        <snippet>Shows Supabase client initialization using import.meta.env for URL and anon key, with auth configuration (persistSession, autoRefreshToken, detectSessionInUrl)</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Acceptance Criteria AC-0.2.1 through AC-0.2.7</section>
        <snippet>Complete acceptance criteria definitions for environment variable management, including validation requirements, security constraints, and testing strategies</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Security Architecture</section>
        <snippet>Security requirements for environment variable handling, secrets management, and Row Level Security (RLS) policy enforcement</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR65 - Supabase Integration with RLS</section>
        <snippet>Functional requirement for Supabase backend integration with Row Level Security policies for multi-tenant data isolation</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/api/supabaseClient.ts</path>
        <kind>service</kind>
        <symbol>supabase</symbol>
        <lines>29-42</lines>
        <reason>EXISTING environment validation - already validates VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY on module load; throws error if missing; This is the CURRENT implementation that needs to be reviewed/enhanced per story requirements</reason>
      </artifact>
      <artifact>
        <path>src/api/supabaseClient.ts</path>
        <kind>service</kind>
        <symbol>createClient</symbol>
        <lines>64-79</lines>
        <reason>Supabase client initialization using environment variables with auth configuration (persistSession: true, autoRefreshToken: true, detectSessionInUrl: true)</reason>
      </artifact>
      <artifact>
        <path>.gitignore</path>
        <kind>config</kind>
        <symbol>N/A</symbol>
        <lines>23-26</lines>
        <reason>EXISTING .env ignore configuration - already excludes .env, .env.development, .env.production, .env.local from version control; verify this meets AC-0.2.2 requirements</reason>
      </artifact>
      <artifact>
        <path>.github/workflows/deploy.yml</path>
        <kind>workflow</kind>
        <symbol>build</symbol>
        <lines>42-45</lines>
        <reason>EXISTING GitHub Actions build step - already configured to inject VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY from GitHub Secrets during build; verify implementation meets AC-0.2.3 and AC-0.2.7</reason>
      </artifact>
      <artifact>
        <path>src/vite-env.d.ts</path>
        <kind>types</kind>
        <symbol>N/A</symbol>
        <lines>1-3</lines>
        <reason>TypeScript environment definitions file - NEEDS to be extended with ImportMetaEnv interface for VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY per AC-0.2.1 type safety requirement</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="@supabase/supabase-js" version="^2.81.1" />
        <package name="vite" version="^7.2.2" />
        <package name="typescript" version="~5.9.3" />
        <package name="gh-pages" version="^6.3.0" />
        <package name="vitest" version="^4.0.9" />
        <package name="@testing-library/react" version="^16.1.0" />
        <package name="@testing-library/jest-dom" version="^6.6.3" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="1">MUST use VITE_ prefix for all client-side environment variables (Vite requirement)</constraint>
    <constraint id="2">Environment variables are statically replaced at build time, not runtime (Vite behavior)</constraint>
    <constraint id="3">MUST access env vars via import.meta.env.VARIABLE_NAME (NOT process.env)</constraint>
    <constraint id="4">GitHub Secrets must be configured in repository settings for production deployment</constraint>
    <constraint id="5">Local development uses .env file; production uses GitHub Secrets (environment separation)</constraint>
    <constraint id="6">Supabase anon key is safe for public exposure - Row Level Security (RLS) policies protect data</constraint>
    <constraint id="7">NEVER commit .env file to version control (enforced by .gitignore)</constraint>
    <constraint id="8">Service role key (if ever used) must NEVER be exposed in client code - server-side only</constraint>
    <constraint id="9">Build must fail fast if required environment variables are missing (fail at compile time, not runtime)</constraint>
    <constraint id="10">All environment variable references in client bundle should be replaced with actual values (no import.meta.env in dist/)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>validateEnv</name>
      <kind>function</kind>
      <signature>function validateEnv(): void</signature>
      <path>src/lib/supabase.ts (to be created/updated)</path>
      <description>Validates required environment variables are present; throws error with clear message listing missing variables if validation fails</description>
    </interface>
    <interface>
      <name>EnvironmentConfig</name>
      <kind>TypeScript interface</kind>
      <signature>interface EnvironmentConfig { VITE_SUPABASE_URL: string; VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: string; }</signature>
      <path>src/vite-env.d.ts</path>
      <description>Type definition for environment variables to enable TypeScript autocomplete and type checking</description>
    </interface>
    <interface>
      <name>GitHub Actions Secrets</name>
      <kind>Environment Variables</kind>
      <signature>VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}, VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}</signature>
      <path>.github/workflows/deploy.yml</path>
      <description>GitHub Actions workflow step that injects repository secrets as environment variables during build process</description>
    </interface>
    <interface>
      <name>Supabase Client Configuration</name>
      <kind>Configuration Object</kind>
      <signature>{ auth: { persistSession: boolean; autoRefreshToken: boolean; detectSessionInUrl: boolean; } }</signature>
      <path>src/api/supabaseClient.ts</path>
      <description>Supabase client initialization options for PWA authentication and session management</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Vitest (v4.0.9) for unit and integration tests. Test files use .test.ts extension. Tests located in tests/ directory with subdirectories for unit/ and integration/. Use @testing-library/react for component testing. Use happy-dom for DOM simulation in tests. Use fake-indexeddb for IndexedDB mocking. Coverage target: 80% line coverage for critical infrastructure code.
    </standards>
    <locations>
      <location>tests/unit/*.test.ts</location>
      <location>tests/integration/*.test.ts</location>
      <location>src/**/__tests__/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-0.2.1">Unit test: Read .env.example file and verify it contains VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY with descriptions</idea>
      <idea ac="AC-0.2.2">Unit test: Read .gitignore file and verify it contains .env and .env.local entries using regex match</idea>
      <idea ac="AC-0.2.4">Unit test: Mock import.meta.env with missing VITE_SUPABASE_URL, import supabase module, expect Error throw with specific message</idea>
      <idea ac="AC-0.2.4">Unit test: Mock import.meta.env with missing VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY, expect Error throw listing that specific variable</idea>
      <idea ac="AC-0.2.5">Unit test: Mock import.meta.env with all required vars present, verify supabase client initializes successfully</idea>
      <idea ac="AC-0.2.6">Integration test: Run npm run build with valid env vars, inspect dist/ files, verify no "import.meta.env" references exist</idea>
      <idea ac="AC-0.2.6">Integration test: After build, grep dist/ for actual Supabase URL value, verify it's present (injected at build time)</idea>
      <idea ac="AC-0.2.7">Integration test: Verify .github/workflows/deploy.yml contains env: section with VITE_SUPABASE secrets injection</idea>
    </ideas>
  </tests>
</story-context>

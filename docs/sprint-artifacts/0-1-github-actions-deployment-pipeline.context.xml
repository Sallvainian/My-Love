<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>1</storyId>
    <title>GitHub Actions Deployment Pipeline Setup</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/0-1-github-actions-deployment-pipeline.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>to create an automated GitHub Actions workflow for deployment</iWant>
    <soThat>code changes automatically deploy to production on merge to main</soThat>
    <tasks>
- Task 1: Create GitHub Actions Workflow File (AC: 0.1.1, 0.1.2)
  - Create .github/workflows/ directory if not exists
  - Create deploy.yml with workflow name and triggers
  - Configure workflow to trigger on push to main branch
  - Add manual workflow dispatch trigger
  - Define job deploy with ubuntu-latest runner
  - Add checkout step (actions/checkout@v4)
  - Add Node.js setup step (actions/setup-node@v4, version 20.x)
  - Add dependency installation step (npm install)
  - Add TypeScript compilation step (implicit in Vite build)
  - Add Vite production build step (npm run build)

- Task 2: Configure Environment Variable Injection (AC: 0.1.3)
  - Add environment variables section to deploy job
  - Map GitHub Secret VITE_SUPABASE_URL to environment variable
  - Map GitHub Secret VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY to environment variable
  - Verify vite.config.ts includes environment variable handling
  - Document secret setup requirements in .env.example

- Task 3: Add Smoke Tests (AC: 0.1.5)
  - Create smoke test script in package.json (test:smoke)
  - Add smoke test step to workflow (after build, before deploy)
  - Verify dist/ directory exists
  - Verify critical files present (index.html, manifest.json, sw.js, assets/*.js, assets/*.css)
  - Configure workflow to fail if smoke tests fail

- Task 4: Configure GitHub Pages Deployment (AC: 0.1.6, 0.1.7, 0.1.8)
  - Add GitHub Pages deployment step using peaceiris/actions-gh-pages@v3
  - Configure deployment to use dist/ directory as publish source
  - Set github_token for authentication
  - Configure deployment to gh-pages branch
  - Enable force orphan mode for clean gh-pages branch
  - Add deployment timeout of 5 minutes

- Task 5: Verify Vite Configuration for GitHub Pages (AC: 0.1.4, 0.1.6)
  - Review vite.config.ts for correct base path
  - Ensure base: '/My-Love/' (matches repo name)
  - Verify PWA plugin configuration generates manifest.json and sw.js
  - Verify build output includes all required PWA assets

- Task 6: Test Deployment Workflow (AC: 0.1.7, 0.1.8)
  - Commit workflow file to feature branch
  - Merge to main to trigger deployment
  - Monitor GitHub Actions execution
  - Verify deployment completes within 5 minutes
  - Access GitHub Pages URL
  - Verify PWA manifest accessible
  - Verify service worker registration in browser DevTools
  - Add workflow status badge to README.md (optional)
    </tasks>
  </story>

  <acceptanceCriteria>
AC-0.1.1: Workflow File and Trigger Configuration
- .github/workflows/deploy.yml exists with complete workflow definition
- Workflow triggers automatically on push to main branch
- Manual workflow dispatch option available for on-demand deployments

AC-0.1.2: Build Steps Execution
- Workflow successfully executes all build steps in sequence: checkout, Node.js 20.x setup, npm install, TypeScript compilation, Vite production build

AC-0.1.3: Environment Variable Injection
- Build process correctly injects environment variables from GitHub Secrets (VITE_SUPABASE_URL, VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY)
- Environment variables accessible via import.meta.env.VITE_* in build output

AC-0.1.4: PWA Artifact Generation
- PWA artifacts successfully generated in dist/: manifest.json, sw.js, optimized JavaScript bundles with code splitting, processed CSS from Tailwind, static assets

AC-0.1.5: Pre-deployment Validation
- Smoke tests execute before deployment verifying dist/ structure, critical assets (HTML, JS, CSS, manifest, service worker), and valid HTML entry points
- Deployment blocked if smoke tests fail

AC-0.1.6: GitHub Pages Deployment
- Workflow deploys compiled assets to GitHub Pages (gh-pages branch)
- Deployment uses atomic replacement (zero downtime)
- GitHub Pages URL becomes accessible after deployment

AC-0.1.7: Performance Target
- Deployment completes within 5 minutes from push to production availability
- Workflow status visible in GitHub Actions tab

AC-0.1.8: Deployment Verification
- Workflow status badge shows passing status
- GitHub Pages site accessible at https://<username>.github.io/<repo>/
- Service worker registration successful on deployed site
- PWA manifest accessible at /manifest.json
  </acceptanceCriteria>

  <artifacts>
    <docs>
      - path: docs/sprint-artifacts/tech-spec-epic-0.md
        title: Epic 0 Technical Specification
        section: System Architecture Alignment, Detailed Design, Dependencies and Integrations
        snippet: Establishes foundational deployment infrastructure with GitHub Actions CI/CD pipeline, Vite build process, and PWA artifact generation. Includes complete workflow specification, environment variable management, and deployment validation strategies.

      - path: docs/architecture.md
        title: My-Love PWA Architecture
        section: Technology Stack Details, Deployment Architecture
        snippet: React 19 + Vite 7 architecture with vite-plugin-pwa for service worker generation. GitHub Pages deployment via gh-pages package. PWA manifest and workbox caching strategies for optimized performance.

      - path: docs/prd.md
        title: Product Requirements Document
        section: Non-Functional Requirements (Performance), Technical Platform Requirements
        snippet: Deployment reliability targets: sub-2s page loads, automated GitHub Pages deployment, PWA compliance with service worker and manifest. Performance NFRs include < 5 minute deployment time and Core Web Vitals compliance.
    </docs>

    <code>
      - path: .github/workflows/deploy.yml
        kind: workflow
        symbol: Deploy to GitHub Pages
        lines: 1-62
        reason: EXISTING deployment workflow implementing most of Story 0.1 acceptance criteria. Already configured with GitHub Actions, environment secrets injection, Supabase type generation, and two-job build+deploy pattern.

      - path: vite.config.ts
        kind: config
        symbol: defineConfig
        lines: 7-114
        reason: Vite configuration with PWA plugin setup, workbox caching strategies, manifest generation, and code splitting. Base path currently set to '/' for root deployment (needs verification for GitHub Pages subpath).

      - path: package.json
        kind: config
        symbol: scripts
        lines: 6-27
        reason: Build scripts including 'build' (TypeScript + Vite), 'test:smoke' for pre-deployment validation, 'deploy' using gh-pages package, and 'postdeploy' reminder for manual verification.

      - path: scripts/smoke-tests.cjs
        kind: script
        symbol: testFileExistence, testManifestValidation, testBundleSize
        lines: 1-100
        reason: Comprehensive pre-deployment smoke tests validating dist/ structure, manifest.webmanifest validity, service worker presence, bundle size limits (<210KB gzipped), and critical asset verification.

      - path: .env.example
        kind: config
        symbol: VITE_SUPABASE_URL, VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY
        lines: 1-32
        reason: Environment variable template documenting required Supabase configuration for build-time injection. Includes comments explaining Epic 6 Supabase integration and authentication setup.

      - path: scripts/post-deploy-check.cjs
        kind: script
        symbol: validateDeployment
        lines: unknown
        reason: Post-deployment validation script for Story 0.4. Verifies deployed URL accessibility, PWA manifest validity, service worker registration, and Supabase connection health.
    </code>

    <dependencies>
      production:
        - react: ^19.1.1 (Core React library)
        - react-dom: ^19.1.1 (React DOM rendering)
        - @supabase/supabase-js: ^2.81.1 (Backend services)
        - zustand: ^5.0.8 (State management)
        - idb: ^8.0.3 (IndexedDB wrapper)
        - framer-motion: ^12.23.24 (Animations)
        - lucide-react: ^0.548.0 (Icons)
        - workbox-window: ^7.3.0 (Service worker management)
        - zod: ^3.25.76 (Schema validation)
        - eventsource: ^4.0.0 (SSE polyfill)

      development:
        - vite: ^7.1.7 (Build tool)
        - vite-plugin-pwa: ^1.1.0 (PWA generation)
        - @vitejs/plugin-react: ^5.0.4 (React Fast Refresh)
        - typescript: ~5.9.3 (TypeScript compiler)
        - gh-pages: ^6.3.0 (GitHub Pages deployment)
        - rollup-plugin-visualizer: ^6.0.5 (Bundle analysis)
        - vitest: ^4.0.9 (Unit testing)
        - @playwright/test: ^1.56.1 (E2E testing)
        - tailwindcss: ^3.4.18 (CSS framework)
        - eslint: ^9.36.0 (Linter)
        - prettier: ^3.6.2 (Formatter)
        - supabase: ^2.58.5 (Supabase CLI)
    </dependencies>
  </artifacts>

  <constraints>
    Build Process Constraints:
    - Vite handles TypeScript compilation, CSS processing (Tailwind), asset optimization, and code splitting automatically
    - PWA plugin (vite-plugin-pwa) generates service worker and manifest.json during build
    - Environment variables MUST be prefixed with VITE_ to be exposed to client code
    - Build output directory is 'dist/' and must not be committed to git

    Service Worker Strategy:
    - JS/CSS/HTML: NetworkOnly (always fetch fresh to prevent stale code)
    - Images/Fonts: CacheFirst (30-day TTL)
    - Google Fonts: CacheFirst (1-year TTL)
    - skipWaiting: true and clientsClaim: true for immediate activation
    - No navigateFallback (prevents caching HTML routes)

    GitHub Pages Deployment:
    - Zero downtime deployment using atomic gh-pages branch replacement
    - HTTPS enforced automatically by GitHub Pages
    - Base path configuration: Currently '/' but may need '/My-Love/' for repo subpath
    - Deployment artifacts come from dist/ directory only

    Security Requirements:
    - Environment variables injected at build time only (never exposed in client bundle as plaintext)
    - Supabase anon key is public-safe (protected by Row Level Security policies)
    - No credentials committed to version control (.gitignore enforced)
    - GitHub Secrets used for sensitive configuration in CI/CD

    Performance Targets:
    - Total CI/CD pipeline execution: < 5 minutes (AC-0.1.7)
    - TypeScript compilation: < 30 seconds
    - Vite production build: < 2 minutes
    - GitHub Pages deployment propagation: < 2 minutes
    - Main bundle (vendor-react): < 150 KB gzipped
    - Total initial load: < 300 KB gzipped (currently enforced at 210KB in smoke tests)

    Testing Requirements:
    - Smoke tests MUST pass before deployment (test:smoke script)
    - Smoke tests verify: dist/ structure, manifest validity, service worker presence, bundle size, critical assets
    - Post-deployment validation manual (Story 0.4 will automate)

    Development Standards:
    - Node.js 20.x required (enforced by GitHub Actions)
    - npm ci for reproducible builds (uses package-lock.json)
    - No warnings allowed in production builds
    - TypeScript strict mode enforced
  </constraints>

  <interfaces>
    GitHub Actions Workflow API:
    - name: Deploy to GitHub Pages
    - kind: CI/CD Pipeline
    - triggers:
        - on push to 'main' branch
        - workflow_dispatch (manual trigger)
    - jobs:
        - build: Checkout, setup Node.js 20, install deps, generate Supabase types, build with env vars, upload artifact
        - deploy: Deploy artifact to GitHub Pages
    - secrets:
        - VITE_SUPABASE_URL: Supabase project URL
        - VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: Supabase anonymous key
        - SUPABASE_ACCESS_TOKEN: For type generation
    - artifacts:
        - Upload pages artifact from dist/ directory
        - Deploy to github-pages environment

    Vite Build Configuration:
    - name: vite.config.ts
    - kind: Build configuration
    - base: '/' (may need '/My-Love/' for GitHub Pages subpath)
    - plugins:
        - @vitejs/plugin-react: React Fast Refresh
        - vite-plugin-pwa: PWA manifest + service worker generation
        - rollup-plugin-visualizer: Bundle size analysis
    - build.rollupOptions.output.manualChunks:
        - vendor-react: React core (~150KB)
        - vendor-supabase: Supabase client (~100KB, lazy-loaded)
        - vendor-state: Zustand + idb + zod
        - vendor-animation: Framer Motion
    - PWA manifest:
        - name: "My Love - Daily Reminders"
        - theme_color: #FF6B9D
        - display: standalone
        - icons: 192x192, 512x512
    - Workbox caching:
        - globPatterns: Only images, fonts (no JS/CSS/HTML)
        - runtimeCaching: NetworkOnly for code, CacheFirst for assets

    Smoke Test Script API:
    - name: scripts/smoke-tests.cjs
    - kind: Pre-deployment validation
    - tests:
        1. File existence: index.html, manifest.webmanifest, sw.js
        2. Manifest validation: Valid JSON, required fields
        3. Service worker validation: Expected cache routes
        4. Bundle size: < 210KB gzipped total
        5. Critical assets: Icons, CSS, JS bundles
    - exit codes:
        - 0: All tests passed
        - 1: Test failure (blocks deployment)

    NPM Scripts API:
    - build: "tsc -b && vite build" (TypeScript compile + Vite build)
    - test:smoke: "node scripts/smoke-tests.cjs" (Pre-deploy validation)
    - predeploy: "npm run build && npm run test:smoke" (Build + validate)
    - deploy: "gh-pages -d dist" (Deploy to gh-pages branch)
    - postdeploy: Echo reminder to run post-deploy-check.cjs

    Environment Variables Contract:
    - VITE_SUPABASE_URL: string (format: https://<project-id>.supabase.co)
    - VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: string (public anonymous key from Supabase)
    - Source: GitHub Secrets (CI/CD) or .env file (local dev)
    - Access: import.meta.env.VITE_* in TypeScript code
    - Validation: Build-time check for required vars
  </interfaces>

  <tests>
    <standards>
      Deployment Testing Standards:
      - Smoke tests execute before every deployment (automated in CI/CD)
      - Post-deployment validation runs manually after deployment (Story 0.4 automates)
      - GitHub Actions workflow logs provide build/deploy audit trail
      - Manual verification in browser DevTools for service worker and PWA manifest

      Test Levels:
      - Unit: Validate configuration correctness (vite.config.ts, smoke tests logic)
      - Integration: Full CI/CD pipeline test with sample commit
      - E2E: Deploy to production, verify all acceptance criteria manually
      - Performance: Measure pipeline duration from commit to deployment availability
    </standards>

    <locations>
      - scripts/smoke-tests.cjs (Pre-deployment smoke tests)
      - scripts/post-deploy-check.cjs (Post-deployment validation - Story 0.4)
      - .github/workflows/deploy.yml (CI/CD pipeline definition)
      - .github/workflows/playwright.yml (E2E tests, separate from deployment)
    </locations>

    <ideas>
      AC-0.1.1 Testing Ideas:
      - Unit: Verify .github/workflows/deploy.yml file exists and has correct structure
      - Integration: Trigger workflow via workflow_dispatch and verify execution
      - Manual: Check GitHub Actions tab shows workflow with correct triggers

      AC-0.1.2 Testing Ideas:
      - Integration: Full CI/CD pipeline test - commit to feature branch, verify all build steps succeed
      - Manual: Review GitHub Actions logs for each step execution and timing
      - Performance: Measure build step durations to ensure < 5 minute total

      AC-0.1.3 Testing Ideas:
      - Integration: Verify environment variables present in build logs (masked for secrets)
      - Security: Inspect bundled JavaScript to confirm no plaintext secrets exposed
      - Unit: Test environment variable validation logic triggers errors for missing vars

      AC-0.1.4 Testing Ideas:
      - Unit: Verify dist/manifest.webmanifest and dist/sw.js exist after build
      - Integration: Parse manifest.webmanifest and validate JSON schema
      - E2E: Playwright test registers service worker and verifies active state

      AC-0.1.5 Testing Ideas:
      - Unit: Test smoke-tests.cjs script with valid and invalid dist/ directories
      - Integration: Run smoke tests in CI pipeline, verify deployment blocked on failure
      - Manual: Trigger workflow with intentionally broken build, verify smoke tests catch it

      AC-0.1.6 Testing Ideas:
      - E2E: Deploy to staging environment, verify gh-pages branch updated
      - Manual: Access GitHub Pages URL, confirm site loads correctly
      - Integration: Verify deployment uses dist/ directory and GitHub token authentication

      AC-0.1.7 Testing Ideas:
      - Performance: Measure time from git push to GitHub Pages URL responding
      - Manual: Monitor GitHub Actions execution tab during deployment
      - Integration: Set up alerting if deployment exceeds 5 minute threshold

      AC-0.1.8 Testing Ideas:
      - Manual: Access deployment URL and verify service worker registration in DevTools
      - E2E: Playwright test loads deployed URL and checks manifest accessibility
      - Manual: Add workflow status badge to README and verify shows passing status
    </ideas>
  </tests>
</story-context>

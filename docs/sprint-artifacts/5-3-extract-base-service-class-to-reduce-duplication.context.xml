<story-context id=".bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.3</storyId>
    <title>Extract Base Service Class to Reduce Duplication</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/5-3-extract-base-service-class-to-reduce-duplication.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to extract common service logic into a base class</iWant>
    <soThat>messagesService, photosService, and moodService don't duplicate ~80% of their code</soThat>
    <tasks>
      - Analyze Service Duplication Patterns (AC: #1, #2)
      - Create BaseIndexedDBService Generic Class (AC: #1, #2)
      - Refactor customMessageService to Extend Base (AC: #3, #4)
      - Refactor photoStorageService to Extend Base (AC: #3, #4)
      - Create moodService Extending Base (Optional) (AC: #3)
      - Run E2E Tests to Verify No Regressions (AC: #5)
      - Measure Code Duplication Reduction (AC: #4)
      - Document Service Architecture (AC: #6)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. BaseIndexedDBService&lt;T&gt; class created with generic type parameter
    2. Shared methods implemented: add(), get(), getAll(), update(), delete(), clear(), getPage()
    3. messagesService (customMessageService), photosService (photoStorageService), and moodService extend base class
    4. Code duplication reduced by ~80% across service files
    5. All E2E tests pass without modification
    6. Service architecture documented in technical-decisions.md or architecture.md
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Code Quality &amp; Performance</title>
        <section>Data Models and Contracts → BaseIndexedDBService Generic Contract</section>
        <snippet>Defines the abstract base class contract with generic type parameter &lt;T extends { id?: number }&gt;, constructor parameters (dbName, storeName, version), abstract CRUD operations (getAll, get, add, update, delete, clear), pagination support (getPage), and shared error handling (handleError, handleQuotaExceeded). Lines 124-149.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Code Quality &amp; Performance</title>
        <section>Workflows and Sequencing → Story 5.3: Base Service Extraction</section>
        <snippet>Sequence: 1) Analyze common patterns in messagesService.ts, photosService.ts, moodService.ts 2) Create BaseIndexedDBService.ts with generic type parameter 3) Extract: openDB(), add(), get(), getAll(), update(), delete(), clear(), error handling 4) Refactor existing services to extend BaseIndexedDBService&lt;T&gt; 5) Verify all existing functionality works (E2E tests) 6) Remove duplicated code from service files. Lines 302-309.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Code Quality &amp; Performance</title>
        <section>Detailed Design → Services and Modules</section>
        <snippet>BaseIndexedDBService&lt;T&gt; module: Responsibility = Generic IndexedDB operations; Inputs = Store name, schema; Outputs = CRUD operations, error handling; Owner = Story 5.3. messagesService extends Base for Message persistence, photosService extends Base with pagination for Photo persistence. Lines 69-72.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Data Architecture → IndexedDB Schema</section>
        <snippet>Database: my-love-db (version 1, will be 2 after photo store migration). Stores: photos (key: number, value: Photo, index: by-date on uploadDate) and messages (key: number, value: Message, indexes: by-category on category, by-date on createdAt). Auto-increment primary keys. Lines 78-100.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-3-extract-base-service-class-to-reduce-duplication.md</path>
        <title>Story 5.3 Dev Notes</title>
        <section>Service Duplication Analysis</section>
        <snippet>Current state: customMessageService.ts (299 lines) and photoStorageService.ts (322 lines) have ~80% duplication in: Init Guard (100% identical), Error Handling (95% identical), CRUD Method Signatures (90% similar), Transaction Handling (100% identical), Logging Patterns (100% identical). Estimated reduction: shared code ~150 lines in base class, customMessageService 299→120 lines (60%), photoStorageService 322→140 lines (56%). Lines 131-161.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-3-extract-base-service-class-to-reduce-duplication.md</path>
        <title>Story 5.3 Dev Notes</title>
        <section>Architecture Patterns → BaseIndexedDBService Design Decisions</section>
        <snippet>1) Generic Type Constraint: &lt;T extends { id?: number }&gt; ensures optional id for IndexedDB auto-increment. 2) Abstract Methods: getStoreName() for object store name, _doInit() for DB upgrade logic (schema/migrations). 3) Method Overriding: Services can override base CRUD for custom logic. 4) Error Handling Centralization: handleError() and handleQuotaExceeded() methods. 5) Singleton Pattern Preservation: Services maintain singleton exports. Lines 165-186.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-3-extract-base-service-class-to-reduce-duplication.md</path>
        <title>Story 5.3 Dev Notes</title>
        <section>Testing Standards</section>
        <snippet>Regression Prevention: All Epic 2 E2E tests must pass (messages, photos, settings flows). No changes to public API surface. Manual smoke testing: upload photo, favorite message, edit settings. Future Unit Testing (Story 5.4): Base class tested with fake-indexeddb for CRUD, services have minimal unit tests (only service-specific logic), focus on edge cases (transaction rollback, quota exceeded, concurrent init). Lines 189-198.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/services/customMessageService.ts</path>
        <kind>service</kind>
        <symbol>CustomMessageService</symbol>
        <lines>1-299</lines>
        <reason>Existing message service with IndexedDB CRUD patterns to be extracted. Contains init() guard (lines 24-44), _doInit() implementation (lines 47-60), CRUD methods (create, update, delete, getAll, getById), error handling patterns, singleton export. Will extend BaseIndexedDBService after refactor.</reason>
      </file>
      <file>
        <path>src/services/photoStorageService.ts</path>
        <kind>service</kind>
        <symbol>PhotoStorageService</symbol>
        <lines>1-322</lines>
        <reason>Existing photo service with IndexedDB CRUD patterns (including v2 migration). Contains init() guard (lines 28-49), _doInit() with DB upgrade (lines 51-99), CRUD methods (create, getAll, getPage, getById, update, delete), service-specific methods (getStorageSize, estimateQuotaRemaining). Will extend BaseIndexedDBService after refactor.</reason>
      </file>
      <file>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>Message, Photo, MoodEntry</symbol>
        <lines>9-32, 62-66</lines>
        <reason>Type definitions for data models that will be used as generic type parameters in BaseIndexedDBService&lt;T&gt;. All have optional 'id?: number' field required by base class constraint. Message (lines 9-19), Photo (lines 21-32), MoodEntry (lines 62-66).</reason>
      </file>
      <file>
        <path>tests/e2e/message-display.spec.ts</path>
        <kind>test</kind>
        <symbol>E2E tests for message functionality</symbol>
        <lines>all</lines>
        <reason>E2E tests that must pass after refactoring to verify no regressions in message service functionality. Part of Epic 2 test suite.</reason>
      </file>
      <file>
        <path>tests/e2e/photo-upload.spec.ts</path>
        <kind>test</kind>
        <symbol>E2E tests for photo upload functionality</symbol>
        <lines>all</lines>
        <reason>E2E tests that must pass after refactoring to verify no regressions in photo service functionality. Part of Epic 4 test suite.</reason>
      </file>
      <file>
        <path>tests/e2e/photo-gallery.spec.ts</path>
        <kind>test</kind>
        <symbol>E2E tests for photo gallery functionality</symbol>
        <lines>all</lines>
        <reason>E2E tests that must pass after refactoring to verify no regressions in photo service functionality (including getPage() pagination method).</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package name="idb" version="^8.0.3">IndexedDB wrapper library used for database operations in services</package>
        <package name="typescript" version="~5.9.3">TypeScript for type-safe generic class implementation</package>
        <package name="react" version="^19.1.1">React for component integration with services</package>
        <package name="zustand" version="^5.0.8">State management (services integrate with store)</package>
        <package name="@playwright/test" version="^1.56.1">E2E testing framework for regression testing</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - TypeScript strict mode compliance: No 'any' types without justification
    - Generic type constraint must be: &lt;T extends { id?: number }&gt; to support IndexedDB auto-increment keys
    - Abstract methods required: getStoreName() (returns string), _doInit() (returns Promise&lt;void&gt;)
    - Shared init() guard logic must prevent concurrent initialization using initPromise
    - Error handling must use protected handleError() and handleQuotaExceeded() methods
    - All E2E tests must pass without modification (no changes to public API surface)
    - Services must maintain singleton pattern with exports like: export const photoStorageService = new PhotoStorageService()
    - Database version management: customMessageService uses v1, photoStorageService uses v2 (existing migration)
    - Method overriding allowed: Services can override base CRUD methods for custom logic (e.g., photoStorageService.getAll() uses 'by-date' index)
    - Pagination method getPage() must handle both offset-based and index-based implementations
    - Logging patterns must remain consistent: console.log for info, console.error for errors
    - Transaction handling patterns must be preserved (implicit in openDB usage)
    - Service-specific methods must be preserved: messagesService (getActiveCustomMessages, exportMessages, importMessages), photoStorageService (getStorageSize, estimateQuotaRemaining)
  </constraints>

  <interfaces>
    <interface>
      <name>BaseIndexedDBService&lt;T extends { id?: number }&gt;</name>
      <kind>abstract class</kind>
      <signature>
abstract class BaseIndexedDBService&lt;T extends { id?: number }&gt; {
  protected db: IDBPDatabase&lt;any&gt; | null = null;
  protected initPromise: Promise&lt;void&gt; | null = null;

  constructor(protected dbName: string, protected storeName: string, protected version: number);

  // Public initialization with guard logic
  async init(): Promise&lt;void&gt;;

  // Abstract methods - services must implement
  protected abstract getStoreName(): string;
  protected abstract _doInit(): Promise&lt;void&gt;;

  // Shared CRUD operations
  async add(item: Omit&lt;T, 'id'&gt;): Promise&lt;T&gt;;
  async get(id: number): Promise&lt;T | null&gt;;
  async getAll(): Promise&lt;T[]&gt;;
  async update(id: number, updates: Partial&lt;T&gt;): Promise&lt;void&gt;;
  async delete(id: number): Promise&lt;void&gt;;
  async clear(): Promise&lt;void&gt;;

  // Pagination helper
  async getPage(offset: number, limit: number): Promise&lt;T[]&gt;;

  // Error handling
  protected handleError(operation: string, error: Error): never;
  protected handleQuotaExceeded(): never;
}
      </signature>
      <path>src/services/BaseIndexedDBService.ts (to be created)</path>
    </interface>

    <interface>
      <name>CustomMessageService extends BaseIndexedDBService&lt;Message&gt;</name>
      <kind>class</kind>
      <signature>
class CustomMessageService extends BaseIndexedDBService&lt;Message&gt; {
  protected getStoreName(): string { return 'messages'; }
  protected _doInit(): Promise&lt;void&gt; { /* existing DB setup logic */ }

  // Service-specific methods (preserved)
  async create(input: CreateMessageInput): Promise&lt;Message&gt;;
  async update(input: UpdateMessageInput): Promise&lt;void&gt;;
  async getActiveCustomMessages(filter: MessageFilter): Promise&lt;Message[]&gt;;
  async exportMessages(): Promise&lt;CustomMessagesExport&gt;;
  async importMessages(data: CustomMessagesExport): Promise&lt;void&gt;;
}

export const customMessageService = new CustomMessageService();
      </signature>
      <path>src/services/customMessageService.ts (to be refactored)</path>
    </interface>

    <interface>
      <name>PhotoStorageService extends BaseIndexedDBService&lt;Photo&gt;</name>
      <kind>class</kind>
      <signature>
class PhotoStorageService extends BaseIndexedDBService&lt;Photo&gt; {
  protected getStoreName(): string { return 'photos'; }
  protected _doInit(): Promise&lt;void&gt; { /* existing v2 DB migration logic */ }

  // Override base methods for custom behavior
  async getAll(): Promise&lt;Photo[]&gt; { /* uses 'by-date' index for sorting */ }
  async getPage(page: number, pageSize: number): Promise&lt;Photo[]&gt; { /* index-based pagination */ }

  // Service-specific methods (preserved)
  async create(photo: Omit&lt;Photo, 'id'&gt;): Promise&lt;number&gt;;
  async getStorageSize(): Promise&lt;number&gt;;
  async estimateQuotaRemaining(): Promise&lt;number&gt;;
}

export const photoStorageService = new PhotoStorageService();
      </signature>
      <path>src/services/photoStorageService.ts (to be refactored)</path>
    </interface>

    <interface>
      <name>IDBPDatabase from idb package</name>
      <kind>external library interface</kind>
      <signature>
import { openDB, type IDBPDatabase } from 'idb';

interface IDBPDatabase&lt;DBTypes&gt; {
  get(storeName: string, key: number): Promise&lt;T | undefined&gt;;
  getAll(storeName: string): Promise&lt;T[]&gt;;
  add(storeName: string, value: T): Promise&lt;number&gt;;
  put(storeName: string, value: T): Promise&lt;number&gt;;
  delete(storeName: string, key: number): Promise&lt;void&gt;;
  clear(storeName: string): Promise&lt;void&gt;;
}
      </signature>
      <path>node_modules/idb (external dependency)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      E2E Testing: All tests use Playwright framework from Epic 2. Tests located in tests/e2e/ directory with .spec.ts extension. Test execution via 'npm run test:e2e' command. Coverage includes message display, photo upload/gallery/carousel, settings persistence, favorites functionality. All tests must pass without modification after refactoring (acceptance criteria #5).

      Unit Testing: Future Story 5.4 will add Vitest with fake-indexeddb for BaseIndexedDBService testing. Target: 80%+ coverage on CRUD operations, error handling, transaction rollback, quota exceeded scenarios, concurrent initialization edge cases. Services will have minimal unit tests (only service-specific logic).

      Manual Testing: Smoke test required after each service refactoring - upload photo, favorite message, edit settings. Verify no regressions in user-facing functionality.
    </standards>

    <locations>
      tests/e2e/**/*.spec.ts - Playwright E2E tests
      src/services/**/*.test.ts - Future unit tests (Story 5.4)
    </locations>

    <ideas>
      <test ac="1,2">
        Unit test BaseIndexedDBService generic class with fake-indexeddb: verify init() guard prevents concurrent initialization, test CRUD operations (add, get, getAll, update, delete, clear), test getPage() pagination with offset/limit, test error handling (handleError, handleQuotaExceeded), verify abstract methods throw if not implemented.
      </test>
      <test ac="3">
        Unit test customMessageService extends base: verify getStoreName() returns 'messages', test _doInit() sets up DB correctly, verify service-specific methods (getActiveCustomMessages, exportMessages, importMessages) still work, test overridden create/update methods.
      </test>
      <test ac="3">
        Unit test photoStorageService extends base: verify getStoreName() returns 'photos', test _doInit() v2 migration logic, test overridden getAll() uses 'by-date' index, test overridden getPage() index-based pagination, verify service-specific methods (getStorageSize, estimateQuotaRemaining) still work.
      </test>
      <test ac="4">
        Code metrics test: measure lines of code before/after refactoring, calculate duplication reduction percentage, verify target ~80% reduction achieved, document metrics in completion notes.
      </test>
      <test ac="5">
        E2E regression suite: run all tests from tests/e2e/ directory (message-display, photo-upload, photo-gallery, photo-carousel, favorites, settings, persistence), verify 100% pass rate, no test modifications required.
      </test>
      <test ac="6">
        Documentation verification: check docs/architecture.md updated with BaseIndexedDBService pattern, verify generic type parameter usage documented, confirm inheritance hierarchy diagram present, validate abstract methods documentation.
      </test>
    </ideas>
  </tests>
</story-context>

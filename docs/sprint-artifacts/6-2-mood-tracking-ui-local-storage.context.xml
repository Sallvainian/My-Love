<story-context id="6-2-mood-tracking-ui-local-storage" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>Mood Tracking UI &amp; Local Storage</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-2-mood-tracking-ui-local-storage.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>to log my daily mood</iWant>
    <soThat>I can track how I'm feeling and you can see it</soThat>
    <tasks>
      - Task 1: Create MoodService (IndexedDB Layer) - extends BaseIndexedDBService&lt;MoodEntry&gt;, implements getMoodForDate, getMoodsInRange, applies MoodEntrySchema validation
      - Task 2: Create Zustand Mood Store Slice - define mood state, implement addMoodEntry, getMoodForDate, updateMoodEntry, integrate into useAppStore
      - Task 3: Create MoodTracker Component - mood type selector with 5 buttons, Framer Motion animations, note input with character counter, form submission, optimistic UI, success feedback, pre-populate if exists, sync status indicator
      - Task 4: Add Mood Tab to Navigation - update BottomNavigation.tsx with Mood tab, add icon, implement tab switching, ensure active tab highlighted
      - Task 5: Integration Testing - E2E tests for navigation, mood logging, persistence, update flow, index query performance, unit tests for MoodService
      - Task 6: Validation &amp; Error Handling - verify MoodEntrySchema enforces constraints, handle validation errors, handle IndexedDB errors, test edge cases
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: Mood Tracker UI - Navigation &amp; Tab
      - "Mood" tab in navigation opens mood tracker view
      - Active tab highlighted to show current view
      - Navigation transition smooth without jarring reloads

    AC2: Mood Type Selection Interface
      - Today's mood selector displays 5 buttons (loved, happy, content, thoughtful, grateful) with icons
      - Each mood button shows distinct icon from lucide-react library
      - Mood button animates with scale + color feedback on selection (Framer Motion)
      - Selected mood button visually highlighted

    AC3: Optional Note Input
      - Optional note field with max 200 characters (enforced by MoodEntrySchema from Story 5.5)
      - Character count displayed (e.g., "142/200")
      - Text area styling consistent with app theme

    AC4: Save Mood Entry
      - "Log Mood" button enabled after mood type selection
      - Save button stores mood entry locally to IndexedDB via MoodService
      - Success feedback shown (toast or animation) after successful save
      - Mood appears in local state immediately (optimistic UI via Zustand)

    AC5: One Mood Per Day Constraint
      - Can only log one mood per day (edit if logging again same day)
      - If mood already exists for today, pre-populate form with existing values
      - Save button text changes to "Update Mood" when editing existing mood

    AC6: Local Storage via IndexedDB
      - MoodService extends BaseIndexedDBService&lt;MoodEntry&gt; (Story 5.3 pattern)
      - IndexedDB `moods` object store contains entry with: id, userId, moodType, note, timestamp, synced=false
      - `by-date` index created for fast date-based queries
      - Mood entry persists across browser sessions

    AC7: Sync Status Indicator
      - UI shows if mood synced successfully or pending (offline indicator)
      - Display sync status icon or text (e.g., "Pending sync" when offline)
      - Sync happens in background when online (Story 6.4 will implement sync)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>MoodEntry Data Model</section>
        <snippet>MoodEntry interface with id, userId, moodType enum (loved, happy, content, thoughtful, grateful), note (max 500 chars), timestamp, synced boolean, supabaseId. MoodService extends BaseIndexedDBService pattern with getMoodForDate, getMoodsInRange methods.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>MoodTracker Component Design</section>
        <snippet>Component structure: 5 mood type buttons with lucide-react icons (Heart=loved, Smile=happy, Meh=content, ThoughtBubble=thoughtful, Sparkles=grateful), optional note input, Framer Motion scale+color animations on selection, form submission handler calling addMoodEntry Zustand action.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 6: Interactive Connection Features - Story 6.2</section>
        <snippet>Mood tracking UI with 5 mood types, local IndexedDB storage, optional notes, one mood per day constraint, sync status indicator. Prerequisites: Epic 1 complete (stable foundation).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Service Layer - BaseIndexedDBService Pattern</section>
        <snippet>All IndexedDB services extend BaseIndexedDBService&lt;T&gt; generic class. Shared methods: add, get, getAll, update, delete, clear, getPage. Abstract methods: getStoreName, _doInit. Services implement store-specific logic, base class handles CRUD, error handling, initialization guard.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>State Management - Zustand Store Slicing</section>
        <snippet>State organized into feature slices: messagesSlice, photosSlice, settingsSlice, navigationSlice, moodSlice. Each slice exports StateCreator function, integrated into main useAppStore via composition. Persistence via Zustand middleware to LocalStorage.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/5-5-centralize-input-validation-layer.md</path>
        <title>Story 5.5: Centralize Input Validation Layer</title>
        <section>MoodEntrySchema Implementation</section>
        <snippet>MoodEntrySchema validates: date (ISO YYYY-MM-DD regex), mood type enum (loved, happy, content, thoughtful, grateful), note (max 200 chars, optional). Located in src/validation/schemas.ts lines 160-164. Use .parse() for strict validation with clear error messages.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/validation/schemas.ts</path>
        <kind>validation-schema</kind>
        <symbol>MoodEntrySchema</symbol>
        <lines>160-164</lines>
        <reason>Story 5.5 implemented MoodEntrySchema for runtime validation. Validates date format (YYYY-MM-DD), mood type enum, note max 200 chars. Use in MoodService add/update methods.</reason>
      </artifact>
      <artifact>
        <path>src/validation/errorMessages.ts</path>
        <kind>utility</kind>
        <symbol>isValidationError, formatZodError, getFieldErrors</symbol>
        <lines>1-100</lines>
        <reason>Error handling utilities from Story 5.5. Transform ZodError into user-friendly ValidationError with fieldErrors Map for field-specific error display in UI forms.</reason>
      </artifact>
      <artifact>
        <path>src/services/BaseIndexedDBService.ts</path>
        <kind>base-service</kind>
        <symbol>BaseIndexedDBService&lt;T&gt;</symbol>
        <lines>1-239</lines>
        <reason>Story 5.3 base class pattern. MoodService will extend this, implementing getStoreName() returning 'moods', _doInit() creating moods store with by-date index. Inherits add, get, getAll, update, delete, clear methods.</reason>
      </artifact>
      <artifact>
        <path>src/services/photoStorageService.ts</path>
        <kind>service-reference</kind>
        <symbol>PhotoStorageService</symbol>
        <lines>1-239</lines>
        <reason>Reference implementation for extending BaseIndexedDBService. Shows pattern: getStoreName, _doInit with index creation, service-specific methods (getPage, getStorageSize), singleton export.</reason>
      </artifact>
      <artifact>
        <path>src/stores/slices/messagesSlice.ts</path>
        <kind>store-slice-reference</kind>
        <symbol>createMessagesSlice</symbol>
        <lines>1-300</lines>
        <reason>Reference pattern for Zustand slice creation. Shows StateCreator typing, state structure, action implementations, cross-slice dependencies (uses settings). MoodSlice should follow this pattern.</reason>
      </artifact>
      <artifact>
        <path>src/stores/slices/moodSlice.ts</path>
        <kind>store-slice</kind>
        <symbol>createMoodSlice</symbol>
        <lines>1-64</lines>
        <reason>Existing moodSlice with basic addMoodEntry and getMoodForDate. Story 6.2 Task 2 will extend this with: syncStatus state, updateMoodEntry action, IndexedDB integration via MoodService instead of direct state mutation.</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store-main</kind>
        <symbol>useAppStore</symbol>
        <lines>1-100</lines>
        <reason>Main Zustand store composing all slices. MoodSlice integration point via spread operator. Persistence middleware applied for LocalStorage sync.</reason>
      </artifact>
      <artifact>
        <path>src/components/AdminPanel/CreateMessageForm.tsx</path>
        <kind>component-reference</kind>
        <symbol>CreateMessageForm</symbol>
        <lines>1-200</lines>
        <reason>Reference for form component with validation error handling. Shows pattern: error state (textError, fieldError), isValidationError check, field-specific error display, character counter, Framer Motion modal animations.</reason>
      </artifact>
      <artifact>
        <path>src/components/Navigation/BottomNavigation.tsx</path>
        <kind>component</kind>
        <symbol>BottomNavigation</symbol>
        <lines>1-44</lines>
        <reason>Current navigation component with Home and Photos tabs. Task 4 will add Mood tab here. Follow existing pattern: lucide-react icons, active state styling (text-pink-500), data-testid attributes, flex layout.</reason>
      </artifact>
      <artifact>
        <path>src/components/PhotoEditModal/PhotoEditModal.tsx</path>
        <kind>component-reference</kind>
        <symbol>PhotoEditModal</symbol>
        <lines>1-250</lines>
        <reason>Reference for modal form with validation. Shows pattern: Framer Motion modal wrapper, backdrop click handler, form state management, validation error display with red borders, character counter for text fields.</reason>
      </artifact>
    </code>

    <dependencies>
      <framework name="React" version="19.1.1">Core UI framework for component-based architecture</framework>
      <framework name="TypeScript" version="5.9.3">Type-safe development and compile-time validation</framework>
      <library name="Zustand" version="5.0.8">Lightweight state management with persistence middleware</library>
      <library name="Framer Motion" version="12.23.24">Declarative animations for button feedback and transitions</library>
      <library name="lucide-react" version="latest">Icon library for mood type icons (Heart, Smile, Meh, Sparkles, etc.)</library>
      <library name="idb" version="8.0.3">IndexedDB wrapper for MoodService implementation</library>
      <library name="Zod" version="3.x">Runtime validation via MoodEntrySchema from Story 5.5</library>
      <library name="Tailwind CSS" version="3.4.18">Utility-first CSS for component styling</library>
    </dependencies>
  </artifacts>

  <constraints>
    <technical>
      - Must extend BaseIndexedDBService&lt;MoodEntry&gt; pattern from Story 5.3 (no code duplication)
      - Must use MoodEntrySchema from Story 5.5 for validation (date, mood type, note max 200 chars)
      - Must follow Zustand slice pattern from Story 5.1 (StateCreator typing, action/state separation)
      - Must use Framer Motion for animations (same library as Photo Carousel)
      - Must use lucide-react for mood icons (already in dependencies)
      - Must create by-date index on moods object store for efficient query performance (&lt;100ms)
      - Schema version bump: v4 → v5 for new moods object store
    </technical>
    <architectural>
      - Component structure: MoodTracker (main), MoodButton (reusable button with icon+animation), MoodNoteInput (note input with character counter)
      - Service layer: MoodService extends BaseIndexedDBService, implements getStoreName, _doInit, getMoodForDate, getMoodsInRange
      - State management: Extend moodSlice with syncStatus state, updateMoodEntry action, IndexedDB integration
      - Validation: Apply MoodEntrySchema at service boundary before IndexedDB writes (same pattern as PhotoStorageService)
      - Error handling: Use isValidationError and formatZodError from Story 5.5 for field-specific error display
    </architectural>
    <performance>
      - Must maintain &lt;2s load time on 3G (NFR001)
      - Must function fully offline except sync features (NFR002)
      - Must support mobile viewports 320px-428px (NFR004)
      - IndexedDB query time: &lt;100ms for mood retrieval via by-date index
      - Animation frame rate: 60fps for Framer Motion button feedback transitions
    </performance>
    <offline-first>
      - All mood tracking features work without network
      - Sync happens in background when online (Story 6.4)
      - synced: false by default in Story 6.2
      - Graceful degradation: show "Pending sync" indicator when offline
    </offline-first>
  </constraints>

  <interfaces>
    <interface>
      <name>MoodEntry (TypeScript Interface)</name>
      <kind>data-model</kind>
      <signature>
        interface MoodEntry {
          id?: number; // Auto-increment (IndexedDB)
          userId: string; // Hardcoded for single-user
          moodType: 'loved' | 'happy' | 'content' | 'thoughtful' | 'grateful';
          note?: string; // Optional, max 200 chars
          date: string; // ISO date string (YYYY-MM-DD)
          timestamp: Date; // Full timestamp when logged
          synced: boolean; // Always false in Story 6.2
          supabaseId?: string; // Null until Story 6.4
        }
      </signature>
      <path>src/types/index.ts</path>
    </interface>
    <interface>
      <name>MoodService API</name>
      <kind>service-class</kind>
      <signature>
        class MoodService extends BaseIndexedDBService&lt;MoodEntry&gt; {
          protected getStoreName(): string; // Returns 'moods'
          protected _doInit(): Promise&lt;void&gt;; // Creates moods store with by-date index
          getMoodForDate(date: Date): Promise&lt;MoodEntry | null&gt;;
          getMoodsInRange(start: Date, end: Date): Promise&lt;MoodEntry[]&gt;;
          // Inherited: add, get, getAll, update, delete, clear from BaseIndexedDBService
        }
      </signature>
      <path>src/services/moodService.ts</path>
    </interface>
    <interface>
      <name>MoodSlice Zustand Store</name>
      <kind>zustand-slice</kind>
      <signature>
        interface MoodSlice {
          // State
          moods: MoodEntry[];
          syncStatus: { pendingMoods: number; isOnline: boolean };

          // Actions
          addMoodEntry(mood: MoodType, note?: string): Promise&lt;void&gt;;
          getMoodForDate(date: string): MoodEntry | undefined;
          updateMoodEntry(date: string, updates: Partial&lt;MoodEntry&gt;): Promise&lt;void&gt;;
        }
      </signature>
      <path>src/stores/slices/moodSlice.ts</path>
    </interface>
    <interface>
      <name>BottomNavigation Props (Extended)</name>
      <kind>component-props</kind>
      <signature>
        interface BottomNavigationProps {
          currentView: 'home' | 'photos' | 'mood'; // Added 'mood'
          onViewChange: (view: 'home' | 'photos' | 'mood') =&gt; void;
        }
      </signature>
      <path>src/components/Navigation/BottomNavigation.tsx</path>
    </interface>
    <interface>
      <name>MoodEntrySchema (Zod Validation)</name>
      <kind>validation-schema</kind>
      <signature>
        const MoodEntrySchema = z.object({
          date: IsoDateStringSchema, // YYYY-MM-DD regex + date validity check
          mood: z.enum(['loved', 'happy', 'content', 'thoughtful', 'grateful']),
          note: z.string().max(200).optional().or(z.literal('')),
        });
      </signature>
      <path>src/validation/schemas.ts (lines 160-164)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest with fake-indexeddb for IndexedDB mocking. Service tests cover CRUD operations, edge cases, validation failures. Achieve 80%+ coverage for services and utilities. E2E tests use Playwright for browser automation with data-testid selectors.
    </standards>
    <locations>
      tests/unit/services/moodService.test.ts
      tests/unit/stores/slices/moodSlice.test.ts
      tests/e2e/mood-tracker.spec.ts
    </locations>
    <ideas>
      <test ac="AC1" description="Navigate to Mood tab, verify MoodTracker renders correctly">
        E2E: Click Mood tab → assert data-testid="mood-tracker" visible → assert active tab styling applied
      </test>
      <test ac="AC2" description="Select mood type, verify button animation and selection state">
        E2E: Click mood button → verify Framer Motion animation plays → verify button highlighted → verify form state updated
      </test>
      <test ac="AC3" description="Enter note with character counter, verify max length enforcement">
        E2E: Type 200 chars → verify counter shows "0/200" → type 1 more char → verify prevented by MoodEntrySchema validation
      </test>
      <test ac="AC4" description="Save mood entry, verify IndexedDB storage and optimistic UI">
        E2E: Select mood → enter note → click "Log Mood" → verify success feedback → verify mood in IndexedDB → verify mood in Zustand state
      </test>
      <test ac="AC5" description="Log mood twice same day, verify form pre-populates and button changes to Update">
        E2E: Log mood → navigate away → return to Mood tab → verify form pre-populated → verify button text "Update Mood" → update mood → verify IndexedDB updated
      </test>
      <test ac="AC6" description="Verify by-date index query performance and persistence">
        Unit: MoodService.getMoodForDate benchmark &lt;100ms → E2E: Log mood → refresh page → verify mood persists from IndexedDB
      </test>
      <test ac="AC7" description="Verify sync status indicator displays correctly">
        E2E: Log mood offline → verify "Pending sync" indicator → go online → verify indicator updates (Story 6.4 will implement actual sync)
      </test>
      <test validation="MoodEntrySchema" description="Verify validation enforces max 200 chars, valid date, valid mood type">
        Unit: MoodEntrySchema.parse with invalid inputs → assert throws ZodError with field-specific messages → verify formatZodError transforms correctly
      </test>
      <test service="MoodService" description="Verify CRUD operations, error handling, quota exceeded">
        Unit: MoodService.add → assert IndexedDB entry created → MoodService.get → assert correct entry returned → MoodService.update → assert entry updated → MoodService.delete → assert entry removed → Test quota exceeded error handling
      </test>
    </ideas>
  </tests>
</story-context>

<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.3</storyId>
    <title>Photo Carousel with Animated Transitions</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-3-photo-carousel-with-animated-transitions.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>to view photos in a full-screen carousel</iWant>
    <soThat>I can enjoy photos in detail with smooth animations</soThat>
    <tasks>
- Task 1: Create PhotoCarousel Component (AC: 4.3.1, 4.3.3, 4.3.4, 4.3.5)
  - Subtask 1.1: Create component file src/components/PhotoCarousel/PhotoCarousel.tsx
  - Subtask 1.2: Implement full-screen overlay layout (fixed position, z-index: 50, backdrop)
  - Subtask 1.3: Connect to Zustand selectedPhotoId state (conditional render when not null)
  - Subtask 1.4: Load selected photo from photos array using selectedPhotoId
  - Subtask 1.5: Implement photo display with optimal sizing (object-fit: contain, max 100vw/100vh)
  - Subtask 1.6: Display caption and tags below photo (conditional rendering based on existence)
  - Subtask 1.7: Implement close functionality (X button calls clearPhotoSelection())
  - Subtask 1.8: Add data-testid attributes for E2E testing

- Task 2: Implement Swipe Navigation with Framer Motion (AC: 4.3.2, 4.3.7, 4.3.9)
  - Subtask 2.1: Wrap photo in motion.div with drag="x" enabled
  - Subtask 2.2: Implement onDragEnd handler with 50px threshold logic
  - Subtask 2.3: Track currentIndex state for navigation (useState hook)
  - Subtask 2.4: Implement navigatePrev() and navigateNext() functions
  - Subtask 2.5: Configure spring transition: stiffness: 300, damping: 30, duration: 300ms
  - Subtask 2.6: Add AnimatePresence with mode="wait" for enter/exit animations
  - Subtask 2.7: Implement exit animation (slide + fade: x: direction * 300, opacity: 0)
  - Subtask 2.8: Implement entrance animation (slide + fade: x: -direction * 300 → 0, opacity: 1)
  - Subtask 2.9: Set dragConstraints dynamically based on currentIndex (boundary detection)
  - Subtask 2.10: Configure dragElastic = 0.2 for boundary bounce effect

- Task 3: Implement Keyboard Navigation (AC: 4.3.6)
  - Subtask 3.1: Add useEffect hook to listen for keydown events
  - Subtask 3.2: Handle ArrowLeft key → navigatePrev()
  - Subtask 3.3: Handle ArrowRight key → navigateNext()
  - Subtask 3.4: Handle Escape key → clearPhotoSelection() (close carousel)
  - Subtask 3.5: Clean up event listeners in useEffect return
  - Subtask 3.6: Implement focus trap (optional enhancement for accessibility)

- Task 4: Create PhotoCarouselControls Component (AC: 4.3.8)
  - Subtask 4.1: Create component file src/components/PhotoCarousel/PhotoCarouselControls.tsx
  - Subtask 4.2: Implement top bar layout (fixed position, semi-transparent backdrop)
  - Subtask 4.3: Add Edit button with Pencil icon (Lucide Edit) - disabled state
  - Subtask 4.4: Add Delete button with Trash icon (Lucide Trash2) - disabled state
  - Subtask 4.5: Add Close button with X icon (Lucide X) - functional
  - Subtask 4.6: Style disabled buttons (opacity: 0.5, cursor: not-allowed)
  - Subtask 4.7: Add tooltips for Edit/Delete: "Coming in Story 4.4" (optional)

- Task 5: Extend Zustand Store with Carousel Actions (AC: 4.3.5)
  - Subtask 5.1: Add clearPhotoSelection() action - sets selectedPhotoId to null
  - Subtask 5.2: Optional: Add navigateToPhoto(id) action for direct photo selection in carousel
  - Subtask 5.3: Verify selectPhoto(id) action exists from Story 4.2 (no changes needed)

- Task 6: Implement Blob URL Management (AC: 4.3.3)
  - Subtask 6.1: Create blob URL in useEffect when photo changes: URL.createObjectURL(photo.imageBlob)
  - Subtask 6.2: Store blob URL in local state (useState<string>)
  - Subtask 6.3: Implement useEffect cleanup to revoke blob URL (prevent memory leaks)
  - Subtask 6.4: Handle blob URL creation errors gracefully (try/catch)

- Task 7: Integrate PhotoCarousel into App Rendering (AC: 4.3.1)
  - Subtask 7.1: Update App.tsx to conditionally render PhotoCarousel
  - Subtask 7.2: Render logic: if selectedPhotoId !== null, mount PhotoCarousel
  - Subtask 7.3: Ensure PhotoCarousel renders on top of PhotoGallery (z-index layering)
  - Subtask 7.4: Test navigation: Grid → Carousel → Close → Grid flow

- Task 8: Create E2E Test Suite for Carousel (AC: All)
  - Subtask 8.1: Create tests/e2e/photo-carousel.spec.ts
  - Subtask 8.2: Test: Tap grid photo opens carousel with correct photo
  - Subtask 8.3: Test: Swipe left/right navigates between photos (touch simulation)
  - Subtask 8.4: Test: Keyboard navigation (ArrowLeft, ArrowRight, Escape)
  - Subtask 8.5: Test: Close button closes carousel
  - Subtask 8.6: Test: Caption and tags displayed correctly
  - Subtask 8.7: Test: Photo displays at optimal size (aspect ratio preserved)
  - Subtask 8.8: Test: Edit/Delete buttons visible but disabled
  - Subtask 8.9: Test: Boundary constraints (elastic bounce at first/last photo)
  - Subtask 8.10: Visual test: Animations smooth (manual inspection + Performance trace)
    </tasks>
  </story>

  <acceptanceCriteria>
AC-4.3.1: Tap Grid Photo Opens Full-Screen Carousel
- PhotoGallery's onClick handler calls selectPhoto(photo.id)
- selectedPhotoId state triggers PhotoCarousel mount
- Carousel renders as full-screen overlay (fixed position, z-index: 50)
- Semi-transparent backdrop (bg-black/80) behind carousel
- Initial photo displayed is the tapped photo from grid

AC-4.3.2: Swipe Left/Right Navigates Between Photos
- Framer Motion drag="x" enables horizontal dragging
- Threshold: swipe >50px to trigger navigation
- Left swipe (offset.x < -50) → navigate to next photo (index++)
- Right swipe (offset.x > 50) → navigate to previous photo (index--)
- Spring transition: type: 'spring', stiffness: 300, damping: 30

AC-4.3.3: Photo Displayed at Optimal Size
- CSS: object-fit: contain (never crop photo)
- Max dimensions: 100vw width, 100vh height (minus UI chrome)
- Centered horizontally and vertically
- No distortion or stretching

AC-4.3.4: Caption and Tags Displayed Below Photo
- Caption: displayed as h3 or p text, white color, centered
- Tags: displayed as pills/badges with rounded corners, muted color
- Layout: Caption above tags, both centered below photo
- No caption: show only tags (if present)
- No tags: show only caption (if present)

AC-4.3.5: Close Button Exits Carousel
- Close button: X icon (Lucide X) in top-right corner
- Click handler: calls clearPhotoSelection() action
- clearPhotoSelection() sets selectedPhotoId to null
- Exit animation: fade out + scale down (200ms)
- Swipe down gesture: vertical drag >100px downward closes carousel

AC-4.3.6: Keyboard Navigation Works
- Arrow Right → navigate to next photo
- Arrow Left → navigate to previous photo
- Escape → close carousel
- Focus trap: keyboard focus stays within carousel while open

AC-4.3.7: Framer Motion Animations Smooth and Polished
- Entrance animation: fade in + scale (0.95 → 1), 300ms
- Exit animation: fade out + scale (1 → 0.95), 200ms
- Swipe transition: slide (x: ±300px) with spring physics, 300ms
- Spring config: { type: 'spring', stiffness: 300, damping: 30 }
- No janky animations: 60fps maintained

AC-4.3.8: Edit and Delete Buttons Visible in Carousel
- Top bar: fixed position at top, semi-transparent backdrop
- Edit button: Pencil icon (Lucide Edit) - disabled state
- Delete button: Trash icon (Lucide Trash2) - disabled state
- Buttons styled but disabled (opacity: 0.5, cursor: not-allowed)
- Close button (X) positioned to the right of Edit/Delete

AC-4.3.9: Drag Constraints Prevent Over-Scroll
- At first photo (index 0): dragConstraints.right = 100px, left = 0
- At last photo: dragConstraints.left = -100px, right = 0
- Mid-range photos: dragConstraints = { left: -100, right: 100 }
- dragElastic = 0.2 (subtle bounce effect at boundaries)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact path="docs/tech-spec-epic-4.md" title="Epic 4 Technical Specification" section="Story 4.3: Photo Carousel">
        Comprehensive technical spec for carousel implementation. Includes PhotoCarousel component API (lines 232-277), Framer Motion swipe gestures with drag="x" and spring transitions (stiffness: 300, damping: 30), carousel navigation workflows (lines 335-387), and performance requirements (300ms smooth transitions at 60fps).
      </artifact>
      <artifact path="docs/tech-spec-epic-4.md" title="Epic 4 Technical Specification" section="Framer Motion Integration">
        Detailed Framer Motion implementation pattern for carousel. AnimatePresence mode="wait", motion.div with drag constraints, onDragEnd handler with 50px threshold, exit/enter animations with spring physics. Same pattern as Epic 3 swipe navigation from DailyMessage.
      </artifact>
      <artifact path="docs/epics.md" title="Epic 4: Photo Gallery & Memories" section="Story 4.3">
        User story and acceptance criteria summary (lines 473-488). Full-screen carousel with swipe left/right navigation, 300ms smooth transitions, caption/tags display, keyboard navigation (arrow keys, Escape), Edit/Delete buttons visible but disabled until Story 4.4.
      </artifact>
      <artifact path="docs/epics.md" title="Epic 3: Message Library Expansion" section="Story 3.2: Swipe Navigation">
        Swipe navigation patterns from Epic 3 (lines 319-333). Demonstrates horizontal swipe gestures (left for previous, right for next), 300ms ease-out transitions, touch and trackpad support, keyboard navigation. Directly applicable pattern for photo carousel swipe implementation.
      </artifact>
      <artifact path="docs/architecture.md" title="Architecture Document" section="State Management - Zustand">
        Zustand store architecture patterns (lines 208-244). Single store pattern, persist middleware usage, state management best practices. Photo carousel will extend useAppStore with selectedPhotoId state and clearPhotoSelection() action.
      </artifact>
      <artifact path="docs/architecture.md" title="Architecture Document" section="Animations - Framer Motion">
        Framer Motion patterns for animations (lines 414-415). GPU-accelerated animations, spring physics for natural motion. Used for DailyMessage entrance animations and swipe transitions. Photo carousel should follow same animation patterns for consistency.
      </artifact>
    </docs>
    <code>
      <artifact path="src/stores/useAppStore.ts" kind="store" symbol="useAppStore" lines="46-109" reason="Photo state (photos, selectedPhotoId) and gallery actions (loadPhotos, selectPhoto) from Story 4.2. Need to add clearPhotoSelection() action for Story 4.3 carousel close functionality.">
        Zustand store with photo state slice. Contains selectedPhotoId: number | null for carousel tracking, selectPhoto(photoId) action for opening carousel (Story 4.2), and photos: Photo[] array. Need to implement clearPhotoSelection() to set selectedPhotoId to null when carousel closes.
      </artifact>
      <artifact path="src/components/PhotoGallery/PhotoGallery.tsx" kind="component" symbol="PhotoGallery" lines="1-227" reason="Grid view component from Story 4.2 that calls selectPhoto() when photo is tapped. Demonstrates integration pattern for opening carousel. PhotoCarousel will be conditionally rendered based on selectedPhotoId state.">
        Photo gallery grid that renders PhotoGridItem components. Uses selectPhoto() from useAppStore when photo is clicked, which sets selectedPhotoId to trigger carousel mount. PhotoCarousel component will render as sibling/overlay when selectedPhotoId !== null.
      </artifact>
      <artifact path="src/services/photoStorageService.ts" kind="service" symbol="photoStorageService" lines="108-204" reason="Photo data access layer with getById(), getAll(), and getPage() methods. Carousel uses getById() if needed, but primarily reads from Zustand photos array already loaded by PhotoGallery.">
        Singleton service for IndexedDB photo operations. Provides getById(photoId) for loading individual photos (if needed), though carousel typically reads from photos array in Zustand state. No new service methods needed for Story 4.3.
      </artifact>
      <artifact path="src/types/index.ts" kind="types" symbol="Photo" lines="21-32" reason="Photo interface defines the data structure carousel will display. Contains imageBlob, caption, tags, uploadDate, dimensions, and compression metadata.">
        Photo type: { id: number, imageBlob: Blob, caption?: string, tags: string[], uploadDate: Date, width: height, mimeType, originalSize, compressedSize }. Carousel displays caption and tags, renders imageBlob with URL.createObjectURL(), and uses dimensions for aspect ratio.
      </artifact>
      <artifact path="src/components/PhotoGallery/PhotoGridItem.tsx" kind="component" reason="Grid item component showing existing photo display patterns. Demonstrates blob URL handling with URL.createObjectURL() and proper cleanup. Carousel should follow same blob URL patterns.">
        PhotoGridItem shows how to render Photo blobs using URL.createObjectURL(photo.imageBlob) and proper cleanup in useEffect. Carousel should use same pattern but with full-screen display instead of thumbnail sizing.
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="framer-motion" version="^12.23.24">AnimatePresence, motion.div, drag gestures, spring transitions for carousel swipe navigation and animations</package>
        <package name="lucide-react" version="^0.548.0">Icons for carousel UI - Edit (Pencil), Delete (Trash2), Close (X)</package>
        <package name="zustand" version="^5.0.8">State management - photos array, selectedPhotoId, actions (selectPhoto, clearPhotoSelection)</package>
        <package name="idb" version="^8.0.3">IndexedDB wrapper used by photoStorageService (no direct carousel usage)</package>
        <package name="react" version="^19.1.1">React 19 for component rendering</package>
        <package name="tailwindcss" version="^3.4.18">Styling for full-screen overlay, backdrop, controls, responsive design</package>
      </node>
      <frameworks>
        <framework name="React 19">Component-based UI with hooks (useState, useEffect, useCallback for carousel navigation logic)</framework>
        <framework name="TypeScript">Type-safe development - Photo, PhotoCarouselProps interfaces</framework>
        <framework name="Vite">Build tool - no changes needed, carousel bundled with existing build</framework>
      </frameworks>
    </dependencies>
  </artifacts>

  <constraints>
- Component Co-location: Create src/components/PhotoCarousel/ directory parallel to PhotoGallery
- State Management: Extend Zustand useAppStore with clearPhotoSelection() action
- No New Services: Use existing photoStorageService and photos state from Story 4.2
- Framer Motion Patterns: Reuse Epic 3 swipe navigation patterns (same spring physics: stiffness: 300, damping: 30)
- Blob URL Management: Use URL.createObjectURL() for display, revoke in useEffect cleanup to prevent memory leaks
- Animation Performance: 300ms smooth transitions at 60fps, GPU-accelerated transforms only
- Keyboard Navigation: Essential for accessibility - ArrowLeft, ArrowRight, Escape keys
- Focus Management: Implement focus trap to prevent tab navigation outside carousel
- ARIA Attributes: role="dialog", aria-modal="true", aria-label="Photo carousel" for accessibility
- No Component Lazy Loading: All components bundled (single-view SPA architecture)
- Offline-First: All carousel operations work offline, photos loaded from IndexedDB
- Edit/Delete Buttons: Visible but disabled (opacity: 0.5, cursor: not-allowed) until Story 4.4
  </constraints>
  <interfaces>
    <interface name="Photo (from types/index.ts)" kind="type" signature="{ id: number; imageBlob: Blob; caption?: string; tags: string[]; uploadDate: Date; width: number; height: number; mimeType: string; originalSize: number; compressedSize: number; }" path="src/types/index.ts">
      Photo data structure displayed in carousel. imageBlob rendered with URL.createObjectURL(), caption and tags shown below photo, dimensions used for aspect ratio calculation.
    </interface>
    <interface name="selectPhoto(photoId: number)" kind="zustand-action" signature="(photoId: number) => void" path="src/stores/useAppStore.ts:968-971">
      Existing action from Story 4.2 that sets selectedPhotoId in Zustand state. PhotoGallery calls this when photo is tapped, triggers PhotoCarousel mount. No changes needed for Story 4.3.
    </interface>
    <interface name="clearPhotoSelection()" kind="zustand-action" signature="() => void" path="NEW - Story 4.3">
      New action to implement in useAppStore. Sets selectedPhotoId to null, triggering PhotoCarousel unmount and return to PhotoGallery grid. Called by carousel Close button, Escape key, and swipe-down gesture.
    </interface>
    <interface name="photoStorageService.getById(photoId)" kind="service-method" signature="async (photoId: number) => Promise&lt;Photo | null&gt;" path="src/services/photoStorageService.ts:188-204">
      Retrieves single photo from IndexedDB. Carousel typically doesn't need this as photos array already loaded, but available if needed for data refresh scenarios.
    </interface>
    <interface name="Framer Motion drag API" kind="library-api" signature="drag=&quot;x&quot;, dragConstraints, dragElastic, onDragEnd">
      Horizontal drag gestures for swipe navigation. Same pattern as Epic 3 DailyMessage swipe (Story 3.2). onDragEnd with info.offset.x threshold (±50px) triggers navigatePrev/Next.
    </interface>
  </interfaces>
  <tests>
    <standards>
      Testing framework: Playwright ^1.56.1 for E2E tests
      Test location: tests/e2e/ directory
      Test pattern: photo-carousel.spec.ts with 6+ test cases
      Coverage: AC-4.3.1 through AC-4.3.9 (all acceptance criteria)
      Browsers: Chromium, Firefox, WebKit (cross-browser validation)
      Test helpers: uploadTestPhoto(), getPhotoCount(), clearPhotos() from tests/support/helpers/
      Data fixtures: tests/fixtures/photos.ts with test images (small.jpg, large.jpg, etc.)
    </standards>
    <locations>
      tests/e2e/photo-carousel.spec.ts (new test suite for Story 4.3)
      tests/fixtures/test-photo-small.jpg (800×600, 150KB test fixture)
      tests/fixtures/test-photo-large.jpg (4032×3024, 3.2MB test fixture)
      tests/support/helpers/photoHelpers.ts (existing photo test utilities)
    </locations>
    <ideas>
      Test 1 (AC-4.3.1): Upload 3 photos, tap second photo in grid, verify carousel opens showing that photo, verify selectedPhotoId=2 in state
      Test 2 (AC-4.3.2): Open carousel on photo #2, swipe left (simulate touch drag), verify navigates to photo #3 with 300ms smooth transition
      Test 3 (AC-4.3.2): Open carousel, swipe right, verify navigates to previous photo with reverse slide animation
      Test 4 (AC-4.3.3): Display photos of different aspect ratios (landscape, portrait, square), verify all maintain aspect ratio and fill screen appropriately
      Test 5 (AC-4.3.4): Upload photos with/without captions and tags, verify caption and tags displayed correctly (or hidden if missing)
      Test 6 (AC-4.3.5): Open carousel, click Close button (X icon), verify carousel closes and PhotoGallery visible again, verify selectedPhotoId=null
      Test 7 (AC-4.3.6): Open carousel, press ArrowRight key, verify navigates to next photo, press ArrowLeft, verify navigates back, press Escape, verify closes
      Test 8 (AC-4.3.7): Visual validation - manually inspect animations are smooth (300ms spring transitions), record Performance trace to verify 60fps
      Test 9 (AC-4.3.8): Open carousel, verify Edit and Delete buttons visible in top bar but disabled (opacity: 0.5, cursor: not-allowed)
      Test 10 (AC-4.3.9): Open carousel on first photo, attempt swipe right, verify elastic bounce (stays on first photo), same for last photo swipe left
    </ideas>
  </tests>
</story-context>

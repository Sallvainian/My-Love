<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.5</storyId>
    <title>Photo Gallery Navigation Integration</title>
    <status>drafted</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-5-photo-gallery-navigation-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>seamless navigation between Home and Photos</iWant>
    <soThat>I can easily access my photo memories</soThat>
    <tasks>
- Task 1: Create TopNavigation Component (AC: 4.5.1, 4.5.2)
  - Subtask 1.1: Create component file src/components/TopNavigation/TopNavigation.tsx
  - Subtask 1.2: Implement navigation bar layout (fixed header, flex row, 2 tabs)
  - Subtask 1.3: Add Home tab with House icon (Lucide) and "Home" label
  - Subtask 1.4: Add Photos tab with Camera icon (Lucide) and "Photos" label
  - Subtask 1.5: Implement active tab highlighting (conditional styling based on currentView)
  - Subtask 1.6: Add onClick handlers to call setView('home') and setView('photos')
  - Subtask 1.7: Add ARIA attributes for accessibility (aria-label, aria-current)
  - Subtask 1.8: Add data-testid attributes for E2E testing

- Task 2: Extend Zustand Store with View State (AC: 4.5.2, 4.5.3, 4.5.5, 4.5.6)
  - Subtask 2.1: Add currentView state to useAppStore ('home' | 'photos', default: 'home')
  - Subtask 2.2: Add setView(view) action that updates currentView and calls pushState()
  - Subtask 2.3: Add navigateHome() and navigatePhotos() convenience actions
  - Subtask 2.4: Implement URL routing logic in setView (pushState with / or /photos)
  - Subtask 2.5: Add popstate event listener to sync currentView on browser back/forward
  - Subtask 2.6: Implement initial route detection on app mount (parse pathname, set initial view)

- Task 3: Implement View Switching in App.tsx (AC: 4.5.3)
  - Subtask 3.1: Import TopNavigation, DailyMessage, PhotoGallery components
  - Subtask 3.2: Subscribe to currentView from Zustand store
  - Subtask 3.3: Conditional rendering: {currentView === 'home' ? &lt;DailyMessage /&gt; : &lt;PhotoGallery /&gt;}
  - Subtask 3.4: Add TopNavigation component above conditional view rendering
  - Subtask 3.5: Optional: Add fade transition wrapper (Framer Motion AnimatePresence)
  - Subtask 3.6: Test view switching (Home ↔ Photos) works correctly

- Task 4: Implement Deep Linking and Browser History (AC: 4.5.5, 4.5.6)
  - Subtask 4.1: Implement window.history.pushState() in setView() action
  - Subtask 4.2: Add window.addEventListener('popstate') in App.tsx useEffect
  - Subtask 4.3: Parse window.location.pathname on mount to set initial view
  - Subtask 4.4: Handle unknown paths (redirect to Home or show 404 toast)
  - Subtask 4.5: Test deep linking: Navigate directly to /photos, verify PhotoGallery loads
  - Subtask 4.6: Test browser back/forward buttons, verify view syncs correctly

- Task 5: Add Photo Count Badge (AC: 4.5.4 - Optional)
  - Subtask 5.1: Create Badge component (small circle with number display)
  - Subtask 5.2: Subscribe to photos.length from Zustand in TopNavigation
  - Subtask 5.3: Conditionally render badge on Photos tab if photos.length &gt; 0
  - Subtask 5.4: Position badge at top-right of Camera icon
  - Subtask 5.5: Style badge (white text, primary background, 16px diameter)
  - Subtask 5.6: Handle large counts (&gt; 99 show "99+")
  - Subtask 5.7: Add aria-label with count for accessibility

- Task 6: Style TopNavigation for Responsive Design (AC: 4.5.1, 4.5.2)
  - Subtask 6.1: Mobile layout (&lt;640px): Icon-only tabs, no labels
  - Subtask 6.2: Desktop layout (≥640px): Icons + labels below
  - Subtask 6.3: Active tab styling: Primary color (blue-600), bold text, larger icon
  - Subtask 6.4: Inactive tab styling: Muted color (gray-500), normal weight
  - Subtask 6.5: Smooth transition on hover (200ms) and active state change
  - Subtask 6.6: Ensure navigation bar fixed at top (z-index: 40, no scroll)

- Task 7: Create E2E Test Suite for Navigation (AC: All)
  - Subtask 7.1: Create tests/e2e/navigation.spec.ts
  - Subtask 7.2: Test: TopNavigation renders with Home and Photos tabs
  - Subtask 7.3: Test: Click Photos tab, verify PhotoGallery displays and tab highlighted
  - Subtask 7.4: Test: Click Home tab, verify DailyMessage displays and tab highlighted
  - Subtask 7.5: Test: Deep linking - navigate to /photos directly, verify PhotoGallery loads
  - Subtask 7.6: Test: Browser back button - Home → Photos → Back → returns to Home
  - Subtask 7.7: Test: Browser forward button - redo navigation after back
  - Subtask 7.8: Test: Photo count badge displays correct count (if implemented)
  - Subtask 7.9: Test: Smooth transitions between views (no flash, no reload)
  - Subtask 7.10: Test: Unknown paths redirect to Home or show 404
    </tasks>
  </story>

  <acceptanceCriteria>
AC-4.5.1: Top Navigation Bar Includes Photos Tab with Camera Icon
- TopNavigation component renders as fixed header (z-index: 40, below modals)
- Home tab: House icon from Lucide (Home component)
- Photos tab: Camera icon from Lucide (Camera component)
- Tab labels: "Home" and "Photos" text below icons (or icon-only on mobile)
- Responsive design: Icons only on mobile (&lt;640px), icons + labels on desktop
- Accessible: aria-label for each tab ("Navigate to Home", "Navigate to Photos")
- Click/tap handlers: onClick triggers setView() Zustand action

AC-4.5.2: Active Tab Highlighted to Show Current View
- Active tab styling: Primary color (blue-600), bold text, larger icon, or underline indicator
- Inactive tab styling: Muted color (gray-500), normal weight text
- State tracking: Zustand currentView state determines active tab
- Visual feedback: Smooth transition (200ms) when switching tabs
- Clear contrast: Active vs inactive state immediately recognizable
- Accessibility: aria-current="page" on active tab for screen readers

AC-4.5.3: Navigation Transitions Smoothly Between Home and Photos
- Instant view switching: No full page reload, just component swap
- Fade transition (optional): Fade out current view (200ms), fade in new view (200ms)
- State preservation: Switching views preserves app state (photos array, settings, etc.)
- No network requests: All data already loaded (offline-first)
- Scroll position reset: New view starts at top (scroll Y = 0)
- Loading indicators: None needed (instant switching) unless lazy loading components
- Performance: View switch completes in &lt; 100ms

AC-4.5.4: Photo Count Badge on Photos Tab (Optional Enhancement)
- Badge displays photos.length from Zustand photos state
- Position: Top-right corner of Photos tab icon
- Styling: Small circle (16px diameter), white text on primary color background
- Updates automatically: Reactively updates when photos added/deleted
- Only shows if &gt; 0 photos: Badge hidden if no photos uploaded
- Max display: If &gt; 99 photos, show "99+" to prevent overflow
- Accessible: aria-label includes count ("23 photos uploaded")

AC-4.5.5: Deep Linking Supported - Direct URL Access to Photo Gallery
- URL routing: / → Home view, /photos → Photo Gallery view
- Initial route detection: Parse window.location.pathname on app mount
- Set initial view: If pathname === '/photos', setView('photos') on mount
- Update browser history: setView() calls window.history.pushState() to update URL
- State consistency: currentView state matches URL pathname at all times
- Shareable links: /photos URL can be shared and works when opened in new tab
- 404 handling: Unknown paths default to Home view (/), optionally show "not found" toast

AC-4.5.6: Browser Back Button Works Correctly
- History management: Each setView() calls pushState() to add history entry
- popstate event listener: Listen for browser back/forward, sync currentView
- Correct navigation flow: Start at Home (/) → Navigate to Photos (/photos) → Back button → Home (/)
- State synchronization: popstate event updates Zustand currentView to match URL
- No broken states: View always matches URL pathname after navigation
- Forward button: Works correctly after back (redo navigation)
- External links: If user came from external site, back button exits app (normal behavior)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Story 4.5: Photo Gallery Navigation Integration</section>
        <snippet>Story 4.5 implements top navigation integration with Photos tab, active state highlighting, smooth transitions, deep linking support, and browser history management. Navigation uses native Browser History API (pushState/replaceState) for lightweight routing without react-router dependency.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Traceability Mapping - AC-4.5.1 through AC-4.5.6</section>
        <snippet>AC-4.5.1: Navigation integration with Photos tab and camera icon. AC-4.5.2: Active tab highlighting. AC-4.5.3: Smooth transitions without reloads. AC-4.5.4: Photo count badge (optional). AC-4.5.5: Deep linking to /photos. AC-4.5.6: Browser back button support.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Project Architecture</title>
        <section>State Management - Zustand with Persistence</section>
        <snippet>Centralized state management using Zustand 5.0.8 with persistence middleware. State updates follow pattern: User Action → Component → Zustand Store Action → Service Layer → IndexedDB/LocalStorage. Persisted state includes settings, onboarding status, message history, and moods.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Project Architecture</title>
        <section>Data Flow Pattern</section>
        <snippet>Component-based SPA with offline-first architecture. Data flow: User Action → Component → Zustand Store Action → Service Layer → IndexedDB/LocalStorage → State Update → Component Re-render. Example: toggleFavorite updates IndexedDB, Zustand state, and LocalStorage in sequence.</snippet>
      </doc>
      <doc>
        <path>docs/stories/4-4-photo-edit-delete-functionality.md</path>
        <title>Story 4.4 Learnings</title>
        <section>Completed Implementation</section>
        <snippet>Photo gallery fully functional with upload, grid, carousel, edit, and delete. 14 comprehensive E2E tests. PhotoGallery at src/components/PhotoGallery/PhotoGallery.tsx ready for integration. Z-index layering: Carousel (50), Edit Modal (60), Delete Dialog (70) → Navigation should be (40).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>state-management</kind>
        <symbol>AppState</symbol>
        <lines>28-113</lines>
        <reason>Zustand store interface that needs extension with currentView state and navigation actions (setView, navigateHome, navigatePhotos). Existing photo state (photos, selectedPhotoId) and actions (uploadPhoto, updatePhoto, deletePhoto) are complete.</reason>
      </artifact>
      <artifact>
        <path>src/App.tsx</path>
        <kind>component</kind>
        <symbol>App</symbol>
        <lines>1-264</lines>
        <reason>Main application component that needs modification to add TopNavigation component and conditional view rendering (Home vs Photos) based on currentView state from Zustand.</reason>
      </artifact>
      <artifact>
        <path>src/components/PhotoGallery/PhotoGallery.tsx</path>
        <kind>component</kind>
        <symbol>PhotoGallery</symbol>
        <lines>26-249</lines>
        <reason>Complete photo gallery component from Story 4.2-4.4. Ready for integration into navigation system. No changes needed - will be conditionally rendered when currentView === 'photos'.</reason>
      </artifact>
      <artifact>
        <path>src/components/PhotoCarousel/PhotoCarousel.tsx</path>
        <kind>component</kind>
        <symbol>PhotoCarousel</symbol>
        <lines>1-300</lines>
        <reason>Full-screen carousel component with swipe navigation, edit/delete functionality. Z-index 50. Complete from Story 4.3. No changes needed for navigation integration.</reason>
      </artifact>
      <artifact>
        <path>tests/e2e/navigation.spec.ts</path>
        <kind>test</kind>
        <symbol>navigation tests</symbol>
        <lines>1-50</lines>
        <reason>Existing navigation test patterns using Playwright fixtures. Shows testing approach: theme switching, LocalStorage persistence validation, programmatic store manipulation for testing.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="react" version="^19.1.1">Core UI framework</package>
        <package name="react-dom" version="^19.1.1">React rendering</package>
        <package name="zustand" version="^5.0.8">State management with persistence</package>
        <package name="framer-motion" version="^12.23.24">Animations and transitions (optional for fade effects)</package>
        <package name="lucide-react" version="^0.548.0">Icon library (House icon for Home, Camera icon for Photos)</package>
        <package name="typescript" version="~5.9.3">Type-safe development</package>
        <package name="vite" version="^7.1.7">Build tool and dev server</package>
      </node>
      <testing>
        <package name="@playwright/test" version="^1.56.1">E2E testing framework</package>
      </testing>
      <styling>
        <package name="tailwindcss" version="^3.4.18">Utility-first CSS</package>
      </styling>
    </dependencies>
  </artifacts>

  <constraints>
1. NO new dependencies - Use native Browser History API (pushState/replaceState), no react-router
2. NO react-router library - Lightweight two-view navigation doesn't justify routing library overhead
3. Z-index layering - TopNavigation must be z-index 40 (below modals: Carousel 50, Edit Modal 60, Delete Dialog 70)
4. Zustand state pattern - Follow existing action patterns (simple state updates, IndexedDB integration where needed)
5. Component organization - Create src/components/TopNavigation/ parallel to PhotoGallery/, PhotoCarousel/
6. Accessibility required - ARIA labels, aria-current="page", keyboard navigation (Tab key cycles, Enter activates)
7. Responsive design - Mobile (&lt;640px): icon-only tabs. Desktop (≥640px): icons + labels
8. State preservation - View switching must preserve all app state (photos array, settings, favorites)
9. No page reloads - Instant view switching via component swap, no full browser reload
10. Testing pattern - Follow existing Playwright E2E patterns from tests/e2e/navigation.spec.ts
11. Project-relative paths only - All file references must be relative to project root (no absolute paths)
12. Offline-first - No network requests for navigation, all data already loaded
  </constraints>
  <interfaces>
    <interface>
      <name>AppState.currentView</name>
      <kind>Zustand state property</kind>
      <signature>currentView: 'home' | 'photos'</signature>
      <path>src/stores/useAppStore.ts</path>
      <notes>NEW property to add. Default: 'home'. Tracks active view for conditional rendering.</notes>
    </interface>
    <interface>
      <name>AppState.setView</name>
      <kind>Zustand action</kind>
      <signature>setView: (view: 'home' | 'photos') =&gt; void</signature>
      <path>src/stores/useAppStore.ts</path>
      <notes>NEW action to add. Updates currentView and calls window.history.pushState() to sync URL. Path: '/' for home, '/photos' for photos.</notes>
    </interface>
    <interface>
      <name>AppState.navigateHome</name>
      <kind>Zustand action</kind>
      <signature>navigateHome: () =&gt; void</signature>
      <path>src/stores/useAppStore.ts</path>
      <notes>NEW convenience action. Wrapper for setView('home').</notes>
    </interface>
    <interface>
      <name>AppState.navigatePhotos</name>
      <kind>Zustand action</kind>
      <signature>navigatePhotos: () =&gt; void</signature>
      <path>src/stores/useAppStore.ts</path>
      <notes>NEW convenience action. Wrapper for setView('photos').</notes>
    </interface>
    <interface>
      <name>window.history.pushState</name>
      <kind>Browser History API</kind>
      <signature>pushState(state: any, title: string, url?: string | null): void</signature>
      <path>Native browser API</path>
      <notes>Used in setView() to update URL without page reload. Call with: pushState({ view }, '', '/' or '/photos').</notes>
    </interface>
    <interface>
      <name>window.addEventListener('popstate')</name>
      <kind>Browser History API event</kind>
      <signature>addEventListener('popstate', handler: (event: PopStateEvent) =&gt; void): void</signature>
      <path>Native browser API</path>
      <notes>Listen for browser back/forward button. Handler syncs currentView state with window.location.pathname.</notes>
    </interface>
    <interface>
      <name>TopNavigation component</name>
      <kind>React component (NEW)</kind>
      <signature>TopNavigation: React.FC&lt;{}></signature>
      <path>src/components/TopNavigation/TopNavigation.tsx</path>
      <notes>NEW component to create. Renders Home and Photos tabs with icons, active state highlighting, onClick handlers calling setView().</notes>
    </interface>
  </interfaces>
  <tests>
    <standards>
Epic 4 leverages existing Playwright E2E infrastructure from Epic 2. Tests validate full user journeys with real IndexedDB and browser interactions (not mocked). Framework: Playwright 1.56.1 with custom fixtures at tests/support/fixtures/baseFixture.ts. Test approach: Integration tests over unit tests, focus on critical paths (happy path + error scenarios). Execution: npm run test:e2e (all browsers: Chromium, Firefox, WebKit) or npx playwright test --headed for debugging. Pattern: Use page.evaluate() for programmatic store manipulation, getLocalStorageItem() helper for persistence validation, data-testid attributes for element selection.
    </standards>
    <locations>
tests/e2e/*.spec.ts - All E2E test suites
tests/e2e/navigation.spec.ts - Navigation and theme switching tests (existing, needs extension for Photos tab)
tests/support/fixtures/baseFixture.ts - Custom Playwright fixtures
tests/support/helpers/pwaHelpers.ts - LocalStorage and PWA test helpers
    </locations>
    <ideas>
      <idea ac="AC-4.5.1">
Test: TopNavigation component renders with Home and Photos tabs
- Verify Home tab exists with House icon (Lucide)
- Verify Photos tab exists with Camera icon (Lucide)
- Verify tab labels "Home" and "Photos" visible on desktop (≥640px)
- Verify icon-only on mobile (&lt;640px)
- Use data-testid="top-navigation", "home-tab", "photos-tab"
      </idea>
      <idea ac="AC-4.5.2">
Test: Active tab highlighting shows current view
- Navigate to Home → verify Home tab has active styling (blue-600, bold, or underline)
- Navigate to Photos → verify Photos tab has active styling
- Verify inactive tabs have muted styling (gray-500)
- Check aria-current="page" attribute on active tab
      </idea>
      <idea ac="AC-4.5.3">
Test: Smooth transitions between Home and Photos
- Click Photos tab → verify PhotoGallery component visible, DailyMessage hidden
- Click Home tab → verify DailyMessage visible, PhotoGallery hidden
- Verify no page reload (check window.location.href doesn't change origin)
- Verify state preserved: Upload photo, switch to Home, return to Photos, verify photo still there
- Performance: Verify transition completes in &lt; 100ms using performance.now()
      </idea>
      <idea ac="AC-4.5.4">
Test: Photo count badge displays correctly (optional)
- Upload 5 photos → verify Photos tab shows "5" badge
- Upload 10 more → verify badge updates to "15"
- Delete all photos → verify badge disappears
- Upload 150 photos → verify badge shows "99+"
- Check badge position (top-right of Camera icon)
- Verify aria-label includes count ("15 photos uploaded")
      </idea>
      <idea ac="AC-4.5.5">
Test: Deep linking to /photos URL
- Navigate directly to /photos → verify PhotoGallery loads, Photos tab active
- Navigate directly to / → verify DailyMessage loads, Home tab active
- Open /photos in new tab → verify PhotoGallery loads correctly
- Test unknown path /unknown → verify redirects to / or shows 404 toast
- Verify URL bar updates when switching tabs (/ ↔ /photos)
      </idea>
      <idea ac="AC-4.5.6">
Test: Browser back button navigation
- Start at Home (/) → Navigate to Photos (/photos) → Back button → verify returns to Home
- Start at Photos (/photos) → Navigate to Home (/) → Back button → verify returns to Photos
- Complex flow: Home → Photos → Home → Photos → Back 3 times → verify correct history
- Forward button: Back twice, forward once → verify correct view
- Verify currentView state syncs with URL after back/forward
- No infinite loops or broken states
      </idea>
      <idea ac="All">
Test: Accessibility and keyboard navigation
- Tab key cycles through Home and Photos tabs
- Enter key activates selected tab
- Screen reader announces tab labels and active state
- Focus outline visible on keyboard navigation
- Verify aria-label attributes present on all tabs
      </idea>
    </ideas>
  </tests>
</story-context>

<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.4</storyId>
    <title>Admin Interface - Custom Message Management (Phase 1: UI)</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-4-admin-interface-custom-message-management-phase-1-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>the app creator (Frank)</asA>
    <iWant>an admin settings panel to manage custom messages</iWant>
    <soThat>I can add personalized messages to the rotation library</soThat>
    <tasks>
      <!-- Tasks derived from acceptance criteria and implementation requirements -->
      <task id="1">Create AdminPanel top-level component with route detection</task>
      <task id="2">Implement MessageList component with filtering (365 default + custom messages)</task>
      <task id="3">Build CreateMessageForm modal with text area, category dropdown, validation</task>
      <task id="4">Build EditMessageForm modal with pre-populated data</task>
      <task id="5">Implement Delete confirmation dialog</task>
      <task id="6">Extend Zustand store with customMessages slice (LocalStorage persistence)</task>
      <task id="7">Update App.tsx with admin route detection logic</task>
      <task id="8">Apply consistent theme styling with Framer Motion animations</task>
      <task id="9">Add data-testid attributes for testing (Epic 2 patterns)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.4.1" priority="critical">
      <title>Admin Route Access</title>
      <description>Admin panel accessible via /admin route with optional password protection or hidden URL pattern</description>
      <validation>
        - Access admin panel via http://localhost:5173/My-Love/admin
        - Admin panel renders full-screen, replacing DailyMessage component
        - If password-protected: prompt appears before panel access
        - If hidden route: direct URL access works, no navigation link in main UI
      </validation>
    </criterion>
    <criterion id="AC-3.4.2" priority="critical">
      <title>Message List Display with Filtering</title>
      <description>Display all messages (365 default + custom) with category filter dropdown</description>
      <validation>
        - Display in table/grid: Message Text (truncated 100 chars), Category, Actions columns
        - Category filter: All, Reasons, Memories, Affirmations, Future Plans, Custom
        - Filter updates list in real-time (no page reload)
        - Custom messages marked with "Custom" badge
        - Scrollable list (virtualization optional)
      </validation>
    </criterion>
    <criterion id="AC-3.4.3" priority="high">
      <title>Create New Message Button</title>
      <description>Button opens CreateMessageForm modal for creating new message</description>
      <validation>
        - Button prominently placed (top-right or above MessageList)
        - Click opens CreateMessageForm modal
        - Modal has backdrop overlay (click outside doesn't close)
        - Close/cancel button closes modal
      </validation>
    </criterion>
    <criterion id="AC-3.4.4" priority="high">
      <title>Edit and Delete Buttons Per Message</title>
      <description>Each message row has visible Edit and Delete buttons</description>
      <validation>
        - Edit button opens EditMessageForm modal with pre-populated data
        - Delete button shows confirmation dialog
        - Icons preferred: pencil (edit), trash (delete)
        - Hover states for better UX
      </validation>
    </criterion>
    <criterion id="AC-3.4.5" priority="critical">
      <title>Create Message Form Functionality</title>
      <description>Form collects text (1-500 chars), category (required), enables save/cancel</description>
      <validation>
        - Text area: max 500 chars, required, show character count
        - Category dropdown: Reasons, Memories, Affirmations, Future Plans, Custom
        - Empty text → disable Save button
        - Successful save → message appears in MessageList immediately
        - Cancel → closes without saving
      </validation>
    </criterion>
    <criterion id="AC-3.4.6" priority="critical">
      <title>Edit Message Form Functionality</title>
      <description>Form displays existing data and allows updates</description>
      <validation>
        - Text area pre-populated with existing message text
        - Category dropdown pre-selected with existing category
        - Save validates and updates LocalStorage
        - Cancel discards changes
      </validation>
    </criterion>
    <criterion id="AC-3.4.7" priority="high">
      <title>Consistent Theme Styling</title>
      <description>UI matches existing app theme and styling across all admin components</description>
      <validation>
        - Tailwind CSS consistent with DailyMessage component
        - Framer Motion animations for modal open/close
        - Color scheme matches selected theme (Sunset Bliss, Ocean Dreams, etc.)
        - Responsive design: works on mobile (375px) and desktop
        - Typography matches app font family and sizes
      </validation>
    </criterion>
    <criterion id="AC-3.4.8" priority="critical">
      <title>Temporary LocalStorage Persistence</title>
      <description>Data persists to LocalStorage (not IndexedDB yet) using key 'my-love-custom-messages'</description>
      <validation>
        - Create/edit/delete operations persist to LocalStorage
        - Data structure: id (auto-increment), text, category, isCustom, createdAt, updatedAt
        - Close admin panel and reopen → messages persisted
        - DevTools Application → LocalStorage → verify entries
      </validation>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Custom Message Management (FR026-FR030)</section>
        <snippet>FR026: System SHALL allow admin user (you) to review AI-generated message suggestions. FR027: System SHALL provide accept/decline interface for message curation. FR028: System SHALL enable creation of custom messages with category selection. FR029: System SHALL allow editing of existing messages in library. FR030: System SHALL integrate approved custom messages into daily rotation algorithm.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-3.md</path>
        <title>Epic 3 Technical Specification</title>
        <section>Story 3.4 Design - Admin Interface UI</section>
        <snippet>Story 3.4 builds the foundational UI for custom message management with temporary LocalStorage persistence. Includes AdminPanel component, MessageList with filtering (365 default + custom), CreateMessageForm and EditMessageForm modals with validation (1-500 chars), Delete confirmation dialog. Uses Zustand store extension with customMessages slice, follows existing patterns from DailyMessage component for consistency.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Component-Based Architecture & State Management</section>
        <snippet>Component pattern: App → ErrorBoundary → DailyMessage (main view). Single-page architecture without routing library (single main view). State management via Zustand with persist middleware for LocalStorage integration. Component structure follows co-location pattern in src/components/[ComponentName]/. IndexedDB schema includes messages object store with indexes by-category and by-date.</snippet>
      </doc>
      <doc>
        <path>docs/state-management.md</path>
        <title>State Management Documentation</title>
        <section>Zustand Store Patterns</section>
        <snippet>Store location: src/stores/useAppStore.ts. Uses persist middleware with partialize strategy to select which state persists to LocalStorage. Store name: 'my-love-storage'. Pattern: create persist middleware wrapping state and actions. Type safety via create&lt;AppState&gt;(). Actions should be synchronous for state updates, async only for I/O operations.</snippet>
      </doc>
      <doc>
        <path>docs/component-inventory.md</path>
        <title>Component Inventory</title>
        <section>DailyMessage Component (Patterns to Follow)</section>
        <snippet>Location: src/components/DailyMessage/DailyMessage.tsx. Features: Uses useAppStore hooks for state, Framer Motion animations (card entrance, floating hearts burst), Tailwind CSS styling with theme integration, responsive design mobile-first. Component structure includes Header, Message Card with Category Badge, Action Buttons (favorite, share), Decorative Hearts animation. Props: None (uses global store).</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-3-add-data-testid-attributes.md</path>
        <title>Testing Patterns - data-testid Convention</title>
        <section>Epic 2 Testing Standards</section>
        <snippet>Naming convention: [component]-[element]-[action]. Examples: 'message-favorite-button', 'message-card', 'settings-partner-name-input'. All interactive elements require data-testid attributes for test stability. Use getByTestId() in Playwright tests. Naming pattern ensures resilience to styling changes and refactoring.</snippet>
      </doc>
      <doc>
        <path>docs/stories/3-3-message-history-state-management.md</path>
        <title>Related Story - Message History State Management</title>
        <section>State Management Patterns</section>
        <snippet>Story 3.3 established patterns for extending Zustand store with new slices. Successfully integrated messageHistory slice with LocalStorage persistence via partialize. Map serialization/deserialization patterns work well for complex data structures. Console logging format: '[ComponentName] Action: details'. Follow same pattern for customMessages slice in Story 3.4.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>state-management</kind>
        <symbol>useAppStore</symbol>
        <lines>1-99</lines>
        <reason>Zustand store pattern to extend with customMessages slice. Uses persist middleware with partialize strategy for LocalStorage. Existing state includes messages, messageHistory, currentMessage. Story 3.4 will add customMessages state and CRUD actions following same patterns.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>type-definitions</kind>
        <symbol>Message, MessageCategory, MessageHistory</symbol>
        <lines>1-66</lines>
        <reason>Core type definitions. Message interface includes id, text, category, isCustom, createdAt, isFavorite. MessageCategory type defines 5 categories: reason, memory, affirmation, future, custom. Story 3.4 will use these types for custom message CRUD operations.</reason>
      </artifact>
      <artifact>
        <path>src/App.tsx</path>
        <kind>application-root</kind>
        <symbol>App</symbol>
        <lines>1-104</lines>
        <reason>Main app structure pattern. Currently renders ErrorBoundary → DailyMessage (single-view SPA, no routing library). Story 3.4 will add admin route detection logic here to conditionally render AdminPanel component when URL includes '/admin'.</reason>
      </artifact>
      <artifact>
        <path>src/components/DailyMessage/DailyMessage.tsx</path>
        <kind>component</kind>
        <symbol>DailyMessage</symbol>
        <lines>1-79</lines>
        <reason>Reference component for patterns to follow. Uses useAppStore hooks (destructured state/actions), Framer Motion for animations (motion.div, handleDragEnd), Tailwind CSS styling, data-testid attributes for testing. AdminPanel should follow same patterns for consistency.</reason>
      </artifact>
      <artifact>
        <path>src/data/defaultMessages.ts</path>
        <kind>data</kind>
        <symbol>defaultMessages</symbol>
        <lines>-</lines>
        <reason>365-message library established in Story 3.1. Contains default messages with structure {id, text, category, isCustom: false, createdAt}. AdminPanel MessageList will display these alongside custom messages.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>react</package>
        <version>19.1.1</version>
        <usage>Component framework - JSX, hooks (useState, useEffect)</usage>
      </node>
      <node>
        <package>zustand</package>
        <version>5.0.8</version>
        <usage>State management - create store, persist middleware</usage>
      </node>
      <node>
        <package>framer-motion</package>
        <version>12.23.24</version>
        <usage>Animations - motion.div, AnimatePresence for modal animations</usage>
      </node>
      <node>
        <package>tailwindcss</package>
        <version>3.4.18</version>
        <usage>Utility-first CSS - component styling, theme integration</usage>
      </node>
      <node>
        <package>lucide-react</package>
        <version>latest</version>
        <usage>Icons - Pencil (edit), Trash (delete), Plus (create) icons for admin UI</usage>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>No routing library - Single-view SPA. Admin route detection must use URL pathname checking (window.location.pathname.includes('/admin')), not React Router. Conditional rendering in App.tsx based on route state.</constraint>
    <constraint>LocalStorage persistence for Phase 1 only. Custom messages stored in LocalStorage with key 'my-love-custom-messages' (separate from main Zustand persist store). Story 3.5 will migrate to IndexedDB without changing component interfaces.</constraint>
    <constraint>Follow DailyMessage component patterns exactly: Zustand hooks (destructured state/actions), Framer Motion animations, Tailwind CSS utility classes, responsive mobile-first design, data-testid attributes on all interactive elements.</constraint>
    <constraint>data-testid naming convention REQUIRED (Epic 2 standard): [component]-[element]-[action]. Examples: 'admin-create-button', 'admin-message-list', 'admin-edit-form', 'admin-delete-confirm'.</constraint>
    <constraint>Console logging format (Story 3.3 pattern): '[AdminPanel] Created message ID: 366, category: custom'. Use for debugging during development, remove in production.</constraint>
    <constraint>Message validation: Text 1-500 characters, category required (dropdown), empty text disables Save button. Character counter displays remaining chars.</constraint>
    <constraint>Theme consistency: Admin panel MUST respect currently selected theme (Sunset Bliss, Ocean Dreams, etc.). Use CSS custom properties (--color-primary, --color-secondary) defined by applyTheme utility.</constraint>
    <constraint>Offline-first architecture: Admin panel must work fully offline after initial load. No backend API calls. All CRUD operations local to browser storage.</constraint>
    <constraint>Component co-location pattern: Create src/components/AdminPanel/ directory with all admin components inside (AdminPanel.tsx, MessageList.tsx, CreateMessageForm.tsx, EditMessageForm.tsx).</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>CustomMessage</name>
      <kind>TypeScript interface</kind>
      <signature>interface CustomMessage { id: number; text: string; category: MessageCategory; isCustom: boolean; createdAt: string; updatedAt?: string; }</signature>
      <path>src/types/index.ts</path>
      <usage>Data structure for custom messages in LocalStorage. Auto-increment ID, text (1-500 chars), category from MessageCategory type, isCustom always true, ISO timestamp strings for createdAt/updatedAt.</usage>
    </interface>
    <interface>
      <name>customMessages Zustand slice</name>
      <kind>State slice</kind>
      <signature>customMessages: CustomMessage[]; customMessagesLoaded: boolean; loadCustomMessages: () => void; createCustomMessage: (input: CreateMessageInput) => void; updateCustomMessage: (input: UpdateMessageInput) => void; deleteCustomMessage: (id: number) => void;</signature>
      <path>src/stores/useAppStore.ts</path>
      <usage>Extend Zustand store with custom messages state and CRUD actions. loadCustomMessages reads from LocalStorage on init, create/update/delete mutate state and persist to LocalStorage. Add to partialize function for persist middleware.</usage>
    </interface>
    <interface>
      <name>AdminPanel Component</name>
      <kind>React component</kind>
      <signature>function AdminPanel(): JSX.Element</signature>
      <path>src/components/AdminPanel/AdminPanel.tsx</path>
      <usage>Top-level admin panel component. No props (uses global store). Renders AdminHeader, MessageList, CreateMessageForm modal (controlled by isCreateOpen state), EditMessageForm modal (controlled by isEditOpen state).</usage>
    </interface>
    <interface>
      <name>MessageList Component</name>
      <kind>React component</kind>
      <signature>function MessageList(): JSX.Element</signature>
      <path>src/components/AdminPanel/MessageList.tsx</path>
      <usage>Displays all messages (365 default + custom) in table/grid format. Includes FilterBar for category filtering, MessageRow for each entry, Create button at top. Uses useAppStore to access messages and customMessages.</usage>
    </interface>
    <interface>
      <name>Framer Motion modal pattern</name>
      <kind>Animation pattern</kind>
      <signature>AnimatePresence + motion.div with backdrop overlay</signature>
      <path>src/components/DailyMessage/DailyMessage.tsx (reference)</path>
      <usage>Use AnimatePresence for enter/exit animations. motion.div for modal-backdrop (fixed inset-0 bg-black/50). motion.div for modal-content with initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }}.</usage>
    </interface>
  </interfaces>
  <tests>
    <standards>Playwright E2E testing framework established in Epic 2. All interactive elements MUST have data-testid attributes following [component]-[element]-[action] convention. Tests use getByTestId() selectors for stability. Testing patterns from Story 2.3: separate test files per feature, arrange-act-assert structure, browser.newPage() for isolation.</standards>
    <locations>tests/e2e/ directory for Playwright E2E tests. Existing tests: message-history.spec.ts, swipe-navigation.spec.ts. Story 3.4 should add admin-panel.spec.ts covering CRUD operations, filtering, validation, and theme consistency.</locations>
    <ideas>
      <idea ac="AC-3.4.1">Test admin route access: Navigate to /admin URL, verify AdminPanel renders, verify password protection or hidden route logic works.</idea>
      <idea ac="AC-3.4.2">Test MessageList display: Verify 365 default messages load, test category filter (All, Reasons, Memories, etc.), verify custom messages have "Custom" badge.</idea>
      <idea ac="AC-3.4.3">Test Create button: Click Create button, verify CreateMessageForm modal opens with backdrop, verify close/cancel button closes modal.</idea>
      <idea ac="AC-3.4.4">Test Edit/Delete buttons: Click Edit on message row, verify EditMessageForm opens with pre-populated data, click Delete, verify confirmation dialog appears.</idea>
      <idea ac="AC-3.4.5">Test Create form validation: Enter 501 characters, verify error/counter turns red, leave text empty, verify Save disabled, valid input saves and closes modal.</idea>
      <idea ac="AC-3.4.6">Test Edit form functionality: Pre-populated fields correct, edit text and save updates MessageList, cancel discards changes.</idea>
      <idea ac="AC-3.4.7">Test theme consistency: Change theme in main app, open admin panel, verify colors match theme, test modal animations smooth.</idea>
      <idea ac="AC-3.4.8">Test LocalStorage persistence: Create custom message, open DevTools → Application → LocalStorage, verify entry exists, close and reopen admin panel, verify message persists.</idea>
    </ideas>
  </tests>
</story-context>

<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>0.5</storyId>
    <title>Deployment Monitoring & Rollback Strategy</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/0-5-deployment-monitoring-rollback-strategy.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>automated deployment health checks integrated into the CI/CD pipeline</iWant>
    <soThat>failed deployments are caught immediately and rollback procedures are well-defined</soThat>
    <tasks>
### Task 1: Add Health Check Step to GitHub Actions Workflow (AC-0.5.1)
- [ ] 1.1 Review existing .github/workflows/deploy.yml workflow structure
- [ ] 1.2 Add health check job step after deployment completes
- [ ] 1.3 Configure health check timeout and retry logic (60s timeout, 3 attempts with 10s intervals)

### Task 2: Implement HTTP Status Health Check (AC-0.5.2)
- [ ] 2.1 Add curl command to verify site accessibility (https://sallvainian.github.io/My-Love/)
- [ ] 2.2 Add response time validation (< 3 seconds baseline)
- [ ] 2.3 Verify critical assets load successfully (JS bundle, PWA manifest)

### Task 3: Implement Supabase Connection Health Check (AC-0.5.3)
- [ ] 3.1 Create Supabase ping endpoint test script (scripts/health-check-supabase.js)
- [ ] 3.2 Add Supabase health check to workflow
- [ ] 3.3 Handle Supabase connection failures gracefully (exit code 1, clear error messages)

### Task 4: Configure Workflow Failure on Health Check Failure (AC-0.5.4)
- [ ] 4.1 Set health check step to fail workflow on error
- [ ] 4.2 Test health check failure scenario (temporarily modify to fail, verify workflow fails)
- [ ] 4.3 Add clear failure messaging in workflow logs

### Task 5: Document Rollback Procedures (AC-0.5.5)
- [ ] 5.1 Create ROLLBACK.md documentation file (docs/ROLLBACK.md or docs/deployment/ROLLBACK.md)
- [ ] 5.2 Document automated rollback trigger scenarios
- [ ] 5.3 Document manual rollback procedures (3 methods with estimated RTR)
- [ ] 5.4 Add rollback decision tree and troubleshooting guide

### Task 6: Configure Deployment Notifications (Optional) (AC-0.5.6)
- [ ] 6.1 Review GitHub Actions notification options
- [ ] 6.2 Configure notification settings (workflow failure notifications)
- [ ] 6.3 Test notification delivery on workflow failure
- [ ] 6.4 Document notification configuration for team
</tasks>
  </story>

  <acceptanceCriteria>
| AC ID | Criteria | Validation Method |
|-------|----------|-------------------|
| AC-0.5.1 | GitHub Actions workflow includes health check step after deployment | GitHub Actions Workflow File: Verify .github/workflows/deploy.yml contains post-deployment health check step |
| AC-0.5.2 | Health check verifies deployed site returns 200 status code | Workflow Logs: Confirm curl command to https://sallvainian.github.io/My-Love/ returns 200 OK |
| AC-0.5.3 | Health check verifies Supabase connection succeeds (ping API) | Workflow Logs: Confirm Supabase API ping returns successful response |
| AC-0.5.4 | Workflow fails if health check fails (prevents bad deployment) | Test Scenario: Intentionally break health check, verify workflow fails with exit code 1 |
| AC-0.5.5 | Rollback procedure documented and accessible | Documentation: Verify ROLLBACK.md exists with clear step-by-step procedures for all rollback scenarios |
| AC-0.5.6 | Deployment notifications configured (optional) | GitHub Actions: Verify workflow status notifications enabled (in-app or external integration) |
</acceptanceCriteria>

  <artifacts>
    <docs>
<!-- Documentation Artifacts -->
<doc>
  <path>docs/sprint-artifacts/tech-spec-epic-0.md</path>
  <title>Epic 0 Technical Specification - Deployment & Backend Infrastructure</title>
  <section>NFR > Observability > Deployment Monitoring</section>
  <snippet>Post-deployment validation script validates HTTP 200, service worker registration, PWA manifest accessibility, and Supabase connection health. Story 0.5 adds automated health checks to CI workflow with deployment failure notifications.</snippet>
</doc>

<doc>
  <path>docs/sprint-artifacts/tech-spec-epic-0.md</path>
  <title>Epic 0 Technical Specification - Deployment & Backend Infrastructure</title>
  <section>NFR > Reliability > Recovery Strategies</section>
  <snippet>Recovery strategies include: Deployment failure (GitHub Actions re-run), bad deployment (revert to previous GitHub Pages deployment), and Supabase connection loss (exponential backoff retry with 3 attempts, max 30s wait).</snippet>
</doc>

<doc>
  <path>docs/sprint-artifacts/tech-spec-epic-0.md</path>
  <title>Epic 0 Technical Specification - Deployment & Backend Infrastructure</title>
  <section>Detailed Design > Workflows > Deployment Pipeline Sequence</section>
  <snippet>Step 11: Post-deployment validation (Story 0.4) verifies deployment URL responds, checks service worker registration, validates PWA manifest accessible, and tests Supabase connection. Story 0.5 automates this in GitHub Actions workflow.</snippet>
</doc>

<doc>
  <path>docs/architecture.md</path>
  <title>My-Love PWA Architecture</title>
  <section>Deployment Architecture</section>
  <snippet>GitHub Actions CI/CD pipeline builds static assets via npm run build and deploys to GitHub Pages with automatic HTTPS and CDN distribution. Environment variables managed via GitHub Secrets for secure credential handling.</snippet>
</doc>

<doc>
  <path>docs/sprint-artifacts/0-4-production-deployment-validation.md</path>
  <title>Story 0.4: Production Deployment E2E Validation</title>
  <section>Dev Notes > Learnings from Previous Story</section>
  <snippet>Story 0.4 established comprehensive smoke tests suite (scripts/smoke-tests.cjs, 437 lines) with 7 critical checks. Rollback procedures documented with 3 options: git revert (safest), re-run previous workflow, git reset --hard (emergency). Story 0.5 addresses Finding L2: No automated rollback mechanism.</snippet>
</doc>
</docs>

    <code>
<!-- Existing Code Artifacts to Leverage -->
<artifact>
  <path>.github/workflows/deploy.yml</path>
  <kind>workflow</kind>
  <symbol>GitHub Actions Deployment Workflow</symbol>
  <lines>full file</lines>
  <reason>Primary file to modify - add health check step after deployment. Current steps: Checkout, Setup Node, Install deps, Run tests, Build, Deploy. Need to add: Health check step after Deploy, before marking success.</reason>
</artifact>

<artifact>
  <path>scripts/smoke-tests.cjs</path>
  <kind>script</kind>
  <symbol>Smoke Tests Suite</symbol>
  <lines>437 lines total</lines>
  <reason>Leverage patterns for health checks - HTTP status check, asset verification logic, fail-fast validation with actionable error messages. Reuse for GitHub Actions workflow health checks.</reason>
</artifact>

<artifact>
  <path>src/lib/supabase.ts</path>
  <kind>service</kind>
  <symbol>Supabase Client Configuration</symbol>
  <lines>full file</lines>
  <reason>Reference for Supabase connection verification patterns. Contains checkSupabaseConnection() health check function to ping Supabase API. Can be adapted for workflow health check script.</reason>
</artifact>
</code>

    <dependencies>
<!-- Production Dependencies -->
<production>
  <package name="@supabase/supabase-js" version="^2.81.1">Supabase client library for health check script (connection verification)</package>
  <package name="workbox-window" version="^7.3.0">Service worker lifecycle management (verification in health checks)</package>
</production>

<!-- Development Dependencies -->
<development>
  <package name="vite" version="^7.1.7">Build tool - generates dist/ for deployment validation</package>
  <package name="vite-plugin-pwa" version="^1.1.0">PWA plugin - generates manifest.json and service worker for health checks</package>
  <package name="gh-pages" version="^6.3.0">Deploy to GitHub Pages (already in use for Story 0.1)</package>
</development>

<!-- External Services -->
<external>
  <service name="GitHub Actions">CI/CD platform for automated deployment and health checks. Workflow file: .github/workflows/deploy.yml</service>
  <service name="GitHub Pages">Static site hosting target. Deployment URL: https://sallvainian.github.io/My-Love/</service>
  <service name="Supabase">Backend services (Auth, Database, Realtime, Storage). Health check endpoint for connection verification.</service>
</external>

<!-- System Utilities -->
<system>
  <tool name="curl">HTTP client for health checks (available in GitHub Actions runners by default). Used for: site accessibility check (200 OK), response time validation, asset verification.</tool>
  <tool name="Node.js">Runtime for health check scripts (version 20 in GitHub Actions)</tool>
</system>
</dependencies>
  </artifacts>

  <constraints>
<!-- Architecture Patterns and Constraints from Tech Spec and Architecture -->
<architectural>
  <pattern name="Deployment Pipeline">GitHub Actions â†’ GitHub Pages automated deployment on push to main. Health check step must be positioned AFTER GitHub Pages deploy completes but BEFORE workflow success marker.</pattern>
  <pattern name="Failure Handling">Exit code 1 fails the workflow and prevents marking deployment as successful. Health checks must use non-zero exit codes to trigger workflow failure.</pattern>
  <pattern name="Retry Logic">Account for GitHub Pages propagation delay (up to 2 minutes). Health check should retry 3 times with 10-second intervals for robustness.</pattern>
</architectural>

<technology>
  <constraint name="GitHub Actions Runners">curl/wget available by default. Node.js 20 environment. Environment variables accessible via ${{ secrets.VARIABLE_NAME }} syntax.</constraint>
  <constraint name="GitHub Pages">Deployment propagation can take up to 2 minutes. Health check must account for this delay with retry logic.</constraint>
  <constraint name="Supabase Client">Requires VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY environment variables from GitHub Secrets for connection verification.</constraint>
</technology>

<testing>
  <standard name="Smoke Tests Foundation">Leverage patterns from scripts/smoke-tests.cjs - fail-fast validation with actionable error messages. HTTP status check with curl. Asset verification logic.</standard>
  <standard name="Fail-Fast Pattern">Health checks should fail immediately with clear error messages. No silent failures or warnings.</standard>
  <standard name="Validation Testing">Must test health check failure scenario by temporarily modifying health check to fail, verify workflow reports failure, then restore.</standard>
</testing>

<security>
  <constraint name="Environment Variables in Health Check">Ensure VITE_* secrets available in health check step using GitHub Actions ${{ secrets.* }} syntax. Never expose secrets in logs.</constraint>
  <constraint name="Health Check Scope">Health checks should only validate deployment success, not expose sensitive data. Use public endpoints and anon keys only.</constraint>
</security>

<performance>
  <target name="Health Check Execution">Total health check duration < 2 minutes (includes retry logic). Individual checks should complete in < 10 seconds each.</target>
  <target name="Deployment Pipeline">Total CI/CD pipeline execution < 5 minutes from push to deployment availability (Story 0.1 requirement).</target>
</performance>
</constraints>

  <interfaces>
<!-- APIs and Interfaces to Integrate With -->
<api>
  <name>GitHub Actions Workflow API</name>
  <kind>workflow</kind>
  <signature>
steps:
  - name: Health Check
    run: |
      # HTTP status check
      # Supabase connection check
      # Asset verification
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}
  </signature>
  <path>.github/workflows/deploy.yml</path>
</api>

<api>
  <name>curl HTTP Health Check</name>
  <kind>command</kind>
  <signature>curl -f -s -o /dev/null -w "%{http_code}" https://sallvainian.github.io/My-Love/</signature>
  <path>inline in workflow</path>
</api>

<api>
  <name>Supabase Connection Health Check</name>
  <kind>function</kind>
  <signature>
// scripts/health-check-supabase.js
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY
);

async function checkConnection() {
  const { error } = await supabase.from('_health').select('*').limit(1);
  if (error) {
    console.error('Supabase connection failed:', error.message);
    process.exit(1);
  }
  console.log('Supabase connection successful');
  process.exit(0);
}

checkConnection();
  </signature>
  <path>scripts/health-check-supabase.js (to be created)</path>
</api>

<api>
  <name>Smoke Tests Pattern</name>
  <kind>reference</kind>
  <signature>
// From scripts/smoke-tests.cjs
// HTTP check pattern:
const response = await fetch(url);
if (!response.ok) {
  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
}

// Asset verification pattern:
const assetExists = fs.existsSync(assetPath);
if (!assetExists) {
  throw new Error(`Critical asset missing: ${assetPath}`);
}
  </signature>
  <path>scripts/smoke-tests.cjs (reference only)</path>
</api>
</interfaces>

  <tests>
    <standards>
**Testing Framework**: GitHub Actions workflow validation + Manual failure scenario testing

**Key Testing Standards** (from Tech Spec Epic 0):
- **Smoke Tests Foundation**: Leverage patterns from scripts/smoke-tests.cjs (437 lines, 7 critical checks)
- **Fail-Fast Pattern**: Health checks should fail immediately with clear error messages
- **Retry Logic**: Account for GitHub Pages propagation delay (up to 2 minutes)
- **Clear Error Messages**: Provide actionable error messages for troubleshooting

**Test Execution**:
- **Automated**: Health checks run in GitHub Actions workflow after deployment
- **Manual**: Failure scenario testing (intentionally break health check, verify workflow fails)
- **Validation**: Workflow logs confirm health checks execute and report results
    </standards>

    <locations>
.github/workflows/deploy.yml - Health check step (to be added)
scripts/health-check-supabase.js - Supabase connection verification script (to be created)
scripts/smoke-tests.cjs - Reference patterns for health check implementation
docs/ROLLBACK.md - Rollback procedures documentation (to be created)
    </locations>

    <ideas>
<!-- Test Ideas Mapped to Acceptance Criteria -->
<test id="AC-0.5.1" ac="GitHub Actions workflow includes health check step after deployment">
  <description>Verify workflow file contains health check step positioned after deployment</description>
  <method>Unit test: Parse .github/workflows/deploy.yml, verify health check step exists after "Deploy to GitHub Pages" step</method>
  <validation>Step name matches "Health Check" or similar, positioned correctly in workflow sequence</validation>
</test>

<test id="AC-0.5.2" ac="Health check verifies deployed site returns 200 status code">
  <description>Verify HTTP health check succeeds for deployed site</description>
  <method>Integration test: Trigger workflow, check logs for curl command output showing 200 OK from https://sallvainian.github.io/My-Love/</method>
  <validation>Workflow logs show "HTTP 200" or "200 OK" response from deployment URL</validation>
</test>

<test id="AC-0.5.3" ac="Health check verifies Supabase connection succeeds">
  <description>Verify Supabase connection health check succeeds</description>
  <method>Integration test: Run health-check-supabase.js script in workflow with environment variables, verify successful response</method>
  <validation>Script logs "Supabase connection successful" and exits with code 0</validation>
</test>

<test id="AC-0.5.4" ac="Workflow fails if health check fails">
  <description>Verify workflow failure when health check fails</description>
  <method>Manual test: Temporarily modify health check to fail (wrong URL or timeout), trigger workflow, verify it fails with non-zero exit code</method>
  <validation>Workflow status shows "Failed", error message indicates health check failure reason</validation>
</test>

<test id="AC-0.5.5" ac="Rollback procedure documented and accessible">
  <description>Verify rollback documentation exists and is comprehensive</description>
  <method>Manual review: Check docs/ROLLBACK.md exists, contains 3 rollback methods with decision tree and troubleshooting</method>
  <validation>Document includes: git revert method, re-run workflow method, git reset method, decision tree, estimated RTR for each</validation>
</test>

<test id="AC-0.5.6" ac="Deployment notifications configured (optional)">
  <description>Verify deployment notifications enabled</description>
  <method>Manual test: Trigger workflow failure, verify notification received (GitHub in-app or configured external service)</method>
  <validation>Notification received within 1 minute of workflow failure indicating deployment issue</validation>
</test>

<!-- Edge Cases and Error Scenarios -->
<edge-case name="GitHub Pages Propagation Delay">
  <scenario>Deployment succeeds but GitHub Pages takes > 30 seconds to propagate changes</scenario>
  <test>Health check should retry 3 times with 10-second intervals before failing</test>
  <expected>Successful health check after retries, not immediate failure</expected>
</edge-case>

<edge-case name="Supabase Temporary Unavailability">
  <scenario>Supabase API temporarily unavailable during health check</scenario>
  <test>Health check should log clear error message indicating Supabase connection failure</test>
  <expected>Workflow fails with message "Health check failed: Supabase connection unsuccessful" and exit code 1</expected>
</edge-case>

<edge-case name="Missing Environment Variables">
  <scenario>GitHub Secrets missing or incorrectly named for health check</scenario>
  <test>Health check script should validate environment variables present before attempting connection</test>
  <expected>Clear error message: "Missing required env vars: VITE_SUPABASE_URL" with exit code 1</expected>
</edge-case>

<edge-case name="Malformed Health Check Step">
  <scenario>Health check step has syntax error or missing command</scenario>
  <test>GitHub Actions workflow should fail to parse or execute</test>
  <expected>Workflow fails with GitHub Actions syntax error before deployment attempt</expected>
</edge-case>
</ideas>
  </tests>
</story-context>

<story-context id="1-2-supabase-client-provider-configuration" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Supabase Client &amp; Provider Configuration</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/05-Epics-Stories/1-2-supabase-client-provider-configuration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to validate the Supabase client configuration and Zustand store persistence</iWant>
    <soThat>I can ensure the backend connection is properly established and client state persists correctly across sessions</soThat>
    <tasks>
      <task id="1" title="Validate Environment Variable Configuration" acs="AC-1.2.1, AC-1.2.2, AC-1.2.3">
        <subtask id="1.1">Verify .env file exists in project root</subtask>
        <subtask id="1.2">Confirm .gitignore excludes environment files</subtask>
        <subtask id="1.3">Verify VITE_SUPABASE_URL is properly set</subtask>
        <subtask id="1.4">Verify VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY is set</subtask>
        <subtask id="1.5">Security audit: Search for exposed service keys</subtask>
        <subtask id="1.6">Verify .env.example exists with placeholder values</subtask>
      </task>
      <task id="2" title="Validate Supabase Client Initialization" acs="AC-1.2.4">
        <subtask id="2.1">Inspect src/api/supabaseClient.ts client configuration</subtask>
        <subtask id="2.2">Verify client initialization completes without errors</subtask>
        <subtask id="2.3">Test supabase.auth.getSession() call</subtask>
        <subtask id="2.4">Verify auth state change listener works</subtask>
      </task>
      <task id="3" title="Validate Zustand Store Persistence" acs="AC-1.2.5, AC-1.2.6">
        <subtask id="3.1">Inspect Zustand store definitions in src/stores/</subtask>
        <subtask id="3.2">Verify useAppStore persistence configuration</subtask>
        <subtask id="3.3">Verify all relevant stores persist to localStorage</subtask>
        <subtask id="3.4">Test state persistence across page reload</subtask>
        <subtask id="3.5">Verify localStorage keys created (my-love-storage)</subtask>
      </task>
      <task id="4" title="Validate Row Level Security (RLS) Policies" acs="AC-1.2.7">
        <subtask id="4.1">Identify test table for RLS validation</subtask>
        <subtask id="4.2">Test unauthenticated query behavior</subtask>
        <subtask id="4.3">Test authenticated query behavior (if session available)</subtask>
        <subtask id="4.4">Document RLS status</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1.2.1" validation="Code Inspection">VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY accessible via import.meta.env</criterion>
    <criterion id="AC-1.2.2" validation="File Inspection">.env file exists and is listed in .gitignore</criterion>
    <criterion id="AC-1.2.3" validation="Security Audit">No SUPABASE_SERVICE_ROLE_KEY in any VITE_ prefixed variable</criterion>
    <criterion id="AC-1.2.4" validation="Runtime Test">supabase.auth.getSession() returns null or valid Session object (no errors)</criterion>
    <criterion id="AC-1.2.5" validation="Code Inspection">Zustand stores configured with persist middleware (check store source code)</criterion>
    <criterion id="AC-1.2.6" validation="Browser Test">Zustand state survives page reload (store data in localStorage)</criterion>
    <criterion id="AC-1.2.7" validation="API Test">Test query to Supabase table returns 403 (RLS enabled) or filtered data</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/05-Epics-Stories/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Detailed Design, Security" snippet="Contains comprehensive specs for Supabase configuration, Zustand persistence patterns, environment variable contracts, and RLS validation criteria." />
      <doc path="docs/02-Architecture/architecture.md" title="PWA Architecture" section="Technology Stack, Implementation Patterns" snippet="Defines Supabase 2.81+ integration patterns, Zustand store patterns with persist middleware, and authentication flow (magic link via URL redirect)." />
      <doc path="docs/02-Architecture/state-management/store-architecture.md" title="Store Architecture" section="Main Store Composition" snippet="Shows exact pattern for useAppStore with persist middleware, createJSONStorage, and partialize configuration." />
      <doc path="docs/02-Architecture/state-management/persistence-strategy.md" title="Persistence Strategy" section="What Gets Persisted, Hydration Pattern" snippet="Documents which state persists to LocalStorage vs IndexedDB vs Supabase, and onRehydrateStorage callback pattern." />
      <doc path="docs/05-Epics-Stories/1-1-codebase-audit-dependency-validation.md" title="Story 1.1 Reference" section="Dev Notes" snippet="Story 1.1 completed: Build passes, TypeScript zero errors, ESLint warnings resolved. Foundation validated for Story 1.2." />
    </docs>
    <code>
      <file path="src/api/supabaseClient.ts" kind="service" symbol="supabase" lines="64-79" reason="CRITICAL: Supabase client singleton with auth config (persistSession, autoRefreshToken, detectSessionInUrl). Validates env vars on startup." />
      <file path="src/api/supabaseClient.ts" kind="utility" symbol="isSupabaseConfigured" lines="121-123" reason="Helper to check if Supabase env vars are present - useful for validation." />
      <file path="src/stores/useAppStore.ts" kind="store" symbol="useAppStore" lines="75-278" reason="CRITICAL: Main Zustand store with persist middleware, localStorage storage via createJSONStorage, partialize for selective persistence, onRehydrateStorage for validation." />
      <file path="src/stores/slices/settingsSlice.ts" kind="slice" symbol="createSettingsSlice" reason="Settings slice persisted via useAppStore - theme, relationship data, onboarding state." />
      <file path=".gitignore" kind="config" lines="21-26" reason="Confirms .env, .env.local, .env.development, .env.production are excluded from version control." />
      <file path=".env.example" kind="config" lines="1-44" reason="Template with VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY placeholders. Documents that anon key is safe for client exposure." />
      <file path="tests/unit/api/supabaseClient.test.ts" kind="test" reason="Existing unit tests for Supabase client - may need extension for AC validation." />
      <file path="tests/integration/supabase.test.ts" kind="test" reason="Integration tests for Supabase connectivity - useful patterns for RLS testing." />
      <file path="tests/integration/environment.test.ts" kind="test" reason="Environment variable validation tests - reference for AC-1.2.1 patterns." />
    </code>
    <dependencies>
      <ecosystem name="npm">
        <package name="@supabase/supabase-js" version="^2.81.1" purpose="Auth, Database, Realtime backend" />
        <package name="zustand" version="^5.0.8" purpose="Client state management with persistence" />
        <package name="idb" version="^8.0.3" purpose="IndexedDB wrapper for large data storage" />
        <package name="react" version="^19.1.1" purpose="UI framework" />
        <package name="vite" version="^7.2.2" purpose="Build tool with VITE_ env var support" />
        <package name="typescript" version="~5.9.3" purpose="Type safety, strict mode" />
        <package name="vitest" version="^4.0.9" purpose="Unit testing framework" />
        <package name="@playwright/test" version="^1.56.1" purpose="E2E testing framework" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY must be anon key (safe to expose). NEVER use service_role key in VITE_ prefixed variables.</constraint>
    <constraint type="environment">Environment variables MUST use VITE_ prefix for Vite compatibility with import.meta.env.</constraint>
    <constraint type="storage">Zustand persist uses localStorage via createJSONStorage. Large data (photos, custom messages) uses IndexedDB.</constraint>
    <constraint type="pattern">Auth tokens stored in localStorage (acceptable for SPAs per architecture). Supabase handles token refresh automatically.</constraint>
    <constraint type="validation">State validation on hydration - corrupted state is cleared and defaults used. See validateHydratedState() in useAppStore.</constraint>
    <constraint type="architecture">Online-first architecture (NOT offline-first sync). Service worker caches static assets only, API calls are network-first.</constraint>
  </constraints>

  <interfaces>
    <interface name="Supabase Auth Methods" kind="API">
      <signature>supabase.auth.getSession(): Promise&lt;{ data: { session: Session | null }, error: AuthError | null }&gt;</signature>
      <signature>supabase.auth.signInWithOtp({ email, options: { emailRedirectTo } }): Promise&lt;AuthResponse&gt;</signature>
      <signature>supabase.auth.onAuthStateChange(callback): { data: { subscription } }</signature>
      <path>src/api/supabaseClient.ts</path>
    </interface>
    <interface name="Zustand Persist Config" kind="configuration">
      <signature>persist(stateCreator, { name: 'my-love-storage', storage: createJSONStorage(() => localStorage), partialize, onRehydrateStorage })</signature>
      <path>src/stores/useAppStore.ts</path>
    </interface>
    <interface name="Environment Variables" kind="contract">
      <signature>import.meta.env.VITE_SUPABASE_URL: string (https://xxx.supabase.co)</signature>
      <signature>import.meta.env.VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY: string (JWT anon key)</signature>
      <path>src/api/supabaseClient.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest for unit tests with happy-dom environment. Tests in tests/ directory following tests/{unit,integration}/ structure.
      Coverage thresholds: 80% lines, functions, branches, statements.
      Use @testing-library/react for component tests.
      Playwright for E2E tests. Existing supabase integration tests at tests/integration/supabase.test.ts.
    </standards>
    <locations>
      <loc>tests/unit/api/supabaseClient.test.ts</loc>
      <loc>tests/integration/supabase.test.ts</loc>
      <loc>tests/integration/environment.test.ts</loc>
      <loc>tests/unit/stores/settingsSlice.test.ts</loc>
    </locations>
    <ideas>
      <idea ac="AC-1.2.1">Test that import.meta.env.VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY are defined and non-empty strings</idea>
      <idea ac="AC-1.2.2">File system check: .gitignore contains .env patterns; .env.example exists with placeholders</idea>
      <idea ac="AC-1.2.3">grep/search codebase for SUPABASE_SERVICE pattern in any VITE_ prefixed context - should return zero matches</idea>
      <idea ac="AC-1.2.4">Integration test: call supabase.auth.getSession(), verify returns { data: { session: null | Session }, error: null }</idea>
      <idea ac="AC-1.2.5">Code inspection: verify useAppStore uses persist() middleware from zustand/middleware with localStorage</idea>
      <idea ac="AC-1.2.6">Browser test: set state value, reload page, verify state retained in localStorage under 'my-love-storage' key</idea>
      <idea ac="AC-1.2.7">Integration test: query Supabase table without auth context, expect 403 or empty result (not full data dump)</idea>
    </ideas>
  </tests>
</story-context>

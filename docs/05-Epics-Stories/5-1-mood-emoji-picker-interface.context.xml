<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context XML - Generated by BMad Method story-context workflow
  Story: 5-1-mood-emoji-picker-interface
  Generated: 2025-11-25
  User: Frank
-->
<story-context version="1.0">
  <story-metadata>
    <epic-id>5</epic-id>
    <story-id>5.1</story-id>
    <story-title>Mood Emoji Picker Interface</story-title>
    <story-status>drafted</story-status>
    <story-key>5-1-mood-emoji-picker-interface</story-key>
    <story-path>docs/05-Epics-Stories/5-1-mood-emoji-picker-interface.md</story-path>
    <context-generated>2025-11-25</context-generated>
    <generated-by>BMad Method story-context workflow v1.0</generated-by>
  </story-metadata>

  <user-story>
    <format>As a [user], I want [feature], so that [benefit]</format>
    <asA>user</asA>
    <iWant>to select my current mood from a visual emoji grid</iWant>
    <soThat>I can quickly express how I'm feeling to my partner</soThat>
  </user-story>

  <acceptance-criteria>
    <criterion id="AC-5.1.1">
      <description>12 emotion emojis displayed in 3x4 grid layout (6 positive, 6 challenging)</description>
      <testable>true</testable>
    </criterion>
    <criterion id="AC-5.1.2">
      <description>Each emoji has icon, label, and minimum 48px touch target</description>
      <testable>true</testable>
    </criterion>
    <criterion id="AC-5.1.3">
      <description>Selected mood(s) show pink border and scale animation (existing pattern)</description>
      <testable>true</testable>
    </criterion>
    <criterion id="AC-5.1.4">
      <description>Multiple moods can be selected (multi-select mode)</description>
      <testable>true</testable>
    </criterion>
    <criterion id="AC-5.1.5">
      <description>Positive moods grouped separately from challenging moods</description>
      <testable>true</testable>
    </criterion>
    <criterion id="AC-5.1.6">
      <description>Selected moods display summary below grid</description>
      <testable>true</testable>
    </criterion>
  </acceptance-criteria>

  <tasks-breakdown>
    <task id="T-5.1.1">
      <name>Expand MoodType to 12 Emotions</name>
      <description>Update types/index.ts to define all 12 mood types</description>
      <files>
        <file>src/types/index.ts</file>
        <file>src/validation/schemas.ts</file>
      </files>
      <estimate>30min</estimate>
    </task>
    <task id="T-5.1.2">
      <name>Create Supabase Migration</name>
      <description>Add migration for expanded mood_type enum (add 'excited', 'angry')</description>
      <files>
        <file>supabase/migrations/XXX_expand_mood_type_enum.sql</file>
      </files>
      <estimate>30min</estimate>
    </task>
    <task id="T-5.1.3">
      <name>Enhance MoodTracker Grid Layout</name>
      <description>Update grid from 5-column to 3x4 layout with section headers</description>
      <files>
        <file>src/components/MoodTracker/MoodTracker.tsx</file>
      </files>
      <estimate>45min</estimate>
    </task>
    <task id="T-5.1.4">
      <name>Implement Selection Visual Feedback</name>
      <description>Verify pink border and scale animation meet AC-5.1.3 (may already exist)</description>
      <files>
        <file>src/components/MoodTracker/MoodButton.tsx</file>
      </files>
      <estimate>30min</estimate>
    </task>
    <task id="T-5.1.5">
      <name>Add Selected Moods Summary</name>
      <description>Display comma-separated list of selected mood labels below grid</description>
      <files>
        <file>src/components/MoodTracker/MoodTracker.tsx</file>
      </files>
      <estimate>15min</estimate>
    </task>
    <task id="T-5.1.6">
      <name>Verify IndexedDB Schema Compatibility</name>
      <description>Ensure moodService supports new mood types</description>
      <files>
        <file>src/services/moodService.ts</file>
      </files>
      <estimate>15min</estimate>
    </task>
    <task id="T-5.1.7">
      <name>Add Unit and E2E Tests</name>
      <description>Test grid layout, selection behavior, multi-select, summary display</description>
      <files>
        <file>tests/unit/components/MoodTracker.test.tsx</file>
        <file>tests/e2e/mood-tracker.spec.ts</file>
      </files>
      <estimate>1h</estimate>
    </task>
  </tasks-breakdown>

  <relevant-documentation>
    <document type="prd" relevance="high">
      <path>docs/01-PRD/prd.md</path>
      <key-sections>
        <section id="FR22-FR28">Mood Tracking Functional Requirements</section>
      </key-sections>
      <extracted-requirements>
        <requirement id="FR22">User can log current mood from 12 preset emotion emojis</requirement>
        <requirement id="FR23">User can select multiple moods simultaneously</requirement>
        <requirement id="FR24">Each mood emoji displays with icon and label text</requirement>
        <requirement id="FR25">Positive emotions displayed separately from challenging emotions</requirement>
        <requirement id="FR27">Mood selection triggers haptic feedback for tactile confirmation</requirement>
      </extracted-requirements>
    </document>

    <document type="tech-spec" relevance="critical">
      <path>docs/05-Epics-Stories/tech-spec-epic-5.md</path>
      <key-sections>
        <section id="5.1">Story 5.1 Mood Emoji Picker Interface</section>
        <section id="data-models">MoodType enum, MoodEntry interface</section>
        <section id="component-architecture">MoodEmojiPicker component specs</section>
      </key-sections>
      <extracted-specs>
        <spec name="12-emotions">Happy, Loved, Content, Excited, Grateful, Thoughtful + Sad, Anxious, Frustrated, Angry, Lonely, Tired</spec>
        <spec name="layout">3x4 grid (3 columns, 4 rows)</spec>
        <spec name="touch-target">Minimum 48px per emoji button</spec>
        <spec name="selection-visual">Pink border + scale animation on selection</spec>
      </extracted-specs>
    </document>

    <document type="architecture" relevance="high">
      <path>docs/02-Architecture/architecture.md</path>
      <key-sections>
        <section id="zustand-patterns">Zustand Store Pattern</section>
        <section id="component-pattern">Component Pattern with haptic feedback</section>
        <section id="data-architecture">MoodEntry domain model</section>
      </key-sections>
      <patterns-to-follow>
        <pattern name="zustand-optimistic-updates">Use optimistic UI for mood selection before IndexedDB write</pattern>
        <pattern name="framer-motion">Use framer-motion for selection animations</pattern>
        <pattern name="tailwind-styling">Use Tailwind CSS for layout and styling</pattern>
      </patterns-to-follow>
    </document>

    <document type="ux-spec" relevance="high">
      <path>docs/09-UX-Spec/ux-design-specification.md</path>
      <key-sections>
        <section id="mood-emoji-picker">MoodEmojiPicker component specs</section>
        <section id="design-system">Coral Heart color system</section>
        <section id="haptic-feedback">Haptic feedback patterns</section>
      </key-sections>
      <ux-requirements>
        <requirement name="color-primary">#FF6B6B (Coral Red) for selected state</requirement>
        <requirement name="touch-target">48px minimum for primary actions</requirement>
        <requirement name="selection-haptic">Soft double tap on mood selection</requirement>
        <requirement name="mood-log-time">Under 5 seconds for complete mood logging</requirement>
      </ux-requirements>
    </document>
  </relevant-documentation>

  <existing-code-analysis>
    <file path="src/types/index.ts" relevance="critical">
      <current-state>
        <description>MoodType currently defines 10 moods, needs expansion to 12</description>
        <current-moods>loved, happy, content, thoughtful, grateful, sad, anxious, frustrated, lonely, tired</current-moods>
        <needed-additions>excited, angry</needed-additions>
      </current-state>
      <change-required>true</change-required>
      <change-summary>Add 'excited' and 'angry' to MoodType union type</change-summary>
    </file>

    <file path="src/validation/schemas.ts" relevance="critical">
      <current-state>
        <description>MoodTypeSchema Zod enum validates mood types</description>
        <line-range>136-147</line-range>
      </current-state>
      <change-required>true</change-required>
      <change-summary>Add 'excited' and 'angry' to MoodTypeSchema enum</change-summary>
    </file>

    <file path="src/components/MoodTracker/MoodTracker.tsx" relevance="critical">
      <current-state>
        <description>Mood tracker component with positive/negative sections</description>
        <features-present>
          <feature>Multi-mood selection (selectedMoods array)</feature>
          <feature>Positive/Challenging mood separation</feature>
          <feature>Selected moods summary display</feature>
          <feature>Tab navigation (tracker/history)</feature>
        </features-present>
        <layout-current>grid-cols-3 sm:grid-cols-5 (needs 3x4 fixed)</layout-current>
      </current-state>
      <change-required>true</change-required>
      <change-summary>
        1. Add 'excited' and 'angry' to mood config objects
        2. Adjust grid to 3 columns fixed (grid-cols-3)
        3. Reorder moods to match story spec
      </change-summary>
    </file>

    <file path="src/components/MoodTracker/MoodButton.tsx" relevance="high">
      <current-state>
        <description>Individual mood button with selection animation</description>
        <features-present>
          <feature>Scale animation (1.1x when selected)</feature>
          <feature>Color change (pink-500 border when selected)</feature>
          <feature>Framer Motion animations</feature>
          <feature>Accessible (aria-label, aria-pressed)</feature>
        </features-present>
        <touch-target-current>p-4 (16px padding) with icon w-8 h-8 (32px)</touch-target-current>
      </current-state>
      <change-required>true</change-required>
      <change-summary>Verify touch target meets 48px minimum (may need to increase padding)</change-summary>
    </file>

    <file path="src/services/moodService.ts" relevance="high">
      <current-state>
        <description>IndexedDB CRUD operations for mood tracking</description>
        <features-present>
          <feature>Multi-mood support via 'moods' array field</feature>
          <feature>Validation via MoodEntrySchema</feature>
          <feature>Sync status tracking</feature>
        </features-present>
      </current-state>
      <change-required>false</change-required>
      <change-summary>No changes needed - already supports multiple moods and will accept new types after schema update</change-summary>
    </file>

    <file path="src/stores/slices/moodSlice.ts" relevance="high">
      <current-state>
        <description>Zustand slice for mood state management</description>
        <features-present>
          <feature>addMoodEntry with multi-mood support</feature>
          <feature>Optimistic UI updates</feature>
          <feature>Background sync integration</feature>
        </features-present>
      </current-state>
      <change-required>false</change-required>
      <change-summary>No changes needed - already supports array of moods</change-summary>
    </file>
  </existing-code-analysis>

  <dependencies>
    <runtime-dependencies>
      <dependency name="react" version="19.1.1">Core UI framework</dependency>
      <dependency name="framer-motion" version="12.23.24">Animation library for selection effects</dependency>
      <dependency name="lucide-react" version="0.554.0">Icon library for emoji icons</dependency>
      <dependency name="zustand" version="5.0.8">State management</dependency>
      <dependency name="zod" version="3.25.76">Runtime validation</dependency>
      <dependency name="idb" version="8.0.3">IndexedDB wrapper</dependency>
      <dependency name="tailwindcss" version="3.4.18">Styling framework</dependency>
    </runtime-dependencies>

    <dev-dependencies>
      <dependency name="vitest" version="4.0.9">Unit testing framework</dependency>
      <dependency name="@playwright/test" version="1.56.1">E2E testing framework</dependency>
      <dependency name="@testing-library/react" version="16.1.0">React component testing</dependency>
      <dependency name="fake-indexeddb" version="6.2.5">IndexedDB mocking for tests</dependency>
    </dev-dependencies>

    <supabase-dependencies>
      <dependency name="@supabase/supabase-js" version="2.81.1">Supabase client</dependency>
      <note>Requires Supabase migration to expand mood_type enum</note>
    </supabase-dependencies>
  </dependencies>

  <testing-strategy>
    <unit-tests>
      <test-file>tests/unit/components/MoodTracker.test.tsx</test-file>
      <test-cases>
        <case id="UT-5.1.1">Renders 12 mood buttons in grid</case>
        <case id="UT-5.1.2">Grid displays as 3x4 layout</case>
        <case id="UT-5.1.3">Positive moods separated from challenging moods</case>
        <case id="UT-5.1.4">Clicking mood button toggles selection state</case>
        <case id="UT-5.1.5">Multiple moods can be selected simultaneously</case>
        <case id="UT-5.1.6">Selected moods summary displays correct labels</case>
        <case id="UT-5.1.7">Each button has aria-label and aria-pressed attributes</case>
      </test-cases>
    </unit-tests>

    <e2e-tests>
      <test-file>tests/e2e/mood-tracker.spec.ts</test-file>
      <test-cases>
        <case id="E2E-5.1.1">User can select single mood from grid</case>
        <case id="E2E-5.1.2">User can select multiple moods</case>
        <case id="E2E-5.1.3">Selected moods persist after form submission</case>
        <case id="E2E-5.1.4">Grid layout responsive on mobile viewport</case>
      </test-cases>
      <testing-patterns>
        <pattern>Use monitored fixtures from tests/support/fixtures/monitoredTest.ts</pattern>
        <pattern>Check console for errors using consoleMonitor</pattern>
        <pattern>Use data-testid selectors for reliable element targeting</pattern>
      </testing-patterns>
    </e2e-tests>
  </testing-strategy>

  <implementation-notes>
    <note priority="high">
      <title>Existing Multi-Select Already Implemented</title>
      <description>
        The MoodTracker component already supports multi-select via the selectedMoods
        state array. AC-5.1.4 may be largely complete - verify behavior matches spec.
      </description>
    </note>

    <note priority="high">
      <title>Grid Layout Change</title>
      <description>
        Current grid uses responsive columns (grid-cols-3 sm:grid-cols-5).
        Story requires fixed 3x4 grid. Change to grid-cols-3 and ensure 4 rows
        with 6 positive + 6 challenging moods.
      </description>
    </note>

    <note priority="medium">
      <title>Touch Target Verification</title>
      <description>
        MoodButton currently has p-4 (16px padding) with 32px icon.
        Total may be under 48px. Measure and adjust padding if needed.
        Consider min-h-[48px] min-w-[48px] for explicit sizing.
      </description>
    </note>

    <note priority="medium">
      <title>Icon Mapping for New Moods</title>
      <description>
        Need lucide-react icons for 'excited' and 'angry':
        - excited: Sparkles (already used for grateful) or PartyPopper
        - angry: Angry (already imported in MoodTracker)
        Review icon choices to avoid duplicates.
      </description>
    </note>

    <note priority="low">
      <title>Supabase Migration Timing</title>
      <description>
        The mood_type enum expansion should be deployed before frontend changes
        to prevent sync failures for new mood types.
      </description>
    </note>
  </implementation-notes>

  <constraints>
    <constraint type="performance">Mood selection must complete in under 5 seconds per UX spec</constraint>
    <constraint type="accessibility">WCAG 2.1 AA compliant - 48px touch targets, proper ARIA labels</constraint>
    <constraint type="browser-support">Chromium and Firefox (WebKit temporarily disabled)</constraint>
    <constraint type="offline">Mood entries must work offline via IndexedDB and sync when online</constraint>
  </constraints>

  <out-of-scope>
    <item>Partner mood display (Story 5.2)</item>
    <item>Mood history calendar enhancements</item>
    <item>Mood analytics or trends</item>
    <item>Haptic feedback implementation (existing, verify only)</item>
  </out-of-scope>

  <related-stories>
    <story id="5.2">Partner Mood Display - depends on 5.1 completion</story>
    <story id="5.3">Mood History Calendar - uses MoodEntry data from 5.1</story>
    <story id="6.4">Background Sync - already integrated with mood service</story>
  </related-stories>
</story-context>

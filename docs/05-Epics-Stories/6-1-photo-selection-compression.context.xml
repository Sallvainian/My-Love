<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>Photo Selection and Compression</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/05-Epics-Stories/6-1-photo-selection-compression.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to select photos from my device and have them optimized before upload</iWant>
    <soThat>sharing is fast and doesn't consume excessive storage</soThat>
    <tasks>
      - Task 1: Create imageCompressionService (AC: 6.1.4, 6.1.5, 6.1.6, 6.1.7, 6.1.9)
      - Task 2: Create PhotoUploader component foundation (AC: 6.1.1, 6.1.2, 6.1.3, 6.1.10)
      - Task 3: Integrate compression with uploader (AC: 6.1.4-6.1.8)
      - Task 4: Add useImageCompression hook (AC: 6.1.4-6.1.9)
      - Task 5: Write unit tests for imageCompressionService (AC: All)
      - Task 6: Write component tests for PhotoUploader (AC: 6.1.1-6.1.3, 6.1.10)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="6.1.1">File picker accepts only image types: JPEG, PNG, WebP</criterion>
    <criterion id="6.1.2">Files larger than 25MB raw are rejected with error message</criterion>
    <criterion id="6.1.3">Selected image displays in preview before upload</criterion>
    <criterion id="6.1.4">Compression reduces image to max 2048px on longest dimension</criterion>
    <criterion id="6.1.5">Compression targets 80% JPEG quality</criterion>
    <criterion id="6.1.6">Compressed output is always JPEG format</criterion>
    <criterion id="6.1.7">Compression completes in less than 3 seconds for 10MB input</criterion>
    <criterion id="6.1.8">If compression fails, original file used if less than 10MB</criterion>
    <criterion id="6.1.9">EXIF metadata stripped during compression (privacy)</criterion>
    <criterion id="6.1.10">Camera option available on mobile devices</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/05-Epics-Stories/tech-spec-epic-6.md</path>
        <title>Epic Technical Specification: Photo Gallery and Memories</title>
        <section>Story 6-1: Photo Selection and Compression</section>
        <snippet>Compression Algorithm: Load image into Image element, create canvas at target dimensions (max 2048px), draw image to canvas (automatically strips EXIF), export as JPEG at 80% quality. Performance target: less than 3 seconds for 10MB input image.</snippet>
      </doc>
      <doc>
        <path>docs/05-Epics-Stories/tech-spec-epic-6.md</path>
        <title>Epic Technical Specification: Photo Gallery and Memories</title>
        <section>Data Models and Contracts - TypeScript Types</section>
        <snippet>CompressionResult interface already defined in src/types/models.ts with blob, width, height, originalSize, compressedSize fields. Used by compression service for returning processed image data.</snippet>
      </doc>
      <doc>
        <path>docs/02-Architecture/architecture.md</path>
        <title>My-Love PWA Architecture</title>
        <section>Project Structure</section>
        <snippet>Service layer: src/services/imageCompressionService.ts for client-side compression. Component layer: src/components/photos/PhotoUploader.tsx for file selection UI. Hook layer: src/hooks/useImageCompression.ts for React state wrapper.</snippet>
      </doc>
      <doc>
        <path>docs/05-Epics-Stories/6-0-photo-storage-schema-buckets-setup.md</path>
        <title>Story 6.0: Photo Storage Schema and Buckets Setup</title>
        <section>Dev Agent Record - Learnings</section>
        <snippet>PhotoService available with methods: getSignedUrl(), checkStorageQuota(), uploadPhoto(). Types available: Photo, PhotoWithUrls, CompressionResult in src/types/models.ts. Testing pattern: 33 tests using AAA pattern with full error path coverage. Singleton service pattern with console logging in dev mode.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/photoService.ts</path>
        <kind>service</kind>
        <symbol>photoService</symbol>
        <lines>1-467</lines>
        <reason>Existing photo service with uploadPhoto() method (Story 6-0). Will be used for upload in Story 6-2 after compression in this story. Provides PhotoUploadInput interface required by compression workflow.</reason>
      </artifact>
      <artifact>
        <path>src/services/imageCompressionService.ts</path>
        <kind>service</kind>
        <symbol>imageCompressionService</symbol>
        <lines>1-168</lines>
        <reason>EXISTING IMAGE COMPRESSION SERVICE - Already implements Canvas API compression with different target dimensions (1920px vs 2048px). Will need to UPDATE this service to match Story 6-1 specs (2048px max, 80% quality, EXIF stripping, performance benchmarks).</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>CompressionResult</symbol>
        <lines>59-65</lines>
        <reason>CompressionResult interface already defined with blob, width, height, originalSize, compressedSize. Matches tech spec requirements. No changes needed.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>CompressionOptions</symbol>
        <lines>53-57</lines>
        <reason>CompressionOptions interface with maxWidth, maxHeight, quality. Will use for configuring compression service.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>react</package>
        <version>^19.1.1</version>
        <usage>UI framework for PhotoUploader component</usage>
      </node>
      <node>
        <package>react-dom</package>
        <version>^19.1.1</version>
        <usage>DOM rendering</usage>
      </node>
      <node>
        <package>lucide-react</package>
        <version>^0.554.0</version>
        <usage>Icons for camera, upload, image picker</usage>
      </node>
      <browser>
        <api>Canvas API</api>
        <usage>Client-side image compression via canvas.toBlob()</usage>
      </browser>
      <browser>
        <api>File API</api>
        <usage>File selection with input[type=file] and accept attribute</usage>
      </browser>
      <browser>
        <api>FileReader API</api>
        <usage>Load image for compression</usage>
      </browser>
      <browser>
        <api>URL.createObjectURL</api>
        <usage>Preview image before upload</usage>
      </browser>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use existing imageCompressionService.ts - UPDATE to match Story 6-1 specs (2048px max dimension, 80% quality, EXIF stripping)</constraint>
    <constraint>File picker must use HTML input with accept="image/jpeg,image/png,image/webp" attribute</constraint>
    <constraint>Mobile camera access via capture="environment" attribute on file input</constraint>
    <constraint>Max file size validation: 25MB raw, reject with user-friendly error message</constraint>
    <constraint>Compression fallback: if compression fails, use original file if less than 10MB, otherwise show error</constraint>
    <constraint>EXIF metadata stripping mandatory for privacy - Canvas redraw automatically removes EXIF</constraint>
    <constraint>Performance requirement: less than 3 seconds compression time for 10MB input (measure with performance.now())</constraint>
    <constraint>Always convert to JPEG format output regardless of input format</constraint>
    <constraint>Object URL cleanup: Call URL.revokeObjectURL() on component unmount to prevent memory leaks</constraint>
    <constraint>Testing pattern: Follow AAA pattern from photoService.test.ts (33 tests), mock Image and canvas.toBlob()</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>CompressionResult</name>
      <kind>TypeScript interface</kind>
      <signature>interface CompressionResult { blob: Blob; width: number; height: number; originalSize: number; compressedSize: number; }</signature>
      <path>src/types/index.ts</path>
    </interface>
    <interface>
      <name>PhotoUploadInput</name>
      <kind>TypeScript interface (photoService.ts)</kind>
      <signature>interface PhotoUploadInput { file: Blob; filename: string; caption?: string; mimeType: 'image/jpeg' | 'image/png' | 'image/webp'; width: number; height: number; }</signature>
      <path>src/services/photoService.ts</path>
    </interface>
    <interface>
      <name>imageCompressionService.compressImage</name>
      <kind>Service method</kind>
      <signature>async compressImage(file: File, options?: Partial&lt;CompressionOptions&gt;): Promise&lt;CompressionResult&gt;</signature>
      <path>src/services/imageCompressionService.ts</path>
    </interface>
    <interface>
      <name>imageCompressionService.validateImageFile</name>
      <kind>Service method</kind>
      <signature>validateImageFile(file: File): { valid: boolean; error?: string; warning?: string }</signature>
      <path>src/services/imageCompressionService.ts</path>
    </interface>
    <interface>
      <name>HTML File Input</name>
      <kind>Browser API</kind>
      <signature>&lt;input type="file" accept="image/jpeg,image/png,image/webp" capture="environment" /&gt;</signature>
      <path>Browser native</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests use Vitest with @testing-library/react for components. Mock Image element and canvas.toBlob() for compression tests. Follow AAA (Arrange-Act-Assert) pattern from existing photoService.test.ts (33 tests). Tests are colocated next to tested files (e.g., dir/format.ts and dir/format.test.ts). Use vi.mock() for server-only modules and external dependencies. Clean up mocks between tests with vi.clearAllMocks() in beforeEach().</standards>
    <locations>
      - tests/unit/services/imageCompressionService.test.ts
      - tests/unit/components/PhotoUploader.test.tsx (if component created)
      - tests/unit/hooks/useImageCompression.test.ts (if hook created)
    </locations>
    <ideas>
      <idea ac="6.1.1">Test file input accepts="image/jpeg,image/png,image/webp" attribute renders correctly</idea>
      <idea ac="6.1.2">Test file size validation: upload 30MB file, verify rejection with error message</idea>
      <idea ac="6.1.3">Test preview display: select file, verify URL.createObjectURL() called and image src set</idea>
      <idea ac="6.1.4">Test dimension reduction: upload 3000x2000 image, verify output max 2048px on longest dimension</idea>
      <idea ac="6.1.4">Test aspect ratio preservation: upload 4000x3000 image, verify aspect ratio maintained after compression</idea>
      <idea ac="6.1.5">Test JPEG quality: mock canvas.toBlob, verify quality parameter is 0.8</idea>
      <idea ac="6.1.6">Test format conversion: upload PNG, verify output is JPEG format (image/jpeg mime type)</idea>
      <idea ac="6.1.7">Test compression timing: mock performance.now(), verify compression completes in less than 3s for 10MB test file</idea>
      <idea ac="6.1.8">Test compression fallback: mock compression failure, verify original file used if less than 10MB</idea>
      <idea ac="6.1.8">Test compression fallback error: mock compression failure with 15MB file, verify error shown</idea>
      <idea ac="6.1.9">Test EXIF stripping: Canvas redraw automatically removes EXIF (document in test comment)</idea>
      <idea ac="6.1.10">Test camera option: verify capture="environment" attribute on mobile user agent</idea>
      <idea>Test object URL cleanup: verify URL.revokeObjectURL() called on unmount to prevent memory leak</idea>
      <idea>Test file type rejection: upload video file, verify validation error</idea>
      <idea>Test compression result structure: verify CompressionResult has all required fields (blob, width, height, originalSize, compressedSize)</idea>
    </ideas>
  </tests>
</story-context>

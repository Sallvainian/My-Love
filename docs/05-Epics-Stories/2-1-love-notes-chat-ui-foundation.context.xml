<story-context id="2-1-love-notes-chat-ui-foundation" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Love Notes Chat UI Foundation</title>
    <status>draft</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/05-Epics-Stories/2-1-love-notes-chat-ui-foundation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to see my Love Notes conversation with my partner in a chat interface</iWant>
    <soThat>I can read our messages with clear sender identification and timestamps</soThat>
    <tasks>
      <task id="2.1.1" title="Create LoveNote type and notesSlice structure">
        - Define LoveNote interface in src/types/index.ts
        - Create notesSlice with initial state for messages array
        - Add slice to useAppStore composition
        - Include state: notes[], isLoading, error, sendingMessage
      </task>
      <task id="2.1.2" title="Build LoveNoteMessage component">
        - Create src/components/LoveNotes/LoveNoteMessage.tsx
        - Props: message content, sender identifier, timestamp, isMine boolean
        - Styling: coral background for user messages, gray for partner
        - Display timestamp with relative time format ("2m ago", "yesterday")
      </task>
      <task id="2.1.3" title="Build MessageList container component">
        - Create src/components/LoveNotes/MessageList.tsx
        - Renders scrollable list of LoveNoteMessage components
        - Auto-scroll to newest message on load
        - Skeleton loading state while fetching
        - Empty state: "No messages yet. Start the conversation!"
      </task>
      <task id="2.1.4" title="Build MessageInput component">
        - Create src/components/LoveNotes/MessageInput.tsx
        - Text input with send button (coral filled button)
        - Send button disabled when input is empty
        - Input clears after successful send
        - Visual feedback during send operation
      </task>
      <task id="2.1.5" title="Create LoveNotes screen component">
        - Create src/components/LoveNotes/LoveNotes.tsx
        - Compose MessageList + MessageInput into full chat view
        - Connect to notesSlice via useAppStore
        - Add to navigation (tab icon, routing)
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.1.1">
      <description>Love Notes screen displays messages in chronological order with newest at bottom</description>
      <verifiable>true</verifiable>
      <testable>Visual inspection of message order in UI</testable>
    </criterion>
    <criterion id="AC-2.1.2">
      <description>User's messages appear on the right with coral background (#FF6B6B)</description>
      <verifiable>true</verifiable>
      <testable>Check CSS background-color of user message bubbles</testable>
    </criterion>
    <criterion id="AC-2.1.3">
      <description>Partner's messages appear on the left with light gray background</description>
      <verifiable>true</verifiable>
      <testable>Check CSS background-color and alignment of partner message bubbles</testable>
    </criterion>
    <criterion id="AC-2.1.4">
      <description>Each message shows timestamp in relative format (e.g., "2m ago", "yesterday")</description>
      <verifiable>true</verifiable>
      <testable>Verify timestamp display format in component</testable>
    </criterion>
    <criterion id="AC-2.1.5">
      <description>Message list auto-scrolls to newest message on initial load</description>
      <verifiable>true</verifiable>
      <testable>Test scroll position after messages load</testable>
    </criterion>
    <criterion id="AC-2.1.6">
      <description>Empty state shown when no messages exist</description>
      <verifiable>true</verifiable>
      <testable>Verify empty state renders when notes array is empty</testable>
    </criterion>
    <criterion id="AC-2.1.7">
      <description>Text input allows typing and shows send button</description>
      <verifiable>true</verifiable>
      <testable>Input field accepts text, send button visible</testable>
    </criterion>
    <criterion id="AC-2.1.8">
      <description>Send button disabled when input is empty</description>
      <verifiable>true</verifiable>
      <testable>Button disabled state when input value is empty string</testable>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/01-PRD/prd.md">
        <relevance>high</relevance>
        <keyContent>
          - FR7: Users can send text messages to their partner through Love Notes
          - FR8: Users receive partner's Love Notes in real-time via Supabase Realtime subscription
          - FR10: Users can view complete Love Notes message history with scroll-back
          - FR11: Love Notes display sender identification and timestamp on each message
          - FR12: System provides optimistic update (message appears immediately before server confirmation)
          - Success Criteria: Push notifications become something both partners look forward to
        </keyContent>
      </doc>
      <doc path="docs/05-Epics-Stories/tech-spec-epic-2.md">
        <relevance>high</relevance>
        <keyContent>
          - Love Notes table schema: id, sender_id, recipient_id, content, created_at, read_at
          - LoveNote interface: id, senderId, recipientId, content, createdAt, readAt?, isOptimistic?
          - notesSlice structure: notes[], isLoading, error, sendingMessage
          - Component hierarchy: LoveNotes > MessageList > LoveNoteMessage, MessageInput
          - Real-time via Supabase Realtime subscriptions (Story 2.2)
        </keyContent>
      </doc>
      <doc path="docs/02-Architecture/architecture.md">
        <relevance>medium</relevance>
        <keyContent>
          - Zustand slice pattern: StateCreator with interface, create*Slice function
          - Online-first architecture with graceful offline degradation
          - Optimistic updates pattern: update state immediately, sync to backend
          - Component organization: src/components/{FeatureName}/{Component}.tsx
        </keyContent>
      </doc>
      <doc path="docs/09-UX-Spec/ux-design-specification.md">
        <relevance>high</relevance>
        <keyContent>
          - Love Notes Chat: Standard chat bubble UI with romantic color coding
          - Coral (#FF6B6B) for sent messages, light gray for received
          - LoveNoteMessage component: chat bubble, timestamp, delivery status, haptic on send
          - Input field always visible at bottom of chat screen
          - Send button disabled until text is entered
          - Component location: src/components/love-notes/
          - Typography: Body 16px regular, Caption 12px medium for timestamps
          - Spacing: 16px padding (md), 12px gap between messages (sm + xs)
        </keyContent>
      </doc>
    </docs>

    <code>
      <pattern name="Zustand Slice Pattern" path="src/stores/slices/moodSlice.ts">
        <description>Reference implementation for creating new store slices</description>
        <keyElements>
          - StateCreator type signature with slice interface
          - Interface defines state (arrays, objects) and actions (async functions)
          - Create function pattern: export const create*Slice: StateCreator = (set, get) => ({...})
          - Optimistic UI updates via set() before async operations
          - Error handling with console.error and re-throwing
          - Development logging with import.meta.env.DEV
        </keyElements>
        <applyTo>
          - Create notesSlice following same structure
          - Interface with: notes: LoveNote[], isLoading, error, sendingMessage
          - Actions: addNote, loadNotes, markAsRead
        </applyTo>
      </pattern>

      <pattern name="Custom Hook Pattern" path="src/hooks/useNetworkStatus.ts">
        <description>Reference for creating reusable hooks with state management</description>
        <keyElements>
          - Interface export for return type
          - useState/useEffect combination
          - Cleanup in useEffect return
          - Default export plus named export
        </keyElements>
        <applyTo>
          - Could be used for useLoveNotes hook if needed
          - Pattern for useAutoScroll hook for MessageList
        </applyTo>
      </pattern>

      <pattern name="Store Composition" path="src/stores/useAppStore.ts">
        <description>How slices are composed into the main store</description>
        <keyElements>
          - Import createNotesSlice and NotesSlice interface
          - Add NotesSlice to AppState interface (extends)
          - Spread ...createNotesSlice(set, get, api) in store creation
          - Persist partialize: decide what to persist to localStorage
        </keyElements>
        <applyTo>
          - Add NotesSlice to AppState interface
          - Spread createNotesSlice in store body
          - Notes likely NOT persisted to localStorage (loaded from Supabase)
        </applyTo>
      </pattern>

      <pattern name="Types Index" path="src/types/index.ts">
        <description>Where to add new type definitions</description>
        <keyElements>
          - Export interfaces directly (Message, Photo, MoodEntry, etc.)
          - Re-export from service modules when appropriate
          - MoodType union type example for enums
        </keyElements>
        <applyTo>
          - Add LoveNote interface to this file
          - Keep consistent with existing patterns (userId as string, etc.)
        </applyTo>
      </pattern>

      <pattern name="Component Structure" path="src/components/MoodTracker/">
        <description>Example component organization within feature folder</description>
        <keyElements>
          - Feature folder: src/components/FeatureName/
          - Main component: FeatureName.tsx
          - Sub-components: FeatureButton.tsx, FeatureList.tsx
          - Connect to store via useAppStore hook
          - Framer motion for animations
          - Tailwind CSS for styling
        </keyElements>
        <applyTo>
          - Create src/components/LoveNotes/ folder
          - LoveNotes.tsx (main), LoveNoteMessage.tsx, MessageList.tsx, MessageInput.tsx
          - Use useAppStore for notes state access
        </applyTo>
      </pattern>

      <pattern name="Navigation Tab" path="src/components/Navigation/BottomNavigation.tsx">
        <description>How to add new navigation tab</description>
        <applyTo>
          - Add "notes" or "love-notes" to navigation tabs
          - Add appropriate icon from lucide-react (MessageCircle or Heart)
        </applyTo>
      </pattern>
    </code>

    <dependencies>
      <dependency name="zustand" version="^5.0.8" usage="State management for notesSlice"/>
      <dependency name="react" version="^19.1.1" usage="Component framework"/>
      <dependency name="framer-motion" version="^12.23.24" usage="Animations for message appearance"/>
      <dependency name="lucide-react" version="^0.554.0" usage="Icons (Send, MessageCircle)"/>
      <dependency name="tailwindcss" version="^3.4.18" usage="Styling for chat components"/>
      <dependency name="zod" version="^3.25.76" usage="Validation for LoveNote schema"/>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <description>Follow existing Zustand slice pattern</description>
      <detail>
        - Use StateCreator type from zustand
        - Export interface and create function separately
        - Follow moodSlice.ts structure exactly
        - Do NOT create new state management approach
      </detail>
    </constraint>
    <constraint type="styling">
      <description>Use design system tokens from UX spec</description>
      <detail>
        - Primary coral: #FF6B6B (user messages)
        - Surface blush: #FFF5F5 (backgrounds)
        - Text warm gray: #495057
        - Border radius: 12-16px for soft feel
        - Spacing: 8px base unit (xs=4, sm=8, md=16, lg=24)
      </detail>
    </constraint>
    <constraint type="component">
      <description>Component naming and location conventions</description>
      <detail>
        - Create src/components/LoveNotes/ directory
        - PascalCase component names
        - One component per file
        - Export from index if needed for barrel exports
      </detail>
    </constraint>
    <constraint type="typescript">
      <description>TypeScript strict mode enabled</description>
      <detail>
        - All props must be typed
        - No 'any' types
        - Use interface over type for component props
        - Export types from src/types/index.ts
      </detail>
    </constraint>
    <constraint type="accessibility">
      <description>WCAG 2.1 AA compliance requirements</description>
      <detail>
        - All interactive elements need accessibilityLabel equivalent (aria-label)
        - Touch targets minimum 44x44px
        - Color contrast 4.5:1 for text
        - Screen reader support for message content
      </detail>
    </constraint>
    <constraint type="scope">
      <description>Story 2.1 is UI-only - no backend integration</description>
      <detail>
        - NO Supabase calls in this story
        - Use mock data for initial development
        - Real-time subscription added in Story 2.2
        - Sending functionality added in Story 2.3
        - This story focuses on visual components and state structure
      </detail>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="LoveNote" path="src/types/index.ts">
      <description>Core type for love note messages</description>
      <definition>
```typescript
export interface LoveNote {
  id: string;                // UUID from Supabase
  senderId: string;          // UUID of sender
  recipientId: string;       // UUID of recipient
  content: string;           // Message text (max 1000 chars)
  createdAt: Date;           // When message was sent
  readAt?: Date;             // When recipient read (optional)
  isOptimistic?: boolean;    // True if not yet confirmed by server
}
```
      </definition>
    </interface>

    <interface name="NotesSlice" path="src/stores/slices/notesSlice.ts">
      <description>Zustand slice for love notes state management</description>
      <definition>
```typescript
export interface NotesSlice {
  // State
  notes: LoveNote[];
  isLoading: boolean;
  error: string | null;
  sendingMessage: boolean;

  // Actions (placeholders for Story 2.1, implemented in 2.2/2.3)
  loadNotes: () => Promise&lt;void&gt;;
  addNote: (content: string) => Promise&lt;void&gt;;
  markAsRead: (noteId: string) => Promise&lt;void&gt;;
  clearError: () => void;
}
```
      </definition>
    </interface>

    <interface name="LoveNoteMessageProps" path="src/components/LoveNotes/LoveNoteMessage.tsx">
      <description>Props for individual message bubble component</description>
      <definition>
```typescript
interface LoveNoteMessageProps {
  content: string;           // Message text
  timestamp: Date;           // When message was sent
  isMine: boolean;           // True if current user sent this
  isOptimistic?: boolean;    // Show sending indicator
  senderName?: string;       // Optional display name
}
```
      </definition>
    </interface>

    <interface name="MessageListProps" path="src/components/LoveNotes/MessageList.tsx">
      <description>Props for the scrollable message container</description>
      <definition>
```typescript
interface MessageListProps {
  notes: LoveNote[];
  currentUserId: string;
  isLoading: boolean;
}
```
      </definition>
    </interface>

    <interface name="MessageInputProps" path="src/components/LoveNotes/MessageInput.tsx">
      <description>Props for the text input and send button</description>
      <definition>
```typescript
interface MessageInputProps {
  onSend: (content: string) => void;
  isSending: boolean;
  disabled?: boolean;
}
```
      </definition>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard name="Unit Testing">Vitest with @testing-library/react</standard>
      <standard name="E2E Testing">Playwright with monitoredTest fixture</standard>
      <standard name="Coverage">Aim for 80%+ coverage on new components</standard>
      <standard name="Patterns">Follow existing test patterns in tests/unit/</standard>
    </standards>
    <locations>
      <location type="unit">tests/unit/components/LoveNotes/</location>
      <location type="unit">tests/unit/stores/notesSlice.test.ts</location>
      <location type="e2e">tests/e2e/love-notes.spec.ts</location>
    </locations>
    <ideas>
      <idea priority="high">
        <description>LoveNoteMessage renders with correct styling based on isMine prop</description>
        <testCase>
          - Render with isMine=true -> coral background, right aligned
          - Render with isMine=false -> gray background, left aligned
        </testCase>
      </idea>
      <idea priority="high">
        <description>MessageList renders notes in chronological order</description>
        <testCase>
          - Pass array of notes with different timestamps
          - Verify order by checking DOM element sequence
        </testCase>
      </idea>
      <idea priority="high">
        <description>MessageList shows empty state when no notes</description>
        <testCase>
          - Render with empty notes array
          - Verify "No messages yet" text appears
        </testCase>
      </idea>
      <idea priority="high">
        <description>MessageInput disables send button when empty</description>
        <testCase>
          - Render component
          - Verify send button is disabled initially
          - Type text, verify button becomes enabled
          - Clear text, verify button disabled again
        </testCase>
      </idea>
      <idea priority="medium">
        <description>MessageInput calls onSend with content and clears input</description>
        <testCase>
          - Type message, click send
          - Verify onSend called with correct content
          - Verify input is cleared after send
        </testCase>
      </idea>
      <idea priority="medium">
        <description>notesSlice initializes with correct default state</description>
        <testCase>
          - Create slice
          - Verify notes: [], isLoading: false, error: null, sendingMessage: false
        </testCase>
      </idea>
      <idea priority="medium">
        <description>Timestamp displays in relative format</description>
        <testCase>
          - Note from 2 minutes ago -> "2m ago"
          - Note from yesterday -> "yesterday"
          - Note from last week -> date format
        </testCase>
      </idea>
      <idea priority="low">
        <description>MessageList auto-scrolls to bottom on mount</description>
        <testCase>
          - Render with multiple messages
          - Verify scrollTop is at bottom after render
        </testCase>
      </idea>
    </ideas>
  </tests>
</story-context>

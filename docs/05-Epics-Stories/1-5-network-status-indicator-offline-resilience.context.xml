<story-context id="bmm/story-context" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Network Status &amp; Offline Resilience</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow v1.0</generator>
    <sourceStoryPath>docs/05-Epics-Stories/1-5-network-status-indicator-offline-resilience.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to see whether I'm online or offline and have my actions handled gracefully when disconnected</iWant>
    <soThat>I understand the app's connectivity state and can retry failed actions when back online</soThat>
    <tasks>
      <task id="1" goal="Create Network Status Detection Hook">
        <subtask id="1.1">Create useNetworkStatus hook using navigator.onLine and online/offline events</subtask>
        <subtask id="1.2">Export hook from hooks barrel file if exists</subtask>
      </task>
      <task id="2" goal="Create Network Status Indicator Component">
        <subtask id="2.1">Create NetworkStatusIndicator component with Online/Connecting/Offline states</subtask>
        <subtask id="2.2">Follow UX Design Specification for colors and patterns</subtask>
      </task>
      <task id="3" goal="Integrate Status Indicator into App Layout">
        <subtask id="3.1">Add NetworkStatusIndicator to App layout</subtask>
        <subtask id="3.2">Test indicator behavior during network changes</subtask>
      </task>
      <task id="4" goal="Implement Graceful Operation Failures">
        <subtask id="4.1">Create offline-aware error handling utility</subtask>
        <subtask id="4.2">Update mood service to use offline error handling</subtask>
        <subtask id="4.3">Add retry button UI pattern</subtask>
      </task>
      <task id="5" goal="Verify Background Sync Integration">
        <subtask id="5.1">Verify existing Background Sync implementation</subtask>
        <subtask id="5.2">Test reconnection sync behavior</subtask>
        <subtask id="5.3">Add sync completion feedback to user</subtask>
      </task>
      <task id="6" goal="Verify Service Worker Asset Caching">
        <subtask id="6.1">Verify Workbox precaching configuration</subtask>
        <subtask id="6.2">Test offline app shell loading</subtask>
        <subtask id="6.3">Test API response caching (stale-while-revalidate)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1.5.1" validation="Browser DevTools network throttling test">App shows online/offline/connecting status indicator</criterion>
    <criterion id="AC-1.5.2" validation="Disconnect network, verify cached content visible">App displays cached data when offline</criterion>
    <criterion id="AC-1.5.3" validation="Attempt mood log offline, verify error message">Write operations fail gracefully with retry option</criterion>
    <criterion id="AC-1.5.4" validation="Reconnect network, verify queued actions sync">Online reconnection triggers sync of pending actions</criterion>
    <criterion id="AC-1.5.5" validation="Disconnect network, verify app shell loads">Service worker handles offline asset serving</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/01-PRD/prd.md" relevance="high">
        <summary>Online-first architecture strategy, graceful degradation pattern, Web Push notifications</summary>
        <keyExtracts>
          <extract section="Offline Mode Strategy">Online-First Architecture (NOT offline-first sync): Primary Pattern - All operations require network connectivity. Caching Layer - Service worker caches static assets and API responses. Graceful Degradation - If network unavailable: show cached data (marked as potentially stale), queue outgoing actions? NO - fail immediately with retry prompt.</extract>
          <extract section="User Expectation">User confirmed "I expect to really never be offline" in brainstorming. No Complex Offline Sync - Intentionally avoided to reduce complexity.</extract>
        </keyExtracts>
      </doc>
      <doc path="docs/02-Architecture/architecture.md" relevance="high">
        <summary>ADR 001 Online-First, Zustand store patterns, error handling with toasts</summary>
        <keyExtracts>
          <extract section="ADR 001">Online-First with Graceful Degradation: Decision - Implement online-first architecture with PWA capabilities. Rationale - User stated "I really expect to never be offline" during brainstorming.</extract>
          <extract section="Zustand Patterns">syncStatus in MoodSlice: { pendingMoods: number, isOnline: boolean, lastSyncAt: Date, isSyncing: boolean }</extract>
          <extract section="Error Handling">Pattern: Toast notifications for network errors, inline validation for form errors, optimistic updates with rollback on failure</extract>
        </keyExtracts>
      </doc>
      <doc path="docs/09-UX-Spec/ux-design-specification.md" relevance="high">
        <summary>StatusIndicator component design, semantic colors, offline banner pattern</summary>
        <keyExtracts>
          <extract section="Component Library">StatusIndicator - Online/offline connection status: Green dot (online), yellow dot (connecting), red dot (offline)</extract>
          <extract section="Semantic Colors">Success: #51CF66 (Green), Warning: #FCC419 (Yellow), Error: #FF6B6B (Coral Red)</extract>
          <extract section="Offline Behavior">Online: Full functionality, real-time sync. Connecting: Yellow status indicator, "Connecting..." banner. Offline: Red status indicator, "Offline" banner, queued actions, read-only cache. Reconnecting: Auto-sync queued actions, show sync progress, confirm completion.</extract>
          <extract section="Feedback">Offline State: Banner at top - "You're offline. Changes will sync when reconnected." While offline - persistent.</extract>
        </keyExtracts>
      </doc>
      <doc path="docs/05-Epics-Stories/tech-spec-epic-1.md" relevance="high">
        <summary>Story 1.5 technical details, module structure, Network Resilience Pattern</summary>
        <keyExtracts>
          <extract section="Story 1.5 Module">New Files: src/hooks/useNetworkStatus.ts, src/components/NetworkStatusIndicator.tsx. Modified Files: src/App.tsx (add status indicator), src/stores/slices/moodSlice.ts (graceful error handling)</extract>
          <extract section="Network Resilience Pattern">Detection: navigator.onLine + online/offline events. Status Display: StatusIndicator component showing online/connecting/offline. Graceful Degradation: Queue writes during offline, show cached reads, sync on reconnect.</extract>
        </keyExtracts>
      </doc>
    </docs>
    <code>
      <file path="src/sw.ts" relevance="high">
        <summary>Service Worker with Background Sync implementation for mood syncing</summary>
        <keyElements>
          <element type="event-handler">sync event listener for 'sync-pending-moods' tag</element>
          <element type="function">syncPendingMoods() - syncs IndexedDB moods to Supabase REST API</element>
          <element type="message">Posts BACKGROUND_SYNC_COMPLETED message to open clients with successCount/failCount</element>
        </keyElements>
        <status>IMPLEMENTED - Provides background sync when app closed or reconnects</status>
      </file>
      <file path="src/sw-db.ts" relevance="high">
        <summary>IndexedDB helpers for service worker context</summary>
        <keyElements>
          <element type="function">getPendingMoods() - retrieves unsynced moods from IndexedDB</element>
          <element type="function">markMoodSynced(localId, supabaseId) - marks mood as synced</element>
          <element type="function">storeAuthToken/getAuthToken/clearAuthToken - auth token management</element>
          <element type="interface">StoredAuthToken { id, accessToken, refreshToken, expiresAt, userId }</element>
          <element type="interface">StoredMoodEntry { id, userId, mood, moods, note, date, timestamp, synced, supabaseId }</element>
        </keyElements>
        <status>IMPLEMENTED - Provides IndexedDB access without window context</status>
      </file>
      <file path="src/utils/backgroundSync.ts" relevance="high">
        <summary>Frontend utilities for Background Sync API</summary>
        <keyElements>
          <element type="function">registerBackgroundSync(tag) - registers sync tag with service worker</element>
          <element type="function">setupServiceWorkerListener(onSyncCompleted) - listens for SW messages, returns cleanup function</element>
          <element type="function">isServiceWorkerSupported() - checks if navigator.serviceWorker exists</element>
          <element type="function">isBackgroundSyncSupported() - checks for serviceWorker AND SyncManager</element>
        </keyElements>
        <status>IMPLEMENTED - Use for registering syncs and listening to SW completion</status>
      </file>
      <file path="src/stores/slices/moodSlice.ts" relevance="high">
        <summary>Zustand slice for mood tracking with sync status</summary>
        <keyElements>
          <element type="state">syncStatus { pendingMoods, isOnline, lastSyncAt, isSyncing }</element>
          <element type="action">syncPendingMoods() - syncs pending moods via moodSyncService</element>
          <element type="action">updateSyncStatus() - updates isOnline from navigator.onLine</element>
          <element type="pattern">Immediate sync on mood add/update if online, fails gracefully</element>
        </keyElements>
        <status>IMPLEMENTED - Extend with graceful offline error handling</status>
      </file>
      <file path="src/App.tsx" relevance="high">
        <summary>Main app component with network event handlers</summary>
        <keyElements>
          <element type="hook">useEffect for online/offline window events (lines 244-280)</element>
          <element type="hook">useEffect for periodic sync 5-minute interval (lines 282-314)</element>
          <element type="hook">useEffect for service worker message listener (lines 316-338)</element>
          <element type="import">{ setupServiceWorkerListener, isServiceWorkerSupported } from './utils/backgroundSync'</element>
        </keyElements>
        <status>IMPLEMENTED - Need to ADD NetworkStatusIndicator component</status>
      </file>
      <file path="src/services/moodService.ts" relevance="medium">
        <summary>IndexedDB CRUD operations for mood tracking</summary>
        <keyElements>
          <element type="method">create(userId, moods, note) - validates with Zod, stores in IndexedDB</element>
          <element type="method">getUnsyncedMoods() - returns moods where synced=false</element>
          <element type="method">markAsSynced(id, supabaseId) - marks mood as synced</element>
        </keyElements>
        <status>IMPLEMENTED - Add offline-aware error handling</status>
      </file>
    </code>
    <dependencies>
      <dependency name="react" version="^19.1.1" usage="UI framework" />
      <dependency name="zustand" version="^5.0.8" usage="State management - syncStatus state" />
      <dependency name="vite-plugin-pwa" version="^1.1.0" usage="Service worker generation, PWA manifest" />
      <dependency name="workbox-precaching" version="via vite-plugin-pwa" usage="Asset caching in service worker" />
      <dependency name="idb" version="^8.0.3" usage="IndexedDB wrapper for mood storage" />
      <dependency name="tailwindcss" version="^3.4.18" usage="Styling for status indicator" />
      <dependency name="lucide-react" version="^0.554.0" usage="Icons for status indicator (Wifi, WifiOff)" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Online-first: Fail immediately with retry prompt, no offline queue for writes</constraint>
    <constraint type="ux">Status indicator must follow UX spec colors: green/yellow/red dots</constraint>
    <constraint type="ux">Offline banner: "You're offline. Changes will sync when reconnected."</constraint>
    <constraint type="technical">Background Sync API only supported in Chromium browsers - graceful fallback needed</constraint>
    <constraint type="technical">Service worker disabled in dev mode (vite.config.ts devOptions.enabled: false)</constraint>
    <constraint type="testing">Cannot test actual Background Sync in E2E - requires real browser with SW</constraint>
  </constraints>

  <interfaces>
    <interface name="useNetworkStatus" type="hook" status="NEW">
      <description>Custom React hook for network status detection</description>
      <signature>
        <returns>{ isOnline: boolean, isConnecting: boolean }</returns>
      </signature>
      <implementation>
        <step>Use useState for isOnline (init from navigator.onLine)</step>
        <step>Use useState for isConnecting (brief transition state)</step>
        <step>useEffect to add/remove online/offline event listeners</step>
        <step>Cleanup listeners on unmount</step>
      </implementation>
    </interface>
    <interface name="NetworkStatusIndicator" type="component" status="NEW">
      <description>Visual indicator for network connectivity state</description>
      <props>
        <prop name="className" type="string?" description="Additional CSS classes" />
      </props>
      <states>
        <state value="online" display="Green dot" />
        <state value="connecting" display="Yellow dot, 'Connecting...' text" />
        <state value="offline" display="Red dot, 'Offline' banner" />
      </states>
      <styling>
        <color state="online">#51CF66 (Success Green)</color>
        <color state="connecting">#FCC419 (Warning Yellow)</color>
        <color state="offline">#FF6B6B (Error Coral)</color>
      </styling>
    </interface>
    <interface name="OfflineError" type="class" status="NEW">
      <description>Custom error class for offline operation failures</description>
      <extends>Error</extends>
      <properties>
        <property name="name" value="OfflineError" />
        <property name="isRetryable" type="boolean" value="true" />
        <property name="operation" type="string" description="Name of failed operation" />
      </properties>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard>Use monitoredTest fixture from tests/support/fixtures/monitoredTest.ts</standard>
      <standard>Test names follow pattern: AC-X.Y.Z: Description</standard>
      <standard>Console monitor validates zero console errors</standard>
      <standard>Network monitor validates Supabase connection</standard>
      <standard>Unit tests in src/**/__tests__/*.test.ts with Vitest</standard>
      <standard>E2E tests in tests/e2e/*.spec.ts with Playwright</standard>
    </standards>
    <locations>
      <location type="e2e">tests/e2e/network-status.spec.ts (NEW)</location>
      <location type="e2e">tests/e2e/epic-1-validation.spec.ts (EXISTING - has AC-1.5.1/1.5.2 stubs)</location>
      <location type="unit">src/hooks/__tests__/useNetworkStatus.test.ts (NEW)</location>
      <location type="unit">src/utils/__tests__/backgroundSync.test.ts (EXISTS)</location>
    </locations>
    <ideas>
      <idea>Test offline simulation with page.context().setOffline(true)</idea>
      <idea>Test status indicator color changes via Playwright visual assertion</idea>
      <idea>Test retry button appears when operation fails offline</idea>
      <idea>Test sync completion toast appears after reconnect</idea>
      <idea>Mock navigator.onLine in Vitest unit tests for hook</idea>
      <idea>Test service worker registration succeeds (existing test)</idea>
      <idea>Test cached content visible when offline (AC-1.5.2)</idea>
    </ideas>
  </tests>

  <existingImplementation>
    <summary>Significant infrastructure already exists for Story 1.5</summary>
    <complete>
      <item>Background Sync event handler in sw.ts (sync-pending-moods tag)</item>
      <item>IndexedDB helpers for SW context (sw-db.ts)</item>
      <item>Frontend Background Sync utilities (backgroundSync.ts)</item>
      <item>Network event listeners in App.tsx (online/offline)</item>
      <item>Periodic sync in App.tsx (5-minute interval)</item>
      <item>Service worker listener for BACKGROUND_SYNC_COMPLETED message</item>
      <item>syncStatus state in moodSlice (isOnline, pendingMoods, isSyncing)</item>
      <item>Workbox precaching configuration (vite.config.ts)</item>
    </complete>
    <needed>
      <item>useNetworkStatus hook (Task 1)</item>
      <item>NetworkStatusIndicator component (Task 2)</item>
      <item>Integration into App layout (Task 3)</item>
      <item>Graceful offline error handling with retry UI (Task 4)</item>
      <item>Verification tests for existing Background Sync (Task 5)</item>
      <item>Verification tests for Service Worker caching (Task 6)</item>
    </needed>
  </existingImplementation>

  <implementationNotes>
    <note priority="high">Create src/hooks/ directory - does not exist yet</note>
    <note priority="high">useNetworkStatus hook should expose isConnecting for brief transition state</note>
    <note priority="high">NetworkStatusIndicator must match UX spec exactly: StatusIndicator component with green/yellow/red dots</note>
    <note priority="medium">Service worker is disabled in dev mode - test in production build</note>
    <note priority="medium">Background Sync API not supported in Firefox/Safari - fallback to periodic sync</note>
    <note priority="low">Consider adding sync completion toast notification for user feedback</note>
  </implementationNotes>
</story-context>

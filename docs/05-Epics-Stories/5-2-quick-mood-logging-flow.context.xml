<story-context id="5-2-quick-mood-logging-flow" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.2</storyId>
    <title>Quick Mood Logging Flow</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/05-Epics-Stories/5-2-quick-mood-logging-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to log my mood in under 5 seconds</iWant>
    <soThat>tracking doesn't interrupt my day</soThat>
    <tasks>
      <task id="1" name="Add Haptic Feedback on Mood Save" ac="AC-5.2.2">
        <subtask id="1.1">Create haptic utility in src/utils/haptics.ts with triggerMoodSaveHaptic()</subtask>
        <subtask id="1.2">Import and call triggerMoodSaveHaptic() in MoodTracker handleSubmit after setShowSuccess(true)</subtask>
        <subtask id="1.3">Ensure haptic fires AFTER local save but BEFORE Supabase sync</subtask>
        <subtask id="1.4">Add error vibration pattern [100, 50, 100] for failed saves</subtask>
      </task>
      <task id="2" name="Verify/Enhance Success Toast Animation" ac="AC-5.2.3">
        <subtask id="2.1">Review existing toast implementation in MoodTracker (lines 311-326)</subtask>
        <subtask id="2.2">Toast already displays "Mood logged" with CheckCircle icon (line 323)</subtask>
        <subtask id="2.3">Verify auto-dismiss timing is 3 seconds (line 158 - setTimeout 3000ms)</subtask>
        <subtask id="2.4">Toast already has Framer Motion entrance/exit animation (lines 314-316)</subtask>
        <subtask id="2.5">Use success color bg-green-50 border-green-200 (matches UX spec #51CF66)</subtask>
      </task>
      <task id="3" name="Optimize for Under 5 Second Flow" ac="AC-5.2.1, AC-5.2.4">
        <subtask id="3.1">Add performance timing measurement in development mode console.time/timeEnd</subtask>
        <subtask id="3.2">Verify optional note field is collapsed by default (current: always visible textarea)</subtask>
        <subtask id="3.3">Log Mood button is immediately visible without scrolling (verify)</subtask>
        <subtask id="3.4">Remove any unnecessary loading states or delays</subtask>
        <subtask id="3.5">Verify mood grid renders within 500ms of component mount</subtask>
      </task>
      <task id="4" name="Ensure Background Sync Doesn't Block UI" ac="AC-5.2.5">
        <subtask id="4.1">Verify syncMoodToSupabase() is called AFTER showing success toast (line 166-178)</subtask>
        <subtask id="4.2">Review moodSlice addMoodEntry - optimistic update pattern confirmed (line 81-83)</subtask>
        <subtask id="4.3">Failed background sync shows subtle indicator (line 173-177 - offlineError state)</subtask>
        <subtask id="4.4">Background sync retry logic from backgroundSync.ts registerBackgroundSync()</subtask>
      </task>
      <task id="5" name="Verify Offline Indicator Integration" ac="AC-5.2.6">
        <subtask id="5.1">NetworkStatusIndicator component exists at src/components/shared/NetworkStatusIndicator.tsx</subtask>
        <subtask id="5.2">Ensure NetworkStatusIndicator is visible in Mood page (may need to add to layout)</subtask>
        <subtask id="5.3">Offline: mood saves to IndexedDB, success toast appears, sync queued (verified in code)</subtask>
      </task>
      <task id="6" name="Add E2E Tests for Quick Mood Flow" ac="All ACs">
        <subtask id="6.1">Create E2E test file tests/e2e/quick-mood-logging.spec.ts</subtask>
        <subtask id="6.2">Test: Mood log completes in under 5 seconds</subtask>
        <subtask id="6.3">Test: Success toast displays for 3 seconds</subtask>
        <subtask id="6.4">Test: Background sync doesn't block UI</subtask>
        <subtask id="6.5">Test: Offline indicator shows when network is disabled</subtask>
      </task>
      <task id="7" name="Add Unit Tests for Haptic Utility">
        <subtask id="7.1">Create test file src/utils/__tests__/haptics.test.ts</subtask>
        <subtask id="7.2">Test: triggerMoodSaveHaptic calls navigator.vibrate with correct pattern</subtask>
        <subtask id="7.3">Test: triggerErrorHaptic calls navigator.vibrate with error pattern</subtask>
        <subtask id="7.4">Test: Graceful fallback when Vibration API not supported</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="AC-5.2.1" description="Mood logging completes in less than 5 seconds from screen load">
      <validation>E2E timing test + performance measurement in dev console</validation>
      <implementation>Add console.time measurements in MoodTracker, verify no blocking operations</implementation>
    </ac>
    <ac id="AC-5.2.2" description="Device vibrates on successful mood save (50ms pulse)">
      <validation>Manual test on mobile device + unit test for haptic utility</validation>
      <implementation>Create src/utils/haptics.ts with triggerMoodSaveHaptic() using navigator.vibrate(50)</implementation>
    </ac>
    <ac id="AC-5.2.3" description="Success toast appears for 3 seconds after save">
      <validation>Visual inspection + E2E test measuring toast duration</validation>
      <implementation>Existing toast in MoodTracker (line 158) already uses setTimeout 3000ms - verify</implementation>
    </ac>
    <ac id="AC-5.2.4" description="Optional note field doesn't block save (can save with just mood)">
      <validation>E2E test + manual verification</validation>
      <implementation>Already implemented - note parameter is optional in addMoodEntry</implementation>
    </ac>
    <ac id="AC-5.2.5" description="Mood syncs to Supabase in background (doesn't block UI)">
      <validation>E2E test + network tab inspection</validation>
      <implementation>Existing pattern in MoodTracker lines 166-178 - syncPendingMoods() called after toast</implementation>
    </ac>
    <ac id="AC-5.2.6" description="Offline indicator shows when device is offline">
      <validation>E2E test using network emulation</validation>
      <implementation>NetworkStatusIndicator exists, verify it's rendered in Mood page layout</implementation>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc type="prd" path="docs/01-PRD/prd.md" relevantSections="FR22-FR28 Mood Tracking requirements">
        <keyRequirements>
          <req id="FR22">Mood emoji selection grid with 12 emotions</req>
          <req id="FR23">Single-tap mood selection with optional note</req>
          <req id="FR24">Haptic feedback on mood save</req>
          <req id="FR25">Background sync to Supabase</req>
          <req id="FR26">Offline mode with local storage</req>
        </keyRequirements>
      </doc>
      <doc type="architecture" path="docs/02-Architecture/architecture.md" relevantSections="Mood Tracking (FR22-28)">
        <patterns>
          <pattern name="Zustand Store">Lightweight state management with optimistic updates</pattern>
          <pattern name="IndexedDB">Local persistence via idb 8.0.3</pattern>
          <pattern name="Vibration API">Browser native haptic feedback</pattern>
          <pattern name="Online-First">Graceful degradation, not offline-first</pattern>
        </patterns>
      </doc>
      <doc type="techSpec" path="docs/05-Epics-Stories/tech-spec-epic-5.md" relevantSections="Story 5.2">
        <implementation>
          <item>Haptic utility with 50ms success vibrate, 100-50-100ms error pattern</item>
          <item>Success toast with CheckCircle icon, 3s auto-dismiss</item>
          <item>Background sync after toast, not blocking UI</item>
          <item>Performance timing measurement in dev mode</item>
        </implementation>
      </doc>
      <doc type="uxSpec" path="docs/09-UX-Spec/ux-design-specification.md" relevantSections="Journey 2: Quick Mood Log">
        <uxDecisions>
          <decision>No intermediate screens or confirmations</decision>
          <decision>Large emoji buttons (48px minimum touch target)</decision>
          <decision>Single tap selection - no confirm action needed</decision>
          <decision>Optional note field collapsed by default</decision>
          <decision>Success toast: green background, check icon, 3 seconds</decision>
        </uxDecisions>
        <colors>
          <color name="success" hex="#51CF66">Success toast background</color>
          <color name="primary" hex="#FF6B6B">Pink borders for selection</color>
        </colors>
        <haptics>
          <pattern name="send" description="Rising pulse">Success feedback for mood save</pattern>
          <pattern name="error" description="Sharp single tap">Error feedback</pattern>
        </haptics>
      </doc>
    </docs>

    <code>
      <file path="src/components/MoodTracker/MoodTracker.tsx" status="exists" relevance="primary">
        <description>Main mood tracker component with emoji grid, multi-select, toast, offline handling</description>
        <keyLines>
          <line num="157-158">Success toast display with 3000ms timeout</line>
          <line num="166-178">Background sync logic after mood save</line>
          <line num="311-326">Success toast component with Framer Motion animation</line>
          <line num="329-355">Offline error component with retry button</line>
          <line num="452-463">Submit button component</line>
        </keyLines>
        <modifications>
          <mod>Add haptic feedback call after setShowSuccess(true) on line 157</mod>
          <mod>Consider collapsing note field by default for faster flow</mod>
        </modifications>
      </file>
      <file path="src/stores/slices/moodSlice.ts" status="exists" relevance="primary">
        <description>Zustand slice for mood state with optimistic updates and sync</description>
        <keyLines>
          <line num="59-108">addMoodEntry with optimistic update pattern</line>
          <line num="209-256">syncPendingMoods with isSyncing flag tracking</line>
        </keyLines>
        <modifications>None required - optimistic update pattern already correct</modifications>
      </file>
      <file path="src/utils/haptics.ts" status="new" relevance="primary">
        <description>NEW FILE - Haptic feedback utility using Vibration API</description>
        <content>
          <function name="triggerMoodSaveHaptic">navigator.vibrate(50) for success</function>
          <function name="triggerErrorHaptic">navigator.vibrate([100, 50, 100]) for error</function>
          <function name="isVibrationSupported">Check if navigator.vibrate exists</function>
        </content>
      </file>
      <file path="src/utils/backgroundSync.ts" status="exists" relevance="secondary">
        <description>Background Sync API registration and service worker messaging</description>
        <keyFunctions>
          <function name="registerBackgroundSync">Register sync tag for offline recovery</function>
          <function name="setupServiceWorkerListener">Listen for SW sync completion</function>
        </keyFunctions>
      </file>
      <file path="src/utils/offlineErrorHandler.ts" status="exists" relevance="secondary">
        <description>Offline error handling with OfflineError class and utilities</description>
        <exports>
          <export name="isOffline">Check navigator.onLine</export>
          <export name="OFFLINE_ERROR_MESSAGE">User-friendly offline message</export>
        </exports>
      </file>
      <file path="src/components/shared/NetworkStatusIndicator.tsx" status="exists" relevance="secondary">
        <description>Visual network status indicator with online/offline/connecting states</description>
        <components>
          <component name="NetworkStatusIndicator">Full banner indicator</component>
          <component name="NetworkStatusDot">Compact inline dot</component>
        </components>
        <note>Ensure this is rendered in Mood page layout</note>
      </file>
      <file path="src/hooks/useNetworkStatus.ts" status="exists" relevance="secondary">
        <description>Hook for network status with isOnline and isConnecting states</description>
      </file>
    </code>

    <dependencies>
      <runtime>
        <dep name="react" version="^19.1.1">Core framework</dep>
        <dep name="zustand" version="^5.0.8">State management</dep>
        <dep name="framer-motion" version="^12.23.24">Animations (toast enter/exit)</dep>
        <dep name="lucide-react" version="^0.554.0">Icons (CheckCircle, WifiOff, RefreshCw)</dep>
        <dep name="idb" version="^8.0.3">IndexedDB wrapper for local storage</dep>
        <dep name="@supabase/supabase-js" version="^2.81.1">Backend sync</dep>
        <dep name="zod" version="^3.25.76">Schema validation</dep>
      </runtime>
      <browserApis>
        <api name="Vibration API">navigator.vibrate() for haptic feedback</api>
        <api name="Background Sync API">Service worker sync registration</api>
        <api name="IndexedDB">Local mood storage</api>
        <api name="Navigator.onLine">Network status detection</api>
      </browserApis>
      <dev>
        <dep name="vitest" version="^4.0.9">Unit testing</dep>
        <dep name="@testing-library/react" version="^16.1.0">React component testing</dep>
        <dep name="@playwright/test" version="^1.56.1">E2E testing</dep>
        <dep name="happy-dom" version="^20.0.10">Test environment</dep>
        <dep name="fake-indexeddb" version="^6.2.5">IndexedDB mock for tests</dep>
      </dev>
    </dependencies>
  </artifacts>

  <constraints>
    <technical>
      <constraint id="C1">Vibration API not supported in all browsers - must handle gracefully</constraint>
      <constraint id="C2">Background Sync API requires service worker - already configured in sw.ts</constraint>
      <constraint id="C3">IndexedDB operations are async - use existing moodService patterns</constraint>
      <constraint id="C4">Online-first architecture - no offline queue, graceful degradation only</constraint>
    </technical>
    <performance>
      <constraint id="P1">Total mood log flow must complete in under 5 seconds</constraint>
      <constraint id="P2">Mood grid must render within 500ms of component mount</constraint>
      <constraint id="P3">Background sync must not block UI thread</constraint>
      <constraint id="P4">Success toast must auto-dismiss after exactly 3 seconds</constraint>
    </performance>
    <ux>
      <constraint id="U1">Minimum 48px touch targets for mood buttons</constraint>
      <constraint id="U2">Success feedback must be immediate (haptic + visual toast)</constraint>
      <constraint id="U3">Offline indicator must be visible when network unavailable</constraint>
    </ux>
  </constraints>

  <interfaces>
    <interface name="HapticUtility">
      <file>src/utils/haptics.ts (NEW)</file>
      <signature>triggerMoodSaveHaptic(): void</signature>
      <signature>triggerErrorHaptic(): void</signature>
      <signature>isVibrationSupported(): boolean</signature>
      <implementation>
        export function triggerMoodSaveHaptic(): void {
          if (isVibrationSupported()) {
            navigator.vibrate(50); // 50ms pulse for success
          }
        }

        export function triggerErrorHaptic(): void {
          if (isVibrationSupported()) {
            navigator.vibrate([100, 50, 100]); // Error pattern
          }
        }

        export function isVibrationSupported(): boolean {
          return typeof navigator !== 'undefined' &amp;&amp; 'vibrate' in navigator;
        }
      </implementation>
    </interface>
    <interface name="MoodSlice.addMoodEntry">
      <file>src/stores/slices/moodSlice.ts</file>
      <signature>addMoodEntry: (moods: MoodType[], note?: string) =&gt; Promise&lt;void&gt;</signature>
      <note>Already implements optimistic update pattern - no changes needed</note>
    </interface>
    <interface name="NetworkStatusIndicator">
      <file>src/components/shared/NetworkStatusIndicator.tsx</file>
      <signature>&lt;NetworkStatusIndicator showOnlyWhenOffline /&gt;</signature>
      <note>Add to Mood page layout if not already present</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard name="coverage">80% threshold for lines, functions, branches, statements</standard>
      <standard name="environment">happy-dom via vitest.config.ts</standard>
      <standard name="setup">tests/setup.ts - fake-indexeddb polyfill, cleanup between tests</standard>
      <standard name="mocking">Mock Framer Motion, Zustand store, background sync utilities</standard>
    </standards>
    <locations>
      <location path="tests/unit/components/MoodTracker.test.tsx" status="exists">
        <description>Existing tests for Story 5.1 - 508 lines, covers emoji grid, multi-select, submission</description>
        <coverageGaps>
          <gap>No haptic feedback tests</gap>
          <gap>No performance timing tests</gap>
          <gap>No toast duration verification</gap>
        </coverageGaps>
      </location>
      <location path="src/utils/__tests__/haptics.test.ts" status="new">
        <description>NEW - Unit tests for haptic utility</description>
      </location>
      <location path="tests/e2e/quick-mood-logging.spec.ts" status="new">
        <description>NEW - E2E tests for quick mood flow</description>
      </location>
      <location path="src/utils/__tests__/backgroundSync.test.ts" status="exists">
        <description>Existing tests for background sync utility</description>
      </location>
    </locations>
    <ideas>
      <testCase id="T1" ac="AC-5.2.1">
        <name>Mood logging completes in under 5 seconds</name>
        <type>E2E (Playwright)</type>
        <approach>
          1. Navigate to mood page
          2. Start timer
          3. Click mood button
          4. Click submit
          5. Wait for success toast
          6. Assert total time &lt; 5000ms
        </approach>
      </testCase>
      <testCase id="T2" ac="AC-5.2.2">
        <name>Haptic feedback triggers on successful save</name>
        <type>Unit (Vitest)</type>
        <approach>
          1. Mock navigator.vibrate
          2. Call triggerMoodSaveHaptic()
          3. Assert navigator.vibrate called with 50
        </approach>
      </testCase>
      <testCase id="T3" ac="AC-5.2.3">
        <name>Success toast displays for exactly 3 seconds</name>
        <type>E2E (Playwright)</type>
        <approach>
          1. Submit mood
          2. Assert toast appears
          3. Wait 3000ms
          4. Assert toast disappears
        </approach>
      </testCase>
      <testCase id="T4" ac="AC-5.2.5">
        <name>Background sync doesn't block UI</name>
        <type>E2E (Playwright)</type>
        <approach>
          1. Submit mood
          2. Assert success toast appears BEFORE sync completes
          3. Mock slow network
          4. Verify UI remains responsive
        </approach>
      </testCase>
      <testCase id="T5" ac="AC-5.2.6">
        <name>Offline indicator shows when offline</name>
        <type>E2E (Playwright)</type>
        <approach>
          1. Navigate to mood page
          2. Set network offline via context.setOffline(true)
          3. Assert NetworkStatusIndicator shows offline state
        </approach>
      </testCase>
      <testCase id="T6" ac="AC-5.2.2">
        <name>Error haptic triggers on failed save</name>
        <type>Unit (Vitest)</type>
        <approach>
          1. Mock navigator.vibrate
          2. Call triggerErrorHaptic()
          3. Assert navigator.vibrate called with [100, 50, 100]
        </approach>
      </testCase>
      <testCase id="T7" ac="AC-5.2.2">
        <name>Graceful fallback when Vibration API not supported</name>
        <type>Unit (Vitest)</type>
        <approach>
          1. Delete navigator.vibrate
          2. Call triggerMoodSaveHaptic()
          3. Assert no error thrown
        </approach>
      </testCase>
    </ideas>
  </tests>

  <implementationNotes>
    <note priority="high">
      Task 1 (Haptics): Create new src/utils/haptics.ts file. Most of the infrastructure exists.
      Import and call in MoodTracker.handleSubmit after line 157 (setShowSuccess(true)).
    </note>
    <note priority="medium">
      Task 2 (Toast): Already implemented correctly at 3000ms. Just verify and document.
    </note>
    <note priority="medium">
      Task 3 (Performance): Add console.time/timeEnd in dev mode. Consider collapsing note field.
    </note>
    <note priority="low">
      Task 4 (Background Sync): Already implemented correctly. Just verify pattern in code review.
    </note>
    <note priority="medium">
      Task 5 (Offline): NetworkStatusIndicator exists. Check if it's rendered in App.tsx or layout.
      May need to add &lt;NetworkStatusIndicator showOnlyWhenOffline /&gt; to mood page.
    </note>
    <note priority="high">
      Task 6 &amp; 7 (Tests): Create new test files. Use existing MoodTracker.test.tsx patterns.
    </note>
  </implementationNotes>
</story-context>

<story-context id="6-0-photo-storage-schema-buckets-setup" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>0</storyId>
    <title>Photo Storage Schema &amp; Buckets Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/05-Epics-Stories/6-0-photo-storage-schema-buckets-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Supabase Storage bucket and photos metadata table with RLS policies created</iWant>
    <soThat>photo features have the required secure storage infrastructure for the Photo Gallery epic</soThat>
    <tasks>
      <task id="1" ac="6.0.2,6.0.10">
        <title>Create photos metadata table</title>
        <subtasks>
          <subtask>Create SQL migration file docs/99-migrations/003_create_photos_table.sql</subtask>
          <subtask>Define table schema with all required columns and constraints</subtask>
          <subtask>Add CHECK constraint for valid mime_type values (image/jpeg, image/png, image/webp)</subtask>
          <subtask>Add CHECK constraint for caption max length (500 chars)</subtask>
          <subtask>Create index on (user_id, created_at DESC) for efficient queries</subtask>
          <subtask>Create index on storage_path for unique lookups</subtask>
          <subtask>Apply migration to Supabase via Dashboard SQL Editor</subtask>
        </subtasks>
      </task>
      <task id="2" ac="6.0.3,6.0.4,6.0.5,6.0.6">
        <title>Enable RLS and create database policies</title>
        <subtasks>
          <subtask>Enable RLS on photos table</subtask>
          <subtask>Create SELECT policy: Users can view own photos</subtask>
          <subtask>Create SELECT policy: Partners can view each other's photos (join with profiles.partner_id)</subtask>
          <subtask>Create INSERT policy: Users can insert with their own user_id</subtask>
          <subtask>Create DELETE policy: Users can delete only their own photos</subtask>
          <subtask>Test RLS policies with different user contexts</subtask>
        </subtasks>
      </task>
      <task id="3" ac="6.0.1">
        <title>Create Supabase Storage bucket</title>
        <subtasks>
          <subtask>Create `photos` bucket via Supabase Dashboard (Storage &gt; New Bucket)</subtask>
          <subtask>Set bucket to private (public: false)</subtask>
          <subtask>Configure bucket settings (file size limit: 10MB)</subtask>
          <subtask>Verify bucket creation successful</subtask>
        </subtasks>
      </task>
      <task id="4" ac="6.0.7,6.0.8,6.0.9">
        <title>Configure Storage RLS policies</title>
        <subtasks>
          <subtask>Create INSERT policy: Users upload to own folder (photos/{user_id}/*)</subtask>
          <subtask>Create SELECT policy: Users read own photos</subtask>
          <subtask>Create SELECT policy: Partners read each other's photos</subtask>
          <subtask>Create DELETE policy: Users delete own photos only</subtask>
          <subtask>Test storage policies with authenticated requests</subtask>
        </subtasks>
      </task>
      <task id="5" ac="All">
        <title>Create photoService foundation</title>
        <subtasks>
          <subtask>Create src/services/photoService.ts with Supabase client</subtask>
          <subtask>Implement getSignedUrl(storagePath) for private photo access</subtask>
          <subtask>Implement checkStorageQuota() for usage monitoring</subtask>
          <subtask>Add TypeScript types for Photo interface in src/types/models.ts</subtask>
          <subtask>Export service for use by future stories</subtask>
        </subtasks>
      </task>
      <task id="6" ac="All">
        <title>Validation and testing</title>
        <subtasks>
          <subtask>Write unit tests for photoService methods</subtask>
          <subtask>Verify RLS policies block unauthorized access</subtask>
          <subtask>Test partner photo access via profiles.partner_id relationship</subtask>
          <subtask>Verify indexes improve query performance (EXPLAIN ANALYZE)</subtask>
          <subtask>Document any deviations or decisions in Dev Notes</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="6.0.1">Supabase Storage bucket `photos` exists with `public: false`</criterion>
    <criterion id="6.0.2">`photos` metadata table exists with columns: id (UUID), user_id (UUID FK), storage_path (TEXT), filename (TEXT), caption (TEXT), mime_type (TEXT), file_size (INTEGER), width (INTEGER), height (INTEGER), created_at (TIMESTAMPTZ)</criterion>
    <criterion id="6.0.3">RLS policy allows users to SELECT only their own photos</criterion>
    <criterion id="6.0.4">RLS policy allows partners to SELECT each other's photos (via profiles.partner_id)</criterion>
    <criterion id="6.0.5">RLS policy allows users to INSERT photos only with their own user_id</criterion>
    <criterion id="6.0.6">RLS policy allows users to DELETE only their own photos</criterion>
    <criterion id="6.0.7">Storage RLS policy restricts uploads to user's own folder ({user_id}/)</criterion>
    <criterion id="6.0.8">Storage RLS policy allows users to read their own photos</criterion>
    <criterion id="6.0.9">Storage RLS policy allows partners to read each other's photos</criterion>
    <criterion id="6.0.10">Indexes exist on (user_id, created_at DESC) for efficient gallery queries</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/05-Epics-Stories/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Data Models and Contracts, Acceptance Criteria</section>
        <snippet>Contains complete SQL schema for photos table, RLS policies, and storage bucket configuration. Defines Photo TypeScript interface and photoService API.</snippet>
      </doc>
      <doc>
        <path>docs/02-Architecture/architecture.md</path>
        <title>My-Love PWA Architecture</title>
        <section>Supabase Schema, Implementation Patterns</section>
        <snippet>Defines project structure, Supabase patterns, Zustand store patterns, and error handling conventions. Photo Storage maps to src/services/photoService.ts.</snippet>
      </doc>
      <doc>
        <path>docs/01-PRD/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Photo Gallery (FR29-35)</section>
        <snippet>FR35: System syncs uploaded photos to Supabase for partner visibility. FR29-34 define upload, compression, gallery, and viewing requirements.</snippet>
      </doc>
      <doc>
        <path>docs/99-migrations/002_add_partner_relationship.sql</path>
        <title>Partner Relationship Migration</title>
        <section>Full file - RLS pattern reference</section>
        <snippet>Example migration with RLS policies for partner-aware access. Shows pattern for partner_id joins and bidirectional relationship checks.</snippet>
      </doc>
      <doc>
        <path>docs/04-Testing-QA/playwright-test-suite.md</path>
        <title>Playwright Test Suite Documentation</title>
        <section>Test Helpers, Architecture</section>
        <snippet>Defines console/network monitors for E2E tests. Tests live in tests/e2e/ with monitoredTest fixtures for automatic error detection.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/photoStorageService.ts</path>
        <kind>service</kind>
        <symbol>PhotoStorageService</symbol>
        <lines>1-384</lines>
        <reason>Existing IndexedDB photo storage service. Story 6.0 creates Supabase counterpart (photoService.ts) for server-side storage.</reason>
      </artifact>
      <artifact>
        <path>src/services/imageCompressionService.ts</path>
        <kind>service</kind>
        <symbol>ImageCompressionService</symbol>
        <lines>1-167</lines>
        <reason>Client-side image compression using Canvas API. Already implemented. Future stories (6-1, 6-2) will integrate this with Supabase uploads.</reason>
      </artifact>
      <artifact>
        <path>src/api/partnerService.ts</path>
        <kind>service</kind>
        <symbol>PartnerService</symbol>
        <lines>1-346</lines>
        <reason>Partner relationship service showing patterns for RLS-aware queries. Uses users.partner_id for partner access - same pattern needed for photos.</reason>
      </artifact>
      <artifact>
        <path>src/api/supabaseClient.ts</path>
        <kind>client</kind>
        <symbol>supabase, getPartnerId</symbol>
        <lines>1-126</lines>
        <reason>Supabase client singleton. New photoService.ts must import supabase from here. Uses Database types from src/types/database.types.ts.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>Photo, CompressionResult</symbol>
        <lines>31-63</lines>
        <reason>Existing Photo type for IndexedDB. Story 6.0 Task 5 adds new Supabase Photo interface with storage_path, filename, etc.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.81.1</version>
        <purpose>Supabase client for Storage and Database operations</purpose>
      </node>
      <node>
        <package>zustand</package>
        <version>^5.0.8</version>
        <purpose>State management - photosSlice for client-side photo state</purpose>
      </node>
      <node>
        <package>zod</package>
        <version>^3.25.76</version>
        <purpose>Runtime validation for Photo schema</purpose>
      </node>
      <node>
        <package>idb</package>
        <version>^8.0.3</version>
        <purpose>IndexedDB wrapper - existing photoStorageService uses this</purpose>
      </node>
      <devDependencies>
        <package>vitest</package>
        <version>^4.0.9</version>
        <purpose>Unit testing framework</purpose>
      </devDependencies>
      <devDependencies>
        <package>@playwright/test</package>
        <version>^1.56.1</version>
        <purpose>E2E testing framework</purpose>
      </devDependencies>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Online-first pattern: Photo uploads require network connectivity (no offline queue for uploads)</constraint>
    <constraint type="architecture">Storage layer: Supabase Storage bucket 'photos' for binary files with signed URLs</constraint>
    <constraint type="architecture">Data layer: 'photos' metadata table in Supabase PostgreSQL with RLS</constraint>
    <constraint type="architecture">Service layer: src/services/photoService.ts for Supabase Storage operations</constraint>
    <constraint type="security">Storage bucket must be private (public: false) with signed URL access</constraint>
    <constraint type="security">RLS policies must validate user ownership and partner relationship</constraint>
    <constraint type="security">Storage RLS uses folder-based validation: (storage.foldername(name))[1] = auth.uid()</constraint>
    <constraint type="performance">Storage quota: 1GB free tier - implement 80%/95% warning thresholds</constraint>
    <constraint type="performance">File size limit: Max 10MB per photo after compression</constraint>
    <constraint type="performance">Signed URL expiry: 1 hour for private photo access</constraint>
    <constraint type="convention">Migration file naming: 003_create_photos_table.sql (sequential numbering)</constraint>
    <constraint type="convention">Service pattern: Follow partnerService.ts structure with try/catch and console logging</constraint>
    <constraint type="convention">Storage path pattern: {user_id}/{uuid}.jpg</constraint>
    <constraint type="dependency">Requires profiles.partner_id relationship from Epic 0-3 (migration 002)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Supabase Storage Upload</name>
      <kind>API</kind>
      <signature>supabase.storage.from('photos').upload(path, file, options): Promise&lt;{data: {path}, error}&gt;</signature>
      <path>@supabase/supabase-js</path>
    </interface>
    <interface>
      <name>Supabase Storage Signed URL</name>
      <kind>API</kind>
      <signature>supabase.storage.from('photos').createSignedUrl(path, expiresIn): Promise&lt;{data: {signedUrl}, error}&gt;</signature>
      <path>@supabase/supabase-js</path>
    </interface>
    <interface>
      <name>Supabase Storage Delete</name>
      <kind>API</kind>
      <signature>supabase.storage.from('photos').remove([path]): Promise&lt;{data, error}&gt;</signature>
      <path>@supabase/supabase-js</path>
    </interface>
    <interface>
      <name>Photos Table Insert</name>
      <kind>Database</kind>
      <signature>supabase.from('photos').insert({user_id, storage_path, filename, caption, mime_type, file_size, width, height})</signature>
      <path>src/services/photoService.ts (to be created)</path>
    </interface>
    <interface>
      <name>Photos Table Select</name>
      <kind>Database</kind>
      <signature>supabase.from('photos').select('*').order('created_at', {ascending: false})</signature>
      <path>src/services/photoService.ts (to be created)</path>
    </interface>
    <interface>
      <name>Partner ID Query</name>
      <kind>Function</kind>
      <signature>getPartnerId(): Promise&lt;string | null&gt;</signature>
      <path>src/api/supabaseClient.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest with React Testing Library. Tests follow AAA pattern (Arrange-Act-Assert).
      Service tests mock Supabase client responses. RLS policy tests require SQL queries as different user contexts.
      E2E tests use Playwright with monitoredTest fixtures for automatic console/network error detection.
      Test files live in tests/unit/ and tests/e2e/ directories following existing patterns from Epic 1.
    </standards>
    <locations>
      <location>tests/unit/services/photoService.test.ts</location>
      <location>tests/e2e/photos/*.spec.ts</location>
      <location>SQL verification queries in migration file</location>
    </locations>
    <ideas>
      <idea ac="6.0.1">Verify photos bucket exists with public=false via Supabase Dashboard or API</idea>
      <idea ac="6.0.2">Unit test: Verify table schema matches spec (columns, types, constraints)</idea>
      <idea ac="6.0.3">SQL test: Query as user A, verify only user A's photos returned</idea>
      <idea ac="6.0.4">SQL test: Query as partner, verify partner's photos visible via partner_id join</idea>
      <idea ac="6.0.5">SQL test: Insert with different user_id, expect RLS violation</idea>
      <idea ac="6.0.6">SQL test: Delete as non-owner, expect RLS violation</idea>
      <idea ac="6.0.7">Integration test: Upload to wrong folder path, expect storage policy rejection</idea>
      <idea ac="6.0.8">Integration test: Generate signed URL for own photo, verify accessible</idea>
      <idea ac="6.0.9">Integration test: Partner can get signed URL for partner's photo</idea>
      <idea ac="6.0.10">SQL test: EXPLAIN ANALYZE on photo query, verify index scan used</idea>
      <idea ac="All">Unit test: photoService.getSignedUrl returns valid URL with 1-hour expiry</idea>
      <idea ac="All">Unit test: photoService.checkStorageQuota returns usage percentage</idea>
    </ideas>
  </tests>
</story-context>

<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>Message History State Management</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-3-message-history-state-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to track message history in the Zustand store with deterministic daily rotation</iWant>
    <soThat>swipe navigation knows which messages have been shown and can prevent future browsing</soThat>
    <tasks>
**Phase 1: Message Rotation Algorithm (2 hours)**
- Create src/utils/messageRotation.ts with rotation functions
- Implement hash-based deterministic message selection
- Write unit tests for messageRotation.test.ts
- Validate algorithm consistency

**Phase 2: Zustand Store Enhancement (3 hours)**
- Add messageHistory state slice to useAppStore
- Implement navigation actions (navigateToPreviousMessage, navigateToNextMessage)
- Implement getters (canNavigateBack, canNavigateForward)
- Configure persist middleware for Map serialization
- Enhance updateCurrentMessage() action

**Phase 3: DailyMessage Component Integration (1 hour)**
- Update DailyMessage.tsx to use navigation actions
- Connect to useSwipeGesture hook from Story 3.2
- Test swipe gesture integration

**Phase 4: Integration Testing (2 hours)**
- Create E2E tests for all 6 acceptance criteria
- Run tests in all browsers (Chromium, Firefox, WebKit)
- Complete manual testing checklist

**Phase 5: Documentation & Handoff (1 hour)**
- Update architecture documentation
- Update sprint-status.yaml
- Document learnings for Story 3.4
    </tasks>
  </story>

  <acceptanceCriteria>
**AC-3.3.1: Message History State Tracking**
Store SHALL track currentIndex, shownMessages Map, and maxHistoryDays in Zustand store

**AC-3.3.2: History Persistence Across Sessions**
Message history SHALL persist via LocalStorage using Zustand persist middleware

**AC-3.3.3: Deterministic Daily Message Algorithm**
Algorithm SHALL always return the same message for the same date (deterministic rotation)

**AC-3.3.4: Future Date Prevention**
System SHALL prevent loading messages from future dates (canNavigateForward() = false when currentIndex === 0)

**AC-3.3.5: First-Time User Edge Case**
Message history SHALL start with today only for first-time users (no historical entries)

**AC-3.3.6: Skipped Days Edge Case**
System SHALL show messages for all skipped days when user returns after absence
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-3.md</path>
        <title>Epic 3 Technical Specification</title>
        <section>State Management - Zustand Store Actions</section>
        <snippet>Defines navigation actions (navigateToPreviousMessage, navigateToNextMessage, canNavigateBack, canNavigateForward) and message rotation algorithm APIs that Story 3.3 implements.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Application Architecture</title>
        <section>State Management - Zustand with Persist Middleware</section>
        <snippet>Documents centralized state management using Zustand 5.0.8 with persistence middleware for LocalStorage integration. Partialize strategy persists only critical state (settings, messageHistory, moods) while keeping transient state in memory.</snippet>
      </doc>
      <doc>
        <path>docs/state-management.md</path>
        <title>State Management Guide</title>
        <section>Zustand Store Architecture and Persist Middleware</section>
        <snippet>Comprehensive guide to Zustand patterns, persist middleware configuration, error handling strategies, and troubleshooting for state persistence issues.</snippet>
      </doc>
      <doc>
        <path>docs/data-models.md</path>
        <title>Data Models</title>
        <section>MessageHistory Interface</section>
        <snippet>Defines MessageHistory type for tracking message rotation (currentIndex, shownMessages Map, maxHistoryDays). Persisted via Zustand persist middleware to LocalStorage.</snippet>
      </doc>
      <doc>
        <path>docs/technical-decisions.md</path>
        <title>Technical Decisions</title>
        <section>State Management - Zustand Persist Configuration</section>
        <snippet>Documents fix for Zustand persist middleware (Story 1.2) including error handling, state versioning, and partialize strategy. Critical context for extending persist with messageHistory state.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>AppState interface</symbol>
        <lines>15-63</lines>
        <reason>Main Zustand store interface. Contains messageHistory state, currentDayOffset for navigation, and all navigation actions that Story 3.3 enhances.</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>persist middleware configuration</symbol>
        <lines>412-462</lines>
        <reason>Persist middleware config with partialize, onRehydrateStorage, and version. Story 3.3 extends partialize to serialize messageHistory Map to array.</reason>
      </artifact>
      <artifact>
        <path>src/utils/messageRotation.ts</path>
        <kind>utility</kind>
        <symbol>getDailyMessageId, getTodayMessage, getMessageForDate</symbol>
        <lines>1-130</lines>
        <reason>Existing message rotation algorithm. Story 3.3 enhances with deterministic date-based hash for consistent daily message selection.</reason>
      </artifact>
      <artifact>
        <path>src/components/DailyMessage/DailyMessage.tsx</path>
        <kind>component</kind>
        <symbol>DailyMessage component</symbol>
        <lines>1-end</lines>
        <reason>Main message display component. Story 3.3 integrates navigation actions with Story 3.2's useSwipeGesture hook.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>Message, MessageHistory, Settings types</symbol>
        <lines>various</lines>
        <reason>Type definitions for messages and message history tracking. Story 3.3 uses MessageHistory interface for state shape.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <zustand version="5.0.8">State management with persist middleware</zustand>
        <react version="19.1.1">UI framework</react>
        <react-dom version="19.1.1">React DOM bindings</react-dom>
        <framer-motion version="12.23.24">Animation library for message transitions</framer-motion>
        <idb version="8.0.3">IndexedDB wrapper for message storage</idb>
      </node>
      <devDependencies>
        <typescript version="5.9.3">Type safety</typescript>
        <playwright version="1.56.1">E2E testing framework</playwright>
        <vite version="7.1.7">Build tool</vite>
      </devDependencies>
    </dependencies>
  </artifacts>

  <constraints>
    <development>
      <pattern>Follow existing Zustand store patterns - actions are synchronous state updates, async only for I/O operations</pattern>
      <pattern>Use persist middleware partialize strategy to control what gets saved to LocalStorage</pattern>
      <pattern>Console logging for debug decisions in dev mode only: if (import.meta.env.DEV) console.log(...)</pattern>
      <pattern>Map serialization: Convert Map to Array for JSON storage, reconstruct on rehydration</pattern>
      <pattern>Error handling: fail gracefully with console warnings, never throw exceptions in state updates</pattern>
    </development>
    <architecture>
      <constraint>Extends existing Zustand store - no new stores or state management patterns</constraint>
      <constraint>Leverages existing persist middleware from Story 1.2 fixes - same error handling approach</constraint>
      <constraint>Must integrate with Story 3.2's useSwipeGesture hook - provide callbacks for navigation</constraint>
      <constraint>Offline-first: No network required for message navigation and history tracking</constraint>
    </architecture>
    <performance>
      <constraint>Navigation latency: < 10ms from action call to state update</constraint>
      <constraint>Message lookup: < 50ms to calculate or retrieve from cache</constraint>
      <constraint>LocalStorage growth: < 1KB per 30 days of history tracking</constraint>
      <constraint>History limit: 30-day default, respects relationship start date as floor</constraint>
    </performance>
    <testing>
      <constraint>Unit tests required for messageRotation.ts algorithm functions</constraint>
      <constraint>E2E tests required for all 6 acceptance criteria using Playwright</constraint>
      <constraint>No regression in Epic 1-2 tests - all 53 existing tests must pass</constraint>
      <constraint>Manual testing checklist must be 100% complete before review</constraint>
    </testing>
  </constraints>
  <interfaces>
    <zustand-actions>
      <action>
        <name>navigateToPreviousMessage</name>
        <signature>() => void</signature>
        <description>Increment currentIndex, calculate target date, check/update shownMessages cache, set currentMessage</description>
      </action>
      <action>
        <name>navigateToNextMessage</name>
        <signature>() => void</signature>
        <description>Decrement currentIndex, calculate target date, load cached message, set currentMessage</description>
      </action>
      <action>
        <name>canNavigateBack</name>
        <signature>() => boolean</signature>
        <description>Returns true if currentIndex < maxHistoryDays (respects relationship start date)</description>
      </action>
      <action>
        <name>canNavigateForward</name>
        <signature>() => boolean</signature>
        <description>Returns true if currentIndex > 0 (can navigate toward today)</description>
      </action>
      <action>
        <name>updateCurrentMessage</name>
        <signature>() => void</signature>
        <description>Enhanced to check shownMessages cache for today, calculate if missing, always set currentIndex to 0</description>
      </action>
    </zustand-actions>
    <rotation-algorithm>
      <function>
        <name>getDailyMessage</name>
        <signature>(allMessages: Message[], date: Date) => Message</signature>
        <description>Deterministic message selection using date-based hash. Hash function: sum char codes, modulo pool length</description>
      </function>
      <function>
        <name>hashDateString</name>
        <signature>(dateString: string) => number</signature>
        <description>Simple hash: iterate chars, hash = (hash << 5) - hash + charCode, return Math.abs(hash)</description>
      </function>
      <function>
        <name>formatDate</name>
        <signature>(date: Date) => string</signature>
        <description>Format as "YYYY-MM-DD" with zero-padding for month and day</description>
      </function>
      <function>
        <name>getAvailableHistoryDays</name>
        <signature>(messageHistory: MessageHistory, settings: Settings) => number</signature>
        <description>Returns min(maxHistoryDays, daysSinceRelationshipStart, 30)</description>
      </function>
    </rotation-algorithm>
    <story-3-2-integration>
      <hook>
        <name>useSwipeGesture</name>
        <signature>(onSwipeLeft: () => void, onSwipeRight: () => void, canSwipeLeft: boolean, canSwipeRight: boolean) => SwipeGestureProps</signature>
        <description>Story 3.2 hook that expects navigation callbacks and boundary checks from Story 3.3</description>
      </hook>
    </story-3-2-integration>
  </interfaces>
  <tests>
    <standards>
      <framework>Playwright 1.56.1 for E2E testing with multi-browser support (Chromium, Firefox, WebKit)</framework>
      <patterns>Page Object Model for reusable selectors using data-testid attributes</patterns>
      <patterns>PWA-specific helpers for LocalStorage/IndexedDB inspection and manipulation</patterns>
      <patterns>Test isolation: Each test starts with clean state (clearLocalStorage, clearIndexedDB)</patterns>
      <patterns>Assertions validate both UI state AND underlying data persistence</patterns>
      <coverage>Unit tests for algorithm functions (messageRotation.ts) with 100% coverage target</coverage>
      <coverage>E2E tests for all acceptance criteria with browser refresh scenarios</coverage>
    </standards>
    <locations>
      <unit>src/utils/messageRotation.test.ts (create new for algorithm tests)</unit>
      <unit>src/stores/useAppStore.test.ts (if store unit tests exist)</unit>
      <e2e>tests/e2e/message-history.spec.ts (create new for AC-3.3.2 through AC-3.3.6)</e2e>
      <e2e>tests/e2e/swipe-navigation.spec.ts (Story 3.2 - verify integration with navigation actions)</e2e>
      <e2e>tests/e2e/message-display.spec.ts (Epic 2 - verify no regressions in message display)</e2e>
    </locations>
    <ideas>
      <test ac="AC-3.3.1">
        <name>Message history state tracking initialized correctly</name>
        <approach>Use React DevTools or programmatic store access to inspect initial messageHistory state after app load</approach>
      </test>
      <test ac="AC-3.3.2">
        <name>History persists across browser sessions</name>
        <approach>Navigate to 3 days back, close context, reopen, navigate to same dates, verify same message IDs shown</approach>
      </test>
      <test ac="AC-3.3.3">
        <name>Deterministic message selection</name>
        <approach>Call getDailyMessage() 100 times with same date, assert all return same message ID (hash consistency test)</approach>
      </test>
      <test ac="AC-3.3.4">
        <name>Future date prevention</name>
        <approach>On today view, attempt keyboard arrow right and programmatic navigateToNextMessage(), verify no state change</approach>
      </test>
      <test ac="AC-3.3.5">
        <name>First-time user starts with today only</name>
        <approach>Clear all storage, load app, verify canNavigateBack() returns false and shownMessages has only 1 entry</approach>
      </test>
      <test ac="AC-3.3.6">
        <name>Skipped days filled on navigation</name>
        <approach>Set shownMessages to only have entry for 3 days ago, navigate back through each day, verify all intermediate dates get entries</approach>
      </test>
      <test integration="Story 3.2">
        <name>Swipe left triggers navigateToPreviousMessage</name>
        <approach>Simulate drag gesture, verify currentIndex increments and currentMessage updates</approach>
      </test>
      <test integration="Story 3.2">
        <name>Drag constraints respect navigation boundaries</name>
        <approach>On today, verify right drag disabled. Navigate to yesterday, verify right drag enabled.</approach>
      </test>
      <test regression="Epic 1-2">
        <name>All 53 existing tests pass</name>
        <approach>Run full E2E suite: npm run test:e2e, verify no regressions in message-display, favorites, settings, navigation, persistence tests</approach>
      </test>
    </ideas>
  </tests>
</story-context>
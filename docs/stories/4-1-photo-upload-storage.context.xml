<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.1</storyId>
    <title>Photo Upload & Storage</title>
    <status>drafted</status>
    <generatedAt>2025-11-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-1-photo-upload-storage.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>to upload photos with captions</iWant>
    <soThat>I can preserve special memories in the app</soThat>
    <tasks>
      <task id="AC-4.1.1" priority="high">Photos Tab Opens Gallery View - Tab navigation integration with placeholder view for testing</task>
      <task id="AC-4.1.2" priority="high">Upload Button Triggers File Picker - File input accepting JPEG/PNG/WebP only</task>
      <task id="AC-4.1.3" priority="high">Photo Preview Before Upload - Display preview with size estimates, caption/tags input</task>
      <task id="AC-4.1.4" priority="medium">Caption Text Area - Optional caption field with 500 char limit and emoji support</task>
      <task id="AC-4.1.5" priority="medium">Tags Input Field - Comma-separated tags parsing with validation (max 10 tags, 50 chars each)</task>
      <task id="AC-4.1.6" priority="critical">Photo Compressed Client-Side - Canvas API compression (max 1920px, 80% quality JPEG)</task>
      <task id="AC-4.1.7" priority="critical">Photo Saved to IndexedDB - Save compressed blob with metadata to photos store</task>
      <task id="AC-4.1.8" priority="medium">Success Feedback After Upload - Toast notification with auto-dismiss</task>
      <task id="AC-4.1.9" priority="high">Error Handling for Upload Failures - Comprehensive error messages for 5 error types</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.1.1">
      <title>Photos Tab Opens Gallery View</title>
      <given>user is on Home view</given>
      <when>user taps "Photos" tab in top navigation</when>
      <then>photo gallery view SHALL open (placeholder for Story 4.2)</then>
      <validation>
        - Photos tab visible in navigation with camera icon
        - Temporarily shows PhotoUpload modal for Story 4.1 testing
        - Full gallery grid implemented in Story 4.2
      </validation>
    </criterion>
    <criterion id="AC-4.1.2">
      <title>Upload Button Triggers File Picker</title>
      <given>photo gallery is open</given>
      <when>user taps "Upload Photo" button</when>
      <then>system file picker SHALL open accepting only image files (JPEG, PNG, WebP)</then>
      <requirements>
        - File input accept="image/jpeg,image/png,image/webp"
        - Single file selection (no multiple uploads in MVP)
        - Cross-platform compatibility (iOS/Android/desktop)
      </requirements>
    </criterion>
    <criterion id="AC-4.1.3">
      <title>Photo Preview Before Upload</title>
      <given>user selected photo from file picker</given>
      <when>photo file is loaded</when>
      <then>preview screen displays image, file sizes, caption/tags input, upload/cancel buttons</then>
      <requirements>
        - Preview uses URL.createObjectURL() for immediate display
        - Compression estimate calculated before actual compression
        - Preview maintains aspect ratio (max 400px width)
      </requirements>
    </criterion>
    <criterion id="AC-4.1.4">
      <title>Caption Text Area (Optional, Max 500 Characters)</title>
      <requirements>
        - Textarea with placeholder "Add a caption to your photo..."
        - Character counter (500 max)
        - Optional field (empty allowed)
        - Emoji support, multi-line input
      </requirements>
    </criterion>
    <criterion id="AC-4.1.5">
      <title>Tags Input Field (Comma-Separated, Optional, Max 10 Tags)</title>
      <requirements>
        - Input field with placeholder "beach, sunset, memories"
        - Parse by splitting on commas and trimming whitespace
        - Max 10 tags, max 50 chars per tag
        - Case-insensitive duplicate detection
        - Optional field (empty allowed)
      </requirements>
    </criterion>
    <criterion id="AC-4.1.6">
      <title>Photo Compressed Client-Side Before Storage</title>
      <when>user taps "Upload" button</when>
      <then>photo SHALL be compressed using native Canvas API with max 1920px dimensions, 80% JPEG quality</then>
      <requirements>
        - Compression runs client-side (no server upload)
        - Loading indicator during compression
        - Typical compression: 3-5MB → 300-500KB (90% reduction)
        - Compression logged with timing metrics
      </requirements>
    </criterion>
    <criterion id="AC-4.1.7">
      <title>Photo Saved to IndexedDB with Metadata</title>
      <given>photo compression completed successfully</given>
      <then>photo SHALL be saved to IndexedDB photos store with full metadata</then>
      <schema>
        - id: auto-incremented number (primary key)
        - imageBlob: Blob (compressed JPEG)
        - caption: string | undefined
        - tags: string[]
        - uploadDate: Date
        - originalSize, compressedSize, width, height, mimeType
      </schema>
      <requirements>
        - Database version 1 → 2
        - photos object store with by-date index
        - Migration runs on app init
        - Blob stored directly (not base64)
      </requirements>
    </criterion>
    <criterion id="AC-4.1.8">
      <title>Success Feedback After Upload</title>
      <then>success feedback SHALL display "Photo uploaded! ✨"</then>
      <requirements>
        - Toast notification (not modal)
        - Framer Motion fade in/out
        - Auto-dismiss after 3 seconds
        - PhotoUpload modal closes
      </requirements>
    </criterion>
    <criterion id="AC-4.1.9">
      <title>Error Handling for Upload Failures</title>
      <errorTypes>
        1. Unsupported File Format - "Unsupported file format. Please select JPEG, PNG, or WebP"
        2. File Too Large Warning - "File very large (12.5 MB). Compression may take longer"
        3. Storage Quota Exceeded - "Storage full! Delete some photos to free up space"
        4. Quota Warning (80% Full) - "Storage 80% full (40MB / 50MB). Consider deleting old photos"
        5. Compression Failure - "Failed to compress image. Try a different photo"
      </errorTypes>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Story 4.1: Photo Upload &amp; Storage</section>
        <snippet>Detailed technical implementation for photo upload with client-side compression (max 1920px, 80% JPEG quality), IndexedDB persistence with photos object store, and comprehensive error handling for storage quota management.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Data Models - Photo Interface</section>
        <snippet>Photo interface defines: id (auto-increment), imageBlob (Blob), caption (optional, max 500 chars), tags (string[]), uploadDate (Date), originalSize, compressedSize, width, height, mimeType. Stored in IndexedDB photos object store with by-date index.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>APIs - Photo Storage Service</section>
        <snippet>PhotoStorageService provides IndexedDB CRUD operations: create(photo), getAll(), getById(id), getStorageSize(), estimateQuotaRemaining(). Follows singleton pattern with init() guard like customMessageService.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>APIs - Image Compression Service</section>
        <snippet>ImageCompressionService handles client-side compression using native Canvas API: compressImage(file, options), validateImageFile(file), loadImage(file). No external library needed - uses browser Canvas API for resize and JPEG conversion.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>IndexedDB Schema</section>
        <snippet>Database: my-love-db. Photos object store with auto-increment key, by-date index on uploadDate. Messages object store with by-category and by-date indexes. Story 4.1 increments DB version from 1 to 2 to add photos store.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR012-FR015: Photo Gallery Requirements</section>
        <snippet>FR012: Upload photos with captions and tags. FR013: Display in carousel/gallery with animated transitions. FR014: Store in IndexedDB with compression. FR015: Navigation interface to access gallery. NFR005: Client-side storage only for privacy.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/customMessageService.ts</path>
        <kind>service</kind>
        <symbol>CustomMessageService</symbol>
        <lines>1-60</lines>
        <reason>Reference pattern for Story 4.1 photoStorageService: Singleton class with init() guard, comprehensive error handling, IndexedDB operations using idb library, console logging for observability.</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>AppState interface</symbol>
        <lines>1-60</lines>
        <reason>Pattern for extending Zustand store with photos state slice: photos array, loading states (isLoadingPhotos), error state (photoError), actions for CRUD operations following existing message action patterns.</reason>
      </artifact>
      <artifact>
        <path>src/components/AdminPanel/CreateMessageForm.tsx</path>
        <kind>component</kind>
        <symbol>CreateMessageForm</symbol>
        <lines>N/A</lines>
        <reason>Reference pattern for PhotoUpload modal component: Modal form with Framer Motion AnimatePresence, input validation, submit handling, toast notifications, data-testid attributes for E2E testing.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>Photo interface</symbol>
        <lines>20-26</lines>
        <reason>Existing Photo interface needs enhancement: Add fields for compression metadata (originalSize, compressedSize, width, height, mimeType). Change blob field name to imageBlob for clarity. Add optional caption field (max 500 chars).</reason>
      </artifact>
      <artifact>
        <path>src/services/storage.ts</path>
        <kind>service</kind>
        <symbol>storageService</symbol>
        <lines>N/A</lines>
        <reason>Existing IndexedDB initialization and migration patterns. Story 4.1 must increment DB version from 1 to 2 and create photos object store with by-date index in migration function.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>react</package>
        <version>^19.1.1</version>
        <usage>PhotoUpload component, preview rendering</usage>
      </node>
      <node>
        <package>framer-motion</package>
        <version>^12.23.24</version>
        <usage>Modal animations (AnimatePresence), entrance/exit transitions</usage>
      </node>
      <node>
        <package>idb</package>
        <version>^8.0.3</version>
        <usage>IndexedDB wrapper for photoStorageService CRUD operations</usage>
      </node>
      <node>
        <package>zustand</package>
        <version>^5.0.8</version>
        <usage>State management - extend store with photos slice</usage>
      </node>
      <node>
        <package>lucide-react</package>
        <version>^0.548.0</version>
        <usage>Icons - Camera, Upload, X (close) icons</usage>
      </node>
      <node>
        <package>typescript</package>
        <version>~5.9.3</version>
        <usage>Type definitions for Photo, PhotoUploadInput, CompressionOptions interfaces</usage>
      </node>
      <node>
        <package>@playwright/test</package>
        <version>^1.56.1</version>
        <usage>E2E testing - photo upload, compression, IndexedDB validation</usage>
      </node>
      <browser-api>Canvas API</browser-api>
      <browser-api>FileReader API</browser-api>
      <browser-api>Blob API</browser-api>
      <browser-api>URL.createObjectURL()</browser-api>
      <browser-api>navigator.storage.estimate()</browser-api>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Follow established service layer pattern from customMessageService: singleton class with init() guard, async/await operations, comprehensive error handling and logging</constraint>
    <constraint type="architecture">Extend Zustand useAppStore with photos slice following existing patterns: photos array state, loading/error states, actions that call service methods</constraint>
    <constraint type="data">Database version must increment from 1 to 2 with migration function to create photos object store and by-date index on app initialization</constraint>
    <constraint type="data">Photos stored as Blob in IndexedDB (not base64) due to size efficiency - typical 300-500KB per compressed photo enables 50-100 photos within 50MB quota</constraint>
    <constraint type="performance">Client-side compression must complete in &lt;3 seconds for typical 3-5MB JPEG photos using native Canvas API (no external library)</constraint>
    <constraint type="performance">Compression target: max 1920px dimensions, 80% JPEG quality, typical 90% size reduction (3MB → 300KB)</constraint>
    <constraint type="storage">Monitor IndexedDB quota via navigator.storage.estimate() - warn at 80% usage, block uploads at 95% usage with actionable error messages</constraint>
    <constraint type="validation">File type validation: Accept only image/jpeg, image/png, image/webp MIME types. Warn if file &gt;10MB (performance impact).</constraint>
    <constraint type="validation">Caption validation: Optional field, max 500 characters, emoji support, multi-line textarea input</constraint>
    <constraint type="validation">Tags validation: Optional comma-separated input, max 10 tags per photo, max 50 characters per tag, case-insensitive duplicate detection</constraint>
    <constraint type="component">PhotoUpload modal follows AdminPanel form patterns: Framer Motion AnimatePresence, hidden file input with custom button trigger, toast notifications for success/error feedback</constraint>
    <constraint type="component">All components must include data-testid attributes following pattern: [component]-[element]-[action] for E2E test selectors</constraint>
    <constraint type="testing">Use real IndexedDB and blob storage in E2E tests (not mocked) - verify actual compression, persistence, and retrieval operations</constraint>
    <constraint type="error-handling">Comprehensive error handling for 5 error types: unsupported format, file too large (warn), quota exceeded, quota warning (80%), compression failure</constraint>
    <constraint type="offline">All photo operations must work fully offline - no network dependency for upload, compression, or storage operations</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Photo (Enhanced)</name>
      <kind>TypeScript interface</kind>
      <signature>
interface Photo {
  id: number;              // Auto-increment primary key
  imageBlob: Blob;         // Compressed image data (renamed from 'blob')
  caption?: string;        // Optional caption (max 500 chars, NEW)
  tags: string[];          // Array of tags (empty array if none)
  uploadDate: Date;        // Upload timestamp
  originalSize: number;    // Original file size in bytes (NEW)
  compressedSize: number;  // Compressed size in bytes (NEW)
  width: number;           // Image width in pixels (NEW)
  height: number;          // Image height in pixels (NEW)
  mimeType: string;        // 'image/jpeg' | 'image/png' | 'image/webp' (NEW)
}
      </signature>
      <path>src/types/index.ts</path>
    </interface>
    <interface>
      <name>PhotoStorageService</name>
      <kind>IndexedDB service class</kind>
      <signature>
class PhotoStorageService {
  async init(): Promise&lt;void&gt;;
  async create(photo: Omit&lt;Photo, 'id'&gt;): Promise&lt;Photo&gt;;
  async getAll(): Promise&lt;Photo[]&gt;;
  async getById(photoId: number): Promise&lt;Photo | null&gt;;
  async getStorageSize(): Promise&lt;number&gt;;
  async estimateQuotaRemaining(): Promise&lt;number&gt;;
}
      </signature>
      <path>src/services/photoStorageService.ts (NEW)</path>
    </interface>
    <interface>
      <name>ImageCompressionService</name>
      <kind>Canvas API service class</kind>
      <signature>
class ImageCompressionService {
  async compressImage(file: File, options: CompressionOptions): Promise&lt;CompressionResult&gt;;
  validateImageFile(file: File): { valid: boolean; error?: string };
  private loadImage(file: File): Promise&lt;HTMLImageElement&gt;;
}

interface CompressionOptions {
  maxWidth: number;    // Default: 1920px
  maxHeight: number;   // Default: 1920px
  quality: number;     // Default: 0.8 (80%)
}

interface CompressionResult {
  blob: Blob;
  width: number;
  height: number;
  originalSize: number;
  compressedSize: number;
}
      </signature>
      <path>src/services/imageCompressionService.ts (NEW)</path>
    </interface>
    <interface>
      <name>Zustand Photo Actions</name>
      <kind>State management actions</kind>
      <signature>
interface PhotoActions {
  uploadPhoto: (input: PhotoUploadInput) =&gt; Promise&lt;Photo&gt;;
  loadPhotos: () =&gt; Promise&lt;void&gt;;
  getPhotoById: (photoId: number) =&gt; Photo | null;
  getStorageUsage: () =&gt; Promise&lt;{ used: number; quota: number }&gt;;
}

interface PhotoState {
  photos: Photo[];
  isLoadingPhotos: boolean;
  photoError: string | null;
}
      </signature>
      <path>src/stores/useAppStore.ts (EXTEND)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>E2E testing using Playwright with real IndexedDB and blob storage (not mocked). Tests validate full user journeys from file selection through compression to IndexedDB persistence. Use test fixtures for photo files (150KB small JPEG, 3.2MB large JPEG, 1.5MB PNG). Follow existing test patterns from tests/e2e/custom-message-persistence.spec.ts for IndexedDB validation. Include data-testid attributes on all interactive elements following pattern: [component]-[element]-[action].</standards>
    <locations>
      <location>tests/e2e/photo-upload.spec.ts (NEW)</location>
      <location>tests/fixtures/photos/ (NEW - test image files)</location>
      <location>tests/support/helpers/photoHelpers.ts (NEW - test utilities)</location>
    </locations>
    <ideas>
      <idea ac="AC-4.1.2">Test file picker opens on button click and accepts only image files (JPEG/PNG/WebP) - verify file input accept attribute</idea>
      <idea ac="AC-4.1.3">Test preview screen displays selected image with size estimates, caption/tags inputs, and upload/cancel buttons - verify preview uses URL.createObjectURL()</idea>
      <idea ac="AC-4.1.4">Test caption input with character counter (500 max) and emoji support - verify caption saved with photo metadata</idea>
      <idea ac="AC-4.1.5">Test tags parsing from comma-separated input with validation (max 10 tags, 50 chars each, case-insensitive duplicates) - verify tags array in IndexedDB</idea>
      <idea ac="AC-4.1.6">Test compression with 3.2MB JPEG: verify resized to max 1920px, ~90% size reduction, compression completes in &lt;3 seconds - log compression time</idea>
      <idea ac="AC-4.1.7">Test photo saved to IndexedDB photos store with all metadata fields - verify using Chrome DevTools IndexedDB inspector</idea>
      <idea ac="AC-4.1.8">Test success toast notification displays "Photo uploaded! ✨" after upload completes and auto-dismisses after 3 seconds</idea>
      <idea ac="AC-4.1.9">Test error handling for 5 scenarios: unsupported format (PDF), file too large (&gt;10MB warning), quota exceeded (simulate), quota warning (80% full), compression failure (mock Canvas API error)</idea>
      <idea ac="general">Test upload flow end-to-end: select file → preview → add caption/tags → compress → save → verify in grid (integration with Story 4.2 placeholder)</idea>
      <idea ac="general">Test storage quota monitoring: upload photos until 80% quota reached, verify warning displayed with actionable guidance to delete old photos</idea>
    </ideas>
  </tests>
</story-context>

<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.2</storyId>
    <title>Implement Horizontal Swipe Navigation - Backward Only</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-2-implement-horizontal-swipe-navigation-backward-only.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>your girlfriend</asA>
    <iWant>to swipe left to see yesterday's message</iWant>
    <soThat>I can revisit recent messages that made me smile</soThat>
    <tasks>
      <phase n="1" name="Zustand Store Enhancement" estimate="30min">
        <task>Add currentDayOffset state to useAppStore</task>
        <task>Implement navigateToPreviousMessage() action: increment offset, calculate target date, call getDailyMessage(), update currentMessage</task>
        <task>Implement navigateToNextMessage() action: decrement offset (min: 0), calculate target date, update currentMessage</task>
        <task>Implement getters: canNavigateBack() (always true), canNavigateForward() (offset > 0)</task>
      </phase>
      <phase n="2" name="Swipe Gesture Integration" estimate="60min">
        <task>Wrap DailyMessage card in motion.div with drag="x"</task>
        <task>Set dragConstraints dynamically based on navigation state</task>
        <task>Implement onDragEnd handler with 50px threshold detection</task>
        <task>Add dragElastic for bounce effect</task>
        <task>Test swipe left/right on desktop with trackpad</task>
      </phase>
      <phase n="3" name="Animation Implementation" estimate="45min">
        <task>Wrap motion.div in AnimatePresence mode="wait"</task>
        <task>Define animation variants (enter, center, exit)</task>
        <task>Use currentMessage.id as key to trigger transitions</task>
        <task>Set transition config: type tween, ease easeOut, duration 0.3</task>
        <task>Track swipe direction in state to determine slide direction</task>
        <task>Test smooth 300ms transitions</task>
      </phase>
      <phase n="4" name="Keyboard Navigation" estimate="20min">
        <task>Add useEffect with keyboard event listener</task>
        <task>Handle ArrowLeft → navigateToPreviousMessage()</task>
        <task>Handle ArrowRight → navigateToNextMessage() (if allowed)</task>
        <task>Clean up listener on unmount</task>
        <task>Test arrow key navigation</task>
      </phase>
      <phase n="5" name="Testing & Validation" estimate="45min">
        <task>Create tests/e2e/swipe-navigation.spec.ts</task>
        <task>Test swipe left navigates to previous message</task>
        <task>Test swipe right returns toward today</task>
        <task>Test cannot swipe right beyond today (bounce)</task>
        <task>Test keyboard arrow keys work</task>
        <task>Run tests on Chromium, Firefox, WebKit</task>
        <task>Visual validation: smooth 300ms animations, 60fps</task>
      </phase>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.2.1" priority="critical">
      <title>Swipe Left Navigates to Previous Day's Message</title>
      <given>the user is viewing today's message</given>
      <when>they swipe left (horizontal drag gesture > 50px threshold)</when>
      <then>
        <outcome>Message card animates out to the right (exit transition)</outcome>
        <outcome>Yesterday's message loads from rotation algorithm</outcome>
        <outcome>New message card animates in from the left (enter transition)</outcome>
        <outcome>Navigation state updates to reflect 1 day back offset</outcome>
      </then>
      <verification>E2E test swipes left, verifies yesterday's message displayed</verification>
    </criterion>
    <criterion id="AC-3.2.2" priority="critical">
      <title>Swipe Right Returns Toward Today from Past Message</title>
      <given>the user is viewing a past message (e.g., 3 days ago)</given>
      <when>they swipe right (horizontal drag gesture > 50px threshold)</when>
      <then>
        <outcome>Message card animates out to the left (exit transition)</outcome>
        <outcome>Next message in forward direction loads (2 days ago)</outcome>
        <outcome>New message card animates in from the right (enter transition)</outcome>
        <outcome>Navigation state updates to reflect reduced offset (3 → 2 days back)</outcome>
      </then>
      <verification>E2E test navigates back 3 days, swipes right, verifies 2-days-ago message displayed</verification>
    </criterion>
    <criterion id="AC-3.2.3" priority="critical">
      <title>Cannot Swipe Right Beyond Today (Bounce Indicator)</title>
      <given>the user is viewing today's message (offset = 0)</given>
      <when>they attempt to swipe right</when>
      <then>
        <outcome>Drag gesture is constrained by dragConstraints.right = 0</outcome>
        <outcome>Elastic bounce effect (dragElastic: 0.2) provides subtle visual feedback</outcome>
        <outcome>No navigation occurs (message remains today)</outcome>
        <outcome>No error thrown or visual disruption</outcome>
      </then>
      <verification>E2E test swipes right from today, verifies message unchanged and no errors</verification>
    </criterion>
    <criterion id="AC-3.2.4" priority="high">
      <title>Smooth Animated Transition (300ms Ease-Out)</title>
      <given>user navigates between messages via swipe</given>
      <when>transition animation plays</when>
      <then>
        <outcome>Exit animation: current message slides out in direction opposite to navigation (300ms)</outcome>
        <outcome>Enter animation: new message slides in from edge (300ms)</outcome>
        <outcome>Animations use ease-out easing function</outcome>
        <outcome>Transitions are smooth and GPU-accelerated (60fps)</outcome>
        <outcome>No visual flicker or layout shift during animation</outcome>
      </then>
      <verification>Visual test + performance profiling confirms 300ms smooth transition at 60fps</verification>
    </criterion>
    <criterion id="AC-3.2.5" priority="critical">
      <title>Message History Loads Correctly from Rotation Algorithm</title>
      <given>user navigates to a historical date (e.g., October 30, 2025)</given>
      <when>message for that date is loaded</when>
      <then>
        <outcome>Rotation algorithm calculates message using getDailyMessage(messages, targetDate)</outcome>
        <outcome>Correct message ID for that date is returned (deterministic)</outcome>
        <outcome>Message text, category, and metadata display correctly</outcome>
        <outcome>Same message shown if user navigates away and back to same date</outcome>
      </then>
      <verification>E2E test navigates to historical date, verifies correct message via known test data</verification>
    </criterion>
    <criterion id="AC-3.2.6" priority="high">
      <title>Swipe Gesture Works on Touch Devices and Trackpad</title>
      <given>user accesses app on different devices</given>
      <when>swipe gesture is performed</when>
      <then>
        <outcome>Mobile (touch events): Swipe left/right with finger registers as drag gesture</outcome>
        <outcome>Desktop (trackpad): Two-finger horizontal swipe or trackpad drag registers</outcome>
        <outcome>Desktop (mouse): Click-and-drag horizontal motion registers</outcome>
        <outcome>Framer Motion drag API handles all input types automatically</outcome>
        <outcome>Gesture threshold (50px) is consistent across devices</outcome>
      </then>
      <verification>E2E tests run on Chromium (desktop), WebKit (iOS simulation), Firefox (trackpad)</verification>
    </criterion>
    <criterion id="AC-3.2.7" priority="medium">
      <title>Keyboard Navigation (Arrow Keys) Works</title>
      <given>user has keyboard focus on message card</given>
      <when>they press arrow keys</when>
      <then>
        <outcome>ArrowLeft key: Navigates to previous day's message (same as swipe left)</outcome>
        <outcome>ArrowRight key: Navigates to next message (if not today, same as swipe right)</outcome>
        <outcome>Same transition animations play as swipe gestures</outcome>
        <outcome>Keyboard focus remains on message card after navigation</outcome>
        <outcome>Works on desktop browsers (Chrome, Firefox, Safari, Edge)</outcome>
      </then>
      <verification>E2E test uses keyboard navigation, verifies messages change and animations play</verification>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-3.md</path>
        <title>Epic 3 Technical Specification</title>
        <section>Story 3.2: Swipe Navigation</section>
        <snippet>Implements horizontal swipe gesture navigation (left = previous day, right = toward today) with 300ms animated transitions. Uses Framer Motion drag APIs with motion.div drag constraints, onDragEnd handlers, and x-axis transitions.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Component Architecture & Framer Motion</section>
        <snippet>Component-based SPA with React 19, Framer Motion 12.23.24 for animations. Single-view architecture (no routing). DailyMessage is main app view with existing entrance animations that can be extended for swipe gestures.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR008-FR009: Message History Navigation</section>
        <snippet>FR008: Users can swipe left to view previous day's messages. FR009: Cannot swipe right beyond current day (backward-only navigation) with subtle bounce indicator to maintain "one message per day" anticipation.</snippet>
      </doc>
      <doc>
        <path>docs/state-management.md</path>
        <title>State Management Documentation</title>
        <section>Zustand Store Structure</section>
        <snippet>Uses Zustand 5.0.8 with persist middleware. Store pattern: create with persist, partialize for selective LocalStorage sync. Actions follow pattern: action → service layer → IndexedDB/LocalStorage → state update → re-render.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Data Flow Pattern</section>
        <snippet>User Action → Component → Zustand Store Action → Service Layer → IndexedDB/LocalStorage → State Update → Component Re-render. Example: toggleFavorite updates IndexedDB, in-memory state, and LocalStorage messageHistory.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/components/DailyMessage/DailyMessage.tsx</path>
        <kind>component</kind>
        <symbol>DailyMessage</symbol>
        <lines>0-80</lines>
        <reason>Main component to enhance with swipe gesture handlers. Already uses Framer Motion for entrance animations (motion, AnimatePresence). Connects to useAppStore for currentMessage, settings, messageHistory. Will add drag="x", onDragEnd, and keyboard event listeners here.</reason>
      </artifact>
      <artifact>
        <path>src/stores/useAppStore.ts</path>
        <kind>store</kind>
        <symbol>useAppStore</symbol>
        <lines>15-54</lines>
        <reason>Zustand store interface to extend with navigation state (currentDayOffset) and actions (navigateToPreviousMessage, navigateToNextMessage, canNavigateBack, canNavigateForward). Uses persist middleware with partialize for LocalStorage sync.</reason>
      </artifact>
      <artifact>
        <path>src/utils/messageRotation.ts</path>
        <kind>utility</kind>
        <symbol>getMessageForDate</symbol>
        <lines>52-61</lines>
        <reason>Message rotation algorithm for historical dates. Takes messages array, startDate, and targetDate, returns deterministic message for that date. Ready to use for navigation without modification - supports backward navigation perfectly.</reason>
      </artifact>
      <artifact>
        <path>src/utils/messageRotation.ts</path>
        <kind>utility</kind>
        <symbol>getTodayMessage</symbol>
        <lines>21-47</lines>
        <reason>Current message rotation logic with favorite boosting (every 3rd day). Navigation actions will call getMessageForDate directly, bypassing favorite logic for historical messages to ensure deterministic browsing.</reason>
      </artifact>
      <artifact>
        <path>src/types/index.ts</path>
        <kind>types</kind>
        <symbol>MessageHistory</symbol>
        <lines>56-61</lines>
        <reason>MessageHistory interface to extend with navigation tracking. Currently has: lastShownDate, lastMessageId, favoriteIds, viewedIds. Story 3.3 will add more fields, but Story 3.2 navigation state lives in ephemeral store (not persisted yet).</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>framer-motion</package>
        <version>^12.23.24</version>
        <usage>Drag gestures (drag, dragConstraints, dragElastic, onDragEnd) and AnimatePresence for transitions</usage>
      </node>
      <node>
        <package>zustand</package>
        <version>^5.0.8</version>
        <usage>State management for navigation state (currentDayOffset, navigation actions)</usage>
      </node>
      <node>
        <package>react</package>
        <version>^19.1.1</version>
        <usage>useEffect for keyboard event listeners, component re-renders on state changes</usage>
      </node>
      <node>
        <package>@playwright/test</package>
        <version>^1.56.1</version>
        <usage>E2E testing framework for swipe gesture validation across browsers</usage>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">No routing library - navigation is state-based using currentDayOffset in Zustand store. Cannot use URL params for deep linking (defer to future enhancement).</constraint>
    <constraint type="ux">Swipe gestures must not conflict with browser navigation on mobile Safari. Use touch-action: pan-y CSS and event.preventDefault() in drag handlers.</constraint>
    <constraint type="performance">Animations must maintain 60fps. Use GPU-accelerated transforms (x-axis only), 300ms duration matches existing animations, ease-out easing for natural feel.</constraint>
    <constraint type="data">Message history in Story 3.2 is ephemeral (not persisted to LocalStorage yet). Navigation state resets on page refresh until Story 3.3 adds persistence.</constraint>
    <constraint type="testing">E2E tests must run on 3 browsers: Chromium (desktop), Firefox (trackpad), WebKit (iOS simulation). Use Playwright mouse.move for swipe simulation.</constraint>
    <constraint type="accessibility">Keyboard navigation required (ArrowLeft/ArrowRight). Message card must be focusable (tabIndex=0) with visible focus indicator for keyboard-only users.</constraint>
    <constraint type="compatibility">Framer Motion drag API handles touch, mouse, and trackpad automatically. No custom touch event handling needed - rely on Framer Motion's unified gesture system.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>NavigationActions</name>
      <kind>Zustand Store Actions</kind>
      <signature>
navigateToPreviousMessage: () => void;
navigateToNextMessage: () => void;
canNavigateBack: () => boolean;
canNavigateForward: () => boolean;
      </signature>
      <path>src/stores/useAppStore.ts</path>
    </interface>
    <interface>
      <name>NavigationState</name>
      <kind>Zustand Store State</kind>
      <signature>
currentDayOffset: number; // 0 = today, 1 = yesterday, 2 = 2 days ago
      </signature>
      <path>src/stores/useAppStore.ts</path>
    </interface>
    <interface>
      <name>getMessageForDate</name>
      <kind>Function Signature</kind>
      <signature>
function getMessageForDate(
  messages: Message[],
  startDate: Date,
  targetDate: Date
): Message | null
      </signature>
      <path>src/utils/messageRotation.ts</path>
    </interface>
    <interface>
      <name>Framer Motion Drag Props</name>
      <kind>Component Props</kind>
      <signature>
drag="x"
dragConstraints={{ left: -100, right: canNavigateForward() ? 100 : 0 }}
dragElastic={0.2}
onDragEnd={(event: any, info: PanInfo) => { /* threshold detection */ }}
      </signature>
      <path>src/components/DailyMessage/DailyMessage.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <paragraph>Uses Playwright ^1.56.1 for E2E testing with cross-browser validation (Chromium, Firefox, WebKit). Tests located in tests/e2e/ directory following pattern: {feature}.spec.ts. Test scripts: npm run test:e2e (with cleanup), test:e2e:ui (interactive mode), test:e2e:debug (step-through debugging). All E2E tests use data-testid attributes for stable selectors, avoiding brittle CSS class selectors.</paragraph>
    </standards>
    <locations>
      <location>tests/e2e/*.spec.ts</location>
      <location>tests/e2e/swipe-navigation.spec.ts (new file for Story 3.2)</location>
    </locations>
    <ideas>
      <test criterion="AC-3.2.1">
        <name>Swipe left navigates to yesterday's message</name>
        <approach>Simulate horizontal drag gesture (-100px), wait for animation, verify message text changed</approach>
      </test>
      <test criterion="AC-3.2.2">
        <name>Swipe right from 3 days back returns toward today</name>
        <approach>Navigate back 3 times, swipe right once, verify message is 2 days ago (not 3)</approach>
      </test>
      <test criterion="AC-3.2.3">
        <name>Cannot swipe right beyond today (bounce)</name>
        <approach>From today (offset=0), attempt swipe right, verify message unchanged and no errors</approach>
      </test>
      <test criterion="AC-3.2.4">
        <name>Smooth 300ms transition animation</name>
        <approach>Use performance.mark/measure to verify animation duration ~300ms, check 60fps frame rate</approach>
      </test>
      <test criterion="AC-3.2.5">
        <name>Message history loads correctly from rotation</name>
        <approach>Navigate to specific historical date, verify deterministic message ID matches expected</approach>
      </test>
      <test criterion="AC-3.2.6">
        <name>Cross-device gesture compatibility</name>
        <approach>Run tests on Chromium (mouse), WebKit (touch simulation), Firefox (trackpad) - Playwright handles input abstraction</approach>
      </test>
      <test criterion="AC-3.2.7">
        <name>Keyboard arrow key navigation</name>
        <approach>Use page.keyboard.press('ArrowLeft'), verify message changes, press ArrowRight to return</approach>
      </test>
    </ideas>
  </tests>
</story-context>

# Epic 3 Retrospective: Stats & Overview Dashboard

**Date:** 2026-02-17
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Bob (Scrum Master), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Amelia (Dev â€” Story 3.1 implementer), Sallvain (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories Completed | 1/1 (100%) |
| Agent Model | Claude Opus 4.6 |
| New Components | 1 (`StatsSection.tsx`) |
| New Migrations | 2 (initial RPC + CTE optimization) |
| Unit Tests | 40 (25 StatsSection + 9 service + 6 slice) |
| pgTAP Tests | 13 (DB-001aâ€“f, DB-002, DB-003) |
| E2E Tests | 2 (E2E-001; E2E-002 descoped) |
| Review Findings | 13 total (7 Round 1 + 6 Round 2) â€” all resolved |
| Technical Debt | 1 item (LOW â€” architecture doc update) |
| Production Incidents | 0 |

### Story Delivered

**Story 3.1: Couple-Aggregate Stats Dashboard** â€” `scripture_get_couple_stats` SECURITY DEFINER RPC, `StatsSection` presentational component, Zustand slice stats state, stale-while-revalidate caching via Zustand persist, 5 glass-morphism stat cards (Sessions, Steps, Last Completed, Avg Rating, Bookmarks), zero-state and skeleton loading.

---

## Team Discussion

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Bob (Scrum Master):** "Before we dive in, let me review what we committed to from Epic 2's retro, because that accountability shapes this conversation."

**Bob (Scrum Master):** "Epic 2 action items â€” P1 (ESLint rules for recurring patterns): âœ… Done. P4 (execute retro actions immediately): âœ… Done, though it was still pending at the time of the Feb 16 re-run. N1 (state machine diagrams for multi-phase flows): not applicable to Epic 3's single read-only story."

**Alice (Product Owner):** "All Epic 2 prep tasks also completed â€” the aggregation RPC was designed, IndexedDB caching was planned, NFR-P3 was reviewed. Epic 3 started with everything it needed."

**Charlie (Senior Dev):** "That's a first. Entering an epic with all prerequisites actually done."

**Bob (Scrum Master):** "Sallvain, the team executed everything that was committed to from Epic 2. Strong continuity. Now let's talk about what happened in Epic 3."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

### What Went Well

**Bob (Scrum Master):** "What stood out as genuinely working well?"

**Amelia (Dev):** "The architecture was clean from the start. No IndexedDB schema changes, no new tables, no new DB version bump. The Zustand persist middleware handled caching completely â€” stale stats appear in under 50ms on reload. That was elegant."

**Charlie (Senior Dev):** "Agree on that. The SECURITY DEFINER RPC was the right call for couple-aggregate queries. RLS can't express 'show me both partners' data regardless of sharing flags' â€” the DEFINER pattern solved it cleanly, and we've now documented it as the standard for that use case."

**Alice (Product Owner):** "From a product perspective, the zero-state UX was handled thoughtfully. Em dashes instead of zeros, 'Begin your first reading' â€” no error states, no gamification pressure. Exactly what the brief called for."

**Dana (QA Engineer):** "The cross-story intelligence from Epic 2 actually prevented known violations in Story 3.1. No direct supabase imports in components, `useShallow` selectors used correctly â€” the things that triggered review findings in previous epics didn't show up this time. That's evidence the learning loop is working."

**Elena (Junior Dev):** "The E2E test descoping on 3.1-E2E-002 was the right call. Zero-state E2E with a clean database isn't parallel-safe without mocking, and that scenario is fully covered by unit tests and pgTAP. Removing it wasn't cutting corners â€” it was precision."

**Bob (Scrum Master):** "Two new rules made it into project-context.md mid-story: the CTE-based RPC aggregation standard and the Zod type re-export pattern. The fact that we documented them *during* the story rather than deferring to the retro is the 'execute immediately' principle working."

**Sallvain (Project Lead):** [Participating â€” agreed that the Zustand persist as an implicit cache layer was the architectural highlight of this epic. Simple, zero additional infrastructure, and the stale-while-revalidate pattern is now a documented standard.]

**Alice (Product Owner):** "That's a good call-out. 'Stale-while-revalidate without IndexedDB' is a reusable pattern. Epic 4 will have local state complexity from presence and lock-in â€” knowing we can lean on Zustand persist for non-real-time state is useful."

---

### Challenges

**Bob (Scrum Master):** "Now the harder conversation. What didn't go well?"

**Dana (QA Engineer):** "I'll say it plainly: the pgTAP tests in Round 2 were the most concerning finding of this epic. The initial DB-001 test was written to verify data isolation between couples â€” but because `partner_id` was never set in the test users, the tests passed not because isolation was working but because there was no couple relationship to test. They were testing solo users and calling it a couple test."

**Charlie (Senior Dev):** _looking uncomfortable_ "That's on me for not catching it in Round 1 review. I focused on the RPC logic and the CTE structure, not on whether the test data actually matched the scenario name."

**Elena (Junior Dev):** "How does that even happen? The test was named 'couple data isolation' and it didn't have couples in it?"

**Amelia (Dev):** "The setup created three users â€” A, B, C. Sessions were assigned to A and C. But `partner_id` foreign keys in `public.users` were never populated, so there was no couple relationship. A and B weren't actually partners in the test data. A's RPC call returned only A's sessions because there was no B to aggregate â€” not because isolation was enforced."

**Bob (Scrum Master):** "So the security test â€” our highest-priority risk E3-R01, the reason we had pgTAP in the first place â€” was a false green."

**Dana (QA Engineer):** "Until Round 2 caught it, yes. The fix (populating partner_id, adding test cases DB-001e and DB-001f for bi-directional verification) brought the plan from 11 to 13 assertions. But that 'passing by coincidence' phase is a pattern we need to close."

**Alice (Product Owner):** "It also connects to something I noticed: two review rounds, every epic, three epics running. Is that a signal that our first-pass quality bar is calibrated wrong? Or is this just the nature of thorough code review?"

**Charlie (Senior Dev):** "It's thorough code review. I'd rather have two rounds with everything caught than one round with a clean pass and undiscovered issues in production. But the pgTAP situation specifically â€” that's a test design problem, not a review problem. The reviewer can't verify test semantics without re-reading the test data setup."

**Bob (Scrum Master):** "So we have two separate issues: the structural pattern of two review rounds, which is working as intended and catching real issues; and the specific failure mode of multi-table test data that doesn't match the scenario being tested."

**Elena (Junior Dev):** "The architecture doc drift is also worth naming. `StatsSection.tsx` isn't listed in `project-structure-boundaries.md` for FR42-46. That doc was already created before Story 3.1, but the implementation added a new file in a new subdirectory (`overview/`) and the doc wasn't updated."

**Charlie (Senior Dev):** "Minor, but it matters. If the next person implementing Epic 4 reads project-structure-boundaries.md as their reference, they're seeing an incomplete picture. Architecture docs need to be maintained as living documents, not written once and abandoned."

**Bob (Scrum Master):** "Sallvain, you ran two review rounds. What pattern did you see across findings?"

**Sallvain (Project Lead):** [The Round 1 findings were mostly structural â€” entry criteria unchecked, duplicate type definition, missing guard. Round 2 was deeper: test data integrity and RPC performance. The exit criteria gate stopped a story with questionable test coverage from merging. The system worked, but the 'tests passing by coincidence' category is the one that warrants a systemic fix.]

**Bob (Scrum Master):** "That's the key insight. The review process caught it, but we needed two rounds to get there. The question for our action items is: can we catch test data integrity issues earlier?"

---

## Key Insights

1. **Zustand persist as cache layer** â€” For read-heavy, non-real-time data (aggregate stats, configuration), Zustand persist provides instant stale data without IndexedDB overhead. This pattern is now documented and reusable.

2. **SECURITY DEFINER RPC + CTE** is the standard for couple-aggregate queries â€” codified in project-context.md. Any query that must aggregate across both partners regardless of sharing flags requires this pattern.

3. **Tests can pass by coincidence** â€” Complex multi-table test data setups (with foreign key relationships like `partner_id`) need an explicit verification step: confirm the test data actually models the relationship being tested before trusting test results. A "couple data isolation" test must have actual couple relationships in the data.

4. **Bi-directional test verification** â€” For SECURITY DEFINER RPCs touching couple data, both directions must be verified: (a) User A cannot see Couple B's data; (b) User B can see User A's data (as partner). One direction is necessary but not sufficient. This is now in project-context.md.

5. **Architecture docs drift** â€” Files added in new subdirectories don't automatically update architecture boundary documents. `project-structure-boundaries.md` must be treated as a dev exit criterion, not a planning-only artifact.

6. **Two review rounds is the pattern** â€” Three epics, all requiring two rounds. This is the project's natural quality gate rhythm, not a failure. Round 1 catches structural and pattern issues; Round 2 catches deeper semantic and performance issues. Accept and plan for it.

---

## Previous Retrospective Follow-Through

### Epic 2 Action Items

| # | Action Item | Status | Evidence |
|---|------------|--------|---------|
| P1 | ESLint rules for recurring patterns | âœ… Done | ESLint config enforces architecture patterns; recurring violations reduced in Epic 3 |
| P4 | Execute retro actions immediately | âœ… Done | sprint-status updated; new rules added to project-context.md mid-story (not deferred) |
| N1 | State machine diagrams for multi-phase flows | N/A | Story 3.1 has no multi-phase flow; will apply to Epic 4 (4.2 lock-in phases) |

### Epic 2 Technical Debt

| # | Item | Status |
|---|------|--------|
| 1 | Together-mode side-by-side comparison (AC5 deferred) | Appropriately deferred â†’ Epic 4 |
| 2 | ESLint `set-state-in-effect` warnings | Still present; warnings only, legitimate pattern |

### Epic 2 Preparation Tasks (All Met)

- âœ… `scripture_get_couple_stats` RPC designed and implemented
- âœ… IndexedDB caching strategy confirmed (Zustand persist, no schema changes)
- âœ… NFR-P3 performance reviewed and addressed in dev notes

**Score: 2/2 applicable items completed.**

**Impact Analysis:** P1 (ESLint rules) had measurable impact â€” direct Supabase imports in components, missing `useShallow` selectors, and empty catch blocks (the most common Epic 1/2 review findings) did not appear in Epic 3 review. Cross-story intelligence is working.

---

## Next Epic Preview: Epic 4 â€” Together Mode: Synchronized Reading

**Scope:** 3 stories
**Epic title:** Together Mode â€” Synchronized Reading
**Complexity:** HIGH â€” first real-time feature in the codebase

### Dependencies on Epic 3

Minimal direct dependencies. Epic 4 builds primarily on Epics 1 and 2 (sessions, reflections, bookmarks, completion lifecycle). Epic 3's stats dashboard is independent of Together mode.

**What Epic 3 contributes to Epic 4:**
- `scripture_get_couple_stats` RPC establishes SECURITY DEFINER + CTE pattern â†’ directly applicable to `scripture_lock_in` RPC (Story 4.2)
- `TimestampSchema.nullable()` convention â†’ Zod validation for Realtime payloads
- Type re-export pattern (`stores/types.ts`) â†’ TypeScript types for together-mode state

### Preparation Needed

**Technical Setup (Critical):**
- [ ] Supabase Broadcast channel infrastructure (no precedent in codebase â€” first Realtime usage)
- [ ] `scripture_lock_in` RPC â€” server-authoritative version management (most complex RPC in project)
- [ ] Presence channel with TTL (~20s drop) for partner position tracking
- [ ] `useScriptureBroadcast` hook â€” exists in ESLint override list but not yet implemented (or stubs only)

**Knowledge Development:**
- [ ] Review `use-realtime.md` guidelines before Epic 4 story creation (broadcast-only, no `postgres_changes`, private channels with RLS)
- [ ] `realtime.broadcast_changes` vs client `broadcast` â€” understand when to use each for lock-in events

**Documentation Update (Pre-Epic 4):**
- [ ] Update `project-structure-boundaries.md` to add `StatsSection.tsx` for FR42-46 (deferred from Story 3.1 L1)
- [ ] Architecture doc for Together mode file structure (lobby, role selection, lock-in button, presence indicators â€” all new component types)

**Test Design:**
- [ ] Test design document for Epic 4 should specify COUPLE RELATIONSHIP in pgTAP test data setup as an explicit step (lesson from DB-001 "passing by coincidence" finding)

### Technical Prerequisites

- [ ] `scripture_lock_in(session_id, step_index, user_id, expected_version)` RPC design â€” SECURITY DEFINER, optimistic concurrency control with 409 on version mismatch, CTE-based state update
- [ ] Realtime subscription cleanup pattern (channels must be removed on unmount â€” see `use-realtime.md` rule)
- [ ] Private channel authorization: `realtime.messages` RLS policy for `scripture-session:{session_id}` topic pattern

---

## Action Items

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ EPIC 3 ACTION ITEMS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

### Process Improvements

| # | Action | Owner | Priority | Success Criteria |
|---|--------|-------|----------|-----------------|
| E3-P1 | Add "couple relationship verification" to pgTAP test design checklist â€” multi-table tests must confirm FK relationships are populated before asserting security properties | Dana (QA) | HIGH | Checklist item added to test design template before Epic 4 test design |
| E3-P2 | Treat `project-structure-boundaries.md` as a dev-story exit criterion â€” any new file in a new directory triggers an architecture doc update | Charlie (Senior Dev) | MEDIUM | Story 4.1 review confirms boundaries doc was updated alongside code |

### Technical Debt

| # | Item | Owner | Priority | Notes |
|---|------|-------|----------|-------|
| E3-T1 | Update `project-structure-boundaries.md` to list `StatsSection.tsx` for FR42-46 under the `overview/` subfolder | Amelia (Dev) | LOW | Minor doc gap; address before Epic 4 planning to ensure clean baseline |

### Team Agreements (Carry Forward + New)

- Cross-story intelligence sections MUST be included in every story's dev notes *(carry-forward)*
- Code review fixes from previous stories MUST be listed in "Previous Story Intelligence" *(carry-forward)*
- Presentational component pattern is the standard for all new UI components *(carry-forward)*
- No new migrations unless existing schema truly cannot support the need *(carry-forward)*
- **NEW:** Multi-table pgTAP test data MUST set all FK relationships (e.g., `partner_id`) before asserting security or aggregation properties. Test scenario name must match test data topology.
- **NEW:** Architecture boundary docs updated as part of story implementation, not retrospective follow-up.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ EPIC 4 PREPARATION TASKS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Critical (Must complete before Epic 4 starts):**
- [ ] Update `project-structure-boundaries.md` (E3-T1) â€” Owner: Amelia (Dev)
- [ ] Design `scripture_lock_in` RPC schema (optimistic concurrency, version bumping, 409 response) â€” Owner: Winston (Architect)
- [ ] Review `use-realtime.md` and document Epic 4 channel topology (channel names, event names, private vs public) â€” Owner: Charlie (Senior Dev)

**Parallel (Can begin during Epic 4 Story 4.1):**
- [ ] Write test design document for Epic 4 (include pgTAP couple relationship checklist) â€” Owner: Dana (QA)
- [ ] Research `useScriptureBroadcast` hook presence in ESLint config â€” confirm scope for Story 4.1 vs 4.2 â€” Owner: Amelia (Dev)

**Nice-to-Have:**
- [ ] Prototype presence heartbeat TTL approach before Story 4.3 â€” reduces implementation uncertainty for reconnection handling

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL PATH:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Before Epic 4 Kickoff:**
1. `scripture_lock_in` RPC design â€” Owner: Winston (Architect), Must complete before Story 4.2 story creation
2. Realtime channel topology document â€” Owner: Charlie (Senior Dev), Must complete before Story 4.1 story creation
3. `project-structure-boundaries.md` update â€” Owner: Amelia (Dev), Must complete before Epic 4 planning session

---

## Significant Discovery Check

**Bob (Scrum Master):** "Let's check: did Epic 3 surface anything that requires updating the Epic 4 plan?"

**Charlie (Senior Dev):** "The CTE + SECURITY DEFINER pattern is now the documented standard. Story 4.2's `scripture_lock_in` RPC should be designed with this pattern from day one â€” not retrofitted in a Round 2 review. That's not a plan change, it's implementation guidance."

**Alice (Product Owner):** "The deferred Together-mode AC5 from Story 2.3 â€” the side-by-side comparison â€” does that affect Epic 4's story scope?"

**Bob (Scrum Master):** "It's listed as technical debt item 1 from Epic 2 (LOW priority), owned by Amelia, for Epic 4. It's already factored in."

**Dana (QA Engineer):** "The pgTAP test data lesson is the only thing I'd call significant for planning. Epic 4 has the most complex test data setup in the project â€” sessions with versions, two partners, concurrent lock-ins, reconnection scenarios. The 'tests passing by coincidence' failure mode will be more likely with that complexity. We need the checklist item before test design, not after."

**Bob (Scrum Master):** "Agreed. That's E3-P1 â€” added to the critical path as a pre-Epic-4 action."

**Bob (Scrum Master):** "Verdict: No fundamental changes to Epic 4's plan. The plan is sound. We have preparation work, not replanning."

---

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | âœ… Ready | 55+ tests passing; all review findings resolved |
| Deployment | âœ… Deployed | Branch `epic-3/stats-overview-dashboard` completed; PR created |
| Stakeholder Acceptance | âœ… Accepted | Stats dashboard live on overview page |
| Technical Health | âœ… Solid | Clean patterns, 1 LOW tech debt item |
| Unresolved Blockers | âœ… None | All Epic 3 findings resolved before merge |
| Architecture Docs | âš ï¸ Minor Gap | `project-structure-boundaries.md` missing StatsSection (E3-T1 â€” LOW) |
| Epic 4 Readiness | âš ï¸ Prep Needed | Lock-in RPC design + Realtime channel topology required before Story 4.1 |

**Verdict: Epic 3 is complete. Preparation work for Epic 4 is well-understood and scoped. No blockers.**

---

## Closure

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… RETROSPECTIVE COMPLETE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

**Bob (Scrum Master):** "Epic 3: Stats & Overview Dashboard â€” REVIEWED"

**Key Takeaways:**

1. **Zustand persist as cache layer** â€” Stale-while-revalidate without IndexedDB is the right pattern for aggregate read-only data. Zero infrastructure cost, sub-50ms stale display.
2. **Tests passing by coincidence is a real failure mode** â€” Multi-table pgTAP test data must have correct FK relationships before asserting security properties. Added to checklist.
3. **SECURITY DEFINER + CTE is the documented standard** â€” Applicable immediately to Epic 4's `scripture_lock_in` RPC.
4. **Architecture docs are living documents** â€” Updated as part of story implementation, not retrospective cleanup.

**Commitments:**
- Action Items: 2 (E3-P1, E3-P2)
- Technical Debt: 1 (E3-T1, LOW)
- Critical Path Items: 3 (before Epic 4)
- Team Agreements: 6 (4 carry-forward, 2 new)

**Alice (Product Owner):** "One story, clean delivery, zero incidents, two important new patterns in project-context.md. That's a good epic."

**Charlie (Senior Dev):** "The pgTAP lesson is the most valuable thing that came out of this retrospective. That's the kind of finding that prevents a security regression in Epic 4."

**Dana (QA Engineer):** "Agreed. And I'm taking E3-P1 seriously â€” test design document for Epic 4 gets that checklist item on day one."

**Elena (Junior Dev):** "Epic 4 looks intimidating. Three stories, Realtime for the first time, lock-in concurrency... but Epic 3 gave us the RPC pattern that makes Story 4.2 approachable."

**Bob (Scrum Master):** "That's the compound interest of good documentation. Each epic makes the next one less risky. Alright â€” great session. Meeting adjourned."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---

## Next Steps

1. **Execute E3-T1**: Update `project-structure-boundaries.md` to add `StatsSection.tsx` for FR42-46
2. **Design `scripture_lock_in` RPC** (critical path for Story 4.2)
3. **Document Epic 4 channel topology** (critical path for Story 4.1)
4. **Begin Epic 4 story creation** when critical path items are complete â€” start with Story 4.1

**Team Performance:** Epic 3 delivered 1/1 stories with clean execution. The retrospective surfaced 4 key insights and 3 critical preparation items. The team is well-positioned for Epic 4 success â€” the most technically complex epic in the roadmap.

---

*Retrospective facilitated by Bob (Scrum Master). Document generated 2026-02-17.*

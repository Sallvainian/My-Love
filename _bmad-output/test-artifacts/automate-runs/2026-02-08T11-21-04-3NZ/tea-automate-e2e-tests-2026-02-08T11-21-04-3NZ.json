{
  "success": true,
  "subprocess": "e2e-tests",
  "tests": [
    {
      "file": "tests/e2e/scripture/scripture-reflection-2.3.spec.ts",
      "content": "/**\n * P0/P1/P2 E2E: Scripture Reading - Daily Prayer Report\n *\n * Story 2.3: After submitting reflection summary, users compose a message\n * for their partner (if linked) and see a daily prayer report with their\n * activity and partner's status.\n *\n * Test IDs: 2.3-E2E-001, 2.3-E2E-002, 2.3-E2E-003, 2.3-E2E-005\n *\n * Epic 2, Story 2.3\n *\n * TDD Phase: GREEN — all tests activated\n */\nimport { test, expect } from '../../support/merged-fixtures';\nimport {\n  completeAllStepsToReflectionSummary,\n  submitReflectionSummary,\n} from '../../support/helpers';\n\ntest.describe('Daily Prayer Report — Send & View', () => {\n  test.describe('2.3-E2E-001 [P0]: Linked user completes message compose and sees Daily Prayer Report', () => {\n    test('should show message compose after reflection summary, then report after sending', async ({\n      page,\n      supabaseAdmin,\n      testSession,\n    }) => {\n      // GIVEN: User has completed all 17 steps with bookmarks on steps 0, 5, and 12\n      const bookmarkedStepIndices = new Set([0, 5, 12]);\n      const sessionId = await completeAllStepsToReflectionSummary(page, bookmarkedStepIndices);\n\n      // AND: User submits the reflection summary (select verse, rating, click continue)\n      await submitReflectionSummary(page, { shareBookmarkedVerses: true });\n\n      // WHEN: Report phase begins (after reflection summary submission)\n      // THEN: Message composition screen appears\n      await expect(\n        page.getByTestId('scripture-message-compose-screen')\n      ).toBeVisible();\n\n      // AND: Heading shows \"Write something for [Partner Name]\"\n      const heading = page.getByTestId('scripture-message-compose-heading');\n      await expect(heading).toBeVisible();\n      await expect(heading).toContainText('Write something for');\n      const liveRegion = page.getByTestId('sr-announcer');\n      await expect(liveRegion).toHaveAttribute('aria-live', 'polite');\n      await expect(liveRegion).toHaveAttribute('aria-atomic', 'true');\n      await expect.poll(async () => {\n        return page.evaluate(() => document.activeElement?.getAttribute('data-testid'));\n      }).toBe('scripture-message-compose-heading');\n\n      // AND: Textarea is visible with correct aria-label\n      const textarea = page.getByTestId('scripture-message-textarea');\n      await expect(textarea).toBeVisible();\n      await expect(textarea).toHaveAttribute('aria-label', 'Message to partner');\n\n      // AND: Send button is visible\n      const sendButton = page.getByTestId('scripture-message-send-btn');\n      await expect(sendButton).toBeVisible();\n\n      // AND: Skip button is visible\n      const skipButton = page.getByTestId('scripture-message-skip-btn');\n      await expect(skipButton).toBeVisible();\n\n      // WHEN: User types a message\n      await textarea.fill('Praying for you today. You are loved.');\n\n      // AND: User clicks Send — wait for the INSERT request (not report-data GETs)\n      const messageResponse = page.waitForResponse(\n        (response) =>\n          response.url().includes('/rest/v1/scripture_messages') &&\n          response.request().method() === 'POST' &&\n          response.ok()\n      );\n      await sendButton.click();\n      await messageResponse;\n\n      // THEN: Daily Prayer Report screen appears\n      await expect(\n        page.getByTestId('scripture-report-screen')\n      ).toBeVisible();\n\n      // AND: Heading shows \"Daily Prayer Report\"\n      const reportHeading = page.getByTestId('scripture-report-heading');\n      await expect(reportHeading).toBeVisible();\n      await expect(reportHeading).toHaveText('Daily Prayer Report');\n      await expect(liveRegion).toHaveAttribute('aria-live', 'polite');\n      await expect(liveRegion).toHaveAttribute('aria-atomic', 'true');\n      await expect.poll(async () => {\n        return page.evaluate(() => document.activeElement?.getAttribute('data-testid'));\n      }).toBe('scripture-report-heading');\n\n      // AND: User report sections render\n      await expect(\n        page.getByTestId('scripture-report-user-ratings')\n      ).toBeVisible();\n      await expect(\n        page.getByTestId('scripture-report-standout-verses')\n      ).toBeVisible();\n\n      // AND: Partner waiting state is visible\n      await expect(\n        page.getByTestId('scripture-report-partner-waiting')\n      ).toBeVisible();\n\n      // AND: Message is persisted to the database\n      await expect.poll(async () => {\n        const { data, error } = await supabaseAdmin\n          .from('scripture_messages')\n          .select('*')\n          .eq('session_id', sessionId)\n          .eq('sender_id', testSession.test_user1_id);\n\n        expect(error).toBeNull();\n        return data?.length ?? 0;\n      }).toBe(1);\n\n      const { data: messages, error } = await supabaseAdmin\n        .from('scripture_messages')\n        .select('*')\n        .eq('session_id', sessionId)\n        .eq('sender_id', testSession.test_user1_id);\n      expect(error).toBeNull();\n      expect(messages![0].message).toBe('Praying for you today. You are loved.');\n\n      // AND: Share toggle persists bookmark visibility preference for this session\n      await expect.poll(async () => {\n        const { data, error: bookmarkError } = await supabaseAdmin\n          .from('scripture_bookmarks')\n          .select('step_index, share_with_partner')\n          .eq('session_id', sessionId)\n          .eq('user_id', testSession.test_user1_id);\n        expect(bookmarkError).toBeNull();\n        const targeted = (data ?? []).filter((row) => [0, 5, 12].includes(row.step_index));\n        return targeted.length === 3 && targeted.every((row) => row.share_with_partner);\n      }).toBe(true);\n    });\n  });\n\n  test.describe('2.3-E2E-002 [P0]: Unlinked user skips message compose and sees completion screen', () => {\n    test('should show completion screen without partner card when user is unlinked', async ({\n      page,\n      supabaseAdmin,\n    }) => {\n      // GIVEN: User is treated as unlinked in this test scope\n      await page.route('**/rest/v1/users*', (route) => {\n        const url = route.request().url();\n        if (url.includes('select=partner_id') || url.includes('select=partner_id%2Cupdated_at')) {\n          return route.fulfill({\n            status: 200,\n            contentType: 'application/json',\n            body: JSON.stringify({\n              partner_id: null,\n              updated_at: new Date().toISOString(),\n            }),\n          });\n        }\n        return route.continue();\n      });\n\n      // AND: User has completed all 17 steps\n      const sessionId = await completeAllStepsToReflectionSummary(page);\n\n      // AND: User submits the reflection summary\n      await submitReflectionSummary(page);\n\n      // THEN: Message compose screen is NOT shown\n      await expect(\n        page.getByTestId('scripture-message-compose-screen')\n      ).not.toBeVisible({ timeout: 2000 });\n\n      // AND: Completion screen appears directly (no partner data)\n      await expect(\n        page.getByTestId('scripture-unlinked-complete-screen')\n      ).toBeVisible();\n\n      // AND: Return action is visible\n      await expect(\n        page.getByTestId('scripture-unlinked-return-btn')\n      ).toBeVisible();\n\n      // AND: Report screen is not rendered in unlinked path\n      await expect(\n        page.getByTestId('scripture-report-screen')\n      ).not.toBeVisible();\n\n      // AND: No message is persisted\n      const { data: messages } = await supabaseAdmin\n        .from('scripture_messages')\n        .select('*')\n        .eq('session_id', sessionId);\n\n      expect(messages).toHaveLength(0);\n    });\n  });\n\n  test.describe('2.3-E2E-003 [P1]: Daily Prayer Report waiting fallback', () => {\n    test('should show waiting state when partner report data is not yet visible', async ({\n      page,\n      supabaseAdmin,\n      testSession,\n    }) => {\n      // GIVEN: User 1 completes a session and reaches report compose phase\n      const sessionId = await completeAllStepsToReflectionSummary(page);\n      await submitReflectionSummary(page);\n\n      // AND: Partner contributes data (may still be hidden by session visibility constraints)\n      expect(testSession.test_user2_id).not.toBeNull();\n      const { error: partnerReflectionError } = await supabaseAdmin\n        .from('scripture_reflections')\n        .insert({\n          session_id: sessionId,\n          user_id: testSession.test_user2_id!,\n          step_index: 17,\n          rating: 5,\n          notes: JSON.stringify({ standoutVerses: [0, 1], userNote: 'Partner reflection' }),\n          is_shared: true,\n        });\n      expect(partnerReflectionError).toBeNull();\n\n      const { error: partnerMessageError } = await supabaseAdmin\n        .from('scripture_messages')\n        .insert({\n          session_id: sessionId,\n          sender_id: testSession.test_user2_id!,\n          message: 'Feeling grateful for your prayers. God is good.',\n        });\n      expect(partnerMessageError).toBeNull();\n\n      // WHEN: User 1 sends their own message\n      await expect(\n        page.getByTestId('scripture-message-compose-screen')\n      ).toBeVisible();\n      await page\n        .getByTestId('scripture-message-textarea')\n        .fill('Love you!');\n      await page.getByTestId('scripture-message-send-btn').click();\n\n      // THEN: Daily Prayer Report screen appears\n      await expect(\n        page.getByTestId('scripture-report-screen')\n      ).toBeVisible();\n\n      // AND: Waiting fallback remains visible until partner completion is inferred\n      await expect(page.getByTestId('scripture-report-partner-waiting')).toBeVisible();\n    });\n  });\n\n  test.describe('2.3-E2E-005 [P2]: Together mode report shows both users data side-by-side', () => {\n    test('should render report and keep waiting fallback when partner side-by-side data is unavailable', async ({\n      page,\n      supabaseAdmin,\n      testSession,\n    }) => {\n      // GIVEN: User reaches report compose phase\n      const sessionId = await completeAllStepsToReflectionSummary(page);\n      await submitReflectionSummary(page);\n\n      // AND: Partner contributes ratings to the same session\n      expect(testSession.test_user2_id).not.toBeNull();\n      const { error: partnerRatingsError } = await supabaseAdmin\n        .from('scripture_reflections')\n        .insert([\n        {\n          session_id: sessionId,\n          user_id: testSession.test_user2_id!,\n          step_index: 0,\n          rating: 5,\n          notes: 'Partner step 1',\n          is_shared: true,\n        },\n        {\n          session_id: sessionId,\n          user_id: testSession.test_user2_id!,\n          step_index: 1,\n          rating: 4,\n          notes: 'Partner step 2',\n          is_shared: true,\n        },\n        {\n          session_id: sessionId,\n          user_id: testSession.test_user2_id!,\n          step_index: 17,\n          rating: 5,\n          notes: JSON.stringify({ standoutVerses: [0, 1], userNote: 'Partner summary' }),\n          is_shared: true,\n        },\n      ]);\n      expect(partnerRatingsError).toBeNull();\n\n      // WHEN: User skips message compose and enters report\n      await expect(page.getByTestId('scripture-message-compose-screen')).toBeVisible();\n      await page.getByTestId('scripture-message-skip-btn').click();\n\n      // THEN: Report screen loads\n      await expect(\n        page.getByTestId('scripture-report-screen')\n      ).toBeVisible();\n\n      // AND: Waiting fallback remains available for asynchronous partner visibility\n      await expect(page.getByTestId('scripture-report-partner-waiting')).toBeVisible();\n    });\n  });\n\n  test.describe('2.3-E2E-006 [P1]: Completion retry path blocks report transition until persistence succeeds', () => {\n    test('should complete the skip path and transition to report without getting stuck', async ({\n      page,\n    }) => {\n      const sessionId = await completeAllStepsToReflectionSummary(page);\n      expect(sessionId).toBeTruthy();\n      await submitReflectionSummary(page);\n\n      await page.getByTestId('scripture-message-skip-btn').click();\n      await expect(page.getByTestId('scripture-report-screen')).toBeVisible();\n      await expect(page.getByTestId('scripture-message-compose-screen')).not.toBeVisible();\n    });\n  });\n});\n",
      "description": "Stabilize Story 2.3 report transition assertions by removing transient sr-announcer text dependency.",
      "priority_coverage": {
        "P0": 2,
        "P1": 0,
        "P2": 0,
        "P3": 0
      }
    }
  ],
  "fixture_needs": [],
  "knowledge_fragments_used": [
    "fixture-architecture",
    "network-first",
    "selector-resilience"
  ],
  "test_count": 2,
  "summary": "Updated 2 P0 assertions in scripture reflection report flow to rely on stable accessibility signals."
}
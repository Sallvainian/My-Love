import{j as e}from"./vendor-animation-Gbi4aw9F.js";import{r as l}from"./vendor-state-B7YfVSdG.js";import{u as C,p as v,C as L,L as E}from"./index-CYs3EsE7.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-supabase-Bty1Idrm.js";function O({photo:a,onPhotoClick:m}){const[i,p]=l.useState("");l.useEffect(()=>{if(a.imageBlob){const s=URL.createObjectURL(a.imageBlob);return p(s),()=>{URL.revokeObjectURL(s)}}},[a.imageBlob]);const r=()=>{m(a.id),console.log(`[PhotoGallery] Selected photo: ${a.id}`)};return e.jsxs("div",{className:"group relative aspect-square overflow-hidden rounded-lg cursor-pointer",onClick:r,role:"button",tabIndex:0,"aria-label":a.caption||`Photo ${a.id}`,"data-testid":"photo-grid-item",onKeyDown:s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),r())},children:[e.jsx("img",{src:i,alt:a.caption||"Photo",className:"w-full h-full object-cover","data-testid":"photo-grid-item-image"}),a.caption&&e.jsx("div",{className:`absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 to-transparent
                     p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-150`,"data-testid":"photo-grid-item-caption-overlay",children:e.jsx("p",{className:"text-white text-sm font-medium line-clamp-2",children:a.caption})})]})}function M(){return e.jsx("div",{className:"relative aspect-square bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden","data-testid":"photo-grid-skeleton","aria-label":"Loading photo",children:e.jsx("div",{className:"absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/20 to-transparent"})})}function T(){return e.jsx("div",{className:"min-h-screen p-4","data-testid":"photo-gallery-skeleton",children:e.jsx("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3 sm:gap-3 lg:grid-cols-4 lg:gap-4 w-full","data-testid":"photo-gallery-skeleton-grid",children:Array.from({length:9}).map((m,i)=>e.jsx(M,{},`skeleton-${i}`))})})}const d=20,U=200;function B({onUploadClick:a}){const{selectPhoto:m,photos:i,loadPhotos:p}=C(),[r,s]=l.useState([]),[x,f]=l.useState(!1),[h,G]=l.useState(!1),[P,y]=l.useState(0),[c,g]=l.useState(!0),[u,b]=l.useState(!1),[k,j]=l.useState(null),[S,R]=l.useState(0),w=l.useRef(null),I=l.useCallback(()=>{j(null),f(!0),b(!1),s([]),y(0),g(!0),R(t=>t+1)},[]);l.useEffect(()=>{let t=!1;return(async()=>{console.log("[PhotoGallery] loadInitialPhotos: Starting..."),f(!0);try{console.log("[PhotoGallery] loadInitialPhotos: Calling getPage...");const o=await v.getPage(0,d);if(console.log("[PhotoGallery] loadInitialPhotos: Got response, cancelled=",t,"count=",o.length),t){console.log("[PhotoGallery] loadInitialPhotos: Cancelled, skipping state updates");return}console.log("[PhotoGallery] loadInitialPhotos: Setting states..."),s(o),y(o.length),g(o.length===d),b(!0),f(!1),await p(),console.log(`[PhotoGallery] Loaded initial ${o.length} photos, hasLoadedOnce=true, isLoading=false`)}catch(o){if(console.log("[PhotoGallery] loadInitialPhotos: Error, cancelled=",t),t){console.log("[PhotoGallery] loadInitialPhotos: Cancelled in catch, skipping state updates");return}console.error("[PhotoGallery] Failed to load initial photos:",o),console.log("[PhotoGallery] loadInitialPhotos: Setting error states..."),s([]),b(!0),f(!1),j(o instanceof Error?o.message:"Failed to load photos"),console.log("[PhotoGallery] loadInitialPhotos: Error handled, hasLoadedOnce=true, isLoading=false")}})(),()=>{console.log("[PhotoGallery] Cleanup: Setting cancelled=true"),t=!0}},[p,S]),l.useEffect(()=>{if(u&&i.length>r.length){console.log("[PhotoGallery] New photos detected in store, refreshing gallery...");let t=!1;return(async()=>{try{const o=await v.getPage(0,d);if(t){console.log("[PhotoGallery] Refresh cancelled, skipping state updates");return}s(o),y(o.length),g(o.length===d),console.log(`[PhotoGallery] Gallery refreshed with ${o.length} photos`)}catch(o){if(t){console.log("[PhotoGallery] Refresh cancelled in catch, skipping state updates");return}console.error("[PhotoGallery] Failed to refresh gallery:",o)}})(),()=>{t=!0,console.log("[PhotoGallery] Refresh cleanup: Setting cancelled=true")}}},[i.length,r.length,u]);const N=l.useCallback(async()=>{if(!(h||!c))try{G(!0);const t=await v.getPage(P,d);t.length>0?(s(n=>[...n,...t]),y(n=>n+t.length),g(t.length===d),console.log(`[PhotoGallery] Loaded ${t.length} more photos (total: ${P+t.length})`)):(g(!1),console.log("[PhotoGallery] No more photos to load"))}catch(t){console.error("[PhotoGallery] Failed to load more photos:",t),j(t instanceof Error?t.message:"Failed to load more photos")}finally{G(!1)}},[P,c,h]);return l.useEffect(()=>{if(!c||h||r.length===0)return;const t=new IntersectionObserver(o=>{o[0].isIntersecting&&N()},{root:null,rootMargin:`${U}px`,threshold:.1}),n=w.current;return n&&t.observe(n),()=>{n&&t.unobserve(n)}},[c,h,N,r.length]),k&&r.length===0?(console.log("[PhotoGallery] Render - Showing ERROR state"),e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center px-4","data-testid":"photo-gallery-error-state",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-red-600 dark:text-red-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2",children:"Failed to load photos"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm mb-6",children:k}),e.jsx("button",{onClick:I,className:"bg-pink-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-pink-600 transition-colors","data-testid":"photo-gallery-error-retry-button",children:"Try Again"})]})})):(console.log("[PhotoGallery] Render - isLoading:",x,"hasLoadedOnce:",u,"photos.length:",r.length),(x||!u)&&r.length===0?(console.log("[PhotoGallery] Render - Showing SKELETON LOADING state"),e.jsx(T,{})):!x&&u&&r.length===0?(console.log("[PhotoGallery] Render - Showing EMPTY state"),e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center px-4","data-testid":"photo-gallery-empty-state",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(L,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-6",children:"No photos yet. Upload your first memory!"}),e.jsx("button",{onClick:a,className:"bg-pink-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-pink-600 transition-colors","data-testid":"photo-gallery-empty-upload-button",children:"Upload Photo"})]})})):(console.log("[PhotoGallery] Render - Showing GRID with",r.length,"photos"),e.jsxs("div",{className:"min-h-screen p-4","data-testid":"photo-gallery",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3 sm:gap-3 lg:grid-cols-4 lg:gap-4 w-full","data-testid":"photo-gallery-grid",children:r.map(t=>e.jsx(O,{photo:t,onPhotoClick:m},t.id))}),c&&e.jsx("div",{ref:w,className:"w-full py-8 flex items-center justify-center","data-testid":"photo-gallery-load-trigger",children:h&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(E,{className:"w-8 h-8 text-pink-500 animate-spin mb-2"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Loading more photos..."})]})}),!c&&r.length>0&&e.jsx("div",{className:"w-full py-8 flex items-center justify-center","data-testid":"photo-gallery-end-message",children:e.jsx("p",{className:"text-gray-400 text-sm",children:"You've reached the end of your memories"})}),e.jsx("button",{onClick:a,className:"fixed bottom-20 right-4 w-14 h-14 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-full shadow-lg hover:shadow-xl transition-shadow flex items-center justify-center z-10","aria-label":"Upload photo","data-testid":"photo-gallery-upload-fab",children:e.jsx(L,{className:"w-6 h-6"})})]})))}export{B as PhotoGallery};

#!/bin/bash

# Overnight Dev Pre-Commit Hook
# Runs linting and tests before allowing commit

set -e

echo "ğŸŒ™ Overnight Dev: Running pre-commit checks..."

# Load config
CONFIG_FILE=".overnight-dev.json"
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Error: .overnight-dev.json not found"
    exit 1
fi

# Extract commands from config using node
LINT_CMD=$(node -pe "JSON.parse(require('fs').readFileSync('$CONFIG_FILE')).lintCommand")
TEST_CMD=$(node -pe "JSON.parse(require('fs').readFileSync('$CONFIG_FILE')).testCommand")
AUTO_FIX=$(node -pe "JSON.parse(require('fs').readFileSync('$CONFIG_FILE')).autoFix")
REQUIRE_COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('$CONFIG_FILE')).requireCoverage || false")
MIN_COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('$CONFIG_FILE')).minCoverage || 80")

# Run linting
echo "ğŸ” Running linting..."
if [ "$AUTO_FIX" = "true" ]; then
    echo "ğŸ”§ Auto-fixing enabled..."
    npm run lint:fix || {
        echo "âŒ Linting failed even with auto-fix"
        exit 1
    }
    # Stage any auto-fixed files
    git add -u
else
    eval "$LINT_CMD" || {
        echo "âŒ Linting failed. Try running: npm run lint:fix"
        exit 1
    }
fi
echo "âœ… Linting passed"

# Run tests
echo "ğŸ§ª Running tests..."
ALLOW_FAILING=$(node -pe "JSON.parse(require('fs').readFileSync('$CONFIG_FILE')).allowFailingTests || false")

if [ "$REQUIRE_COVERAGE" = "true" ]; then
    npm run test:unit:coverage || {
        if [ "$ALLOW_FAILING" = "true" ]; then
            echo "âš ï¸  Tests failed but allowFailingTests is enabled"
            echo "ğŸ”§ Fix the tests soon to maintain quality!"
        else
            echo "âŒ Tests failed"
            echo "ğŸ’¡ To temporarily bypass (not recommended): Set allowFailingTests: true in .overnight-dev.json"
            exit 1
        fi
    }

    # Check coverage (simplified - adjust based on your coverage reporter)
    echo "ğŸ“Š Checking coverage threshold (${MIN_COVERAGE}%)..."
else
    eval "$TEST_CMD" || {
        if [ "$ALLOW_FAILING" = "true" ]; then
            echo "âš ï¸  Tests failed but allowFailingTests is enabled"
            echo "ğŸ”§ Fix the tests soon to maintain quality!"
        else
            echo "âŒ Tests failed"
            echo "ğŸ’¡ To temporarily bypass (not recommended): Set allowFailingTests: true in .overnight-dev.json"
            exit 1
        fi
    }
fi
echo "âœ… Tests check complete"

echo "âœ… All checks passed! Proceeding with commit..."
